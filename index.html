<script>
/* ----------------------------------------------------
   index.html 入口 JS  — 2025-09 V7.2+free-fix
   - FREE_SLUGS 白名單 + 相容 data.index.json 的 free 欄位
   - 封面/前往/測驗 點擊行為
---------------------------------------------------- */
(() => {
  const $  = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> [...r.querySelectorAll(s)];

  // 未登入也可看白名單（保險，與 data.index.json 的 free 並用）
  const FREE_SLUGS = ['mid-autumn'];

  const grid = $('#grid');
  const dlg  = $('#dlgLogin');
  const stat = $('#stat');
  const q    = $('#q');

  const authName = $('#authName');
  const btnLogin = $('#btnLogin');
  const btnLogout= $('#btnLogout');

  let ALL = [];
  let filter = 'all';
  let keyword = '';

  // ---------- 讀清單 ----------
  async function loadIndex(){
    const res = await fetch('data/index.json', {cache:'no-store'});
    if(!res.ok) throw new Error('讀取 data/index.json 失敗');
    const meta = await res.json();
    ALL = meta.items || [];
    stat.textContent = `已收錄 ${ALL.length} 個故事`;
    render();
  }

  // ---------- 篩選 ----------
  function passFilter(x){
    if(filter !== 'all' && (x.length||'').toLowerCase() !== filter) return false;
    if(!keyword) return true;
    const k = keyword.toLowerCase();

    // 同時支援 title/subtitle 舊新欄位
    const t1 = (x.title||'').toLowerCase();
    const t2 = (x.subtitle||'').toLowerCase();
    const te = (x.title_en||'').toLowerCase();
    const tz = (x.title_zh||'').toLowerCase();
    const sg = (x.slug||'').toLowerCase();

    return t1.includes(k) || t2.includes(k) || te.includes(k) || tz.includes(k) || sg.includes(k);
  }

  // 判定是否免費（任一條件為真即視為免費）
  const isFreeItem = (item) =>
    item.free === true || item.is_free === true || FREE_SLUGS.includes(item.slug);

  // ---------- 渲染卡片 ----------
  function render(){
    grid.innerHTML = '';
    const list = ALL.filter(passFilter);

    list.forEach(item=>{
      const free = isFreeItem(item);

      // 顯示用標題（相容舊新）
      const titleEn = item.title || item.title_en || '';
      const titleZh = item.subtitle || item.title_zh || '';

      const el = document.createElement('article');
      el.className = 'card';

      const coverImg = item.cover
        ? `<img class="card-cover" src="${item.cover}" loading="lazy" onerror="this.style.display='none'">`
        : '';

      el.innerHTML = `
        <div class="card-cover-wrap" data-act="go" data-slug="${item.slug}" title="前往">
          ${coverImg}
          <span class="badge ${free ? 'free':'lock'}">${free ? '免費試看' : '需登入'}</span>
        </div>
        <div class="body">
          <div class="title">${titleEn}</div>
          <div class="meta">${titleZh} · ${(item.length||'').toUpperCase()}</div>
          <div class="foot">
            <a class="btn sm" data-act="go" data-slug="${item.slug}">前往 ▶</a>
            <a class="btn sm ghost" data-act="quiz" data-slug="${item.slug}">測驗</a>
          </div>
        </div>
      `;

      el.addEventListener('click', (e)=>{
        const act  = e.target?.dataset?.act;
        if(!act) return;
        const slug = e.target.dataset.slug;
        const user = window.fakeAuth?.getUser?.();
        const freeNow = FREE_SLUGS.includes(slug) || item.free === true || item.is_free === true;

        if(act==='go'){
          if(freeNow || user){
            location.href = `player.html?slug=${encodeURIComponent(slug)}`;
          }else{
            dlg.showModal();
          }
        }else if(act==='quiz'){
          // 如要鎖測驗，改成與 go 一樣的判斷
          location.href = `player.html?slug=${encodeURIComponent(slug)}&tab=quiz`;
        }
        e.preventDefault();
        e.stopPropagation();
      });

      grid.appendChild(el);
    });
  }

  // ---------- 搜尋 ----------
  q.addEventListener('input', ()=>{
    keyword = q.value.trim();
    render();
  });

  // ---------- 篩選 chips ----------
  $$('.chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.chip').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      filter = btn.dataset.filter;
      render();
    });
  });

  // ---------- 對話框 ----------
  $('#btnDlgClose').onclick = ()=> dlg.close();
  $('#btnGoLogin').onclick = ()=>{
    dlg.close();
    if (window.fakeAuth?.open) window.fakeAuth.open();
    else alert('這裡之後接 Supabase/OAuth 登入流程。');
  };

  // ---------- 登入列 UI ----------
  function refreshAuth(){
    const u = window.fakeAuth?.getUser?.();
    if(u){
      authName.textContent = `👤 ${u.name || u.email || '已登入'}`;
      btnLogout.style.display = 'inline-block';
      btnLogin.style.display  = 'none';
    }else{
      authName.textContent = '';
      btnLogout.style.display = 'none';
      btnLogin.style.display  = 'inline-block';
    }
  }
  btnLogin.onclick  = ()=> window.fakeAuth?.open ? window.fakeAuth.open() : alert('這裡之後接 Supabase/OAuth 登入流程。');
  btnLogout.onclick = ()=> { window.fakeAuth?.logout?.(); };

  window.addEventListener('fakeauth:change', refreshAuth);

  // ---------- 啟動 ----------
  loadIndex().catch(err=>{
    grid.innerHTML = `<div class="muted" style="grid-column:1/-1;padding:16px;border:1px solid var(--border);border-radius:12px;background:#0f1a33">讀取失敗：${err.message}</div>`;
  });
  refreshAuth();
})();
</script>
