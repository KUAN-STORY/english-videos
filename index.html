<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>çœ‹æ•…äº‹å­¸è‹±æ–‡ Â· Stories</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#15c37e; --warn:#f59e0b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 80px}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
  .title{font-size:28px;font-weight:800;letter-spacing:.02em}
  .actions{display:flex;gap:8px}
  .btn{padding:8px 14px;border:1px solid var(--border);background:#132046;color:#fff;border-radius:12px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .note{margin:14px 0 22px 0;color:var(--muted)}
  .bar{display:flex;gap:8px;margin:14px 0 22px 0}
  .input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1a33;color:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 12px;border:1px solid var(--border);background:#101b39;border-radius:999px;color:#c6d0ef;cursor:pointer}
  .chip.active{background:#18306b;color:#fff;border-color:#2d4ea7}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:640px){ .grid{grid-template-columns:1fr} }

  .card{display:flex;flex-direction:column;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .thumbBox{position:relative;height:210px;background:linear-gradient(160deg,#152548,#0b1324)}
  .thumb{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;top:10px;left:10px;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700}
  .badge.free{background:rgba(21,195,126,.15);color:#82f5c3;border:1px solid rgba(130,245,195,.4)}
  .badge.lock{background:rgba(245,158,11,.15);color:#ffd08a;border:1px solid rgba(245,158,11,.35)}
  .titleBox{padding:12px 14px 2px 14px;font-size:18px;font-weight:700}
  .meta{display:flex;align-items:center;justify-content:space-between;color:var(--muted);padding:0 14px 12px 14px}
  .linkRow{display:flex;gap:8px;padding:0 14px 14px 14px}
  .link{padding:7px 10px;border:1px solid var(--border);background:#12214a;color:#cfe3ff;border-radius:10px}

  .foot{margin-top:28px;color:#7a86a6}
  .small{font-size:12px;color:#8f9abc}

  /* ç™»å…¥å°è©±æ¡† */
  .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
  .modal{background:#0f1a33;border:1px solid var(--border);width:min(92vw,420px);border-radius:16px;padding:18px}
  .modal h3{margin:0 0 8px 0}
  .modal p{color:var(--muted);margin:0 0 14px 0}
  .modal .row{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ç”¨æ•…äº‹å­¸è‹±æ–‡ï¼šé›™èªå­—å¹•ã€æ¸¬é©—èˆ‡å–®å­—</div>
    <div class="actions">
      <button class="btn" id="btnLogin">ç™»å…¥</button>
      <a class="btn" href="https://github.com/kuan-story/english-videos" target="_blank" rel="noopener">GitHub</a>
    </div>
  </header>

  <div class="note">å¾ä¸‹æ–¹å¡ç‰‡é¸æ•…äº‹é–‹å§‹ã€‚å¤§å¤šæ•¸å…§å®¹éœ€ç™»å…¥å¾Œè§€çœ‹ï¼Œã€ˆä¸­ç§‹ç¯€ã€‰ç‚ºå…è²»è©¦çœ‹ã€‚</div>

  <div class="bar">
    <input id="kw" class="input" placeholder="è¼¸å…¥é—œéµå­—æœå°‹ï¼ˆä¸­/è‹±æ¨™é¡Œ/æ¨™ç±¤ï¼‰â€¦" />
    <div class="chips">
      <button class="chip active" data-filter="all">å…¨éƒ¨</button>
      <button class="chip" data-filter="short">çŸ­ç¯‡</button>
      <button class="chip" data-filter="long">é•·ç¯‡</button>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="foot small">Â© 2025 KUAN-STORY â€¢ Made for learning on GitHub Pages</div>
</div>

<!-- å‡ç™»å…¥å°è©±æ¡†ï¼ˆå…ˆæ“‹ä½ç›´æ¥è§€çœ‹ï¼Œæ—¥å¾Œå¯æ¥ Supabase/OAuthï¼‰ -->
<div id="mask" class="modalMask">
  <div class="modal">
    <h3>è«‹å…ˆç™»å…¥</h3>
    <p>æ­¤å…§å®¹åƒ…é™æœƒå“¡è§€çœ‹ã€‚æ‚¨å¯ä»¥å…ˆé€›é€›å…è²»å½±ç‰‡ã€ˆä¸­ç§‹ç¯€ã€‰ğŸ™‚</p>
    <div class="row">
      <button class="btn" id="btnClose">å–æ¶ˆ</button>
      <button class="btn" id="btnGoLogin">å»ç™»å…¥</button>
    </div>
  </div>
</div>

<script>
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];

let allItems = [];
let filterKind = 'all';
let kw = '';
let isLogin = false; // å‡ç™»å…¥æ——æ¨™ï¼ˆä¹‹å¾Œå¯æ”¹æ¥ Supabaseï¼‰

/* ç”Ÿæˆå¡ç‰‡ */
function render(items){
  const grid = $('#grid');
  grid.innerHTML = '';
  if(!items?.length){
    grid.innerHTML = '<div class="small" style="opacity:.75">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ•…äº‹ã€‚</div>';
    return;
  }
  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';

    const thumbBox = document.createElement('div');
    thumbBox.className = 'thumbBox';

    // badge
    const badge = document.createElement('div');
    badge.className = 'badge ' + (it.free?'free':'lock');
    badge.textContent = it.free ? 'å…è²»è©¦çœ‹' : 'éœ€ç™»å…¥';
    thumbBox.appendChild(badge);

    // åœ–
    const img = document.createElement('img');
    img.className = 'thumb';
    img.alt = it.title_en || it.title_zh || it.slug;
    // è‹¥ JSON æœ‰æä¾› poster å…ˆæ”¾ï¼Œé¿å…ç™½åœ–
    if(it.poster) img.src = it.poster;
    thumbBox.appendChild(img);

    card.appendChild(thumbBox);

    const title = document.createElement('div');
    title.className = 'titleBox';
    title.textContent = it.title_en || it.title_zh || it.slug;
    card.appendChild(title);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<span>${it.title_zh || ''}</span><span>${it.length || ''}</span>`;
    card.appendChild(meta);

    const links = document.createElement('div');
    links.className = 'linkRow';

    const aPlay = document.createElement('a');
    aPlay.className = 'link';
    aPlay.textContent = 'å‰å¾€ â–¶';
    aPlay.href = `player.html?slug=${encodeURIComponent(it.slug)}`;

    // éå…è²» â†’ æ””æˆªé»æ“Šé¡¯ç¤ºç™»å…¥
    aPlay.addEventListener('click', (ev)=>{
      if(!it.free && !isLogin){
        ev.preventDefault();
        openLogin();
      }
    });

    const aQuiz = document.createElement('a');
    aQuiz.className = 'link';
    aQuiz.textContent = 'æ¸¬é©—';
    aQuiz.href = `player.html?slug=${encodeURIComponent(it.slug)}#quiz`;
    // æ¸¬é©—åŒæ¨£åšé–€æª»
    aQuiz.addEventListener('click', (ev)=>{
      if(!it.free && !isLogin){
        ev.preventDefault();
        openLogin();
      }
    });

    links.appendChild(aPlay);
    links.appendChild(aQuiz);
    card.appendChild(links);

    grid.appendChild(card);

    // å˜—è©¦æ“·å–å½±ç‰‡ç¸®åœ–ï¼ˆç¬¬ 1 ç§’ï¼‰
    if(it.video){
      makeThumb(it.video, 1).then(url=>{
        if(url) img.src = url;
      }).catch(()=>{/* ignore */});
    }
  });
}

/* å¾å½±ç‰‡æ“·å–æŒ‡å®šç§’æ•¸çš„ç¸®åœ–ï¼ˆæ›´ç©©ç‰ˆæœ¬ï¼‰ */
function makeThumb(src, sec=1){
  return new Promise((resolve)=>{
    let done = false;
    const finish = (url)=>{ if(!done){ done=true; resolve(url||''); } };

    const v = document.createElement('video');
    v.crossOrigin = 'anonymous';        // ä¿éšª
    v.preload   = 'metadata';
    v.muted     = true;                 // æŸäº›ç€è¦½å™¨è¦éœéŸ³æ‰å…è¨± programmatic
    v.playsInline = true;
    v.src = src;

    const onError = ()=> finish('');
    v.onerror = onError;

    v.addEventListener('loadedmetadata', ()=>{
      // é¿å…è¶…å‡ºé•·åº¦
      let t = Math.max(0, Math.min(sec, (v.duration||sec) - 0.1));
      const seeked = ()=>{
        v.removeEventListener('seeked', seeked);
        try{
          const w = v.videoWidth || 640, h = v.videoHeight || 360;
          if(!w || !h) return finish('');
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(v, 0, 0, w, h);
          finish(canvas.toDataURL('image/jpeg', 0.8));
        }catch(e){ finish(''); }
      };
      v.addEventListener('seeked', seeked);
      try{ v.currentTime = t; }catch{ seeked(); } // æœ‰äº›ç’°å¢ƒä¸èƒ½ seek å°±ç›´æ¥ç•«ç¬¬ä¸€å¹€
    }, {once:true});

    // å¤šä¸€å€‹ canplay ä¿éšª
    v.addEventListener('canplay', ()=>{
      if(!done){
        try{
          const w = v.videoWidth || 640, h = v.videoHeight || 360;
          const c = document.createElement('canvas');
          c.width = w; c.height = h;
          c.getContext('2d').drawImage(v,0,0,w,h);
          finish(c.toDataURL('image/jpeg', .8));
        }catch{ finish(''); }
      }
    }, {once:true});

    // 3 ç§’é‚„æ²’æˆåŠŸå°±æ”¾æ£„
    setTimeout(()=>finish(''), 3000);
  });
}

/* æ¿¾å™¨ */
function applyFilter(){
  const words = kw.trim().toLowerCase();
  let list = allItems.filter(it=>{
    if(filterKind==='short' && it.length!=='çŸ­ç¯‡') return false;
    if(filterKind==='long'  && it.length!=='é•·ç¯‡') return false;
    if(!words) return true;
    const keys = [
      it.title_en||'', it.title_zh||'',
      (it.tags||[]).join(' ')
    ].join(' ').toLowerCase();
    return keys.includes(words);
  });
  render(list);
}

/* ç™»å…¥å°è©±æ¡†ï¼ˆç¤ºæ„ï¼‰ */
function openLogin(){ $('#mask').style.display = 'flex'; }
function closeLogin(){ $('#mask').style.display = 'none'; }
// å‡ç™»å…¥ï¼šé»ã€Œå»ç™»å…¥ã€å°±è¨­ç‚ºå·²ç™»å…¥
$('#btnGoLogin').onclick = ()=>{ isLogin = true; closeLogin(); alert('å·²æ¨¡æ“¬ç™»å…¥ï¼Œå¯é–‹å•Ÿä»˜è²»å…§å®¹ã€‚'); };
$('#btnClose').onclick   = closeLogin;
$('#btnLogin').onclick   = openLogin;

/* åˆå§‹åŒ– */
(async function(){
  try{
    const res = await fetch('data/index.json');
    const json = await res.json();
    // æœŸæœ›ï¼š
    // { items: [{slug,title_en,title_zh,video,poster,free,length,tags}] }
    allItems = (json.items||[]).map(it=>({
      ...it,
      poster: it.poster || '',           // å»ºè­°æä¾›æµ·å ±æª”åŠ é€Ÿé¡¯ç¤º
      free: !!it.free,                   // true=å…è²»è©¦çœ‹
      length: it.length || ''            // "çŸ­ç¯‡"/"é•·ç¯‡"
    }));
    applyFilter();
  }catch(e){
    $('#grid').innerHTML = `<div class="small">è®€å– <code>data/index.json</code> å¤±æ•—ã€‚</div>`;
  }

  // äº‹ä»¶
  $('#kw').addEventListener('input', (e)=>{ kw = e.target.value; applyFilter(); });
  $$('.chip').forEach(c=>{
    c.onclick = ()=>{
      $$('.chip').forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
      filterKind = c.dataset.filter;
      applyFilter();
    };
  });
})();
</script>
</body>
</html>
