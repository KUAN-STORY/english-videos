<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>看故事學英文 · Stories</title>

  <!-- 1) Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
  <!-- 2) 初始化 supa -->
  <script src="supa.js?v=2" defer></script>
  <!-- 3) 登入控制 -->
  <script src="login.js?v=2" defer></script>

  <style>
    body { background:#0b1324; color:#e7eaf3; font-family:sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; padding:14px 18px; background:#0f1a33; }
    .btn { padding:6px 12px; border:1px solid #203057; background:#15224a; color:#fff; border-radius:6px; cursor:pointer; }
    .cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; padding:20px; }
    .card { background:#16244f; border:1px solid #203057; border-radius:10px; overflow:hidden; }
    .card img { width:100%; height:150px; object-fit:cover; display:block; }
    .box { padding:12px; }
    .tag { font-size:12px; background:#203057; padding:2px 6px; border-radius:99px; margin-right:6px; }
    .muted { color:#a9b3cf; }
  </style>
</head>
<body>
  <header>
    <div>看故事學英文 · Stories</div>
    <div>
      <span id="whoami" class="muted"></span>
      <button id="btnLogin" class="btn">登入</button>
      <button id="btnLogout" class="btn" style="display:none">登出</button>
    </div>
  </header>

  <main>
    <h2 style="padding:0 20px">用故事學英文：雙語字幕、測驗與單字</h2>
    <div class="cards">
      <!-- 免費：Mid-Autumn -->
      <a class="card" href="player.html?slug=mid-autumn" data-requires-login="false">
        <img src="cover-mid.jpg" alt="Mid-Autumn">
        <div class="box"><span class="tag">免費</span> Mid-Autumn Festival <div class="muted">中秋節</div></div>
      </a>
      <!-- 需登入：Houyi -->
      <a class="card" href="player.html?slug=houyi" data-requires-login="true">
        <img src="cover-houyi.jpg" alt="Houyi">
        <div class="box"><span class="tag">需登入</span> Hou Yi Shoots the Suns <div class="muted">后羿射日</div></div>
      </a>
      <!-- 需登入：Lantern -->
      <a class="card" href="player.html?slug=lantern" data-requires-login="true">
        <img src="cover-lantern.jpg" alt="Lantern">
        <div class="box"><span class="tag">需登入</span> The Lantern Festival <div class="muted">元宵節</div></div>
      </a>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // 更新登入狀態
      async function refreshUI() {
        const { data:{ session } } = await supa.auth.getSession();
        document.getElementById("whoami").textContent = session?.user?.email || "";
        document.getElementById("btnLogin").style.display = session ? "none" : "inline-block";
        document.getElementById("btnLogout").style.display = session ? "inline-block" : "none";
      }

      document.getElementById("btnLogin").onclick = ()=>showLogin();
      document.getElementById("btnLogout").onclick = async ()=>{
        await supa.auth.signOut();
        refreshUI();
      };

      supa.auth.onAuthStateChange(()=>refreshUI());
      refreshUI();

      // 卡片點擊守門
      document.querySelectorAll(".card").forEach(card=>{
        card.addEventListener("click", async (e)=>{
          const needLogin = card.dataset.requiresLogin === "true";
          if(needLogin){
            const { data:{ session } } = await supa.auth.getSession();
            if(!session){
              e.preventDefault(); // 阻止進入 player
              showLogin();
            }
          }
        });
      });
    });
  </script>
</body>
</html>









