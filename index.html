<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>看故事學英文 · Stories</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="./login.js"></script>
</head>
<body>
  <header>
    <h1>看故事學英文·Stories</h1>
    <div>
      <span id="spanUser"></span>
      <button id="btnLogin">登入</button>
      <button id="btnLogout" style="display:none;">登出</button>
    </div>
  </header>

  <main>
    <h2>用故事學英文：雙語字幕、測驗與單字</h2>
    <div id="videos">
      <div class="video-card" data-slug="mid-autumn" data-public="true">
        <img src="covers/mid-autumn.jpg" alt="Mid-Autumn Festival">
        <h3>Mid-Autumn Festival</h3>
        <p>中秋節 · SHORT</p>
        <button class="btnPlay">前往</button>
      </div>

      <div class="video-card" data-slug="houyi" data-public="false">
        <img src="covers/houyi.jpg" alt="Hou Yi Shoots the Suns">
        <h3>Hou Yi Shoots the Suns</h3>
        <p>后羿射日 · SHORT</p>
        <button class="btnPlay">前往</button>
      </div>

      <div class="video-card" data-slug="lantern" data-public="false">
        <img src="covers/lantern.jpg" alt="Lantern Festival">
        <h3>Lantern Festival</h3>
        <p>元宵節 · SHORT</p>
        <button class="btnPlay">前往</button>
      </div>
    </div>
  </main>

  <!-- 登入提示框 -->
  <dialog id="dlgLogin">
    <p>請先登入<br>此內容僅限會員觀看 · 您可以先選擇免費影片（中秋節）</p>
    <menu>
      <button id="btnCancelLogin">取消</button>
      <button id="btnGoLogin">去登入</button>
    </menu>
  </dialog>

  <script type="module">
    import { getUser } from './supa.js';

    const dlg = document.getElementById('dlgLogin');
    const btnCancel = document.getElementById('btnCancelLogin');
    const btnGoLogin = document.getElementById('btnGoLogin');

    btnCancel.addEventListener('click', () => dlg.close());

    btnGoLogin.addEventListener('click', () => {
      dlg.close();
      setTimeout(() => {
        if (window.showLoginPrompt) {
          window.showLoginPrompt();
        } else {
          const b = document.getElementById('btnLogin');
          if (b) b.click();
        }
      }, 50);
    });

    document.querySelectorAll('.btnPlay').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.video-card');
        const slug = card.dataset.slug;
        const isPublic = card.dataset.public === 'true';
        const user = await getUser();

        if (!isPublic && !user) {
          dlg.showModal();
          return;
        }

        // 進入影片播放器
        location.href = `./player.html?slug=${slug}`;
      });
    });
  </script>
</body>
</html>
