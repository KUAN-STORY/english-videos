<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>çœ‹æ•…äº‹å­¸è‹±æ–‡ Â· Stories</title>
<meta name="description" content="Bilingual story videos with subtitles, quizzes and vocabulary."/>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --muted:#a9b3cf; --text:#e7eaf3;
    --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524; --border:#203057;
    --danger:#ef4444;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Noto Sans,sans-serif}
  a{color:inherit;text-decoration:none}

  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:rgba(11,19,36,.9);backdrop-filter: blur(6px);
    border-bottom:1px solid var(--border)}
  .nav{display:flex;align-items:center;gap:12px;padding:12px 0}
  .brand{font-weight:800;letter-spacing:.5px}
  .brand .dot{color:var(--brand)}
  .nav-spacer{flex:1}
  .btn{border:1px solid var(--border);background:#15224a;color:#fff;border-radius:10px;
    padding:8px 12px;cursor:pointer}
  .btn:hover{filter:brightness(1.12)}
  .btn-ghost{background:transparent}
  .btn-brand{background:var(--brand);border-color:#2a62de}
  .btn-danger{background:var(--danger);border-color:#d93434}
  .hero{display:grid;grid-template-columns: 1.2fr .8fr;gap:18px;align-items:center;padding:18px 0}
  .hero h1{margin:0 0 8px 0;font-size: clamp(22px,3.6vw,34px)}
  .muted{color:var(--muted)}
  .tool{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .search{flex:1;min-width:220px;background:#0e1a35;border:1px solid var(--border);color:var(--text);
    border-radius:12px;padding:10px 12px;outline:none}

  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{color:#fff;background:#1a2c66;border-color:#2d4ea7}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:18px 0 40px}
  @media (max-width:880px){ .hero{grid-template-columns:1fr} .grid{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }

  .card{display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;position:relative}
  .thumb{aspect-ratio:16/9;background:#000;display:flex;align-items:center;justify-content:center;position:relative}
  .thumb img,.thumb video{width:100%;height:100%;object-fit:cover}
  .lock{
    position:absolute;top:10px;left:10px;background:rgba(12,18,34,.75);
    border:1px solid var(--border);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px
  }
  .free{background:rgba(20,184,110,.2);border-color:rgba(20,184,110,.5)}
  .card-body{padding:12px}
  .title{font-weight:700;margin:0 0 4px}
  .sub{font-size:13px;color:var(--muted);margin:0 0 10px}
  .row{display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;color:#fff;background:#1a2c66;border:1px solid #2d4ea7;border-radius:999px;padding:4px 8px}
  .go{margin-left:auto}
  .empty{color:var(--muted);text-align:center;padding:28px;border:1px dashed var(--border);border-radius:14px}

  footer{border-top:1px solid var(--border);padding:18px 0;color:var(--muted)}

  /* Modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
  .modal{width:min(92vw,420px);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
  .modal h3{margin:0 0 10px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .input{background:#0e1a35;border:1px solid var(--border);color:#fff;border-radius:10px;padding:10px 12px}
  .row-between{display:flex;gap:10px;justify-content:space-between;align-items:center}
</style>
</head>
<body>

<header>
  <div class="wrap nav">
    <div class="brand">çœ‹æ•…äº‹å­¸è‹±æ–‡<span class="dot">â€¢</span>Stories</div>
    <div class="nav-spacer"></div>
    <button id="btnLogin" class="btn btn-ghost">ç™»å…¥</button>
    <button id="btnLogout" class="btn btn-danger" style="display:none">ç™»å‡º</button>
    <a class="btn btn-brand" href="https://github.com/kuan-story/english-videos" target="_blank" rel="noopener">GitHub</a>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <div>
      <h1>ç”¨æ•…äº‹å­¸è‹±æ–‡ï¼šé›™èªå­—å¹•ã€æ¸¬é©—èˆ‡å–®å­—</h1>
      <p class="muted">å¾ä¸‹æ–¹ç‰‡å–®ä¸­é¸æ“‡æ•…äº‹é–‹å§‹ã€‚å¤§å¤šæ•¸å…§å®¹é ˆç™»å…¥å¾Œè§€çœ‹ï¼Œ<b>ã€ˆä¸­ç§‹ç¯€ã€‰ç‚ºå…è²»è©¦çœ‹</b>ã€‚</p>
      <div class="tool" style="margin-top:12px">
        <input id="kw" class="search" placeholder="è¼¸å…¥é—œéµå­—æœå°‹ï¼ˆä¸­ / è‹±æ¨™é¡Œ / æ¨™ç±¤ï¼‰â€¦" />
        <div class="chips" id="tagChips"><div class="chip active" data-tag="*">å…¨éƒ¨</div></div>
      </div>
    </div>
    <div class="empty" id="statBox">
      ğŸŒŸ ç›®å‰å·²æ”¶éŒ„ <span id="count">0</span> å€‹æ•…äº‹ã€‚<br/>æ”¯æ´æ‰‹æ©Ÿèˆ‡æ¡Œæ©Ÿè§€çœ‹ã€‚
    </div>
  </section>

  <section>
    <div class="grid" id="grid"></div>
    <div id="empty" class="empty" style="display:none">æ²’æœ‰ç¬¦åˆçš„çµæœã€‚</div>
  </section>
</main>

<footer>
  <div class="wrap row">
    <div>Â© 2025 KUAN-STORY</div>
    <div class="nav-spacer"></div>
    <div class="muted">Made for learning â€¢ GitHub Pages</div>
  </div>
</footer>

<!-- Login Modal -->
<div id="modalBg" class="modal-bg" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row-between">
      <h3>ç™»å…¥å¸³è™Ÿ</h3>
      <button id="btnClose" class="btn btn-ghost">âœ•</button>
    </div>
    <p class="muted" id="gateMsg" style="margin:4px 0 10px 0">ç™»å…¥å¾Œå¯è§€çœ‹å…¨éƒ¨å½±ç‰‡ã€‚</p>
    <div class="field">
      <label>Email</label>
      <input id="email" type="email" class="input" placeholder="you@example.com"/>
    </div>
    <div class="field">
      <label>å¯†ç¢¼</label>
      <input id="pwd" type="password" class="input" placeholder="è‡³å°‘ 6 ç¢¼"/>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="doLogin" class="btn btn-brand" style="flex:1">ç™»å…¥ï¼ˆç¤ºç¯„ï¼‰</button>
      <button id="doSignup" class="btn" style="flex:1">è¨»å†Šï¼ˆç¤ºç¯„ï¼‰</button>
    </div>
    <p class="muted" style="margin-top:10px;font-size:13px">
      â€» ç›®å‰å…ˆç”¨ç¤ºç¯„ç™»å…¥ï¼ˆlocalStorageï¼‰ã€‚æœªä¾†å¯æ›æˆ Supabase Authã€‚
    </p>
  </div>
</div>

<script>
/* ============ å°å·¥å…· ============ */
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const escapeHtml = (s='')=> s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* Login ç‹€æ…‹ï¼ˆç¤ºç¯„ï¼šlocalStorageï¼‰ */
const auth = {
  get logged(){ return localStorage.getItem('logged')==='1'; },
  login(){ localStorage.setItem('logged','1'); uiAuth(); },
  logout(){ localStorage.removeItem('logged'); uiAuth(); },
};
function uiAuth(){
  $('#btnLogin').style.display = auth.logged ? 'none' : 'inline-block';
  $('#btnLogout').style.display = auth.logged ? 'inline-block' : 'none';
}

/* ============ è¼‰å…¥æ¸…å–® ============ */
let allItems = [];   // åŸå§‹
let userTag = '*';   // ç•¶å‰æ¨™ç±¤ç¯©é¸
let kw = '';         // æœå°‹å­—

async function loadList(){
  try{
    const res = await fetch('data/index.json');
    const json = await res.json();
    allItems = (json.items||[]).map(x=>({
      slug: x.slug,
      title_en: x.title_en || x.title || '',
      title_zh: x.title_zh || '',
      video: x.video,
      cues: x.cues,
      quiz: x.quiz,
      cover: x.cover || '',          // å¯åŠ å°é¢è·¯å¾‘
      tags:  x.tags  || [],          // å¯åŠ æ¨™ç±¤é™£åˆ—
      free:  !!x.free                // å…è²»å½±ç‰‡
    }));

    // æŒ‰æ¨™ç±¤ç”Ÿæˆ chips
    const tagSet = new Set();
    allItems.forEach(it => (it.tags||[]).forEach(t=> tagSet.add(t)));
    const tagChips = $('#tagChips');
    tagChips.innerHTML = '<div class="chip active" data-tag="*">å…¨éƒ¨</div>' +
      [...tagSet].map(t=>`<div class="chip" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</div>`).join('');

    $('#count').textContent = allItems.length;
    render();
  }catch(e){
    $('#grid').innerHTML = '<div class="empty">è®€å– <code>data/index.json</code> å¤±æ•—ã€‚</div>';
    console.error(e);
  }
}

function filterItems(){
  const needle = kw.toLowerCase();
  return allItems.filter(it=>{
    // æ–‡å­—éæ¿¾
    const text = (it.title_en+' '+it.title_zh+' '+(it.tags||[]).join(' ')).toLowerCase();
    const passKw = !needle || text.includes(needle);
    // æ¨™ç±¤éæ¿¾
    const passTag = (userTag==='*') || (it.tags||[]).includes(userTag);
    return passKw && passTag;
  });
}

function coverOf(it){
  if (it.cover) return it.cover;
  // æ²’å°é¢å°±ç”¨æ–‡å­—ä½”ä½
  const label = encodeURIComponent((it.title_en||'Story').replace(/\s+/g,'+'));
  return `https://dummyimage.com/640x360/0b1324/ffffff&text=${label}`;
}

function render(){
  const list = filterItems();
  const grid = $('#grid');
  grid.innerHTML = '';

  if(!list.length){ $('#empty').style.display='block'; return; }
  $('#empty').style.display='none';

  list.forEach(it=>{
    const a = document.createElement('a');
    a.className = 'card';
    a.href = `player.html?slug=${encodeURIComponent(it.slug)}`;

    const isFree = it.free || it.slug === 'mid-autumn'; // ã€ˆä¸­ç§‹ç¯€ã€‰æ°¸é å…è²»
    const locked = !auth.logged && !isFree;

    a.innerHTML = `
      <div class="thumb">
        <img src="${coverOf(it)}" alt="cover"/>
        <div class="lock ${isFree?'free':''}">
          ${ isFree ? 'å…è²»è©¦çœ‹' : 'éœ€ç™»å…¥' }
        </div>
      </div>
      <div class="card-body">
        <p class="title">${escapeHtml(it.title_en)}</p>
        <p class="sub">${escapeHtml(it.title_zh||'')}</p>
        <div class="row">
          ${(it.tags||[]).slice(0,3).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join('')}
          ${it.quiz?'<span class="pill">æ¸¬é©—</span>':''}
          <span class="nav-spacer"></span>
          <span class="muted">å‰å¾€ â–¶</span>
        </div>
      </div>
    `;

    if(locked){
      // æœªç™»å…¥ & éå…è²»ï¼šæ””æˆªï¼Œæ”¹ç‚ºé–‹ç™»å…¥æç¤º
      a.addEventListener('click', (ev)=>{
        ev.preventDefault();
        $('#gateMsg').textContent = `ã€Œ${it.title_zh||it.title_en}ã€ç‚ºæœƒå“¡å…§å®¹ï¼Œè«‹å…ˆç™»å…¥ã€‚`;
        modalOpen();
      });
    }

    grid.appendChild(a);
  });
}

/* ============ äº‹ä»¶ ============ */
$('#kw').addEventListener('input', e=>{ kw = e.target.value.trim(); render(); });
$('#tagChips').addEventListener('click', e=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  $$('.chip','#tagChips').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  userTag = chip.dataset.tag;
  render();
});

/* Modalï¼ˆç¤ºç¯„ç™»å…¥ï¼‰ */
const modalBg = $('#modalBg');
function modalOpen(){ modalBg.style.display='flex'; }
function modalClose(){ modalBg.style.display='none'; }
$('#btnLogin').onclick = ()=>{ $('#gateMsg').textContent='ç™»å…¥å¾Œå¯è§€çœ‹å…¨éƒ¨å½±ç‰‡ã€‚'; modalOpen(); };
$('#btnClose').onclick = modalClose;
modalBg.addEventListener('click', e=>{ if(e.target===modalBg) modalClose(); });
$('#doLogin').onclick = ()=>{ auth.login(); modalClose(); render(); };
$('#doSignup').onclick = ()=>{ auth.login(); modalClose(); render(); };
$('#btnLogout').onclick = ()=>{ auth.logout(); render(); };

/* å•Ÿå‹• */
uiAuth();
loadList();
</script>
</body>
</html>
