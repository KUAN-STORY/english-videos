<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>看故事學英文 · Stories</title>
<link rel="preconnect" href="https://esm.sh">
<style>
  :root{--bg:#0b1324;--panel:#0f1a33;--text:#e7eaf3;--muted:#a9b3cf;--brand:#3c7cff;--border:#213257}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  .wrap{max-width:1180px;margin:0 auto;padding:28px 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .title{font-size:28px;font-weight:800}
  .btn{background:#14224a;border:1px solid var(--border);color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .hint{color:var(--muted);margin:6px 0 18px}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media (max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:680px){.cards{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{position:relative;aspect-ratio:16/9;background:#000}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;left:10px;top:10px;background:#0a8e41;border-radius:999px;padding:6px 9px;font-size:12px}
  .badge.lock{background:#5c4d19}
  .meta{padding:14px}
  .meta h3{margin:0 0 4px;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;margin-top:12px}
  .ghost{background:transparent}
  .pill{border-radius:999px}
  .modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:10}
  .dialog{background:var(--panel);border:1px solid var(--border);max-width:520px;padding:18px;border-radius:12px}
  input[type="email"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#09112a;color:#fff}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">用故事學英文：雙語字幕、測驗與單字</div>
    <div>
      <button id="btnGithub" class="btn ghost" onclick="window.open('https://github.com/KUAN-STORY/english-videos','_blank')">GitHub</button>
      <button id="btnAuth" class="btn">登入</button>
    </div>
  </header>
  <p class="hint">從下方卡片選擇故事開始。大多數內容需登入後觀看，〈<b>中秋節</b>〉為免費試看。</p>

  <div id="cards" class="cards"></div>
</div>

<!-- 登入對話 -->
<div id="loginModal" class="modal">
  <div class="dialog">
    <h3 style="margin:0 0 10px">登入</h3>
    <p class="muted" style="margin-top:0">輸入 Email 收取一次性驗證連結（Magic Link）。</p>
    <input id="email" type="email" placeholder="you@example.com"/>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="btnSend">寄送登入連結</button>
      <button class="btn ghost" id="btnCancel">取消</button>
    </div>
  </div>
</div>

<script type="module">
  import { supa, getUser, signInWithEmail, signOut } from './js/supa.js'

  const FREE_SLUG = 'mid-autumn' // 免費試看
  const $ = (s,r=document)=>r.querySelector(s)
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)]

  const btnAuth = $('#btnAuth')
  const cardsBox = $('#cards')
  const loginModal = $('#loginModal')
  const btnSend = $('#btnSend')
  const btnCancel = $('#btnCancel')

  const user = await getUser()
  refreshAuthUI(user)

  // Navbar login/logout
  btnAuth.onclick = async ()=>{
    const u = await getUser()
    if (u){ await signOut(); location.reload() }
    else { loginModal.style.display='grid' }
  }

  btnCancel.onclick = ()=> loginModal.style.display='none'
  btnSend.onclick = async ()=>{
    const email = $('#email').value.trim()
    if(!email) return alert('請輸入 Email')
    const { error } = await signInWithEmail(email)
    if (error) alert(error.message)
    else {
      alert('已寄送登入連結，請到信箱點擊連結完成登入。')
      loginModal.style.display='none'
    }
  }

  // build cards
  async function loadIndex(){
    const res = await fetch('./data/index.json')
    const j = await res.json()
    renderCards(j.items || [])
  }
  loadIndex()

  function renderCards(items){
    cardsBox.innerHTML = ''
    items.forEach(it=>{
      const lock = it.slug !== FREE_SLUG
      const el = document.createElement('div')
      el.className = 'card'
      el.innerHTML = `
        <div class="thumb">
          <img src="${it.cover || './videos/mid-autumn.jpg'}" alt="">
          <span class="badge ${lock?'lock':''}">${lock?'需登入':'免費試看'}</span>
        </div>
        <div class="meta">
          <h3>${it.title_en}</h3>
          <div class="muted">${it.title_zh} · ${it.length || 'SHORT'}</div>
          <div class="actions">
            <button class="btn pill ghost" data-act="quiz" data-slug="${it.slug}">測驗</button>
            <button class="btn pill" data-act="go" data-slug="${it.slug}">前往 ▶</button>
          </div>
        </div>`
      cardsBox.appendChild(el)
    })

    cardsBox.addEventListener('click',async e=>{
      const b=e.target.closest('button'); if(!b) return
      const slug=b.dataset.slug, act=b.dataset.act
      if (slug!==FREE_SLUG){ // gate
        const u = await getUser()
        if(!u){ alert('此內容僅限會員觀看。您可以先逛逛免費影片〈中秋節〉'); return }
      }
      if(act==='go') location.href = `./player.html?slug=${encodeURIComponent(slug)}`
      if(act==='quiz') location.href = `./player.html?slug=${encodeURIComponent(slug)}#quiz`
    },{once:true})
  }

  function refreshAuthUI(user){
    btnAuth.textContent = user? '登出' : '登入'
  }

  // auth state changed
  supa.auth.onAuthStateChange((_e,session)=>refreshAuthUI(session?.user||null))
</script>
</body>
</html>
