<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>用故事學英文：雙語字幕、測驗與單字</title>
  <style>
    body{margin:0;background:#0c1424;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang TC,Heiti TC,Noto Sans TC,Arial;}
    .wrap{max-width:1200px;margin:40px auto;padding:0 20px;}
    h1{font-size:28px;margin:0 0 8px}
    .bar{display:flex;gap:12px;justify-content:flex-end;margin:16px 0}
    .btn{padding:8px 14px;border-radius:10px;background:#1e2a44;color:#e6eefc;border:1px solid #2d3b5d;cursor:pointer}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));margin-top:18px}
    .card{background:#0f1a2f;border:1px solid #223055;border-radius:16px;overflow:hidden}
    .thumb{aspect-ratio:16/9;background:#0a1120;display:block;width:100%;object-fit:cover}
    .tag{position:absolute;top:10px;left:10px;background:#0b6; padding:4px 8px;border-radius:999px;font-size:12px}
    .need{background:#a66}
    .ct{padding:14px}
    .title{font-weight:700;font-size:18px;margin:4px 0}
    .meta{opacity:.75;font-size:13px}
    .row{display:flex;gap:10px;margin-top:10px}
    a.btn{text-decoration:none;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>用故事學英文：雙語字幕、測驗與單字</h1>
    <p>從下方卡片選擇故事開始。大多數內容需登入後觀看，〈中秋節〉為免費試看。</p>

    <div class="bar">
      <button id="btnGithub" class="btn" onclick="window.open('https://github.com/kuan-story/english-videos','_blank')">GitHub</button>
      <button id="btnAuth" class="btn">登入</button>
    </div>

    <div id="cards" class="grid"></div>
  </div>

  <!-- 主腳本：使用 module -->
  <script type="module">
    import { supa } from './js/supa.js';

    // 產出相對路徑
    const url = (p) => new URL(p, location.origin + location.pathname.replace(/\/[^/]*$/, '/')).toString();
    const INDEX_URL = url('data/index.json');

    const btnAuth = document.getElementById('btnAuth');
    async function refreshAuthBtn(){
      const { data:{ user } } = await supa.auth.getUser();
      btnAuth.textContent = user ? '登出' : '登入';
    }
    refreshAuthBtn();

    btnAuth.addEventListener('click', async () => {
      const { data:{ user } } = await supa.auth.getUser();
      if (user) {
        await supa.auth.signOut();
      } else {
        // 使用魔術連結（Email），你也可改成 OAuth
        const email = prompt('請輸入 Email 收信登入：');
        if (email) {
          const { error } = await supa.auth.signInWithOtp({ email });
          if (error) alert(error.message);
          else alert('已寄送魔術連結，請到信箱點擊登入。');
        }
      }
      refreshAuthBtn();
    });

    // 載入影片清單
    async function loadIndex(){
      const res = await fetch(`${INDEX_URL}?v=${Date.now()}`);
      if (!res.ok) throw new Error('無法讀取 data/index.json');
      const list = await res.json();
      render(list.items || []);
    }

    function render(items){
      const el = document.getElementById('cards');
      el.innerHTML = items.map(item => cardHTML(item)).join('');
    }

    function cardHTML(it){
      const cover = `./videos/${(it.video||'').split('/').pop().replace('.mp4','.jpg')}`;
      const needLogin = it.slug !== 'mid-autumn';
      return `
        <div class="card">
          <div style="position:relative">
            <img class="thumb" src="./videos/${it.slug}.jpg" onerror="this.src='${cover}'" alt="">
            ${needLogin ? `<span class="tag need">需登入</span>` : `<span class="tag">免費試看</span>`}
          </div>
          <div class="ct">
            <div class="title">${it.title_en}</div>
            <div class="meta">${it.title_zh} · ${ (it.length||'').toUpperCase?.() || 'SHORT' }</div>
            <div class="row">
              <a class="btn" href="./player.html?slug=${it.slug}">前往 ▶</a>
              <a class="btn" href="./player.html?slug=${it.slug}#quiz">測驗</a>
            </div>
          </div>
        </div>
      `;
    }

    loadIndex().catch(err=>{
      console.error(err);
      document.getElementById('cards').innerHTML = `<div class="card"><div class="ct">讀取清單失敗：${err.message}</div></div>`;
    });
  </script>
</body>
</html>
