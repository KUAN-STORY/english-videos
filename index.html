<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>看故事學英文 · Stories</title>
  <style>
    :root{
      --bg:#0b1324; --card:#0f1a33; --muted:#a9b3cf; --text:#e7eaf3;
      --border:#203057; --brand:#3c7cff; --ok:#12b886; --warn:#f5a524;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 16px 56px;}
    h1{font-size:28px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .topbar{display:flex;gap:10px;align-items:center;margin:16px 0 22px}
    .search{flex:1;display:flex;align-items:center;background:#0d1730;border:1px solid var(--border);
      border-radius:12px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:0;color:#fff;outline:0;font-size:15px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#122147;color:#fff;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:16/9;background:#000;position:relative;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;left:10px;top:10px;padding:4px 8px;background:#16244f;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .badge.free{background:rgba(18,184,134,.15);border-color:#1c7a62;color:#a6f4d0}
    .body{padding:12px 12px 14px}
    .title{font-weight:700;margin:0 0 4px}
    .meta{color:var(--muted);font-size:14px;margin-bottom:10px}
    .actions{display:flex;gap:8px;margin-top:auto}
    .actions .btn.primary{background:#1b3a83;border-color:#2d4ea7}
    .lock{position:absolute;inset:0;background:linear-gradient(180deg,transparent,rgba(11,19,36,.86));
      display:none;align-items:flex-end;justify-content:center;padding:12px}
    .lock .pill{padding:8px 10px;border:1px dashed #446; background:#0c1734;border-radius:10px}
    .card[aria-locked="true"] .lock{display:flex}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>看故事學英文 · Stories</h1>
    <p class="lead">從下方卡片選擇故事開始。〈中秋節〉為免費試看；其餘內容需登入。</p>

    <div class="topbar">
      <div class="search">
        <input id="q" type="search" placeholder="輸入關鍵字搜尋（中／英標題／標籤）…">
        <button class="btn" id="btnCheck">檢查登入中…</button>
      </div>
      <button class="btn" id="btnAuth">登入</button>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <!-- 1) 先載入 UMD 版 Supabase（一定要先） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- 2) 建立全域 supa 實例（你的 supabase URL/KEY 在 supa.js 裡） -->
  <script src="supa.js"></script>
  <!-- 3) 登入彈窗 / 狀態監聽（會用到 supa） -->
  <script src="login.js"></script>

  <!-- 4) 本頁主程式 -->
  <script>
  (()=>{

    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
    const FREE_SLUGS = new Set(['mid-autumn']); // 免費試看清單（可自行擴充）

    // 顯示登入狀態
    async function refreshAuthUI() {
      const { data: { session } } = await supa.auth.getSession();
      $('#btnAuth').textContent = session ? '登出' : '登入';
      $('#btnCheck').textContent = session ? '已登入' : '尚未登入';
    }

    // 登入／登出按鈕
    $('#btnAuth').onclick = async()=>{
      const { data: { session } } = await supa.auth.getSession();
      if(session){
        await supa.auth.signOut();
      }else{
        if(typeof showLogin==='function'){ showLogin(); }
        else{
          const { error } = await supa.auth.signInWithOAuth({ provider:'google' });
          if(error) alert(error.message);
        }
      }
      refreshAuthUI();
    };

    // 監聽狀態變更
    supa.auth.onAuthStateChange(()=> refreshAuthUI());

    // 載入資料
    let allItems = [];
    async function loadData(){
      const url = 'data/index.json?v=' + Date.now();
      const res = await fetch(url);
      if(!res.ok) throw new Error('index.json 載入失敗');
      const json = await res.json();
      allItems = json.items || [];
      renderCards(allItems);
    }

    // 渲染卡片
    function renderCards(list){
      const g = $('#grid'); g.innerHTML = '';
      list.forEach(item=>{
        const locked = !FREE_SLUGS.has(item.slug);
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-slug', item.slug);
        card.setAttribute('aria-locked', locked ? 'true':'false');

        card.innerHTML = `
          <div class="thumb">
            <img loading="lazy" src="${item.cover}" alt="${item.title_en}">
            <div class="badge ${FREE_SLUGS.has(item.slug)?'free':''}">
              ${FREE_SLUGS.has(item.slug)?'免費試看':'會員限定'}
            </div>
            <div class="lock"><div class="pill">登入後可觀看</div></div>
          </div>
          <div class="body">
            <div class="title">${item.title_en}</div>
            <div class="meta">${item.title_zh} · ${item.length||'SHORT'}</div>
            <div class="actions">
              <button class="btn primary" data-act="watch">前往</button>
              <button class="btn" data-act="quiz">測驗</button>
            </div>
          </div>
        `;

        card.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button[data-act]');
          if(!btn) return;
          const act = btn.dataset.act;
          const slug = item.slug;

          // 權限檢查
          const needLogin = !FREE_SLUGS.has(slug);
          if(needLogin){
            const { data:{ session } } = await supa.auth.getSession();
            if(!session){
              if(typeof showLogin==='function'){ showLogin(); }
              else{
                const { error } = await supa.auth.signInWithOAuth({ provider:'google' });
                if(error) alert(error.message);
              }
              return;
            }
          }

          // 導向
          if(act==='watch'){
            location.href = `player.html?slug=${encodeURIComponent(slug)}`;
          }else if(act==='quiz'){
            location.href = `player.html?slug=${encodeURIComponent(slug)}&tab=quiz`;
          }
        });

        g.appendChild(card);
      });
    }

    // 搜尋
    $('#q').addEventListener('input', ()=>{
      const q = $('#q').value.trim().toLowerCase();
      const list = !q ? allItems : allItems.filter(it=>{
        return (it.title_en||'').toLowerCase().includes(q) ||
               (it.title_zh||'').toLowerCase().includes(q) ||
               (it.tags||[]).join(',').toLowerCase().includes(q);
      });
      renderCards(list);
    });

    // 初始化
    (async()=>{
      await refreshAuthUI().catch(console.error);
      await loadData().catch(err=>{
        console.error(err);
        $('#grid').innerHTML = `<div style="color:#f66">載入失敗：${err.message}</div>`;
      });
    })();
  })();
  </script>
</body>
</html>







