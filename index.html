<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>看故事學英文 · Stories</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#15c37e; --warn:#f59e0b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 80px}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
  .title{font-size:28px;font-weight:800;letter-spacing:.02em}
  .actions{display:flex;gap:8px}
  .btn{padding:8px 14px;border:1px solid var(--border);background:#132046;color:#fff;border-radius:12px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .note{margin:14px 0 22px 0;color:var(--muted)}
  .bar{display:flex;gap:8px;margin:14px 0 22px 0}
  .input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1a33;color:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 12px;border:1px solid var(--border);background:#101b39;border-radius:999px;color:#c6d0ef;cursor:pointer}
  .chip.active{background:#18306b;color:#fff;border-color:#2d4ea7}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:640px){ .grid{grid-template-columns:1fr} }

  .card{display:flex;flex-direction:column;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .thumbBox{position:relative;height:210px;background:linear-gradient(160deg,#152548,#0b1324)}
  .thumb{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;top:10px;left:10px;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700}
  .badge.free{background:rgba(21,195,126,.15);color:#82f5c3;border:1px solid rgba(130,245,195,.4)}
  .badge.lock{background:rgba(245,158,11,.15);color:#ffd08a;border:1px solid rgba(245,158,11,.35)}
  .titleBox{padding:12px 14px 2px 14px;font-size:18px;font-weight:700}
  .meta{display:flex;align-items:center;justify-content:space-between;color:var(--muted);padding:0 14px 12px 14px}
  .linkRow{display:flex;gap:8px;padding:0 14px 14px 14px}
  .link{padding:7px 10px;border:1px solid var(--border);background:#12214a;color:#cfe3ff;border-radius:10px}
  .foot{margin-top:28px;color:#7a86a6}
  .small{font-size:12px;color:#8f9abc}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">用故事學英文：雙語字幕、測驗與單字</div>
    <div class="actions">
      <button class="btn" onclick="alert('登入功能稍後開放')">登入</button>
      <a class="btn" href="https://github.com/kuan-story/english-videos" target="_blank" rel="noopener">GitHub</a>
    </div>
  </header>

  <div class="note">從下方卡片選故事開始。大多數內容需登入後觀看，〈中秋節〉為免費試看。</div>

  <div class="bar">
    <input id="kw" class="input" placeholder="輸入關鍵字搜尋（中/英標題/標籤）…" />
    <div class="chips">
      <button class="chip active" data-filter="all">全部</button>
      <button class="chip" data-filter="short">短篇</button>
      <button class="chip" data-filter="long">長篇</button>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="foot small">© 2025 KUAN-STORY • Made for learning on GitHub Pages</div>
</div>

<script>
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
let allItems = [];
let filterKind = 'all';
let kw = '';

/* 生成卡片：包含影片擷取縮圖 */
function render(items){
  const grid = $('#grid');
  grid.innerHTML = '';
  if(!items?.length){
    grid.innerHTML = '<div class="small" style="opacity:.75">找不到符合條件的故事。</div>';
    return;
  }
  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';

    const thumbBox = document.createElement('div');
    thumbBox.className = 'thumbBox';

    // badge
    const badge = document.createElement('div');
    badge.className = 'badge ' + (it.free?'free':'lock');
    badge.textContent = it.free ? '免費試看' : '需登入';
    thumbBox.appendChild(badge);

    // 預留 <img> 做為縮圖容器
    const img = document.createElement('img');
    img.className = 'thumb';
    img.alt = it.title_en || it.title_zh || it.slug;

    // 1) 先用 poster（若 JSON 提供），避免白圖
    if(it.poster){ img.src = it.poster; }

    thumbBox.appendChild(img);
    card.appendChild(thumbBox);

    // 標題
    const title = document.createElement('div');
    title.className = 'titleBox';
    title.textContent = it.title_en || it.title_zh || it.slug;
    card.appendChild(title);

    // 類別 / 長短
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<span>${it.title_zh || ''}</span><span>${it.length || ''}</span>`;
    card.appendChild(meta);

    // 連結列
    const links = document.createElement('div');
    links.className = 'linkRow';
    const a1 = document.createElement('a');
    a1.className = 'link';
    a1.textContent = '前往 ▶';
    a1.href = `player.html?slug=${encodeURIComponent(it.slug)}`;
    const a2 = document.createElement('a');
    a2.className = 'link';
    a2.textContent = '測驗';
    a2.href = `player.html?slug=${encodeURIComponent(it.slug)}#quiz`;
    links.appendChild(a1);
    links.appendChild(a2);
    card.appendChild(links);

    grid.appendChild(card);

    // 2) 嘗試從影片擷取縮圖（1 秒）
    //    與頁面同網域的 mp4 可直接擷取，不會有 CORS。
    if(it.video){
      makeThumb(it.video, 1).then(url=>{
        if(url) img.src = url;
      }).catch(()=>{/*ignore*/});
    }
  });
}

/* 從影片擷取指定秒數的縮圖（回傳 dataURL）*/
async function makeThumb(src, sec=1){
  return new Promise((resolve)=>{
    const v = document.createElement('video');
    v.crossOrigin = 'anonymous';       // 同網域可不寫，保險起見保留
    v.preload = 'metadata';
    v.src = src;

    // 有些瀏覽器需靜音才能 programmatic play
    v.muted = true;

    const onError = ()=> resolve('');
    v.onerror = onError;

    v.addEventListener('loadeddata', ()=>{
      const go = ()=>{
        try{
          const w = v.videoWidth || 640, h = v.videoHeight || 360;
          if(!w || !h) return resolve('');
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(v, 0, 0, w, h);
          const url = canvas.toDataURL('image/jpeg', 0.8);
          resolve(url);
        }catch(e){ resolve(''); }
      };
      // 嘗試定位到指定秒數
      if(sec && !isNaN(sec)){
        const seeked = ()=>{
          v.removeEventListener('seeked', seeked);
          go();
        };
        v.addEventListener('seeked', seeked);
        try{ v.currentTime = sec; }catch{ go(); }
      }else{
        go();
      }
    }, {once:true});
  });
}

/* 搜尋 + 篩選 */
function applyFilter(){
  const words = kw.trim().toLowerCase();
  let list = allItems.filter(it=>{
    if(filterKind==='short' && it.length!=='短篇') return false;
    if(filterKind==='long'  && it.length!=='長篇') return false;
    if(!words) return true;
    const keys = [
      it.title_en||'', it.title_zh||'',
      (it.tags||[]).join(' ')
    ].join(' ').toLowerCase();
    return keys.includes(words);
  });
  render(list);
}

/* 初始化 */
(async function(){
  try{
    const res = await fetch('data/index.json');
    const json = await res.json();
    // 期望結構示例：
    // { items: [{slug,title_en,title_zh,video,poster,free,tags:["中秋節"],length:"短篇"}] }
    allItems = (json.items||[]).map(it=>({
      ...it,
      poster: it.poster || '',          // optional
      free: !!it.free,                  // bool
      length: it.length || ''           // "短篇"/"長篇"
    }));
    applyFilter();
  }catch(e){
    $('#grid').innerHTML = `<div class="small">讀取 <code>data/index.json</code> 失敗。</div>`;
  }

  // 事件
  $('#kw').addEventListener('input', (e)=>{ kw = e.target.value; applyFilter(); });
  $$('.chip').forEach(c=>{
    c.onclick = ()=>{
      $$('.chip').forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
      filterKind = c.dataset.filter;
      applyFilter();
    };
  });
})();
</script>
</body>
</html>
