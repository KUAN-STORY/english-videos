<script>
/* ----------------------------------------------------
   index.html å…¥å£ JS  â€” 2025-09 V7.2+free-fix
   - FREE_SLUGS ç™½åå–® + ç›¸å®¹ data.index.json çš„ free æ¬„ä½
   - å°é¢/å‰å¾€/æ¸¬é©— é»æ“Šè¡Œç‚º
---------------------------------------------------- */
(() => {
  const $  = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> [...r.querySelectorAll(s)];

  // æœªç™»å…¥ä¹Ÿå¯çœ‹ç™½åå–®ï¼ˆä¿éšªï¼Œèˆ‡ data.index.json çš„ free ä¸¦ç”¨ï¼‰
  const FREE_SLUGS = ['mid-autumn'];

  const grid = $('#grid');
  const dlg  = $('#dlgLogin');
  const stat = $('#stat');
  const q    = $('#q');

  const authName = $('#authName');
  const btnLogin = $('#btnLogin');
  const btnLogout= $('#btnLogout');

  let ALL = [];
  let filter = 'all';
  let keyword = '';

  // ---------- è®€æ¸…å–® ----------
  async function loadIndex(){
    const res = await fetch('data/index.json', {cache:'no-store'});
    if(!res.ok) throw new Error('è®€å– data/index.json å¤±æ•—');
    const meta = await res.json();
    ALL = meta.items || [];
    stat.textContent = `å·²æ”¶éŒ„ ${ALL.length} å€‹æ•…äº‹`;
    render();
  }

  // ---------- ç¯©é¸ ----------
  function passFilter(x){
    if(filter !== 'all' && (x.length||'').toLowerCase() !== filter) return false;
    if(!keyword) return true;
    const k = keyword.toLowerCase();

    // åŒæ™‚æ”¯æ´ title/subtitle èˆŠæ–°æ¬„ä½
    const t1 = (x.title||'').toLowerCase();
    const t2 = (x.subtitle||'').toLowerCase();
    const te = (x.title_en||'').toLowerCase();
    const tz = (x.title_zh||'').toLowerCase();
    const sg = (x.slug||'').toLowerCase();

    return t1.includes(k) || t2.includes(k) || te.includes(k) || tz.includes(k) || sg.includes(k);
  }

  // åˆ¤å®šæ˜¯å¦å…è²»ï¼ˆä»»ä¸€æ¢ä»¶ç‚ºçœŸå³è¦–ç‚ºå…è²»ï¼‰
  const isFreeItem = (item) =>
    item.free === true || item.is_free === true || FREE_SLUGS.includes(item.slug);

  // ---------- æ¸²æŸ“å¡ç‰‡ ----------
  function render(){
    grid.innerHTML = '';
    const list = ALL.filter(passFilter);

    list.forEach(item=>{
      const free = isFreeItem(item);

      // é¡¯ç¤ºç”¨æ¨™é¡Œï¼ˆç›¸å®¹èˆŠæ–°ï¼‰
      const titleEn = item.title || item.title_en || '';
      const titleZh = item.subtitle || item.title_zh || '';

      const el = document.createElement('article');
      el.className = 'card';

      const coverImg = item.cover
        ? `<img class="card-cover" src="${item.cover}" loading="lazy" onerror="this.style.display='none'">`
        : '';

      el.innerHTML = `
        <div class="card-cover-wrap" data-act="go" data-slug="${item.slug}" title="å‰å¾€">
          ${coverImg}
          <span class="badge ${free ? 'free':'lock'}">${free ? 'å…è²»è©¦çœ‹' : 'éœ€ç™»å…¥'}</span>
        </div>
        <div class="body">
          <div class="title">${titleEn}</div>
          <div class="meta">${titleZh} Â· ${(item.length||'').toUpperCase()}</div>
          <div class="foot">
            <a class="btn sm" data-act="go" data-slug="${item.slug}">å‰å¾€ â–¶</a>
            <a class="btn sm ghost" data-act="quiz" data-slug="${item.slug}">æ¸¬é©—</a>
          </div>
        </div>
      `;

      el.addEventListener('click', (e)=>{
        const act  = e.target?.dataset?.act;
        if(!act) return;
        const slug = e.target.dataset.slug;
        const user = window.fakeAuth?.getUser?.();
        const freeNow = FREE_SLUGS.includes(slug) || item.free === true || item.is_free === true;

        if(act==='go'){
          if(freeNow || user){
            location.href = `player.html?slug=${encodeURIComponent(slug)}`;
          }else{
            dlg.showModal();
          }
        }else if(act==='quiz'){
          // å¦‚è¦é–æ¸¬é©—ï¼Œæ”¹æˆèˆ‡ go ä¸€æ¨£çš„åˆ¤æ–·
          location.href = `player.html?slug=${encodeURIComponent(slug)}&tab=quiz`;
        }
        e.preventDefault();
        e.stopPropagation();
      });

      grid.appendChild(el);
    });
  }

  // ---------- æœå°‹ ----------
  q.addEventListener('input', ()=>{
    keyword = q.value.trim();
    render();
  });

  // ---------- ç¯©é¸ chips ----------
  $$('.chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.chip').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      filter = btn.dataset.filter;
      render();
    });
  });

  // ---------- å°è©±æ¡† ----------
  $('#btnDlgClose').onclick = ()=> dlg.close();
  $('#btnGoLogin').onclick = ()=>{
    dlg.close();
    if (window.fakeAuth?.open) window.fakeAuth.open();
    else alert('é€™è£¡ä¹‹å¾Œæ¥ Supabase/OAuth ç™»å…¥æµç¨‹ã€‚');
  };

  // ---------- ç™»å…¥åˆ— UI ----------
  function refreshAuth(){
    const u = window.fakeAuth?.getUser?.();
    if(u){
      authName.textContent = `ğŸ‘¤ ${u.name || u.email || 'å·²ç™»å…¥'}`;
      btnLogout.style.display = 'inline-block';
      btnLogin.style.display  = 'none';
    }else{
      authName.textContent = '';
      btnLogout.style.display = 'none';
      btnLogin.style.display  = 'inline-block';
    }
  }
  btnLogin.onclick  = ()=> window.fakeAuth?.open ? window.fakeAuth.open() : alert('é€™è£¡ä¹‹å¾Œæ¥ Supabase/OAuth ç™»å…¥æµç¨‹ã€‚');
  btnLogout.onclick = ()=> { window.fakeAuth?.logout?.(); };

  window.addEventListener('fakeauth:change', refreshAuth);

  // ---------- å•Ÿå‹• ----------
  loadIndex().catch(err=>{
    grid.innerHTML = `<div class="muted" style="grid-column:1/-1;padding:16px;border:1px solid var(--border);border-radius:12px;background:#0f1a33">è®€å–å¤±æ•—ï¼š${err.message}</div>`;
  });
  refreshAuth();
})();
</script>
