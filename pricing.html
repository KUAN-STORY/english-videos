<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜方案與定價</title>
  <meta name="description" content="BookWide：故事、音樂、電影、新聞、專業行業等英語學習主題，支援字幕對照、小測驗與學習追蹤。" />
  <style>
    :root{
      --bg:#0b1324; --ink:#eaf1ff; --muted:#8a96b6; --panel:#0f1732; --badge:#1a2a4a;
      --brand:#5b86fa; --ok:#34c759;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0 0 8px 0;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(5,minmax(190px,1fr));gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px;
      padding:18px; display:flex; flex-direction:column; gap:10px; min-height:340px;
    }
    .card h3{margin:0 0 6px 0}
    .price{font-size:26px;margin:4px 0 8px 0}
    .features{margin:0;padding:0 0 0 18px;color:var(--muted);line-height:1.6}
    .pick{display:flex;align-items:center;gap:8px;margin-top:auto}
    .pick input{transform:scale(1.2)}
    .period{
      margin:22px 0 10px; padding:14px; background:var(--panel);
      border:1px solid rgba(255,255,255,.08); border-radius:12px;
    }
    .period label{display:inline-flex;align-items:center;margin-right:14px;gap:6px}
    .sumbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 16px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:var(--panel)
    }
    .btn{
      padding:12px 18px;border-radius:10px;background:var(--brand);color:#fff;border:1px solid rgba(255,255,255,.12);
      cursor:pointer
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BookWide</h1>
      <a class="pill" href="./index.html">回首頁</a>
    </header>

    <p class="muted">每個主題定價皆為 <b>NT$200 / 月</b>；你可以一次勾選多個主題，單一筆訂單一起結帳。</p>

    <!-- 五張方案卡 -->
    <section class="grid" id="planGrid">
      <!-- 卡片由 JS 依 PLANS 產生 -->
    </section>

    <!-- 方案週期 -->
    <section class="period" id="periodBox">
      <div style="margin-bottom:6px;">選擇方案週期：</div>
      <label><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
      <label><input type="radio" name="period" value="halfyear"> 半年 NT$960 / 主題</label>
      <label><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>
    </section>

    <!-- 合計 / 結帳 -->
    <section class="sumbar">
      <div>
        <span id="chosenCount">0</span> 個主題，週期 <span id="periodText">月繳</span>，
        合計 <b id="totalText">NT$0</b>
      </div>
      <button id="checkoutBtn" class="btn" disabled>前往結帳</button>
    </section>

    <p class="muted" style="margin-top:12px;font-size:13px">
      結帳採用綠界金流（ECPay），所有勾選主題會合併成<strong>一筆</strong>訂單付款；付款成功後，系統會將你的帳號開通各勾選主題的存取權。
    </p>
  </div>

  <script>
    // ===== 方案與價目 =====
    const PLANS = [
      { id:'story', name:'故事 Story', features:['分級故事影片與字幕','單字／文法／閱讀測驗','可列印成績單'] },
      { id:'music', name:'音樂 Music', features:['歌曲影片、歌詞雙語字幕','關鍵用語小測驗','收藏精選歌曲'] },
      { id:'movie', name:'電影 Movie', features:['電影片段學英文','情境會話／片語重點','主題測驗可列印'] },
      { id:'news',  name:'新聞 News', features:['國際新聞精讀','重點單字／時事測驗','每週更新'] },
      { id:'pro',    name:'專業行業 Professional', features:['商務／科技／設計等領域','商務情境對話','術語與案例剖析'] }
    ];
    const PRICES = { month:200, halfyear:960, year:1680 };
    const PERIOD_LABEL = { month:'月繳', halfyear:'半年', year:'年繳' };

    // ===== 動態產卡片 =====
    const grid = document.getElementById('planGrid');
    grid.innerHTML = PLANS.map(p => `
      <article class="card" data-plan="${p.id}">
        <h3>${p.name}</h3>
        <div class="price">NT$200 / 月</div>
        <ul class="features">
          ${p.features.map(t => `<li>${t}</li>`).join('')}
        </ul>
        <label class="pick"><input type="checkbox" class="pickbox" data-id="${p.id}"> 勾選這個主題</label>
      </article>
    `).join('');

    // ===== 狀態管理 =====
    let selected = new Set();
    let period = 'month';

    const chosenCount = document.getElementById('chosenCount');
    const totalText   = document.getElementById('totalText');
    const periodText  = document.getElementById('periodText');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function refreshSummary(){
      const unit = PRICES[period];
      const total = unit * selected.size;
      chosenCount.textContent = selected.size;
      periodText.textContent  = PERIOD_LABEL[period];
      totalText.textContent   = `NT$${total.toLocaleString()}`;
      checkoutBtn.disabled = selected.size === 0;
    }

    // 勾選事件
    grid.addEventListener('change', (e)=>{
      if(!e.target.matches('.pickbox')) return;
      const id = e.target.dataset.id;
      if(e.target.checked) selected.add(id); else selected.delete(id);
      refreshSummary();
    });

    // 週期事件
    document.getElementById('periodBox').addEventListener('change', (e)=>{
      if(e.target.name !== 'period') return;
      period = e.target.value;
      refreshSummary();
    });

    refreshSummary();

    // ===== 前往結帳（呼叫 Edge Function -> 綠界） =====
    checkoutBtn.addEventListener('click', async ()=>{
      if(selected.size === 0) return alert('請至少勾選一個主題');

      const unit = PRICES[period];
      const lineItems = [...selected].map(pid => ({
        product_id: pid,   // 後端可依此對應顯示名稱
        period,            // month / halfyear / year
        qty: 1,
        unit_price: unit
      }));

      // 可先顯示預覽
      const names = lineItems.map(li => li.product_id).join(', ');
      if(!confirm(`已勾選：${names}\n週期：${PERIOD_LABEL[period]}\n總金額：NT$${(unit*lineItems.length).toLocaleString()}\n\n是否前往付款？`)){
        return;
      }

      try{
        const resp = await fetch('https://qtgwedankftrqjmzuset.supabase.co/functions/v1/ecpay-checkout', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ lineItems })
        });
        const data = await resp.json();

        // 後端可回傳：{ payUrl } 或 { formHtml }（自動 submit）
        if(data && data.payUrl){
          location.href = data.payUrl;
        }else if(data && data.formHtml){
          const div = document.createElement('div');
          div.innerHTML = data.formHtml;
          document.body.appendChild(div);
          const f = document.getElementById('ecpay-form');
          if(f) f.submit(); else alert('未找到收銀台表單');
        }else{
          alert('建立收銀台失敗：' + JSON.stringify(data));
        }
      }catch(err){
        alert('錯誤：' + err.message);
      }
    });
  </script>
</body>
</html>
