<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>重設密碼 · BookWide</title>
  <style>
    :root{ --ink:#0a1020; --muted:#6b7280; --accent:#2563eb; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC";color:var(--ink);background:#f6f7fb}
    .wrap{max-width:520px;margin:8vh auto;padding:20px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .hd{padding:16px 18px;border-bottom:1px solid #eef1f6;font-weight:800}
    .bd{padding:18px}
    .row{display:flex;gap:8px;margin:10px 0;align-items:center}
    .ipt{width:100%;height:44px;border:1px solid #d4d9e3;border-radius:10px;padding:0 12px;font-size:15px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #d4d9e3;background:#0f172a;color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .msg{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd" id="title">重設密碼</div>
      <div class="bd">
        <div id="panel-request">
          <div class="muted">輸入你的 Email，我們會寄送一封重設密碼的連結給你。</div>
          <div class="row"><input id="email" type="email" class="ipt" placeholder="Email"></div>
          <div class="row"><button id="btnSend" class="btn">寄送重設連結</button></div>
          <div class="msg" id="msg1"></div>
        </div>

        <div id="panel-update" style="display:none">
          <div class="muted">請設定新的密碼。</div>
          <div class="row"><input id="pwd" type="password" class="ipt" placeholder="新密碼"></div>
          <div class="row"><input id="pwd2" type="password" class="ipt" placeholder="再次輸入新密碼"></div>
          <div class="row"><button id="btnUpdate" class="btn">更新密碼</button></div>
          <div class="msg" id="msg2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script type="module" src="./supa.js"></script>
  <script type="module">
    const supa = window.supa;
    const q = new URLSearchParams(location.hash.slice(1)); // Supabase recovery帶在 hash
    const hasToken = q.get('type')==='recovery' && q.get('access_token');

    const title = document.getElementById('title');
    const pReq = document.getElementById('panel-request');
    const pUpd = document.getElementById('panel-update');
    const msg1 = document.getElementById('msg1');
    const msg2 = document.getElementById('msg2');

    const redirect = new URL(location.search, location.href).searchParams.get('redirect') || (location.origin + '/english-videos/');

    function showMsg(el, t, ok=false){ el.style.color = ok?'#065f46':'#b91c1c'; el.textContent=t; }

    if (hasToken) {
      // 顯示更新密碼介面
      title.textContent = '設定新密碼';
      pReq.style.display='none'; pUpd.style.display='';
    }

    // 寄送重設連結
    document.getElementById('btnSend')?.addEventListener('click', async ()=>{
      msg1.textContent='';
      const email = (document.getElementById('email').value||'').trim();
      if(!email){ showMsg(msg1,'請輸入 Email'); return; }
      try{
        const { error } = await supa.auth.resetPasswordForEmail(email, {
          // 收到信後會回來 reset.html（帶 token）
          redirectTo: new URL('./reset.html', location.origin + location.pathname).toString()
        });
        if(error) return showMsg(msg1, error.message);
        showMsg(msg1,'已寄出重設連結（請查收信箱）', true);
      }catch(e){ showMsg(msg1, String(e)); }
    });

    // 更新密碼
    document.getElementById('btnUpdate')?.addEventListener('click', async ()=>{
      msg2.textContent='';
      const p1 = document.getElementById('pwd').value;
      const p2 = document.getElementById('pwd2').value;
      if(!p1 || !p2) return showMsg(msg2,'請輸入兩次新密碼');
      if(p1 !== p2) return showMsg(msg2,'兩次輸入不一致');

      try{
        const { data: { user }, error } = await supa.auth.updateUser({ password: p1 });
        if(error) return showMsg(msg2, error.message);
        showMsg(msg2,'已更新密碼，將返回首頁…', true);
        setTimeout(()=> location.href = redirect, 1200);
      }catch(e){ showMsg(msg2, String(e)); }
    });
  </script>
</body>
</html>
