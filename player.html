<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>英語影片播放器</title>
<style>
:root{ --bg:#0b1324; --panel:#0f172a; --ink:#e6efff; --accent:#3c7cff; --line:#1f2a44; --btn:#182543; --btnink:#e6efff; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif}
.container{max-width:1200px;margin:70px auto 32px;padding:0 16px;}
.topbar{position:fixed;inset:0 0 auto 0;height:56px;background:rgba(11,19,36,.85);backdrop-filter:blur(6px);display:flex;align-items:center;z-index:900}
.topbar h1{font-size:18px;margin-left:16px}
#authBtn{position:fixed;top:8px;right:12px;z-index:1102;border:0;background:#3161ff;color:#fff;border-radius:16px;padding:6px 12px;cursor:pointer}
#verTag{position:fixed;top:10px;right:96px;z-index:1101;background:#fff;color:#111;padding:4px 10px;border-radius:12px;font-size:12px}
@media (max-width:420px){ #verTag{ right:112px; } }
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
@media (max-width:960px){ .grid{grid-template-columns:1fr} }
.videoWrap{padding:14px}
video{width:100%;max-height:62vh;border-radius:10px;background:#000}
.controls{margin-top:10px;padding:12px;background:var(--panel);border:1px solid var(--line);border-radius:12px}
.controls .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:var(--btn);color:var(--btnink);border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:#3161ff;border-color:#3161ff}
.switch{display:flex;gap:8px;align-items:center}
.tabs{display:flex;gap:10px;padding:12px;background:var(--panel);border-bottom:1px solid var(--line)}
.tabbtn{border:1px solid var(--line);background:var(--btn);color:var(--btnink);border-radius:999px;padding:6px 14px;cursor:pointer}
.tabbtn.active{background:#234;box-shadow:inset 0 0 0 1px #2f4a88}
.tabpane{display:none;padding:12px}
.tabpane.active{display:block}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
.table th{text-align:left;color:#9fb2ff}
.enLine{font-size:16px}
.cnLine{font-size:14px;color:#b8c7ff;opacity:.85;margin-top:6px}
#authGateCover{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:1000}
#authGateCover.show{display:flex;align-items:center;justify-content:center}
#authGateCard{background:var(--panel);color:var(--ink);border-radius:14px;padding:20px 24px;width:min(480px,88vw);box-shadow:0 12px 40px rgba(0,0,0,.35)}
#authGateCard .row{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
.printBar{display:flex;gap:10px;justify-content:flex-end;margin:8px 0 0 0;}
.notice{color:#9fb2ff;font-size:12px;margin-left:8px}
</style>
</head>
<body>
<div class="topbar"><h1>英語影片播放器</h1></div>
<button id="authBtn" title="登入">登入</button>
<div id="verTag">{VERSION}</div>
<div class="container">
  <div class="grid">
    <div class="panel videoWrap">
      <video id="player" preload="metadata">
        <source src="" type="video/mp4">
      </video>
      <div class="controls">
        <div class="row">
          <button class="btn" id="btnPrev">上一句</button>
          <button class="btn" id="btnPlay">播放 / 暫停</button>
          <button class="btn" id="btnNext">下一句</button>
          <button class="btn" id="btnRepeat">重複本句</button>
          <label class="switch"><input type="checkbox" id="chkFollow"> 跟隨</label>
          <span class="notice">（未登入前已鎖定播放）</span>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="tabs">
        <button class="tabbtn active" data-tab="sub">字幕</button>
        <button class="tabbtn" data-tab="quiz">測驗</button>
        <button class="tabbtn" data-tab="vocab">單字</button>
      </div>
      <div class="printBar">
        <button id="btnPrintScore" class="btn">列印成績單</button>
      </div>
      <div id="tab-sub" class="tabpane active">
        <table class="table">
          <thead><tr><th style="width:72px">時間</th><th>英文 / 中文</th></tr></thead>
          <tbody id="subBody">
            <tr><td>00:01</td><td><div class="enLine">The Mid-Autumn Festival is on the fifteenth day of the eighth month in the Chinese calendar.</div><div class="cnLine">中秋節是在農曆八月十五日。</div></td></tr>
            <tr><td>00:06</td><td><div class="enLine">It is a time to look at the big round moon.</div><div class="cnLine">這是一個仰望又大又圓的月亮的時刻。</div></td></tr>
          </tbody>
        </table>
      </div>
      <div id="tab-quiz" class="tabpane">
        <div id="quizPanel">
          <h3>已載入（mid-autumn）‧ 共 3 題</h3>
          <ol>
            <li>People eat ___ during the Mid-Autumn Festival.
              <ul><li>dumplings</li><li><b>mooncakes</b> ✅</li><li>rice cakes</li></ul>
            </li>
          </ol>
          <p>本分區分數：<b>100 / 100</b></p>
        </div>
      </div>
      <div id="tab-vocab" class="tabpane">
        <ul><li><b>festival</b> / 節慶</li><li><b>lantern</b> / 燈籠</li><li><b>myth</b> / 神話</li></ul>
      </div>
    </div>
  </div>
</div>
<div id="authGateCover">
  <div id="authGateCard">
    <h3 style="margin:0 0 6px 0;">需要登入</h3>
    <p style="margin:0;">請先登入以繼續使用，您的學習記錄會安全地保存在雲端。</p>
    <div class="row">
      <button id="btnGateLater" class="btn">稍後</button>
      <button id="btnGateLogin" class="btn primary">以 Google 登入</button>
    </div>
  </div>
</div>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
const SUPABASE_URL = 'https://qtgwedankftrqjmzuset.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const gate = document.getElementById('authGateCover');
const btnGateLogin = document.getElementById('btnGateLogin');
const btnGateLater = document.getElementById('btnGateLater');
const authBtn = document.getElementById('authBtn');
const vid = document.getElementById('player');

function showGate(){ gate.classList.add('show'); }
function hideGate(){ gate.classList.remove('show'); }

function lockPlayer(lock=true){
  if(!vid) return;
  if(lock){ vid.pause(); vid.controls = false; vid.dataset.locked='1'; }
  else{ vid.controls = true; delete vid.dataset.locked; }
}

if (vid){
  const block = (e)=>{ if(!window.__authed){ e.preventDefault?.(); vid.pause(); showGate(); } };
  ['play','click','touchstart'].forEach(ev=>vid.addEventListener(ev, block, true));
}

btnGateLater?.addEventListener('click', ()=>{ showGate(); lockPlayer(true); });
btnGateLogin?.addEventListener('click', async ()=>{
  await supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
});
authBtn?.addEventListener('click', async ()=>{
  await supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
});

let wroteLog=false;
async function writeWatchLog(user){
  if(wroteLog||!user) return;
  wroteLog=true;
  const slug=new URL(location.href).searchParams.get('slug')||'unknown';
  try{ await supabase.from('watch_logs').insert({ user_id:user.id, email:user.email||null, video_slug:slug }); }
  catch(e){ console.warn('watch_logs insert failed:', e.message); }
}

(async function(){
  try{
    const { data: { user } } = await supabase.auth.getUser();
    window.__authed = !!user;
    if(window.__authed){ hideGate(); lockPlayer(false); writeWatchLog(user); }
    else{ showGate(); lockPlayer(true); }
    supabase.auth.onAuthStateChange((e, session)=>{
      window.__authed = !!session?.user;
      if(window.__authed){ hideGate(); lockPlayer(false); writeWatchLog(session.user); }
      else{ showGate(); lockPlayer(true); }
    });
  }catch(e){ console.error(e); showGate(); lockPlayer(true); }
})();

document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id='tab-'+btn.dataset.tab;
    document.querySelectorAll('.tabpane').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

(function(){
  const btn=document.querySelector('#btnPrintScore');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    const src=document.querySelector('#quizPanel')||document.body;
    const html=`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>測驗成績單</title>
    <style>@page{size:A4;margin:12mm}body{font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;color:#111;}
    h2{margin:0 0 10px 0}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px 8px;vertical-align:top}</style></head><body>
    <h2>BookWide ‧ 英語影片測驗成績單</h2>
    <div style="color:#666;margin:6px 0 16px 0;">匯出時間：{TIME}</div>
    ${src.outerHTML}
    </body></html>`;
    const iframe=document.createElement('iframe');
    Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'});
    document.body.appendChild(iframe);
    const idoc=iframe.contentWindow.document;
    idoc.open(); idoc.write(html); idoc.close();
    iframe.onload=()=>{ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('無法開啟列印視窗，請確認瀏覽器未封鎖快顯。'); }
      setTimeout(()=>document.body.removeChild(iframe),1200); };
  });
})();

document.getElementById('btnPlay')?.addEventListener('click', ()=> vid && (vid.paused?vid.play():vid.pause()));
</script>
</body>
</html>








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































