<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player (字幕三欄+測驗填空)</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}

  .layout{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh; }
  @media(max-width:1024px){ .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; } }

  .videoColumn{ display:grid; grid-template-rows: minmax(0, 1fr) auto; min-height:0;
    border-right:1px solid var(--border); }
  .videoStage{ min-height:0; display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden; }
  video{ max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; background:#000; transform-origin:center center; }

  .toolBar{ padding:10px 12px; background:#101b39; border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .btn,.chip{ border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:6px 10px; cursor:pointer; user-select:none; }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }
  .range{ vertical-align:middle; width:140px; margin-left:6px; }

  .side{ display:flex; flex-direction:column; min-height:0; background:var(--panel); }
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}

  /* 三欄字幕表 */
  table.subs{ width:100%; border-collapse:collapse; font-size:15px; }
  .subs th,.subs td{ padding:6px 8px; border-bottom:1px solid var(--border); vertical-align:top; }
  .subs th{ color:var(--muted); font-weight:600; }
  .subs tr.active{ background:#1a2c66; }
  .subs td.time{ color:var(--muted); width:70px; }

  /* 測驗 */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .fill{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:#15224a;color:#fff}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:12px}
</style>
</head>
<body>
<div class="layout">

  <!-- 左 -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlay">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>
      <button class="btn" id="btnRepeatOne">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnABClear">取消循環</button>
      <label class="chip">變焦<input id="zoom" class="range" type="range" min="1" max="2" step="0.05" value="1"></label>
      <label class="chip">速度<input id="rate" class="range" type="range" min="0.5" max="2" step="0.05" value="1">
        <span id="rateLabel" style="margin-left:6px">1.00×</span></label>
    </div>
  </section>

  <!-- 右 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <!-- 字幕 -->
    <div id="panelTranscript" class="panel">
      <input id="searchSub" type="text" placeholder="搜尋字幕..." style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;background:#15224a;color:#fff">
      <table class="subs">
        <thead><tr><th>時間</th><th>英文</th><th>中文</th></tr></thead>
        <tbody id="subsBody"></tbody>
      </table>
    </div>

    <!-- 測驗 -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="footBar">
        <div class="muted" id="quizProgress">0 / 0</div>
        <div>
          <button id="btnCheck" class="btn">交卷</button>
          <button id="btnRetry" class="btn" style="display:none">再試一次</button>
        </div>
      </div>
      <div id="quizResult" class="result"></div>
    </div>
  </aside>
</div>

<script>
const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const qs=new URLSearchParams(location.search);const slug=qs.get('slug')||'';
const toSec=t=>{const [m,s]=String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);return m*60+s;};

/* 載入 index.json */
async function loadMeta(){
  const res=await fetch('data/index.json');const meta=await res.json();
  return (meta.items||[]).find(x=>x.slug===slug)||meta.items?.[0];
}

/* 字幕 */
let cueList=[];
async function loadCues(path){const res=await fetch(path);return await res.json();}
function renderTranscript(data){
  const list=Array.isArray(data)?data:(data.items||[]);
  const body=$('#subsBody');body.innerHTML='';
  cueList=list.map(row=>{
    const t=row.time||row.t||'0:0';const en=row.text||row.en||'';const zh=row.zh||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="time">[${t}]</td><td>${en}</td><td>${zh}</td>`;
    tr.onclick=()=>{const sec=toSec(t);const v=$('#player');v.currentTime=sec;v.play();highlightByTime(sec);};
    body.appendChild(tr);
    return{tSec:toSec(t),tr};
  });
}
let lastActive=-1;
function highlightByTime(current){
  let idx=-1;for(let i=0;i<cueList.length;i++){if(cueList[i].tSec<=current)idx=i;else break;}
  if(idx===lastActive)return;lastActive=idx;
  $$('#subsBody tr').forEach(tr=>tr.classList.remove('active'));
  if(idx>=0){const tr=cueList[idx].tr;tr.classList.add('active');tr.scrollIntoView({block:'center',behavior:'smooth'});}
}
$('#searchSub').addEventListener('input',e=>{
  const kw=e.target.value.toLowerCase();
  cueList.forEach(c=>{
    const show=c.tr.textContent.toLowerCase().includes(kw);
    c.tr.style.display=show?'':'none';
  });
});

/* 測驗 */
async function loadQuiz(path){const res=await fetch(path);let arr=await res.json();
  arr=Array.isArray(arr)?arr:(arr.items||[]);return arr.slice(0,20).map((q,i)=>{
    const type=q.type|| (q.q?.includes('___')?'fill':'choice');
    return{q:q.q||q.question||`Q${i+1}`,opts:q.a||q.options||[],ans:q.answerIndex??q.correct??q.ans,type};
  });
}
function renderQuiz(questions){
  const box=$('#quizBox');box.innerHTML='';
  questions.forEach((q,i)=>{
    const wrap=document.createElement('div');wrap.className='q';
    wrap.innerHTML=`<h4>${i+1}. ${q.q}</h4>`;
    if(q.type==='fill'){wrap.innerHTML+=`<input class="fill" name="q${i}">`;}
    else{q.opts.forEach((opt,j)=>{wrap.innerHTML+=`<label class="opt"><input type="radio" name="q${i}" value="${j}"><span>${opt}</span></label>`;});}
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent=`0 / ${questions.length}`;
  box.addEventListener('input',()=>{
    let done=0;questions.forEach((q,i)=>{if(q.type==='fill'){if($(`input[name="q${i}"]`).value.trim())done++;}else{if($(`input[name="q${i}"]:checked`))done++;}});
    $('#quizProgress').textContent=`${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick=()=>{
    let correct=0;questions.forEach((q,i)=>{
      if(q.type==='fill'){const val=$(`input[name="q${i}"]`).value.trim().toLowerCase();
        const ans=Array.isArray(q.ans)?q.ans:[q.ans];if(ans.some(a=>String(a).toLowerCase()===val))correct++;}
      else{const pick=$(`input[name="q${i}"]:checked`);if(pick&&parseInt(pick.value)==q.ans)correct++;}});
    const ratio=Math.round(correct/questions.length*100);
    const res=$('#quizResult');res.style.display='block';res.className='result '+(ratio>=80?'pass':'fail');res.textContent=`分數 ${correct}/${questions.length} (${ratio}%)`;
    $('#btnRetry').style.display='inline-block';
  };
  $('#btnRetry').onclick=()=>renderQuiz(questions);
}

/* Tabs */
function setupTabs(){const t1=$('#tabTranscript'),p1=$('#panelTranscript'),t2=$('#tabQuiz'),p2=$('#panelQuiz');
  t1.onclick=()=>{t1.classList.add('active');t2.classList.remove('active');p1.style.display='block';p2.style.display='none';};
  t2.onclick=()=>{t2.classList.add('active');t1.classList.remove('active');p2.style.display='block';p1.style.display='none';};}

/* 左工具列 */
let A=null,B=null,abTimer=null;
function jumpPrev(){const t=$('#player').currentTime;const prev=[...cueList].reverse().find(c=>c.tSec<t-0.05);if(prev){$('#player').currentTime=prev.tSec;$('#player').play();}}
function jumpNext(){const t=$('#player').currentTime;const next=cueList.find(c=>c.tSec>t+0.05);if(next){$('#player').currentTime=next.tSec;$('#player').play();}}
function setRepeatOne(){const t=$('#player').currentTime;let i=cueList.findIndex((c,idx)=>c.tSec<=t&&(!cueList[idx+1]||cueList[idx+1].tSec>t));if(i<0)i=0;A=cueList[i].tSec;B=(cueList[i+1]?cueList[i+1].tSec:null);clearInterval(abTimer);abTimer=setInterval(()=>{const v=$('#player');if(B&&v.currentTime>=B)v.currentTime=A;},120);}
function setAB(){const v=$('#player');if(A==null){A=v.currentTime;alert('設定 A');}else if(B==null){B=v.currentTime;alert('設定 B');startAB();}else{A=v.currentTime;B=null;alert('重設 A');}}
function startAB(){clearInterval(abTimer);abTimer=setInterval(()=>{const v=$('#player');if(B&&v.currentTime>=B)v.currentTime=A;},120);}
function clearLoop(){A=null;B=null;clearInterval(abTimer);}
function bindLeftToolbar(){ $('#btnPrev').onclick=jumpPrev;$('#btnNext').onclick=jumpNext;$('#btnPlay').onclick=()=>{const v=$('#player');v.paused?v.play():v.pause();};$('#btnRepeatOne').onclick=setRepeatOne;$('#btnAB').onclick=setAB;$('#btnABClear').onclick=clearLoop;$('#rate').oninput=e=>{const v=$('#player');v.playbackRate=+e.target.value;$('#rateLabel').textContent=v.playbackRate.toFixed(2)+'×';};$('#zoom').oninput=e=>$('#player').style.transform=`scale(${+e.target.value})`;}

/* 啟動 */
(async()=>{
  setupTabs();bindLeftToolbar();
  const meta=await loadMeta();$('#player').src=meta.video;
  const cues=await loadCues(meta.cues);renderTranscript(cues);
  $('#player').addEventListener('timeupdate',()=>highlightByTime($('#player').currentTime));
  if(meta.quiz){const q=await loadQuiz(meta.quiz);renderQuiz(q);}else{$('#tabQuiz').style.display='none';}
})();
</script>
</body>
</html>
