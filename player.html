<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);height:100dvh;box-sizing:border-box}
  @media(max-width:1024px){ .layout{grid-template-columns:1fr} }

  /* 左側影片 */
  .videoWrap{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:#000;position:relative;overflow:hidden;padding:8px;box-sizing:border-box}
  video{width:100%;height:auto;max-height:calc(100dvh - 200px);object-fit:contain;background:#000;display:block}

  /* 工具列 */
  .toolBar{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
  .btn{padding:6px 10px;border:1px solid var(--border);background:#15224a;color:#fff;border-radius:8px;cursor:pointer;font-size:14px}
  .btn:hover{filter:brightness(1.2)}
  .sliderBox{display:flex;align-items:center;gap:6px;margin-left:10px}
  .sliderBox input{width:120px}

  /* 右側欄 */
  .side{display:flex;flex-direction:column;background:var(--panel);border-left:1px solid var(--border)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .chip{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}
  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .line{line-height:1.5;margin:8px 0}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:6px}
  .line:hover{background:#15224a;border-radius:8px;padding:4px}

  /* 測驗 */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}
</style>
</head>
<body>
<div class="layout">
  <!-- 左：影片 + 工具列 -->
  <div class="videoWrap">
    <video id="player" controls preload="metadata"></video>

    <!-- 學習工具列 -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlayPause">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>
      <button class="btn" id="btnRepeat">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnCancelAB">取消循環</button>
      <button class="btn" id="btnAutoPause">逐句自動暫停</button>
      <button class="btn" id="btnLoopAll">整段循環</button>
      <div class="sliderBox">
        <label>變焦</label><input type="range" id="zoomSlider" min="0.5" max="1.5" step="0.1" value="1">
      </div>
      <div class="sliderBox">
        <label>速度</label><input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
        <span id="speedLabel">1.0×</span>
      </div>
    </div>
  </div>

  <!-- 右：字幕/測驗 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>
    <div class="toolbar">
      <span class="muted">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
    </div>
    <div id="panelTranscript" class="panel"></div>
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div class="row">
            <button id="btnCheck" class="btn">交卷</button>
            <button id="btnRetry" class="btn" style="display:none">再試一次</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>
  </aside>
</div>

<script>
const $ = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';
let FONT='M', cues=[], abA=null, abB=null, autoPause=false;

/* 字級 */
function setFont(size){
  FONT=size; const map={S:'13px',M:'15px',L:'17px'};
  $$('#panelTranscript, #panelQuiz, .q').forEach(el=> el.style.fontSize=map[size]);
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* 載入 meta */
async function loadMeta(){
  const res=await fetch('data/index.json'); if(!res.ok) throw new Error('index.json 載入失敗');
  const meta=await res.json(); return (meta.items||[]).find(x=>x.slug===slug)||meta.items?.[0];
}
async function loadCues(path){const r=await fetch(path);return await r.json();}
function renderTranscript(data){
  cues = Array.isArray(data)?data:data.items||[];
  const box=$('#panelTranscript'); box.innerHTML='';
  cues.forEach((row,i)=>{
    const t=row.time||row.t||row.start||'', s=row.text||row.en||row.caption||'';
    const div=document.createElement('div'); div.className='line';
    div.innerHTML=`<span class="time">[${t}]</span>${s}`;
    div.onclick=()=>{const [m,ss]=t.split(':').map(n=>+n||0);$('#player').currentTime=m*60+ss;$('#player').play();}
    box.appendChild(div);
  });
}

/* 工具列功能 */
function setupTools(){
  const v=$('#player');
  $('#btnPlayPause').onclick=()=> v.paused?v.play():v.pause();
  $('#btnPrev').onclick=()=> jump(-1);
  $('#btnNext').onclick=()=> jump(1);
  $('#btnRepeat').onclick=()=> repeatCurrent();
  $('#btnAB').onclick=()=> setAB(v.currentTime);
  $('#btnCancelAB').onclick=()=>{abA=abB=null;};
  $('#btnAutoPause').onclick=()=> autoPause=!autoPause;
  $('#btnLoopAll').onclick=()=>{v.loop=!v.loop;}
  $('#zoomSlider').oninput=e=> v.style.transform=`scale(${e.target.value})`;
  $('#speedSlider').oninput=e=>{v.playbackRate=e.target.value;$('#speedLabel').textContent=parseFloat(e.target.value).toFixed(2)+'×';}

  v.ontimeupdate=()=>{
    if(abA!=null && abB!=null && v.currentTime>=abB) v.currentTime=abA;
  }
}
function jump(dir){
  const v=$('#player'); let t=v.currentTime;
  for(let i=0;i<cues.length;i++){
    const [m,s]= (cues[i].time||'0:0').split(':').map(n=>+n||0);
    const sec=m*60+s;
    if(sec>t && dir>0){v.currentTime=sec;return;}
    if(sec<t && dir<0){v.currentTime=sec;return;}
  }
}
function repeatCurrent(){
  const v=$('#player'); let t=v.currentTime;
  for(let i=cues.length-1;i>=0;i--){
    const [m,s]=(cues[i].time||'0:0').split(':').map(n=>+n||0);
    const sec=m*60+s; if(t>=sec){v.currentTime=sec;return;}
  }
}
function setAB(time){ if(abA==null) abA=time; else abB=time; }

/* 啟動 */
(async()=>{
  setFont('M');
  const meta=await loadMeta(); $('#player').src=meta.video;
  const cueData=await loadCues(meta.cues); renderTranscript(cueData);
  setupTools();
})();
</script>
</body>
</html>
