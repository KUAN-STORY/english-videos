!doctype html>
<html lang="zh-Hant">
  
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- player.html ç‰ˆæœ¬ï¼š2025.10.13 FocusMobile v2.2 -->
<!-- player.html ç‰ˆæœ¬ï¼š2025.10.13 FocusMobile v2.4 -->
<!-- player.html ç‰ˆæœ¬ï¼š2025.10.13 FocusMobile v2.5 -->
<!-- player.html ç‰ˆæœ¬ï¼š2025.10.13 FocusMobile v2.6 -->
<title>è‹±èªå½±ç‰‡æ’­æ”¾å™¨</title>
<!-- player.html ç‰ˆæœ¬ï¼š2025.10.13 V3.3-restore | è‡ªå‹•ç¿»è­¯/æ³¡æ³¡å›å¾©ç‰ˆ -->

<style>
  /* ===== æ‰‹æ©Ÿç›´å¼è‡ªå‹•ä¸Šä¸‹å †ç–Š ===== */
@media (max-width: 768px) and (orientation: portrait) {
  #mainWrap {
    flex-direction: column !important;
  }
  #leftPanel, #rightPanel {
    width: 100% !important;
    flex: none !important;
  }
}

  :root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6efff; --muted:#9fb0c9; --accent:#3c7cff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
  h1{font-size:20px;margin:0}
  .btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
  .btn.blue{background:#14335f;border-color:#2c5aa3}
  .muted{color:var(--muted)}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}

  .wrap{padding:16px;height:calc(100vh - 58px);}
  .layout{height:100%;display:flex;gap:16px;overflow:hidden}
  .left,.right{flex:1;min-width:0;background:var(--panel);border:1px solid #1f2a44;border-radius:12px}
  .left{display:flex;flex-direction:column;padding:14px}
  .right{display:flex;flex-direction:column}
  .pane{flex:1;overflow:auto}

  .videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
  .videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

  .controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
  .controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
  .speed{display:flex;align-items:center;gap:10px}
  input[type="range"]{width:260px;accent-color:var(--accent)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}

  .tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid #1f2a44}
  .tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:10px;padding:8px 12px}
  .tab.active{background:#154274}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
  tbody tr{background:#0f1f34}
  tbody tr:nth-child(2n){background:#0d1a2b}
  tbody tr:hover{background:#0f2a4e}
  tr.active{background:#173a6e}
  #pane-sub td:nth-child(2),#pane-sub td:nth-child(3){word-break:break-word;white-space:normal;line-height:1.6}

  .q-tabs{display:flex;gap:8px;flex-wrap:wrap}
  .q-tabs .qtab{background:#122340;border:1px solid #1f375f;border-radius:10px;padding:6px 12px;color:#e6efff;cursor:pointer}
  .q-tabs .qtab.on{background:#154274}

  .voc{border:1px solid #213a64;background:#0f223b;border-radius:12px;padding:12px;margin:10px 14px}
  .voc-h{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
  .voc-word{font-size:20px;font-weight:800}
  .voc-pos{opacity:.85}
  .voc-zh{color:#cfe2ff;margin-top:2px}
  .voc-en{color:#9fb0c9}
  .voc-actions{display:flex;gap:8px;margin-top:8px}

  /* ===== åˆ—å°æ¨£å¼ï¼ˆé—œéµè£œå¼·ï¼‰ ===== */
  @media print{
    html,body{ background:#fff !important; color:#000 !important; height:auto !important; }
    header,.tabs,.controls,#authArea,.drawer-grab{ display:none !important; }
    .wrap{ padding:0 !important; }
    .layout{ display:block !important; height:auto !important; overflow:visible !important; }
    .left{ display:none !important; }
    .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
    .pane, #pane-quiz, .quiz-shell, #quizList{
      height:auto !important; max-height:none !important; overflow:visible !important;
    }
    #pane-quiz{ display:block !important; }        /* åªå°æ¸¬é©— */
    #quizList{ font-size:12.5pt; line-height:1.25; }
    #quizList > li{
      break-inside:avoid; page-break-inside:avoid;     /* é¡Œç›®ä¸è¢«åˆ‡åŠ */
      padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc;
    }
    @page { margin:10mm 10mm 12mm 10mm; }           /* ç‰ˆé‚Š */
    #printHeader{ display:flex !important; }         /* é¡¯ç¤ºåˆ—å°é é¦– */
    #phScore{ font-size:22px; font-weight:900; }
  }
  /* åˆ—å°é é¦–ï¼ˆå¹³å¸¸éš±è—ã€åˆ—å°é¡¯ç¤ºï¼‰ */
  #printHeader{display:none; align-items:center; justify-content:space-between; padding:12px 8px 16px; margin:0 8px 8px; border-bottom:1px solid #ddd; color:#111; background:#fff;}
  #phLeft{display:flex;align-items:center;gap:10px}
  #phLogo{width:26px;height:26px}
  #phTitle{font-weight:800}
  #phMeta{font-size:12px;color:#444;margin-top:2px}
  #phRight{text-align:right}
  #phScore{font-size:24px;font-weight:900}
  #phFeedback{font-size:12px;color:#444}
</style>

<style>
/* === V3.3-restore additions (auto-translate bubble) === */
.wtoken{border-bottom:1.5px dotted #0b3b6f;cursor:help;text-underline-offset:2px}
#wordTip{position:fixed;z-index:99999;display:none;background:#fff;color:#111;
  border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px;box-shadow:0 10px 24px rgba(0,0,0,.15);
  font-size:14px;line-height:1.2;max-width:80vw}
</style>

<style>
/* ===== 2025.10.13 FocusMobile v2.2 ===== */
:root{ --badge-bg: rgba(15,23,42,.9); --badge-fg:#e6efff; --badge-bd: rgba(100,116,139,.5); }

/* å³ä¸Šç‰ˆæœ¬è§’æ¨™ï¼ˆä¹Ÿç”¨ä¾†å–ä»£ç™»å…¥ï¼‰ */
#verBadgeTop{
  position: fixed; top: 8px; right: 10px; z-index: 100000;
  background: var(--badge-bg); color: var(--badge-fg);
  padding: 4px 8px; border-radius: 8px; font-size: 12px;
  border: 1px solid var(--badge-bd);
}

@media (max-width: 860px) and (orientation: portrait) {
  /* ä¸Šä¸‹å †ç–Šï¼Œä¸å£“ç¸® */
  .layout{ display:flex; flex-direction:column !important; gap:12px; }
  .left,.right{ width:100% !important; max-width:100% !important; flex:none !important; min-width:0 !important; }
  .left video, .left iframe, .left .player, .left .video-wrapper{ max-width:100%; height:auto; }

  /* å­—å¹•è¡¨æ ¼é¿å…è‹±æ–‡å­—ç›´æ’ */
  #pane-sub table{ table-layout:auto !important; width:100%; }
  #pane-sub td, #pane-sub th{ white-space:normal !important; word-break:break-word; line-height:1.6; }

  /* å°ˆæ³¨æ¨¡å¼ï¼šå½±ç‰‡éš±è—ã€å…§å®¹å…¨å¯¬ï¼›é¡¯ç¤ºè¿”å›éµ */
  body.focus-mode .left{ display:none !important; }
  body.focus-mode .right{ width:100% !important; max-width:100% !important; }
  #btnExitFocus{ position:fixed; right:14px; bottom:18px; z-index: 100001;
    padding:.6rem .9rem; border-radius:12px; background:#2563eb; color:#fff; border:0;
    box-shadow: 0 10px 24px rgba(0,0,0,.18); display:none; }
  body.focus-mode #btnExitFocus{ display:inline-block; }

  /* å·¥å…·åˆ—é è¨­æ”¶åˆï¼ˆé¿å…é‡è¦†ï¼ŒJS æœƒæ‰¾å®¹å™¨åŠ ä¸Šé€™å€‹ classï¼‰ */
  .tools-collapsed{ max-height:0 !important; overflow:hidden !important; padding-top:0 !important; padding-bottom:0 !important; opacity:0; transition:max-height .25s ease, opacity .2s ease; }

  /* æˆ‘å€‘è‡ªå®¶çš„æŠŠæ‰‹ï¼ˆè‹¥é é¢å·²æœ‰ã€Œæ’­æ”¾å·¥å…·åˆ—ã€æŒ‰éˆ•ï¼ŒJS ä¸æœƒå†å»ºç«‹ï¼‰ */
  .tools-toggle{ display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .8rem;
    border:1px solid var(--badge-bd); background:var(--badge-bg); color:var(--badge-fg);
    border-radius:10px; font-size:.95rem; }
}
</style>

<style>
/* ===== 2025.10.13 FocusMobile v2.4 ===== */
:root{
  --badge-bg: rgba(15,23,42,.9);
  --badge-fg: #e6efff;
  --badge-bd: rgba(100,116,139,.5);
}
#verBadgeTop{
  position: fixed; top: 8px; right: 10px; z-index: 100000;
  background: var(--badge-bg); color: var(--badge-fg);
  padding: 4px 8px; border-radius: 8px; font-size: 12px;
  border: 1px solid var(--badge-bd);
}

@media (max-width: 860px) and (orientation: portrait){
  .layout{ display:flex; flex-direction:column !important; gap:12px; }
  .left,.right{ width:100% !important; max-width:100% !important; flex:none !important; min-width:0 !important; }
  .left video,.left iframe,.left .player,.left .video-wrapper{ max-width:100%; height:auto; }
  .mobile-tabs-bar{
    position: sticky; top: 8px; z-index: 10000;
    background: var(--panel1,#0f172a);
    border: 1px solid rgba(100,116,139,.4);
    border-radius: 12px; padding: 6px 8px; margin: 6px 0 8px 0;
    backdrop-filter: blur(2px);
  }
  body.focus-mode .left{ display:none !important; }
  body.focus-mode .right{ width:100% !important; max-width:100% !important; }
  #btnExitFocus{
    position:fixed; right:14px; bottom:18px; z-index:100001;
    padding:.6rem .9rem; border-radius:12px; background:#2563eb; color:#fff; border:0;
    box-shadow:0 10px 24px rgba(0,0,0,.18); display:none;
  }
  body.focus-mode #btnExitFocus{ display:inline-block; }
  .tools-collapsed{
    max-height:0 !important; overflow:hidden !important;
    padding-top:0 !important; padding-bottom:0 !important;
    opacity:0; transition:max-height .25s ease, opacity .2s ease;
  }
  .tools-toggle{
    display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .8rem;
    border:1px solid var(--badge-bd); background:var(--badge-bg); color:var(--badge-fg);
    border-radius:10px; font-size:.95rem;
  }
}
</style>

<style>
/* ===== 2025.10.13 FocusMobile v2.5 ===== */
@media (max-width: 860px) and (orientation: portrait){
  /* å›ºå®šé¡¯ç¤ºçš„å·¥å…·åˆ—æŠŠæ‰‹ï¼ˆè‹¥åŸç”Ÿæœ‰å°±ä¸å†é¡¯ç¤ºï¼‰ */
  #toolsToggleFixed{
    position: sticky; top: 8px; z-index: 10002;
    display: inline-flex; align-items: center; gap: .4rem;
    padding: .45rem .8rem; border-radius: 10px;
    border: 1px solid rgba(100,116,139,.5);
    background: rgba(15,23,42,.9); color: #e6efff;
    margin-bottom: 6px;
  }
  /* æ”¶åˆæ™‚é«˜åº¦ç‚º 0ï¼›å±•é–‹æ™‚å…è¨±é«˜åº¦è‡ªå‹• */
  .tools-collapsed{ max-height: 0 !important; overflow: hidden !important; opacity: 0; }
  .tools-expanded{ max-height: 1000px !important; overflow: visible !important; opacity: 1; transition: max-height .25s ease, opacity .2s ease; }
}
</style>

<style>
/* ===== 2025.10.13 FocusMobile v2.6 ===== */
@media (max-width: 860px) and (orientation: portrait){
  #btnPrintQuiz{
    position: sticky; top: 8px; right: 10px; z-index: 10003;
    float: right;
    margin: 0 0 8px 8px;
    padding: .45rem .7rem;
    border-radius: 10px; border: 1px solid rgba(100,116,139,.5);
    background: rgba(15,23,42,.9); color: #e6efff; font-size: .9rem;
  }
}

/* ---- Print rules: ä¿è­‰ 20 é¡Œå®Œæ•´åˆ—å° ---- */
@media print {
  /* ç™½åº•é»‘å­—ï¼Œç§»é™¤èƒŒæ™¯ */
  * { color: #000 !important; background: #fff !important; box-shadow: none !important; }
  html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  /* ç‰ˆé¢ï¼šåªå°å³æ¬„å…§å®¹ï¼ˆæ¸¬é©—ï¼‰ */
  .left, header, nav, .mobile-tabs-bar, #verBadgeTop, #toolsToggle, #toolsToggleFixed, #btnExitFocus { display: none !important; }
  .right { width: 100% !important; max-width: 100% !important; }
  /* å·¥å…·åˆ—ä¸å° */
  .tools, .controls, #toolbar, #playTools { display: none !important; }
  /* æ¸¬é©—å…§å®¹å…¨éƒ¨å±•é–‹å¯è¦‹ */
  #pane-quiz, [data-pane="quiz"], .quiz, .exam, .questions, .question-list { display: block !important; visibility: visible !important; height: auto !important; max-height: none !important; }
  /* é¿å… sticky / fixed é€ æˆè¦†è“‹ */
  * { position: static !important; }
  /* æ®µè½/é¡Œçµ„æ›é å‹å–„ */
  .question, .q { break-inside: avoid-page; page-break-inside: avoid; margin-bottom: 10px; }
  .section, .part { page-break-before: auto; }
  /* é€£çµæ¨£å¼ */
  a::after { content: ""; }
}
</style>

<style>
/* ===== 2025.10.13 FocusMobile v2.7 â€” Mobile horizontal swipe pager ===== */
@media (max-width: 860px) and (orientation: portrait){
  /* Use the existing .layout as the pager track */
  .layout{
    flex-direction: row !important;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .left, .right{
    flex: 0 0 100% !important;
    max-width: 100% !important;
    scroll-snap-align: start;
  }
  /* Neutralize old focus-mode (we will slide instead of hiding the video) */
  body.focus-mode .left{ display:block !important; }
  body.focus-mode .right{ width:100% !important; max-width:100% !important; }
  #btnExitFocus{ position: fixed; right: 14px; bottom: 18px; z-index: 100001; }
}
</style>


<style>
/* ===== 2025.10.14 FocusMobile v2.8 ===== */
/* Mobile horizontal swipe: left page (video+toolbar) / right page (tabs) */
@media (max-width: 860px) and (orientation: portrait){
  .layout{
    flex-direction: row !important;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .left, .right{
    flex: 0 0 100% !important;
    max-width: 100% !important;
    scroll-snap-align: start;
  }
  .left .toolbar, .left #controls{
    display:block !important;
    max-height:none !important;
  }
  #btnExitFocus{
    position: fixed; right: 16px; bottom: 16px;
    z-index: 9999;
  }
}
</style>

</head>
<body>
<header>
  <h1>è‹±èªå½±ç‰‡æ’­æ”¾å™¨</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <button id="btnLogin" class="btn">ç™»å…¥</button>
    <button id="btnLogout" class="btn" style="display:none">ç™»å‡º</button>
    <span id="userNameBadge" class="muted"></span>
  </div>
</header>

<div class="wrap">
  <div class="layout">
    <section class="left" id="videoContainer">
      <div id="videoWrap" class="videoWrap">
        <video id="player" playsinline controls></video>
      </div>

      <div class="controls" id="controlsDrawer">
        <div class="drawer-grab" id="drawerGrab">
          <div class="grab-bar" style="width:44px;height:4px;border-radius:4px;margin:0 auto 4px;background:#2b4a78;"></div>
          <div class="drawer-title" style="font-size:12px;color:#9fb0c9;">æ’­æ”¾å·¥å…·åˆ—ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰</div>
        </div>
        <div class="row">
          <button id="btnPrev" class="btn">â® ä¸Šä¸€å¥</button>
          <button id="btnPlay" class="btn">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
          <button id="btnNext" class="btn">â­ ä¸‹ä¸€å¥</button>
          <button id="btnReplay" class="btn">ğŸ” é‡è¤‡æœ¬å¥</button>
        </div>
        <div class="row">
          <label class="chip"><input id="chkFollow" type="checkbox"/> è·Ÿéš¨</label>
          <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
          <button id="btnOffsetMinus" class="btn">-0.5s</button>
          <button id="btnOffsetPlus" class="btn">+0.5s</button>
          <button id="btnAutoSync" class="btn">ğŸ§­ ç°¡æ˜“æ ¡æº–</button>
        </div>
        <div class="row speed">
          <span class="muted">é€Ÿåº¦</span>
          <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
          <span id="speedVal">1.00x</span>
        </div>
      </div>
    </section>

    <section class="right" id="studyContainer">
      <div class="tabs">
        <div class="tab active" data-tab="sub" id="tabSub">å­—å¹•</div>
        <div class="tab" data-tab="quiz">æ¸¬é©—</div>
        <div class="tab" data-tab="vocab">å–®å­—</div>
      </div>

      <!-- åˆ—å°é é¦–ï¼ˆåˆ—å°æ™‚é¡¯ç¤ºï¼‰ -->
      <div id="printHeader" aria-hidden="true">
        <div id="phLeft">
          <!-- å…§åµŒ SVG Logo -->
          <svg id="phLogo" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="2"></circle>
            <path d="M7 13h10M7 9h10M7 17h6" stroke="#111" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div>
            <div id="phTitle">BookWide Â· è‹±èªå½±ç‰‡æ¸¬é©—æˆç¸¾å–®</div>
            <div id="phMeta">
              å½±ç‰‡ï¼š<span id="phSlug">-</span>ã€€åˆ†å€ï¼š<span id="phSection">-</span>ã€€åˆ—å°ï¼š<span id="phTime">-</span>
            </div>
          </div>
        </div>
        <div id="phRight">
          <div id="phScore">0 / 100</div>
          <div id="phFeedback">ï¼ˆ0%ï¼‰</div>
        </div>
      </div>

      <div class="pane">
        <div id="pane-sub">
          <div id="cuesStatus" class="muted" style="padding:10px 14px">ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰</div>
          <table>
            <thead><tr><th style="width:80px">æ™‚é–“</th><th>è‹±æ–‡</th><th style="width:40%">ä¸­æ–‡</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div id="pane-quiz" style="display:none">
          <div class="quiz-shell">
            <div id="quizTabs" class="q-tabs" style="margin:6px 0 10px 0;">
              <button class="qtab on" data-sec="Vocabulary">å–®å­—</button>
              <button class="qtab" data-sec="Grammar">æ–‡æ³•</button>
              <button class="qtab" data-sec="Reading">é–±è®€</button>
              <button class="qtab" data-sec="Mixed">ç¶œåˆ</button>
              <span id="quizMeta" class="muted" style="margin-left:12px">ï¼ˆæ¸¬é©—è¼‰å…¥ä¸­â€¦ï¼‰</span>
            </div>
            <ol id="quizList" style="line-height:1.6"></ol>
            <div class="q-actions" style="margin:14px 0 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">äº¤å·</button>
              <button class="btn" id="btnShowAnswer" style="display:none">é¡¯ç¤ºç­”æ¡ˆ</button>
              <!-- åˆ—å°æŒ‰éˆ•ï¼ˆå¸¸é§é¡¯ç¤ºæ–¼æ¸¬é©—å€ï¼‰ -->
              <button class="btn" id="btnPrint" style="display:none">åˆ—å°æˆç¸¾å–®</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
            <div id="quizResult" style="display:none;margin-top:10px"></div>
          </div>
        </div>

        <div id="pane-vocab" style="display:none">
          <div id="vocabStatus" class="muted" style="padding:10px 14px">( å–®å­—è¼‰å…¥ä¸­â€¦ )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ===== æ’­æ”¾å™¨ä¸»ç¨‹å¼ ===== -->
<script>
/* ---------- å°å·¥å…· ---------- */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ---------- åƒæ•¸ ---------- */
const params=new URLSearchParams(location.search);
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;

/* ---------- è³‡æºè¼‰å…¥ï¼ˆå«å›é€€ï¼‰ ---------- */
async function fetchWithFallback(p,f,kind){
  try{const r=await fetch(p,{cache:'no-store'}); if(!r.ok)throw 0; return {data:await r.json(),used:'primary'};}
  catch{ try{const r2=await fetch(f,{cache:'no-store'}); if(!r2.ok)throw 0; slug='mid-autumn'; return {data:await r2.json(),used:'fallback'};}
  catch(e2){ console.error(`[fatal] ${kind} è®€å–å¤±æ•—`,e2); return {data:null,used:'error'};}}
}

/* ---------- DOM ---------- */
const video=$('#player'); const cuesBody=$('#cuesBody'); const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnAutoSync=$('#btnAutoSync'); const btnPrint=$('#btnPrint');
const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;
function setOffset(v){offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset));}
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* ---------- å½±ç‰‡ & å­—å¹• ---------- */
async function loadVideo(){
  const src=s=>`./videos/${s}.mp4`;
  video.src=src(primarySlug);
  video.addEventListener('error',()=>{ video.src=src('mid-autumn'); },{once:true});
}
async function loadCues(){
  cuesStatus.textContent='ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰';
  const {data,used}=await fetchWithFallback(`./data/cues-${primarySlug}.json?v=${Date.now()}`,`./data/cues-mid-autumn.json?v=${Date.now()}`,'cues');
  if(!data){ cuesStatus.textContent='âš ï¸ å­—å¹•è®€å–å¤±æ•—'; return; }
  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}"><td class="muted" style="width:80px">${c.t?fmt(c.t):''}</td><td>${esc(c.en)}</td><td style="width:40%">${esc(c.zh)}</td></tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent=used==='fallback' ? 'å·²è¼‰å…¥å­—å¹•ï¼ˆmid-autumn å›é€€ï¼‰' : `å·²è¼‰å…¥å­—å¹•ï¼ˆ${primarySlug}ï¼‰`;
}
function currentIndex(){ const t=video.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }
function highlightRow(idx){ const trs=$$('#cuesBody tr'); trs.forEach(tr=>tr.classList.remove('active')); const tr=trs[idx]; if(!tr)return; tr.classList.add('active'); if(chkFollow.checked) tr.scrollIntoView({block:'center',behavior:'smooth'}); }
function seekTo(idx,play=true){ if(!cues[idx])return; video.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) video.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }

/* ---------- æ¸¬é©— ---------- */
async function loadQuiz(){
  const listEl=$('#quizList',paneQuiz), metaEl=$('#quizMeta',paneQuiz);
  const {data,used}=await fetchWithFallback(`./data/quiz-${primarySlug}.json?v=${Date.now()}`,`./data/quiz-mid-autumn.json?v=${Date.now()}`,'quiz');
  if(!data){ metaEl.textContent='âš ï¸ é¡Œåº«è®€å–å¤±æ•—'; return; }

  let questions=[];
  if(Array.isArray(data)){
    questions=data.map(q=>({section:(q.section||'Mixed'),type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||q.q||'',options:q.options||q.choices||[],answer:q.answer??q.ans??''}));
  }else if(data.sections){
    const push=(sec,arr=[])=>arr?.forEach(q=>questions.push({section:sec,type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||'',options:q.options||[],answer:q.answer??''}));
    push('Vocabulary',data.sections.vocab); push('Grammar',data.sections.grammar);
    push('Reading',data.sections.reading); push('Mixed',data.sections.mixed);
  }
  metaEl.textContent=used==='fallback'?`å·²è¼‰å…¥ï¼ˆmid-autumn å›é€€ï¼‰ï¼Œå…± ${questions.length} é¡Œ`:`å·²è¼‰å…¥ï¼ˆ${primarySlug}ï¼‰ï¼Œå…± ${questions.length} é¡Œ`;

  function renderSection(sec){
    const arr=questions.filter(q=>q.section===sec);
    if(!arr.length){ listEl.innerHTML='<li style="color:#9fb3ff">ï¼ˆæ­¤åˆ†å€ç„¡é¡Œç›®ï¼‰</li>'; return; }
    listEl.innerHTML=arr.map((q,i)=>{
      const idx=i+1;
      if(q.type==='MCQ'){
        const opts=q.options.map(opt=>`<label style="display:block;margin:4px 0"><input type="radio" name="q${sec}-${idx}" value="${String(opt)}"> ${String(opt)}</label>`).join('');
        return `<li data-type="MCQ" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><div>${opts}</div><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }else{
        return `<li data-type="SA" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><input type="text" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff"><button class="btn btn-check" style="margin-left:6px">æª¢æŸ¥</button><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }
    }).join('');
    listEl.addEventListener('click',e=>{
      if(!e.target.classList.contains('btn-check'))return;
      const li=e.target.closest('li'); const ipt=li.querySelector('input');
      const ok=(ipt.value||'').trim().toLowerCase()===String(li.dataset.ans||'').trim().toLowerCase();
      const msg=li.querySelector('span.msg')||li.querySelector('.msg'); const exp=li.querySelector('.exp');
      msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; exp.textContent=ok?'':`æ­£è§£ï¼š${li.dataset.ans}`;
    },{once:true});
  }
  $('#quizTabs').querySelectorAll('.qtab').forEach(b=>{ b.addEventListener('click',()=>{ $('#quizTabs').querySelectorAll('.qtab').forEach(x=>x.classList.remove('on')); b.classList.add('on'); renderSection(b.dataset.sec); }); });
  renderSection('Vocabulary');

  $('#btnSubmitQuiz').onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')]; if(!items.length)return;
    let got=0,total=items.length;
    items.forEach(li=>{
      const ans=String(li.dataset.ans||'').trim();
      if(li.dataset.type==='MCQ'){
        const sel=li.querySelector('input[type="radio"]:checked'); const user=sel?sel.value:''; const ok=user===ans;
        if(ok)got++; const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`æ­£è§£ï¼š${ans}`;
      }else{
        const ipt=li.querySelector('input'); const ok=(ipt.value||'').trim().toLowerCase()===ans.toLowerCase(); if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`æ­£è§£ï¼š${ans}`;
      }
    });
    const score=got*5, full=total*5;
    $('#quizScore').textContent=`æœ¬åˆ†å€åˆ†æ•¸ï¼š${score} / ${full}`;
    $('#quizResult').style.display='block';
    $('#btnShowAnswer').style.display='inline-block';
    btnPrint.style.display='inline-block';
    // æ›´æ–°åˆ—å°é é¦–è³‡è¨Š
    updatePrintHeader(score, full);
  };
  $('#btnShowAnswer').onclick=()=>{ $('#quizList').querySelectorAll('li').forEach(li=>{ const exp=li.querySelector('.exp'); if(exp&&!exp.textContent) exp.textContent=`æ­£è§£ï¼š${li.dataset.ans}`; }); };

  /* ===== åˆ—å°ï¼ˆä½¿ç”¨å¼·åŒ–éçš„ CSSï¼›é€™è£¡åªè² è²¬è£œä¸Šé é¦–è³‡è¨Šï¼‰ ===== */
  function updatePrintHeader(score, full){
    const pct = full ? Math.round((score/full)*100) : 0;
    const words = pct>=90 ? 'å¤ªå¼·äº†ï¼' : pct>=75 ? 'å¾ˆæ£’ï¼Œç¹¼çºŒåŠ æ²¹ï¼' : pct>=60 ? 'é‚„å¯ä»¥ï¼Œå†ç·´ç·´æœƒæ›´å¥½ã€‚' : 'å…ˆåˆ¥ç°å¿ƒï¼é‡ä½œéŒ¯é¡Œã€èƒŒé—œéµå­—å†è©¦ä¸€æ¬¡æœƒæ›´å¥½ã€‚';
    $('#phSlug').textContent = slug;
    $('#phSection').textContent = $('#quizTabs .qtab.on')?.textContent?.trim() || 'Vocabulary';
    $('#phTime').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
    $('#phScore').textContent = `${score} / ${full}`;
    $('#phFeedback').textContent = `ï¼ˆ${pct}%ï¼‰${words}`;
  }
  // è®“ 20 é¡Œå®Œæ•´é¡¯ç¤ºï¼šå…¶å¯¦é¡Œç›®æœ¬ä¾†å°±éƒ½åœ¨ DOMï¼Œä¸­é€”ä¸å†å‹• displayï¼Œäº¤çµ¦ @media print è² è²¬é«˜åº¦/åˆ†é 

  // åˆ—å°æŒ‰éˆ•ï¼šé–‹å°å‰å†ä¿éšªæŠ“ä¸€æ¬¡åˆ†æ•¸ï¼ˆé¿å…æ²’äº¤å·ä¹Ÿèƒ½å°ï¼‰
  btnPrint.onclick=()=>{
    let s=0,f=0;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f||100);
    window.print();
  };
  // ä½¿ç”¨è€…ç›´æ¥ Ctrl+P æ™‚ä¹Ÿè£œé é¦–
  window.addEventListener('beforeprint',()=>{
    let s=0,f=100;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f);
  });
}

/* ---------- å­—å½™å¡ ---------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const {data,used}=await fetchWithFallback(`./data/vocab-${primarySlug}.json?v=${Date.now()}`,`./data/vocab-mid-autumn.json?v=${Date.now()}`,'vocab');
  if(!data||!data.length){ vStatus.textContent='âš ï¸ æŸ¥ç„¡å–®å­—è³‡æ–™'; vBox.innerHTML=''; return; }
  vStatus.textContent=used==='fallback'?'å·²è¼‰å…¥å–®å­—ï¼ˆmid-autumn å›é€€ï¼‰':`å·²è¼‰å…¥å–®å­—ï¼ˆ${primarySlug}ï¼‰`;
  const go=t=>{ const p=toSec(t); video.currentTime=Math.max(0,p); video.play(); };
  vBox.innerHTML=data.map(v=>`<div class="voc"><div class="voc-h"><div class="voc-word">${esc(v.word||'')}</div><div class="voc-pos">${esc(v.pos||'')}</div></div>${v.zh?`<div class="voc-zh">${esc(v.zh)}</div>`:''}${v.en?`<div class="voc-en">${esc(v.en)}</div>`:''}<div class="voc-actions">${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">è·³åˆ°ç‰‡æ®µ</button>`:''}<button class="btn" data-act="speak" data-text="${esc(v.word||v.en||'')}">ğŸ”Š æœ—è®€</button></div></div>`).join('');
  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump')go(e.target.dataset.time||0);
    if(act==='speak'){ try{ const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  });
}

/* ---------- æ§åˆ¶ ---------- */
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(video.paused) video.play(); else video.pause(); });
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));

video.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=video.currentTime+offset; if(t>=e-0.02){ video.currentTime=Math.max(0,s-offset+0.0001); video.play(); } } });

(function(){ const drawer=$('#controlsDrawer'),grab=$('#drawerGrab'); if(!drawer||!grab)return; const toggle=()=>drawer.classList.toggle('open'); grab.addEventListener('click',toggle); })();

function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ---------- åˆå§‹åŒ– ---------- */
(async function init(){
  // æ’­æ”¾åƒæ•¸
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;

  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab();
  showTab('sub');
})();
</script>

<!-- ===== Supabase å®ˆé–€ & è§€çœ‹ç´€éŒ„ ===== -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://qtgwedankftrqjmzuset.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // å¿…é ˆç™»å…¥
  const { data: authData, error: authErr } = await supabase.auth.getUser();
  if (authErr || !authData?.user) {
    alert("è«‹å…ˆç™»å…¥å¾Œå†è§€çœ‹å½±ç‰‡ã€‚");
    location.href = "index.html";
  } else {
    const user = authData.user;
    const videoSlug = new URLSearchParams(location.search).get("slug") || "mid-autumn";

    // ç¬¬ä¸€æ¬¡æ’­æ”¾å¯«ä¸€ç­†ç´€éŒ„
    let hasLogged = false;
    const logOnce = async () => {
      if (hasLogged) return;
      hasLogged = true;
      try {
        await supabase.from("watch_logs").insert({
          user_id: user.id,
          email: user.email,
          video_slug: videoSlug
          // viewed_at äº¤çµ¦ DB default now()
        });
      } catch (e) {
        console.warn("watch_logs å¯«å…¥å¤±æ•—ï¼š", e?.message || e);
      }
    };
    document.getElementById("player")?.addEventListener("play", logOnce, { once: true });
  }
</script>

<script>
// === V3.3-restore: auto word-translate tooltip (desktop hover 0.3s / mobile long-press) ===
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const vocabMap = window.vocabMap || (window.vocabMap = Object.create(null));
  const builtIn = Object.assign(Object.create(null), {
    festival:'ç¯€æ—¥', moon:'æœˆäº®', sun:'å¤ªé™½', legend:'å‚³èªª', story:'æ•…äº‹', shoot:'å°„æ“Š',
    earth:'åœ°çƒ', people:'äººå€‘', special:'ç‰¹åˆ¥çš„', look:'çœ‹', big:'å¤§', round:'åœ“çš„'
  });
  let tip, showTimer, longTimer;

  function ensureTip(){
    if (tip) return tip;
    tip = document.createElement('div'); tip.id='wordTip'; document.body.appendChild(tip);
    return tip;
  }
  function hideTip(){ if(tip) tip.style.display='none'; }
  function showTipAt(x,y,word){
    const el = ensureTip();
    const w = word.toLowerCase();
    const zh = vocabMap[w] || builtIn[w] || 'ï¼ˆæš«ç„¡ç¿»è­¯ï¼‰';
    el.innerHTML = `<b>${word}</b>ï¼š${zh}`;
    el.style.display='block';
    const pad=10, vw=Math.max(document.documentElement.clientWidth, innerWidth||0), vh=Math.max(document.documentElement.clientHeight, innerHeight||0);
    const wmax = Math.min(vw*0.8, el.offsetWidth||260);
    el.style.left = Math.min(vw - wmax - pad, Math.max(pad, x+8)) + 'px';
    el.style.top  = Math.min(vh - 60, Math.max(pad, y+8)) + 'px';
  }

  function englishColIndex(table){
    const ths = $$('thead th', table).map(th=>th.textContent.trim());
    let idx = ths.findIndex(t=>/è‹±/.test(t)); if (idx === -1 && ths.length>=2) idx = 1;
    return idx;
  }

  function tokenizeOnce(){
    const table = $('#pane-sub table') || $('table'); if(!table) return false;
    if (table.dataset.v33tk === '1') return true;
    const idx = englishColIndex(table); if (idx<0) return false;
    const rows = $$('tbody tr', table); const re=/[A-Za-z]+(?:'[A-Za-z]+)?/g;
    rows.forEach(tr=>{
      const tds = $$('td', tr); const td = tds[idx]; if(!td) return;
      const raw = td.textContent; let out='', last=0; for(const m of raw.matchAll(re)){
        const w = m[0], i = m.index;
        if (i>last) out += raw.slice(last,i);
        out += `<span class="wtoken" data-w="${w.toLowerCase()}">${w}</span>`;
        last = i + w.length;
      }
      out += raw.slice(last);
      td.innerHTML = out;
    });
    bindEvents(table);
    table.dataset.v33tk = '1';
    console.log('[V3.3-restore] tokenized.');
    return true;
  }

  function bindEvents(root){
    const onEnter = (e)=>{
      const el = e.target.closest('.wtoken'); if(!el) return;
      clearTimeout(showTimer);
      const {clientX:x, clientY:y} = e;
      showTimer = setTimeout(()=> showTipAt(x,y, el.textContent.trim()), 300);
    };
    const onMove = (e)=>{
      if(!e.target.closest('.wtoken')) return;
      const {clientX:x, clientY:y} = e;
      if (tip && tip.style.display==='block') showTipAt(x,y, e.target.textContent.trim());
    };
    $$('.wtoken', root).forEach(el=>{
      el.addEventListener('mouseenter', onEnter);
      el.addEventListener('mousemove', onMove);
      el.addEventListener('mouseleave', ()=>{ clearTimeout(showTimer); hideTip(); });
      // Mobile long-press
      el.addEventListener('touchstart', (ev)=>{
        clearTimeout(longTimer);
        const t = ev.touches[0];
        longTimer = setTimeout(()=> showTipAt(t.clientX,t.clientY, el.textContent.trim()), 420);
      }, {passive:true});
      el.addEventListener('touchend', ()=>{ clearTimeout(longTimer); hideTip(); }, {passive:true});
      el.addEventListener('touchmove', ()=>{ clearTimeout(longTimer); hideTip(); }, {passive:true});
    });
    $('#pane-sub')?.addEventListener('scroll', hideTip, {passive:true});
  }

  function buildVocab(){
    $$('#vocabBox .voc').forEach(card=>{
      const w = (card.querySelector('.voc-word')?.textContent||'').trim().toLowerCase();
      const zh = (card.querySelector('.voc-zh')?.textContent||'').trim();
      if(w) vocabMap[w] = zh || vocabMap[w];
    });
  }

  const tryInit = ()=> tokenizeOnce();
  document.addEventListener('DOMContentLoaded', ()=>{ buildVocab(); tryInit(); });
  const mo = new MutationObserver(()=>{ buildVocab(); tryInit(); });
  mo.observe(document.body, {subtree:true, childList:true});
})();
</script>

<script>
(function(){
  const VERSION = "2025.10.13 FocusMobile v2.2";
  const isMobilePortrait = () => matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  // å³ä¸Šè§’ç‰ˆæœ¬è§’æ¨™ï¼Œä¸¦éš±è—ã€Œç™»å…¥ã€
  function mountVersionBadgeTop(){
    const loginBtn = $$('a,button').find(el => (el.textContent||'').trim() === 'ç™»å…¥');
    if (loginBtn) loginBtn.style.display = 'none';
    if (!$('#verBadgeTop')){
      const b = document.createElement('div');
      b.id='verBadgeTop'; b.textContent = VERSION;
      document.body.appendChild(b);
    }
  }

  // å˜—è©¦æ‰¾åˆ°æ’­æ”¾å·¥å…·åˆ—å®¹å™¨
  function findToolPanel(){
    const nativeToggle = $$('button, [role="button"]').find(b => /æ’­æ”¾å·¥å…·åˆ—/.test((b.textContent||'').trim()));
    if (nativeToggle) return nativeToggle.closest('section,div,form,article') || nativeToggle.parentElement;
    const labels = ['ä¸Šä¸€å¥','æ’­æ”¾','æš«åœ','ä¸‹ä¸€å¥','é‡è¤‡æœ¬å¥','è·Ÿéš¨','åç§»','é€Ÿåº¦'];
    let best=null, score=0;
    $$('button,[role="button"],label').forEach(el=>{
      const t=(el.textContent||'').trim();
      if (labels.some(k=>t.includes(k))){
        const p = el.closest('.tools,.controls,.panel,section,div');
        if (p){
          let s=1;
          labels.forEach(k=>{ if ((p.textContent||'').includes(k)) s++; });
          if (s>score){ score=s; best=p; }
        }
      }
    });
    return best;
  }

  // ç¶å®šã€Œå­—å¹•ï¼æ¸¬é©—ï¼å–®å­—ã€â†’ å°ˆæ³¨æ¨¡å¼ï¼›å†æŒ‰ä¸€æ¬¡æˆ–æŒ‰è¿”å›å¯é€€å‡º
  function bindFocusModeOnTabs(){
    if (!isMobilePortrait()) return;
    const need = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    const tabs = $$('button, a, [role="tab"]');
    tabs.forEach(el=>{
      const t=(el.textContent||'').trim();
      if (need.has(t) && !el.dataset.fmBound){
        el.dataset.fmBound='1';
        el.addEventListener('click', ()=>{
          document.body.classList.toggle('focus-mode');
        }, {passive:true});
      }
    });
  }

  // æ‰‹æ©Ÿï¼šè·Ÿéš¨é è¨­ä¸å‹¾é¸
  function keepFollowOff(){
    if (!isMobilePortrait()) return;
    const chk = $('#chkFollow') || $$('input[type="checkbox"]').find(i=> (i.id||'').toLowerCase().includes('follow')) ||
                $$('label').find(l=>/è·Ÿéš¨/.test((l.textContent||'')))?.querySelector('input[type="checkbox"]');
    if (chk) chk.checked = false;
  }

  // ç¢ºä¿è¿”å›å½±ç‰‡æŒ‰éˆ•å­˜åœ¨
  function ensureExitButton(){
    if (!$('#btnExitFocus')){
      const btn = document.createElement('button');
      btn.id='btnExitFocus'; btn.textContent='è¿”å›å½±ç‰‡';
      document.body.appendChild(btn);
      btn.addEventListener('click', ()=> document.body.classList.remove('focus-mode'));
    }
  }

  // å·¥å…·åˆ—é è¨­æ”¶åˆï¼›è‹¥å·²å­˜åœ¨åŸç”Ÿã€Œæ’­æ”¾å·¥å…·åˆ—ã€æŒ‰éˆ•å°±ä½¿ç”¨åŸç”Ÿï¼Œä¸å†å»ºç«‹ç¬¬äºŒé¡†
  function ensureToolsCollapsed(){
    if (!isMobilePortrait()) return;
    const tools = findToolPanel();
    if (!tools) return;
    if (!tools.classList.contains('tools-collapsed')) tools.classList.add('tools-collapsed');
    const hasNativeToggle = $$('button, [role="button"]').some(b => /æ’­æ”¾å·¥å…·åˆ—/.test((b.textContent||'').trim()));
    if (!hasNativeToggle && !$('#toolsToggle')){
      const h=document.createElement('button');
      h.id='toolsToggle'; h.className='tools-toggle'; h.type='button';
      h.textContent='æ’­æ”¾å·¥å…·åˆ— â–¾';
      tools.parentNode.insertBefore(h, tools);
      h.addEventListener('click', ()=>{
        tools.classList.toggle('tools-collapsed');
        h.textContent = tools.classList.contains('tools-collapsed') ? 'æ’­æ”¾å·¥å…·åˆ— â–¾' : 'æ’­æ”¾å·¥å…·åˆ— â–´';
      });
    }
  }

  function init(){
    mountVersionBadgeTop();
    if (isMobilePortrait()){
      ensureExitButton();
      ensureToolsCollapsed();
      bindFocusModeOnTabs();
      keepFollowOff();
    } else {
      document.body.classList.remove('focus-mode');
    }
  }

  window.addEventListener('resize', init, {passive:true});
  window.addEventListener('orientationchange', init, {passive:true});
  document.addEventListener('DOMContentLoaded', init);
  const mo = new MutationObserver(()=>{ if (isMobilePortrait()) bindFocusModeOnTabs(); });
  mo.observe(document.body, {subtree:true, childList:true});
})();
</script>

<script>
(function(){
  const VERSION = "2025.10.13 FocusMobile v2.4";
  const isMobilePortrait = () => matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function mountVersionBadgeTop(){
    const loginBtn = $$('a,button').find(el => (el.textContent||'').trim() === 'ç™»å…¥');
    if (loginBtn) loginBtn.style.display = 'none';
    if (!$('#verBadgeTop')){
      const b = document.createElement('div');
      b.id='verBadgeTop'; b.textContent = VERSION;
      document.body.appendChild(b);
    } else { $('#verBadgeTop').textContent = VERSION; }
  }

  function stickTabsBar(){
    if (!isMobilePortrait()) return;
    const keys = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    const tabs = $$('button,a,[role="tab"]').filter(el => keys.has((el.textContent||'').trim()));
    if (tabs.length){
      const bar = tabs[0].closest('nav,.tabs,.tabbar,.tabs-container,.panel,section,div') || tabs[0].parentElement;
      if (bar && !bar.classList.contains('mobile-tabs-bar')) bar.classList.add('mobile-tabs-bar');
    }
  }

  function findToolPanel(){
    const nativeToggle = $$('button,[role="button"]').find(b => /æ’­æ”¾å·¥å…·åˆ—/.test((b.textContent||'').trim()));
    if (nativeToggle) return nativeToggle.closest('section,div,form,article') || nativeToggle.parentElement;
    const labels = ['ä¸Šä¸€å¥','æ’­æ”¾','æš«åœ','ä¸‹ä¸€å¥','é‡è¤‡æœ¬å¥','è·Ÿéš¨','åç§»','é€Ÿåº¦'];
    let best=null, score=0;
    $$('button,[role="button"],label').forEach(el=>{
      const t=(el.textContent||'').trim();
      if (labels.some(k=>t.includes(k))){
        const p = el.closest('.tools,.controls,.panel,section,div');
        if (p){
          let s=1; labels.forEach(k=>{ if ((p.textContent||'').includes(k)) s++; });
          if (s>score){ score=s; best=p; }
        }
      }
    });
    return best;
  }

  function collapseToolsAsOne(){
    if (!isMobilePortrait()) return;
    const tools = findToolPanel();
    if (!tools) return;
    tools.classList.add('tools-collapsed');
    const hasNativeToggle = $$('button,[role="button"]').some(b => /æ’­æ”¾å·¥å…·åˆ—/.test((b.textContent||'').trim()));
    if (!hasNativeToggle && !$('#toolsToggle')){
      const h=document.createElement('button');
      h.id='toolsToggle'; h.className='tools-toggle'; h.type='button';
      h.textContent='æ’­æ”¾å·¥å…·åˆ— â–¾';
      tools.parentNode.insertBefore(h, tools);
      h.addEventListener('click', ()=>{
        tools.classList.toggle('tools-collapsed');
        h.textContent = tools.classList.contains('tools-collapsed') ? 'æ’­æ”¾å·¥å…·åˆ— â–¾' : 'æ’­æ”¾å·¥å…·åˆ— â–´';
      });
    }
  }

  function bindFocusModeOnTabs(){
    if (!isMobilePortrait()) return;
    const keys = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    const tabs = $$('button,a,[role="tab"]');
    tabs.forEach(el=>{
      const t=(el.textContent||'').trim();
      if (keys.has(t) && !el.dataset.fmBound){
        el.dataset.fmBound='1';
        el.addEventListener('click', ()=>{
          document.body.classList.toggle('focus-mode');
          if (document.body.classList.contains('focus-mode')) window.scrollTo({ top: 0, behavior:'smooth' });
        }, {passive:true});
      }
    });
  }

  function ensureExitButton(){
    if (!$('#btnExitFocus')){
      const btn = document.createElement('button');
      btn.id='btnExitFocus'; btn.textContent='è¿”å›å½±ç‰‡';
      document.body.appendChild(btn);
      btn.addEventListener('click', ()=> document.body.classList.remove('focus-mode'));
    }
  }

  function keepFollowOff(){
    if (!isMobilePortrait()) return;
    const chk = $('#chkFollow') ||
      $$('input[type="checkbox"]').find(i=> (i.id||'').toLowerCase().includes('follow')) ||
      $$('label').find(l=>/è·Ÿéš¨/.test((l.textContent||'')))?.querySelector('input[type="checkbox"]');
    if (chk) chk.checked = false;
  }

  function init(){
    mountVersionBadgeTop();
    if (isMobilePortrait()){
      stickTabsBar();
      collapseToolsAsOne();
      bindFocusModeOnTabs();
      ensureExitButton();
      keepFollowOff();
    } else {
      document.body.classList.remove('focus-mode');
    }
  }

  window.addEventListener('resize', init, {passive:true});
  window.addEventListener('orientationchange', init, {passive:true});
  document.addEventListener('DOMContentLoaded', init);
  const mo = new MutationObserver(()=>{ if (isMobilePortrait()) { stickTabsBar(); bindFocusModeOnTabs(); } });
  mo.observe(document.body, {subtree:true, childList:true});
})();
</script>

<script>
(function(){
  const VERSION = "2025.10.13 FocusMobile v2.5";
  const isMobilePortrait = () => matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  // æ›´æ–°ç‰ˆæœ¬è§’æ¨™
  document.addEventListener('DOMContentLoaded', ()=>{
    const badge = document.getElementById('verBadgeTop');
    if (badge) badge.textContent = VERSION;
  });

  // æ‰¾ã€Œæ•´çµ„ã€å·¥å…·åˆ—å®¹å™¨ï¼ˆå«æŠ“æŠŠ/ä¸Šä¸€å¥/æ’­æ”¾/ä¸‹ä¸€å¥/è·Ÿéš¨/é€Ÿåº¦ï¼‰
  function findControlsWrap(){
    const candidates = [
      '#controlsWrap', '#playerControls', '#toolbar', '#playTools', '.controls', '.tools', '.play-tools'
    ];
    for (const sel of candidates){
      const el = document.querySelector(sel);
      if (el) return el;
    }
    // fallback ä»¥æŒ‰éˆ•æ–‡å­—æ¨å›å®¹å™¨
    const labels = ['ä¸Šä¸€å¥','æ’­æ”¾','æš«åœ','ä¸‹ä¸€å¥','é‡è¤‡æœ¬å¥','è·Ÿéš¨','åç§»','é€Ÿåº¦'];
    let best=null, score=0;
    $$('button,[role="button"],label').forEach(el=>{
      const t=(el.textContent||'').trim();
      if (labels.some(k=>t.includes(k))){
        const p = el.closest('section,div,form,article');
        if (p){
          let s=1; labels.forEach(k=>{ if ((p.textContent||'').includes(k)) s++; });
          if (s>score){ score=s; best=p; }
        }
      }
    });
    return best;
  }

  // å›ºå®šé¡¯ç¤ºä¸€é¡†æŠŠæ‰‹ï¼Œç¢ºä¿æ°¸é å¯ä»¥å±•é–‹ï¼ˆå¦‚æœé é¢å·²æœ‰åŸç”ŸæŒ‰éˆ•å°±ä¸é¡¯ç¤ºé€™é¡†ï¼‰
  function ensureToolsToggle(controls){
    if (!isMobilePortrait() || !controls) return;
    const hasNative = $$('button,[role="button"]').some(b => /æ’­æ”¾å·¥å…·åˆ—/.test((b.textContent||'').trim()));
    if (hasNative) return;
    if (!document.getElementById('toolsToggleFixed')){
      const btn = document.createElement('button');
      btn.id = 'toolsToggleFixed';
      btn.type = 'button';
      btn.textContent = 'æ’­æ”¾å·¥å…·åˆ— â–¾';
      // æŠŠæŠŠæ‰‹æ”¾åœ¨å³æ¬„æœ€å‰é¢ï¼ˆè‹¥æ‰¾ä¸åˆ°å³æ¬„ï¼Œå°±æ”¾åœ¨ controls å‰é¢ï¼‰
      const right = document.querySelector('.right') || controls.parentNode;
      if (right && right.firstChild) right.insertBefore(btn, right.firstChild);
      else controls.parentNode.insertBefore(btn, controls);
      btn.addEventListener('click', ()=>{
        const collapsed = controls.classList.contains('tools-collapsed');
        controls.classList.toggle('tools-collapsed', !collapsed);
        controls.classList.toggle('tools-expanded', collapsed);
        btn.textContent = collapsed ? 'æ’­æ”¾å·¥å…·åˆ— â–´' : 'æ’­æ”¾å·¥å…·åˆ— â–¾';
      });
    }
  }

  // åˆå§‹å°‡å·¥å…·åˆ—è¨­ç‚ºæ”¶åˆï¼ˆtools-collapsedï¼‰ï¼Œé»æŒ‰éˆ•å¾Œåˆ‡æ›åˆ° tools-expanded
  function prepareControls(){
    const controls = findControlsWrap();
    if (!controls) return;
    controls.classList.remove('tools-expanded');
    controls.classList.add('tools-collapsed');
    ensureToolsToggle(controls);
  }

  // åƒ…å°‡ã€Œæœ€ä¸Šå±¤åˆ†é åˆ—ï¼šå­—å¹•/æ¸¬é©—/å–®å­—ã€ç¶ç‚ºå°ˆæ³¨æ¨¡å¼ï¼Œä¸å½±éŸ¿æ¸¬é©—å…§éƒ¨çš„ã€Œå–®å­—/æ–‡æ³•/é–±è®€/ç¶œåˆã€
  function bindFocusOnTopTabs(){
    if (!isMobilePortrait()) return;
    const TOP = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    // æ‰¾åˆ°åŒä¸€å€‹ tabs å®¹å™¨ï¼Œä¸”åŒæ™‚åŒ…å«ã€Œå­—å¹•/æ¸¬é©—/å–®å­—ã€ä¸‰å€‹å­—
    const allButtons = $$('button,a,[role="tab"]');
    const containers = new Map();
    allButtons.forEach(el=>{
      const t=(el.textContent||'').trim();
      if (TOP.has(t)){
        const c = el.closest('nav,.tabs,.tabbar,.tabs-container,.panel,section,div') || el.parentElement;
        if (!c) return;
        const set = containers.get(c) || new Set();
        set.add(t); containers.set(c,set);
      }
    });
    // æ‰¾å‡ºåŒæ™‚åŒ…å«ä¸‰å€‹æ¨™ç±¤çš„å®¹å™¨
    const topBars = Array.from(containers.entries()).filter(([c,set])=> set.has('å­—å¹•') && set.has('æ¸¬é©—') && set.has('å–®å­—')).map(([c])=>c);
    if (!topBars.length) return;
    const topBar = topBars[0];
    // çµ¦é€™å€‹å®¹å™¨ sticky æ¨£å¼ï¼ˆè‹¥å°šæœªï¼‰
    if (!topBar.classList.contains('mobile-tabs-bar')) topBar.classList.add('mobile-tabs-bar');

    // ç¶å®š topBar å…§çš„ä¸‰å€‹æŒ‰éˆ•ï¼Œä¸å»ç¢°æ¸¬é©—å…§éƒ¨çš„å…¶ä»–åˆ†é 
    $$('button,a,[role="tab"]', topBar).forEach(el=>{
      const t=(el.textContent||'').trim();
      if (TOP.has(t) && !el.dataset.fmBound){
        el.dataset.fmBound='1';
        el.addEventListener('click', ()=>{
          document.body.classList.add('focus-mode');
          window.scrollTo({ top: 0, behavior:'smooth' });
        }, {passive:true});
      }
    });
  }

  // å³ä¸‹è§’è¿”å›éµ
  function ensureExitButton(){
    if (!document.getElementById('btnExitFocus')){
      const btn = document.createElement('button');
      btn.id='btnExitFocus'; btn.textContent='è¿”å›å½±ç‰‡';
      document.body.appendChild(btn);
      btn.addEventListener('click', ()=> document.body.classList.remove('focus-mode'));
    }
  }

  // æ‰‹æ©Ÿé è¨­ä¸å•Ÿå‹•ã€Œè·Ÿéš¨ã€
  function keepFollowOff(){
    if (!isMobilePortrait()) return;
    const chk = document.getElementById('chkFollow') ||
      $$('input[type="checkbox"]').find(i=> (i.id||'').toLowerCase().includes('follow')) ||
      $$('label').find(l=>/è·Ÿéš¨/.test((l.textContent||'')))?.querySelector('input[type="checkbox"]');
    if (chk) chk.checked = false;
  }

  function init(){
    if (isMobilePortrait()){
      prepareControls();
      bindFocusOnTopTabs();
      ensureExitButton();
      keepFollowOff();
    } else {
      document.body.classList.remove('focus-mode');
    }
  }

  window.addEventListener('resize', init, {passive:true});
  window.addEventListener('orientationchange', init, {passive:true});
  document.addEventListener('DOMContentLoaded', init);
  const mo = new MutationObserver(()=>{ if (isMobilePortrait()) { bindFocusOnTopTabs(); } });
  mo.observe(document.body, {subtree:true, childList:true});
})();
</script>

<script>
(function(){
  const VERSION = "2025.10.13 FocusMobile v2.6";
  const isMobilePortrait = () => matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  // æ›´æ–°å³ä¸Šè§’ç‰ˆæœ¬è§’æ¨™
  document.addEventListener('DOMContentLoaded', ()=>{
    const badge = document.getElementById('verBadgeTop');
    if (badge) badge.textContent = VERSION;
  });

  // æ‰¾åˆ°ã€Œå­—å¹•/æ¸¬é©—/å–®å­—ã€æœ€ä¸Šå±¤åˆ†é å®¹å™¨ï¼ˆåŒæ™‚åŒ…å«ä¸‰å€‹ï¼‰
  function getTopTabsBar(){
    const TOP = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    const buttons = $$('button,a,[role="tab"]');
    const byContainer = new Map();
    buttons.forEach(el=>{
      const t=(el.textContent||'').trim();
      if (TOP.has(t)){
        const c = el.closest('nav,.tabs,.tabbar,.tabs-container,.panel,section,div') || el.parentElement;
        if (!c) return;
        const set = byContainer.get(c) || new Set();
        set.add(t); byContainer.set(c,set);
      }
    });
    const bars = Array.from(byContainer.entries()).filter(([c,set])=> set.has('å­—å¹•') && set.has('æ¸¬é©—') && set.has('å–®å­—')).map(([c])=>c);
    return bars[0] || null;
  }

  function clickQuizTabIfNeeded(){
    const bar = getTopTabsBar();
    if (!bar) return;
    const quizBtn = $$('button,a,[role="tab"]', bar).find(el => (el.textContent||'').trim() === 'æ¸¬é©—');
    if (quizBtn) quizBtn.click();
  }

  function ensurePrintButton(){
    if (!isMobilePortrait()) return;
    if (document.getElementById('btnPrintQuiz')) return;
    const bar = getTopTabsBar();
    const host = bar || document.querySelector('.right') || document.body;
    const btn = document.createElement('button');
    btn.id = 'btnPrintQuiz';
    btn.type = 'button';
    btn.textContent = 'åˆ—å°æ¸¬é©—';
    host.insertBefore(btn, host.firstChild);
    btn.addEventListener('click', ()=>{
      // 1) åˆ‡åˆ°æ¸¬é©—åˆ†é ï¼ˆè‹¥å°šæœªï¼‰
      clickQuizTabIfNeeded();
      // 2) é€€å‡º focus-modeï¼ˆé¿å…æŒ‰éˆ•è¢«éš±è—ï¼‰ï¼Œæˆ–ä¹Ÿå¯ä¿æŒï¼Œå› ç‚º print CSS æœƒéš±è—å½±ç‰‡
      // document.body.classList.remove('focus-mode');
      // 3) å»¶é²ä¸€æ‹è®“ DOM å®Œæˆåˆ‡æ›
      setTimeout(()=> window.print(), 120);
    });
  }

  function init(){
    if (isMobilePortrait()) ensurePrintButton();
  }
  window.addEventListener('resize', init, {passive:true});
  window.addEventListener('orientationchange', init, {passive:true});
  document.addEventListener('DOMContentLoaded', init);
})();
</script>

<script>
// ===== 2025.10.13 FocusMobile v2.7 â€” swipe pager logic =====
(function(){
  const isMP = () => matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  function $$(s, r=document){ return Array.from(r.querySelectorAll(s)); }
  function $(s, r=document){ return r.querySelector(s); }

  function setPage(idx){
    const track = $('.layout');
    if (!track) return;
    const w = track.clientWidth;
    track.scrollTo({ left: idx * w, behavior: 'smooth' });
  }

  function bindTopTabs(){
    if (!isMP()) return;
    const TOP = new Set(['å­—å¹•','æ¸¬é©—','å–®å­—']);
    const all = $$('button,a,[role="tab"]');
    all.forEach(el=>{
      const t = (el.textContent||'').trim();
      if (TOP.has(t) && !el.dataset.pagerBound){
        el.dataset.pagerBound = '1';
        el.addEventListener('click', ()=> setPage(1), { passive:true });
      }
    });
  }

  function bindBack(){
    const back = document.getElementById('btnExitFocus');
    if (back && !back.dataset.pagerBound){
      back.dataset.pagerBound = '1';
      back.onclick = () => setPage(0);
    }
  }

  function init(){
    if (!isMP()) return;
    // ensure smooth scroll behaviour
    const track = document.querySelector('.layout');
    if (track) track.style.scrollBehavior = 'smooth';
    bindTopTabs();
    bindBack();
  }

  window.addEventListener('resize', init, { passive:true });
  window.addEventListener('orientationchange', init, { passive:true });
  document.addEventListener('DOMContentLoaded', init);
  // Observe for late-rendered tabs
  const mo = new MutationObserver(()=> init());
  mo.observe(document.body, { subtree:true, childList:true });
})();
</script>


<script>
(function(){
  const isMobile = ()=> matchMedia('(max-width: 860px) and (orientation: portrait)').matches;
  function setPage(idx){
    const layout = document.querySelector('.layout');
    if (!layout) return;
    layout.scrollTo({ left: idx * layout.clientWidth, behavior: 'smooth' });
  }
  function bindTabs(){
    if (!isMobile()) return;
    const tabTexts = ['å­—å¹•','æ¸¬é©—','å–®å­—'];
    document.querySelectorAll('button,a').forEach(btn=>{
      const txt = (btn.textContent||'').trim();
      if(tabTexts.includes(txt)){
        btn.onclick = ()=> setPage(1);
      }
    });
    const back=document.getElementById('btnExitFocus');
    if(back) back.onclick=()=> setPage(0);
  }
  document.addEventListener('DOMContentLoaded', bindTabs);
})();
</script>

<div style="position:fixed;top:8px;right:8px;z-index:9999;font-size:12px;color:#333;">2025.10.14 FocusMobile v2.8</div></body>
</html>























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































