<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}

  /* å…©æ¬„ï¼šå·¦å½±ç‰‡ / å³é¢æ¿ */
  .layout{
    display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh;
  }
  @media(max-width:1024px){
    .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; }
  }

  /* å·¦æ¬„ï¼šä¸Šå½±ç‰‡èˆå°(å¯æ”¶ç¸®) + ä¸‹å·¥å…·åˆ—(å›ºå®š) */
  .videoColumn{
    display:grid; grid-template-rows: minmax(0, 1fr) auto; min-height:0;
    border-right:1px solid var(--border);
  }
  .videoStage{
    min-height:0; display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden;
  }
  video{
    max-width:100%; max-height:100%; width:auto; height:auto;
    object-fit:contain; background:#000; transform-origin:center center;
  }

  /* å·¥å…·åˆ—å›ºå®šé¡¯ç¤º */
  .toolBar{
    position:relative; z-index:2;
    padding:10px 12px; background:#101b39;
    border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .btn,.chip{
    border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; user-select:none;
  }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }
  .range{ vertical-align:middle; width:160px; margin-left:8px; }

  /* å³æ¬„ï¼šå­—å¹• / æ¸¬é©— */
  .side{ display:flex; flex-direction:column; min-height:0; background:var(--panel); }
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}

  /* å­—å¹•è¡Œ */
  .line{line-height:1.6;margin:10px 0;border-radius:8px;padding:6px 8px}
  .line .time{color:var(--muted);margin-right:8px;font-variant-numeric:tabular-nums}
  .line .zh{color:var(--muted);display:block;margin-left:52px}
  .line.active{background:#1a2c66}

  /* æ¸¬é©— */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:12px}
</style>
</head>
<body>
<div class="layout">

  <!-- å·¦ï¼šå½±ç‰‡ï¼ˆä¸Šï¼šèˆå°ï¼Œä¸‹ï¼šå·¥å…·åˆ—ï¼‰ -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- å·¦ä¸‹ å›ºå®šå·¥å…·åˆ— -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
      <button class="btn" id="btnPlay">æ’­æ”¾/æš«åœ</button>
      <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>

      <button class="btn" id="btnRepeatOne">é‡è¤‡æœ¬å¥</button>
      <button class="btn" id="btnAB">A-B å¾ªç’°</button>
      <button class="btn" id="btnABClear">å–æ¶ˆå¾ªç’°</button>

      <label class="chip">è®Šç„¦
        <input id="zoom" class="range" type="range" min="1" max="2" step="0.05" value="1">
      </label>
      <label class="chip">é€Ÿåº¦
        <input id="rate" class="range" type="range" min="0.5" max="2" step="0.05" value="1">
        <span id="rateLabel" style="margin-left:6px">1.00Ã—</span>
      </label>
    </div>
  </section>

  <!-- å³ï¼šå­—å¹• / æ¸¬é©— -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
    </div>

    <!-- å­—ç´š -->
    <div class="toolbar">
      <span style="color:#a9b3cf">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
    </div>

    <!-- å­—å¹• -->
    <div id="panelTranscript" class="panel"></div>

    <!-- æ¸¬é©— -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="footBar">
        <div class="muted" id="quizProgress">0 / 0</div>
        <div>
          <button id="btnCheck" class="btn">äº¤å·</button>
          <button id="btnRetry" class="btn" style="display:none">å†è©¦ä¸€æ¬¡</button>
        </div>
      </div>
      <div id="quizResult" class="result"></div>
    </div>
  </aside>
</div>

<script>
/* ------------------ å°å·¥å…· ------------------ */
const $ = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

const toSec = (t)=>{
  const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);
  return m*60 + s;
};

/* ------------------ è¼‰å…¥ç´¢å¼• ------------------ */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=> x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item; // {video,cues,quiz,...}
}

/* ------------------ è¨­å®šå½±ç‰‡ ------------------ */
function setupVideo(src){
  const v = $('#player');
  v.src = src;
}

/* ------------------ è¼‰å…¥å­—å¹• ------------------ */
/* æ”¯æ´ï¼š
   [{ time:"00:05", text:"...", zh:"..." }, ...]
   æˆ– { items:[...åŒä¸Š] }
*/
let cueList = []; // [{tSec, el}]
async function loadCues(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('å­—å¹• JSON è¼‰å…¥å¤±æ•—');
  return await res.json();
}
function renderTranscript(data){
  const box = $('#panelTranscript');
  box.innerHTML = '';
  const list = Array.isArray(data)? data : (data.items||[]);
  cueList = list.map(row=>{
    const t = row.time || row.t || row.start || '0:00';
    const en = row.text || row.en || row.caption || '';
    const zh = row.zh || '';
    const el = document.createElement('div');
    el.className = 'line';
    el.innerHTML = `
      <span class="time">[${t}]</span>${en}
      ${zh ? `<span class="zh">${zh}</span>` : ''}`;
    el.onclick = ()=>{
      const sec = toSec(t);
      const v = $('#player');
      v.currentTime = sec; v.play();
      highlightByTime(sec);
    };
    box.appendChild(el);
    return { tSec: toSec(t), el };
  });
}

/* ------------------ é«˜äº®ï¼‹è‡ªå‹•ç½®ä¸­æ»¾å‹• ------------------ */
let lastActive = -1;
function highlightByTime(current){
  let idx = -1;
  for(let i=0;i<cueList.length;i++){
    if(cueList[i].tSec <= current) idx = i; else break;
  }
  if(idx===lastActive) return;
  lastActive = idx;

  $$('.line', $('#panelTranscript')).forEach(l=>l.classList.remove('active'));
  if(idx>=0){
    const el = cueList[idx].el;
    el.classList.add('active');
    // ç½®ä¸­æ»¾å‹•ï¼ˆç„¡éœ€é–‹é—œï¼‰
    el.scrollIntoView({block:'center', behavior:'smooth'});
  }
}

/* ------------------ æ¸¬é©— ------------------ */
/* æ”¯æ´æ¬„ä½ï¼š
   å•é¡Œï¼šquestion / q
   é¸é …ï¼šoptions / a / choices
   ç­”æ¡ˆï¼šanswerIndex / correct / ansï¼ˆæ•¸å­—ç´¢å¼•æˆ–æ–‡å­—ï¼‰
*/
let quizData = [];
async function loadQuiz(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('æ¸¬é©— JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  let arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  return arr.slice(0,20).map((x,i)=>{
    const q = x.question || x.q || `Q${i+1}`;
    const opts = x.options || x.a || x.choices || [];
    let ans = x.answerIndex ?? x.correct ?? x.ans;
    if(typeof ans!=='number'){ // è‹¥ç­”æ¡ˆæ˜¯æ–‡å­—ï¼Œè½‰ç‚ºç´¢å¼•
      const idx = opts.findIndex(o=> (o.text||o)===ans);
      ans = idx>=0? idx : undefined;
    }
    return {q, opts:opts.map(o=> (o.text||o)), ans};
  });
}
function renderQuiz(questions){
  const box = $('#quizBox');
  box.innerHTML = '';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    wrap.innerHTML = `<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt, j)=>{
      const id = `q${i}_o${j}`;
      const line = document.createElement('label');
      line.className = 'opt';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}" id="${id}"/>
                        <span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;

  // ç›£è½é€²åº¦
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });

  $('#btnCheck').onclick = ()=>{
    // è‹¥æ²’æœ‰ç­”æ¡ˆæ¬„ä½ï¼Œæ”¹ç‚ºæé†’
    if(questions.some(q=> typeof q.ans==='undefined')){
      alert('æ­¤æ¸¬é©—ç¼ºå°‘ç­”æ¡ˆæ¬„ä½ï¼ˆanswerIndex/correct/ansï¼‰ï¼Œè«‹è£œé½Šå¾Œå†è©•åˆ†ã€‚');
      return;
    }
    let correct = 0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const val = picked ? parseInt(picked.value,10) : -1;
      if(val===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    const res = $('#quizResult');
    res.style.display = 'block';
    res.className = 'result ' + (ratio>=80 ? 'pass':'fail');
    res.textContent = `åˆ†æ•¸ï¼š${correct} / ${questions.length}ï¼ˆ${ratio}%ï¼‰` + (ratio>=80?'  ğŸ‘ å¤ªæ£’äº†ï¼':'  å†æ¥å†å²ï¼');
    $('#btnRetry').style.display = 'inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent = `0 / ${questions.length}`;
    const res = $('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display = 'none';
  };
}

/* ------------------ åˆ†é åˆ‡æ› ------------------ */
function setupTabs(){
  const t1 = $('#tabTranscript'), p1 = $('#panelTranscript');
  const t2 = $('#tabQuiz'),       p2 = $('#panelQuiz');
  t1.onclick = ()=>{ t1.classList.add('active'); t2.classList.remove('active'); p1.style.display='block'; p2.style.display='none'; };
  t2.onclick = ()=>{ t2.classList.add('active'); t1.classList.remove('active'); p2.style.display='block'; p1.style.display='none'; };
}

/* ------------------ å·¦å´å·¥å…·åˆ— ------------------ */
let A=null, B=null, abTimer=null;
function jumpPrev(){
  const t = $('#player').currentTime;
  const prev = [...cueList].reverse().find(c=>c.tSec < t - 0.05);
  if(prev){ $('#player').currentTime = prev.tSec; $('#player').play(); }
}
function jumpNext(){
  const t = $('#player').currentTime;
  const next = cueList.find(c=>c.tSec > t + 0.05);
  if(next){ $('#player').currentTime = next.tSec; $('#player').play(); }
}
function setRepeatOne(){
  const t = $('#player').currentTime;
  let i = cueList.findIndex((c,idx)=> c.tSec<=t && (idx+1>=cueList.length || cueList[idx+1].tSec>t));
  if(i<0) i=0;
  A = cueList[i].tSec;
  B = (i+1<cueList.length ? cueList[i+1].tSec : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('å·²è¨­å®š A é»'); }
  else if(B==null){ B = v.currentTime; alert('å·²è¨­å®š B é»ï¼›é–‹å§‹å¾ªç’°'); startAB(); }
  else { A=v.currentTime; B=null; alert('å·²é‡è¨­ A é»ï¼Œè«‹å†æŒ‰ä¸€æ¬¡è¨­å®š B é»'); }
}
function startAB(){
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function clearLoop(){
  A=null; B=null; clearInterval(abTimer);
}
function bindLeftToolbar(){
  $('#btnPrev').onclick = jumpPrev;
  $('#btnNext').onclick = jumpNext;
  $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
  $('#btnRepeatOne').onclick = setRepeatOne;
  $('#btnAB').onclick = setAB;
  $('#btnABClear').onclick = clearLoop;
  $('#rate').oninput = e=>{
    const v = $('#player'); v.playbackRate = +e.target.value;
    $('#rateLabel').textContent = v.playbackRate.toFixed(2)+'Ã—';
  };
  $('#zoom').oninput = e=>{
    const z = +e.target.value;
    $('#player').style.transform = `scale(${z})`;
  };
}

/* ------------------ å­—ç´šèª¿æ•´ï¼ˆå³ï¼‰ ------------------ */
function bindFontToolbar(){
  const setFont = s=>{
    const map={S:'13px',M:'15px',L:'17px'};
    $('#panelTranscript').style.fontSize = map[s]||'15px';
    $$('#fS,#fM,#fL').forEach(b=>b.classList.remove('active'));
    ({S:'#fS',M:'#fM',L:'#fL'}[s] && $(({S:'#fS',M:'#fM',L:'#fL'}[s])).classList.add('active'));
  };
  $('#fS').onclick=()=>setFont('S');
  $('#fM').onclick=()=>setFont('M');
  $('#fL').onclick=()=>setFont('L');
  setFont('M');
}

/* ------------------ å•Ÿå‹• ------------------ */
(async ()=>{
  try{
    setupTabs();
    bindLeftToolbar();
    bindFontToolbar();

    const meta = await loadMeta();
    setupVideo(meta.video);

    const cues = await loadCues(meta.cues);
    renderTranscript(cues);

    // æ’­æ”¾æ™‚é–“ -> é«˜äº®+ç½®ä¸­
    $('#player').addEventListener('timeupdate', ()=>{
      highlightByTime($('#player').currentTime);
    });

    // æ¸¬é©—ï¼ˆè‹¥ meta.quiz å­˜åœ¨å°±è¼‰å…¥ï¼‰
    if(meta.quiz){
      quizData = await loadQuiz(meta.quiz);
      renderQuiz(quizData);
    }else{
      $('#tabQuiz').style.display='none';
    }
  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div style="color:#f88">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
  }
})();
</script>
</body>
</html>
