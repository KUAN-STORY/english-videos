<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player (Left Fix)</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;}

  /* 整體兩欄：左影片 / 右面板 = 50 / 50 */
  .layout{
    display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh;
  }
  @media(max-width:1024px){
    .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; }
  }

  /* 左欄 = 上方影片舞台(1fr) + 下方工具列(auto) -> 永遠看得到工具列 */
  .videoColumn{
    display:grid; grid-template-rows: 1fr auto; min-height:0; /* 1fr 可收縮 */
    border-right:1px solid var(--border);
  }

  /* 影片舞台：讓影片置中等比縮放，避免被裁切或捲動 */
  .videoStage{
    min-height:0; /* 讓 1fr 真能縮放 */
    display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden;
  }
  video{
    max-width:100%; max-height:100%;
    width:auto; height:auto; object-fit:contain; background:#000;
  }

  /* 工具列：固定在左欄下方，不會被擠出畫面 */
  .toolBar{
    position:relative; z-index:2;
    padding:10px 12px; background:#101b39;
    border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .btn,.chip{
    border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; user-select:none;
  }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }

  /* 右側面板（保留你的現況） */
  .side{
    display:flex; flex-direction:column; min-height:0; 
    background:var(--panel);
  }
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;
       color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}
  .line{line-height:1.5;margin:8px 0;border-radius:6px}
  .line.active{background:#1a2c66}
  .time{color:var(--muted);margin-right:6px;font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="layout">

  <!-- 左：影片（上：舞台，下：工具列） -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- 固定在左欄底部的工具列（示範基本按鈕） -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlay">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>

      <button class="btn" id="btnRepeatOne">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnABClear">取消循環</button>

      <label class="chip">變焦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" style="vertical-align:middle; width:140px; margin-left:8px;">
      </label>
      <label class="chip">速度
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" style="vertical-align:middle; width:160px; margin-left:8px;">
        <span id="rateLabel" style="margin-left:6px">1.00×</span>
      </label>
    </div>
  </section>

  <!-- 右：字幕（保留你現況的結構） -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <div class="toolbar">
      <span style="color:#a9b3cf">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">跟隨</button>
      <button id="btnTheme" class="btn">主題</button>
    </div>

    <div id="panelTranscript" class="panel"></div>
    <div id="panelQuiz" class="panel" style="display:none"></div>
  </aside>
</div>

<script>
/* ＝＝＝＝＝ 簡化：保留你原本資料載入方式，只示範左欄修正與必要鉤子 ＝＝＝＝＝ */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* 載入 index.json 取得當前影片/字幕/測驗路徑（保持你的約定） */
async function loadMeta(){
  const res = await fetch('data/index.json');
  const meta = await res.json();
  return (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
}

/* 渲染字幕（保持現況），並提供逐句註冊時間點供工具列使用 */
let cueList = []; // [{tSec, text, el}]
function toSec(t){
  const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);
  return m*60 + s;
}
function renderTranscript(data){
  const list = Array.isArray(data)? data : (data.items||[]);
  const box = $('#panelTranscript'); box.innerHTML='';
  cueList = list.map(row=>{
    const t = row.time || row.t || row.start || '0:0';
    const txt = row.text || row.en || row.caption || '';
    const el = document.createElement('div');
    el.className = 'line';
    el.innerHTML = `<span class="time">[${t}]</span>${txt}`;
    el.onclick = ()=>{
      const sec = toSec(t);
      const v = $('#player');
      v.currentTime = sec; v.play();
      highlightByTime(sec);
    };
    box.appendChild(el);
    return { tSec: toSec(t), text: txt, el };
  });
}

/* 逐句高亮 & 自動跟隨 */
let follow = false;
function highlightByTime(current){
  // 找到 <= current 的最後一句
  let idx = -1;
  for(let i=0;i<cueList.length;i++){
    if(cueList[i].tSec <= current) idx = i; else break;
  }
  $$('.line', $('#panelTranscript')).forEach(l=>l.classList.remove('active'));
  if(idx>=0){
    const el = cueList[idx].el;
    el.classList.add('active');
    if(follow){
      el.scrollIntoView({block:'center', behavior:'smooth'});
    }
  }
}

/* ───── 左邊工具列（上一句 / 下一句 / 重複 / A-B / 速度 / 變焦） ───── */
let A=null, B=null, abTimer=null, repeatOne=false;

function jumpPrev(){
  const t = $('#player').currentTime;
  const prev = [...cueList].reverse().find(c=>c.tSec < t - 0.05);
  if(prev){ $('#player').currentTime = prev.tSec; $('#player').play(); }
}
function jumpNext(){
  const t = $('#player').currentTime;
  const next = cueList.find(c=>c.tSec > t + 0.05);
  if(next){ $('#player').currentTime = next.tSec; $('#player').play(); }
}
function setRepeatOne(){
  repeatOne = true;
  // 取當前句的起點 A，下一句的起點當 B
  const t = $('#player').currentTime;
  let i = cueList.findIndex(c=> c.tSec <= t && t < (cueList[cueList.length-1].tSec+3600));
  if(i<0) i=0;
  A = cueList[i].tSec;
  B = (i+1<cueList.length ? cueList[i+1].tSec : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('已設定 A 點'); }
  else if(B==null){ B = v.currentTime; alert('已設定 B 點；開始循環'); startAB(); }
  else { A=v.currentTime; B=null; alert('已重設 A 點，請再按一次設定 B 點'); }
}
function startAB(){
  repeatOne = false;
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function clearLoop(){
  repeatOne = false; A=null; B=null;
  clearInterval(abTimer);
}

function bindLeftToolbar(){
  $('#btnPrev').onclick = jumpPrev;
  $('#btnNext').onclick = jumpNext;
  $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
  $('#btnRepeatOne').onclick = setRepeatOne;
  $('#btnAB').onclick = setAB;
  $('#btnABClear').onclick = clearLoop;
  $('#rate').oninput = e=>{
    const v = $('#player'); v.playbackRate = +e.target.value;
    $('#rateLabel').textContent = v.playbackRate.toFixed(2)+'×';
  };
  $('#zoom').oninput = e=>{
    const z = +e.target.value;
    // 以 transform scale 放大影片，又不影響排版
    const v = $('#player');
    v.style.transform = `scale(${z})`;
    v.style.transformOrigin = 'center center';
  };
}

/* 跟隨 / 字級（右側簡單保留） */
function bindRightToolbar(){
  $('#btnFollow').onclick = ()=>{
    follow = !follow;
    $('#btnFollow').textContent = follow? '跟隨中' : '跟隨';
  };
  const setFont = s=>{
    const map={S:'13px',M:'15px',L:'17px'};
    $('#panelTranscript').style.fontSize = map[s]||'15px';
    $$('.chip').forEach(b=>b.classList.remove('active'));
    ({S:'#fS',M:'#fM',L:'#fL'}[s] && $(({S:'#fS',M:'#fM',L:'#fL'}[s])).classList.add('active'));
  };
  $('#fS').onclick=()=>setFont('S');
  $('#fM').onclick=()=>setFont('M');
  $('#fL').onclick=()=>setFont('L');
}

/* 啟動 */
(async ()=>{
  const meta = await loadMeta();
  if(!meta) return;

  // 設定影片
  $('#player').src = meta.video;

  // 載入字幕
  const cuesRes = await fetch(meta.cues);
  const cuesJson = await cuesRes.json();
  renderTranscript(cuesJson);

  // 播放時間驅動高亮
  $('#player').addEventListener('timeupdate', ()=>{
    highlightByTime($('#player').currentTime);
  });

  bindLeftToolbar();
  bindRightToolbar();
})();
</script>
</body>
</html>
