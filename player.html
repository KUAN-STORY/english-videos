<!--
  player.html 版本：2025.10.12V2.7
  更新：
  - 翻譯泡泡改為「全域啟用」：不侷限閱讀模式。
  - 桌機：滑鼠懸停 0.3s 顯示翻譯；滑出/捲動關閉。
  - 手機：長按顯示翻譯；放開/捲動關閉。
  - 保留列印保護區、Supabase 與桌機/手機既有邏輯。
-->
<!--
  PRINT GUARD: The code between the markers below is locked.
  Any future automated mobile/feature updates must NOT modify content
  between:  ===== PRINT SECTION START / END =====
  This keeps the print layout (20 題成績單/雙語表) stable and recoverable.
-->
<!--
  P25.10.07V2.1
  功能摘要：
  - 桌機版：保留 Supabase 登入、題庫、列印與左右排版。
  - 手機版：影片上方、控制列可收合、分頁切換進專注模式。
  - 閱讀模式：支援單字即時翻譯泡泡（內建小字典）。
  - 未啟用 AI 翻譯 API（預留接口）。
-->

!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>英語影片播放器</title>

<!-- ===== PRINT SECTION START (Do Not Modify) ===== -->
<style>
  :root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6efff; --muted:#9fb0c9; --accent:#3c7cff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
  h1{font-size:20px;margin:0}
  .btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
  .btn.blue{background:#14335f;border-color:#2c5aa3}
  .muted{color:var(--muted)}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}

  .wrap{padding:16px;height:calc(100vh - 58px);}
  .layout{height:100%;display:flex;gap:16px;overflow:hidden}
  .left,.right{flex:1;min-width:0;background:var(--panel);border:1px solid #1f2a44;border-radius:12px}
  .left{display:flex;flex-direction:column;padding:14px}
  .right{display:flex;flex-direction:column}
  .pane{flex:1;overflow:auto}

  .videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
  .videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

  .controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
  .controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
  .speed{display:flex;align-items:center;gap:10px}
  input[type="range"]{width:260px;accent-color:var(--accent)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}

  .tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid #1f2a44}
  .tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:10px;padding:8px 12px}
  .tab.active{background:#154274}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
  tbody tr{background:#0f1f34}
  tbody tr:nth-child(2n){background:#0d1a2b}
  tbody tr:hover{background:#0f2a4e}
  tr.active{background:#173a6e}
  #pane-sub td:nth-child(2),#pane-sub td:nth-child(3){word-break:break-word;white-space:normal;line-height:1.6}

  .q-tabs{display:flex;gap:8px;flex-wrap:wrap}
  .q-tabs .qtab{background:#122340;border:1px solid #1f375f;border-radius:10px;padding:6px 12px;color:#e6efff;cursor:pointer}
  .q-tabs .qtab.on{background:#154274}

  .voc{border:1px solid #213a64;background:#0f223b;border-radius:12px;padding:12px;margin:10px 14px}
  .voc-h{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
  .voc-word{font-size:20px;font-weight:800}
  .voc-pos{opacity:.85}
  .voc-zh{color:#cfe2ff;margin-top:2px}
  .voc-en{color:#9fb0c9}
  .voc-actions{display:flex;gap:8px;margin-top:8px}

  /* ===== 列印樣式（關鍵補強） ===== */
  @media print{
    html,body{ background:#fff !important; color:#000 !important; height:auto !important; }
    header,.tabs,.controls,#authArea,.drawer-grab{ display:none !important; }
    .wrap{ padding:0 !important; }
    .layout{ display:block !important; height:auto !important; overflow:visible !important; }
    .left{ display:none !important; }
    .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
    .pane, #pane-quiz, .quiz-shell, #quizList{
      height:auto !important; max-height:none !important; overflow:visible !important;
    }
    #pane-quiz{ display:block !important; }        /* 只印測驗 */
    #quizList{ font-size:12.5pt; line-height:1.25; }
    #quizList > li{
      break-inside:avoid; page-break-inside:avoid;     /* 題目不被切半 */
      padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc;
    }
    @page { margin:10mm 10mm 12mm 10mm; }           /* 版邊 */
    #printHeader{ display:flex !important; }         /* 顯示列印頁首 */
    #phScore{ font-size:22px; font-weight:900; }
  }
  /* 列印頁首（平常隱藏、列印顯示） */
  #printHeader{display:none; align-items:center; justify-content:space-between; padding:12px 8px 16px; margin:0 8px 8px; border-bottom:1px solid #ddd; color:#111; background:#fff;}
  #phLeft{display:flex;align-items:center;gap:10px}
  #phLogo{width:26px;height:26px}
  #phTitle{font-weight:800}
  #phMeta{font-size:12px;color:#444;margin-top:2px}
  #phRight{text-align:right}
  #phScore{font-size:24px;font-weight:900}
  #phFeedback{font-size:12px;color:#444}
</style>
<!-- ===== PRINT SECTION END ===== -->


<style>
@media (max-width: 768px){
  .layout{ display:block !important; }
  .left,.right{ width:100% !important; max-width:100% !important; }
  #videoWrap,.videoWrap,.left video{ width:100% !important; }
  video,#player,#video{ width:100% !important; height:auto !important; object-fit:contain !important; background:#000; }
  .right{ display:block !important; min-height:40vh; }
  .tabs{ display:flex !important; position:sticky; top:0; z-index:40; background:#0f172a; padding:8px 10px; }
  #pane-sub{ display:block !important; }
  #pane-quiz,#pane-vocab{ display:none !important; }
  #controlsDrawer{
    position:sticky; bottom:0; z-index:50;
    margin:10px -10px -10px; padding:10px 12px; border-radius:14px 14px 0 0;
    background:#0e2038; border:1px solid #183459;
    transform:translateY(calc(100% - 24px));
    transition:transform .24s ease;
  }
  #controlsDrawer.open{ transform:translateY(0); }
  #drawerGrab,.drawer-grab{ display:block !important; cursor:pointer; }
  body.focus-mode .left{ display:none !important; }
  body.focus-mode .right{ display:block !important; width:100% !important; }
  #focusBack{
    position:fixed; right:12px; bottom:14px; z-index:9999;
    padding:10px 12px; border-radius:12px; border:1px solid #1f375f;
    background:#122340; color:#e6efff; display:none;
  }
  body.focus-mode #focusBack{ display:inline-block; }
}
</style>

<style>
/* ===== Print add-on (non-invasive): quiz copy page break ===== */
@media print{
  #quizPrintCopy{ page-break-before: always; }
  #quizPrintCopy button, #quizPrintCopy input, #quizPrintCopy .no-print{ display:none !important; }
}
</style>

<style>
/* ===== Dictionary hint underline ===== */
.dict-hint{ border-bottom:1px dotted #7cf; cursor:help; }
/* Safer hide for login button (multiple possible selectors) */
#btnLogin, .btn-login, [data-role="login"]{ display:none !important; }
</style>

<style>
/* ===== V2.4: More visible dotted underline for dictionary words ===== */
.dict-hint{
  text-decoration: underline dotted #7cf 2px;
  text-underline-offset: 2px;
  border-bottom: none !important;
  cursor: help;
}
/* high-contrast fallback for browsers without dotted support */
@supports not (text-decoration-style: dotted){
  .dict-hint{ border-bottom:1px dotted #7cf !important; }
}
</style>

<style>
/* ===== V2.5 Light Theme Overrides (safe, layered on top) ===== */
:root{
  --bg: #ffffff;
  --bg-soft: #f8fafc;
  --bg-elev: #f1f5f9;
  --text: #111827;
  --muted: #475569;
  --line: #d1d5db;
  --primary: #0f4c81;
  --primary-weak: #e6f0f8;
  --chip: #eef2ff;
}
html, body{ background: var(--bg) !important; color: var(--text) !important; }
.app, .layout, .left, .right, .pane, .panel, .card, .card-like{ background: var(--bg) !important; color: var(--text) !important; }
.container, .wrap, .content, .main{ background: var(--bg) !important; }

/* header / title bar */
.header, .topbar, #topbar, .navbar{ background: var(--bg-soft) !important; border-bottom:1px solid var(--line) !important; }

/* tabs */
.tabs{ background: var(--bg-soft) !important; border-bottom: 1px solid var(--line) !important; }
.tabs button, .tabs .tab{
  color: var(--text) !important; background: var(--chip) !important; border:1px solid var(--line) !important;
}
.tabs .active, .tabs [aria-selected="true"]{ background: #fff !important; border-bottom-color: var(--bg) !important; box-shadow: 0 0 0 1px var(--line) inset; }

/* tables */
table{ background:#fff !important; color:var(--text) !important; border-color: var(--line) !important; }
th, td{ border-color: var(--line) !important; }
thead th{ background: var(--bg-elev) !important; }
tbody tr:nth-child(even){ background: var(--bg-soft) !important; }
tbody tr:nth-child(odd){ background: #fff !important; }

/* controls drawer */
#controlsDrawer{
  background: var(--bg-soft) !important; color: var(--text) !important; border:1px solid var(--line) !important;
  box-shadow: 0 6px 14px rgba(0,0,0,.08) !important;
}
#drawerGrab, .drawer-grab{ background: var(--bg-elev) !important; border:1px solid var(--line) !important; }

/* buttons / chips */
button, .btn{ background:#fff; color:var(--text); border:1px solid var(--line); }
button:hover{ background: var(--bg-elev); }
.primary, .btn-primary{ background: var(--primary); color:#fff; border-color: var(--primary); }
.badge, .chip{ background: var(--chip); color: var(--text); border:1px solid var(--line); }

/* links */
a{ color: var(--primary); }
a:hover{ text-decoration: underline; }

/* tooltip for translation bubble */
#wordTip{
  background: #1f2937 !important;  /* dark bubble for contrast */
  color: #f8fafc !important;
  border: 1px solid #0b2947 !important;
}

/* dictionary hint underline on light background */
.dict-hint{
  text-decoration: underline dotted #0b3b6f 2px !important;
  text-underline-offset: 2px;
}

/* remove dark-only embellishments */
.hr, hr{ border-color: var(--line) !important; }

/* login button remains hidden */
#btnLogin, .btn-login, [data-role="login"]{ display:none !important; }
</style>

<style>
/* ===== V2.6: 強化虛線底線標示 ===== */
.dict-hint {
  position: relative;
  text-decoration: none !important;
  border-bottom: 1.5px dotted #0b3b6f;
  text-underline-offset: 2px;
  text-decoration-skip-ink: none;
  padding-bottom: 2px;
  cursor: help;
  transition: border-color 0.2s ease;
}
.dict-hint:hover {
  border-bottom-color: #2563eb; /* hover 時變亮藍 */
}
</style>

<style>
/* ===== V2.7: 全字幕單字可翻譯（英欄位逐字包裝） ===== */
.wtoken{
  text-decoration: none !important;
  border-bottom: 1px dotted #0b3b6f;
  text-underline-offset: 2px;
  text-decoration-skip-ink: none;
  padding-bottom: 1px;
  cursor: help;
  transition: border-color .15s ease;
}
.wtoken:hover{ border-bottom-color:#2563eb; }
</style>
</head>
<body>
<header>
  <h1>英語影片播放器</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <button id="btnLogin" class="btn">登入</button>
    <button id="btnLogout" class="btn" style="display:none">登出</button>
    <span id="userNameBadge" class="muted"></span>
  </div>
</header>

<div class="wrap">
  <div class="layout">
    <section class="left" id="videoContainer">
      <div id="videoWrap" class="videoWrap">
        <video id="player" playsinline controls></video>
      </div>

      <div class="controls" id="controlsDrawer">
        <div class="drawer-grab" id="drawerGrab">
          <div class="grab-bar" style="width:44px;height:4px;border-radius:4px;margin:0 auto 4px;background:#2b4a78;"></div>
          <div class="drawer-title" style="font-size:12px;color:#9fb0c9;">播放工具列（點擊展開/收合）</div>
        </div>
        <div class="row">
          <button id="btnPrev" class="btn">⏮ 上一句</button>
          <button id="btnPlay" class="btn">▶️ 播放 / 暫停</button>
          <button id="btnNext" class="btn">⏭ 下一句</button>
          <button id="btnReplay" class="btn">🔁 重複本句</button>
        </div>
        <div class="row">
          <label class="chip"><input id="chkFollow" type="checkbox"/> 跟隨</label>
          <span class="chip">偏移 <span id="offsetVal">0.0s</span></span>
          <button id="btnOffsetMinus" class="btn">-0.5s</button>
          <button id="btnOffsetPlus" class="btn">+0.5s</button>
          <button id="btnAutoSync" class="btn">🧭 簡易校準</button>
        </div>
        <div class="row speed">
          <span class="muted">速度</span>
          <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
          <span id="speedVal">1.00x</span>
        </div>
      </div>
    </section>

    <section class="right" id="studyContainer">
      <div class="tabs">
        <div class="tab active" data-tab="sub" id="tabSub">字幕</div>
        <div class="tab" data-tab="quiz">測驗</div>
        <div class="tab" data-tab="vocab">單字</div>
      </div>

      <!-- 列印頁首（列印時顯示） -->
      
<!-- ===== PRINT SECTION START (Do Not Modify) ===== -->
<div id="printHeader" aria-hidden="true">
        <div id="phLeft">
          <!-- 內嵌 SVG Logo -->
          <svg id="phLogo" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="2"></circle>
            <path d="M7 13h10M7 9h10M7 17h6" stroke="#111" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div>
            <div id="phTitle">BookWide · 英語影片測驗成績單</div>
<!-- ===== PRINT SECTION END ===== -->

            <div id="phMeta">
              影片：<span id="phSlug">-</span>　分區：<span id="phSection">-</span>　列印：<span id="phTime">-</span>
            </div>
          </div>
        </div>
        <div id="phRight">
          <div id="phScore">0 / 100</div>
          <div id="phFeedback">（0%）</div>
        </div>
      </div>

      <div class="pane">
        <div id="pane-sub">
          <div id="cuesStatus" class="muted" style="padding:10px 14px">（字幕載入中…）</div>
          <table>
            <thead><tr><th style="width:80px">時間</th><th>英文</th><th style="width:40%">中文</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div id="pane-quiz" style="display:none">
          <div class="quiz-shell">
            <div id="quizTabs" class="q-tabs" style="margin:6px 0 10px 0;">
              <button class="qtab on" data-sec="Vocabulary">單字</button>
              <button class="qtab" data-sec="Grammar">文法</button>
              <button class="qtab" data-sec="Reading">閱讀</button>
              <button class="qtab" data-sec="Mixed">綜合</button>
              <span id="quizMeta" class="muted" style="margin-left:12px">（測驗載入中…）</span>
            </div>
            <ol id="quizList" style="line-height:1.6"></ol>
            <div class="q-actions" style="margin:14px 0 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">交卷</button>
              <button class="btn" id="btnShowAnswer" style="display:none">顯示答案</button>
              <!-- 列印按鈕（常駐顯示於測驗區） -->
              <button class="btn" id="btnPrint" style="display:none">列印成績單</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
            <div id="quizResult" style="display:none;margin-top:10px"></div>
          </div>
        </div>

        <div id="pane-vocab" style="display:none">
          <div id="vocabStatus" class="muted" style="padding:10px 14px">( 單字載入中… )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ===== 播放器主程式 ===== -->

<!-- ===== PRINT SECTION START (Do Not Modify) ===== -->
<script>
/* ---------- 小工具 ---------- */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ---------- 參數 ---------- */
const params=new URLSearchParams(location.search);
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;

/* ---------- 資源載入（含回退） ---------- */
async function fetchWithFallback(p,f,kind){
  try{const r=await fetch(p,{cache:'no-store'}); if(!r.ok)throw 0; return {data:await r.json(),used:'primary'};}
  catch{ try{const r2=await fetch(f,{cache:'no-store'}); if(!r2.ok)throw 0; slug='mid-autumn'; return {data:await r2.json(),used:'fallback'};}
  catch(e2){ console.error(`[fatal] ${kind} 讀取失敗`,e2); return {data:null,used:'error'};}}
}

/* ---------- DOM ---------- */
const video=$('#player'); const cuesBody=$('#cuesBody'); const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnAutoSync=$('#btnAutoSync'); const btnPrint=$('#btnPrint');
const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;
function setOffset(v){offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset));}
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* ---------- 影片 & 字幕 ---------- */
async function loadVideo(){
  const src=s=>`./videos/${s}.mp4`;
  video.src=src(primarySlug);
  video.addEventListener('error',()=>{ video.src=src('mid-autumn'); },{once:true});
}
async function loadCues(){
  cuesStatus.textContent='（字幕載入中…）';
  const {data,used}=await fetchWithFallback(`./data/cues-${primarySlug}.json?v=${Date.now()}`,`./data/cues-mid-autumn.json?v=${Date.now()}`,'cues');
  if(!data){ cuesStatus.textContent='⚠️ 字幕讀取失敗'; return; }
  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}"><td class="muted" style="width:80px">${c.t?fmt(c.t):''}</td><td>${esc(c.en)}</td><td style="width:40%">${esc(c.zh)}</td></tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent=used==='fallback' ? '已載入字幕（mid-autumn 回退）' : `已載入字幕（${primarySlug}）`;
}
function currentIndex(){ const t=video.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }
function highlightRow(idx){ const trs=$$('#cuesBody tr'); trs.forEach(tr=>tr.classList.remove('active')); const tr=trs[idx]; if(!tr)return; tr.classList.add('active'); if(chkFollow.checked) tr.scrollIntoView({block:'center',behavior:'smooth'}); }
function seekTo(idx,play=true){ if(!cues[idx])return; video.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) video.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }

/* ---------- 測驗 ---------- */
async function loadQuiz(){
  const listEl=$('#quizList',paneQuiz), metaEl=$('#quizMeta',paneQuiz);
  const {data,used}=await fetchWithFallback(`./data/quiz-${primarySlug}.json?v=${Date.now()}`,`./data/quiz-mid-autumn.json?v=${Date.now()}`,'quiz');
  if(!data){ metaEl.textContent='⚠️ 題庫讀取失敗'; return; }

  let questions=[];
  if(Array.isArray(data)){
    questions=data.map(q=>({section:(q.section||'Mixed'),type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||q.q||'',options:q.options||q.choices||[],answer:q.answer??q.ans??''}));
  }else if(data.sections){
    const push=(sec,arr=[])=>arr?.forEach(q=>questions.push({section:sec,type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||'',options:q.options||[],answer:q.answer??''}));
    push('Vocabulary',data.sections.vocab); push('Grammar',data.sections.grammar);
    push('Reading',data.sections.reading); push('Mixed',data.sections.mixed);
  }
  metaEl.textContent=used==='fallback'?`已載入（mid-autumn 回退），共 ${questions.length} 題`:`已載入（${primarySlug}），共 ${questions.length} 題`;

  function renderSection(sec){
    const arr=questions.filter(q=>q.section===sec);
    if(!arr.length){ listEl.innerHTML='<li style="color:#9fb3ff">（此分區無題目）</li>'; return; }
    listEl.innerHTML=arr.map((q,i)=>{
      const idx=i+1;
      if(q.type==='MCQ'){
        const opts=q.options.map(opt=>`<label style="display:block;margin:4px 0"><input type="radio" name="q${sec}-${idx}" value="${String(opt)}"> ${String(opt)}</label>`).join('');
        return `<li data-type="MCQ" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><div>${opts}</div><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }else{
        return `<li data-type="SA" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><input type="text" placeholder="輸入答案…" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff"><button class="btn btn-check" style="margin-left:6px">檢查</button><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }
    }).join('');
    listEl.addEventListener('click',e=>{
      if(!e.target.classList.contains('btn-check'))return;
      const li=e.target.closest('li'); const ipt=li.querySelector('input');
      const ok=(ipt.value||'').trim().toLowerCase()===String(li.dataset.ans||'').trim().toLowerCase();
      const msg=li.querySelector('span.msg')||li.querySelector('.msg'); const exp=li.querySelector('.exp');
      msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; exp.textContent=ok?'':`正解：${li.dataset.ans}`;
    },{once:true});
  }
  $('#quizTabs').querySelectorAll('.qtab').forEach(b=>{ b.addEventListener('click',()=>{ $('#quizTabs').querySelectorAll('.qtab').forEach(x=>x.classList.remove('on')); b.classList.add('on'); renderSection(b.dataset.sec); }); });
  renderSection('Vocabulary');

  $('#btnSubmitQuiz').onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')]; if(!items.length)return;
    let got=0,total=items.length;
    items.forEach(li=>{
      const ans=String(li.dataset.ans||'').trim();
      if(li.dataset.type==='MCQ'){
        const sel=li.querySelector('input[type="radio"]:checked'); const user=sel?sel.value:''; const ok=user===ans;
        if(ok)got++; const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }else{
        const ipt=li.querySelector('input'); const ok=(ipt.value||'').trim().toLowerCase()===ans.toLowerCase(); if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }
    });
    const score=got*5, full=total*5;
    $('#quizScore').textContent=`本分區分數：${score} / ${full}`;
    $('#quizResult').style.display='block';
    $('#btnShowAnswer').style.display='inline-block';
    btnPrint.style.display='inline-block';
    // 更新列印頁首資訊
    updatePrintHeader(score, full);
  };
  $('#btnShowAnswer').onclick=()=>{ $('#quizList').querySelectorAll('li').forEach(li=>{ const exp=li.querySelector('.exp'); if(exp&&!exp.textContent) exp.textContent=`正解：${li.dataset.ans}`; }); };

  /* ===== 列印（使用強化過的 CSS；這裡只負責補上頁首資訊） ===== */
  function updatePrintHeader(score, full){
    const pct = full ? Math.round((score/full)*100) : 0;
    const words = pct>=90 ? '太強了！' : pct>=75 ? '很棒，繼續加油！' : pct>=60 ? '還可以，再練練會更好。' : '先別灰心！重作錯題、背關鍵字再試一次會更好。';
    $('#phSlug').textContent = slug;
    $('#phSection').textContent = $('#quizTabs .qtab.on')?.textContent?.trim() || 'Vocabulary';
    $('#phTime').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
    $('#phScore').textContent = `${score} / ${full}`;
    $('#phFeedback').textContent = `（${pct}%）${words}`;
  }
  // 讓 20 題完整顯示：其實題目本來就都在 DOM，中途不再動 display，交給 @media print 負責高度/分頁

  // 列印按鈕：開印前再保險抓一次分數（避免沒交卷也能印）
  btnPrint.onclick=()=>{
    let s=0,f=0;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f||100);
    window.print();
  };
  // 使用者直接 Ctrl+P 時也補頁首
  window.addEventListener('beforeprint',()=>{
    let s=0,f=100;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f);
  });
}

/* ---------- 字彙卡 ---------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const {data,used}=await fetchWithFallback(`./data/vocab-${primarySlug}.json?v=${Date.now()}`,`./data/vocab-mid-autumn.json?v=${Date.now()}`,'vocab');
  if(!data||!data.length){ vStatus.textContent='⚠️ 查無單字資料'; vBox.innerHTML=''; return; }
  vStatus.textContent=used==='fallback'?'已載入單字（mid-autumn 回退）':`已載入單字（${primarySlug}）`;
  const go=t=>{ const p=toSec(t); video.currentTime=Math.max(0,p); video.play(); };
  vBox.innerHTML=data.map(v=>`<div class="voc"><div class="voc-h"><div class="voc-word">${esc(v.word||'')}</div><div class="voc-pos">${esc(v.pos||'')}</div></div>${v.zh?`<div class="voc-zh">${esc(v.zh)}</div>`:''}${v.en?`<div class="voc-en">${esc(v.en)}</div>`:''}<div class="voc-actions">${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">跳到片段</button>`:''}<button class="btn" data-act="speak" data-text="${esc(v.word||v.en||'')}">🔊 朗讀</button></div></div>`).join('');
  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump')go(e.target.dataset.time||0);
    if(act==='speak'){ try{ const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  });
}

/* ---------- 控制 ---------- */
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(video.paused) video.play(); else video.pause(); });
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));

video.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=video.currentTime+offset; if(t>=e-0.02){ video.currentTime=Math.max(0,s-offset+0.0001); video.play(); } } });

(function(){ const drawer=$('#controlsDrawer'),grab=$('#drawerGrab'); if(!drawer||!grab)return; const toggle=()=>drawer.classList.toggle('open'); grab.addEventListener('click',toggle); })();

function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ---------- 初始化 ---------- */
(async function init(){
  // 播放參數
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;

  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab();
  showTab('sub');
})();
</script>
<!-- ===== PRINT SECTION END ===== -->


<!-- ===== Supabase 守門 & 觀看紀錄 ===== -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://qtgwedankftrqjmzuset.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 必須登入
  const { data: authData, error: authErr } = await supabase.auth.getUser();
  if (authErr || !authData?.user) {
    alert("請先登入後再觀看影片。");
    location.href = "index.html";
  } else {
    const user = authData.user;
    const videoSlug = new URLSearchParams(location.search).get("slug") || "mid-autumn";

    // 第一次播放寫一筆紀錄
    let hasLogged = false;
    const logOnce = async () => {
      if (hasLogged) return;
      hasLogged = true;
      try {
        await supabase.from("watch_logs").insert({
          user_id: user.id,
          email: user.email,
          video_slug: videoSlug
          // viewed_at 交給 DB default now()
        });
      } catch (e) {
        console.warn("watch_logs 寫入失敗：", e?.message || e);
      }
    };
    document.getElementById("player")?.addEventListener("play", logOnce, { once: true });
  }
</script>

<button id="focusBack" type="button" aria-label="返回">返回</button>


<script>
(() => {
  const urlp = new URLSearchParams(location.search);
  const forceMobile = urlp.get('m') === '1';
  const isMobile = forceMobile || window.matchMedia('(max-width: 768px)').matches;
  const $ = (s, r=document)=>r.querySelector(s);
  const on = (el, ev, fn, opt)=>el && el.addEventListener(ev, fn, opt);

  function enterFocus(){ if(!isMobile) return; document.body.classList.add('focus-mode'); }
  function exitFocus(){ document.body.classList.remove('focus-mode'); }

  function initMobileDefault(){
    if (!isMobile) return;
    const drawer = $('#controlsDrawer');
    const grab = $('#drawerGrab') || document.querySelector('.drawer-grab');
    if (drawer){ drawer.classList.remove('open'); }
    if (grab){ on(grab, 'click', () => drawer.classList.toggle('open'), {passive:true}); }

    if (typeof showTab === 'function') showTab('sub');
    else {
      const sub=$('#pane-sub'), q=$('#pane-quiz'), v=$('#pane-vocab');
      if(sub){ sub.hidden=false; sub.style.display='block'; }
      if(q){ q.hidden=true; q.style.display='none'; }
      if(v){ v.hidden=true; v.style.display='none'; }
    }

    document.body.classList.remove('focus-mode');

    const chk = $('#chkFollow');
    if (chk){ chk.checked = false; chk.disabled = true; chk.closest('label')?.setAttribute('title','手機版暫不提供此功能'); }
  }

  function bindTabsToFocus(){
    on($('#tabSub'),  'click', ()=>enterFocus());
    on($('#tabQuiz'), 'click', ()=>enterFocus());
    on($('#tabVocab'),'click', ()=>enterFocus());
  }

  function bindBack(){
    on($('#focusBack'), 'click', ()=>exitFocus());
  }

  document.addEventListener('DOMContentLoaded', () => {
    initMobileDefault();
    bindTabsToFocus();
    bindBack();
  });
})();
</script>

<style>
#wordTip {
  position: absolute;
  background: rgba(15,23,42,0.95);
  color: #fff;
  border: 1px solid #1f375f;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  z-index: 9999;
  display: none;
  max-width: 80%;
  line-height: 1.4;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
</style>
<div id="wordTip"></div>


<script>
(()=>{
  const tip = document.getElementById('wordTip');
  const isMobile = window.matchMedia('(max-width: 768px)').matches;

  async function translateWord(word){
    const dict = { love:'愛', dream:'夢想', moon:'月亮', blood:'血液', hope:'希望', life:'生命', happy:'快樂', sad:'悲傷', sun:'太陽', world:'世界' };
    return dict[word.toLowerCase()] || '(暫無翻譯)';
  }

  function showTip(x, y, text){
    tip.textContent = text;
    tip.style.left = `${x}px`;
    tip.style.top = `${y-40}px`;
    tip.style.display = 'block';
  }

  function hideTip(){ tip.style.display = 'none'; }

  document.addEventListener('click', async (e)=>{
    if (!document.body.classList.contains('focus-mode')) return; // only in reading mode
    const sel = window.getSelection();
    const word = sel.toString().trim();
    if (word && word.split(/\s+/).length === 1 && /^[a-zA-Z'-]+$/.test(word)){
      const meaning = await translateWord(word);
      showTip(e.pageX, e.pageY, `${word}：${meaning}`);
    } else {
      hideTip();
    }
  });

  document.addEventListener('scroll', hideTip);
  document.addEventListener('touchstart', (e)=>{
    if (!document.body.classList.contains('focus-mode')) return;
    const sel = window.getSelection();
    const word = sel.toString().trim();
    if (word && word.split(/\s+/).length === 1 && /^[a-zA-Z'-]+$/.test(word)){
      translateWord(word).then((meaning)=>showTip(e.touches[0].pageX, e.touches[0].pageY, `${word}：${meaning}`));
    } else {
      hideTip();
    }
  });
})();
</script>

<script>
// ===== Print augmentation: attach quiz section to printout safely (runtime only) =====
(function(){
  function $(s, r){ return (r||document).querySelector(s); }
  function $all(s, r){ return Array.from((r||document).querySelectorAll(s)); }

  function getReportContainer(){
    return $("#print-area") || $("#reportContainer") || $("#report") || document.body;
  }
  function getQuizSection(){
    // Prefer explicit quiz pane if exists
    return $("#pane-quiz") || $(".quiz-section") || $(".pane-quiz");
  }

  function sanitizeForPrint(root){
    // remove interactive controls
    $all("button, input, .no-print, [contenteditable]", root).forEach(el=>{
      el.remove();
    });
    // expand details/accordions if any
    $all("details", root).forEach(d=>{ d.open = true; });
  }

  function buildQuizHeading(){
    const h = document.createElement("h3");
    h.textContent = "📘 測驗題目（共 20 題）";
    h.style.margin = "10px 0 12px";
    h.style.fontWeight = "600";
    return h;
  }

  function handleBeforePrint(){
    const report = getReportContainer();
    const quiz = getQuizSection();
    if (!report || !quiz) return;
    if (document.getElementById("quizPrintCopy")) return;

    // Deep clone to avoid mutating live UI
    const copy = quiz.cloneNode(true);
    copy.id = "quizPrintCopy";

    // If the quiz content is virtualized or needs activation, try to reveal hidden panes
    // Show quiz pane content blocks if they use hidden/display:none attributes
    $all("[hidden]", copy).forEach(n => n.hidden = false);
    $all('[style*="display:none"]', copy).forEach(n => n.style.display = "block");

    // Sanitize
    sanitizeForPrint(copy);
    copy.prepend(buildQuizHeading());

    // Append to the end of the report for printing
    report.appendChild(copy);
  }

  function handleAfterPrint(){
    const copy = document.getElementById("quizPrintCopy");
    if (copy) copy.remove();
  }

  if (window.matchMedia){
    const mql = window.matchMedia("print");
    if (mql.addListener){ // older browsers
      mql.addListener(function(e){ if (e.matches) handleBeforePrint(); else handleAfterPrint(); });
    }
  }
  window.addEventListener("beforeprint", handleBeforePrint);
  window.addEventListener("afterprint", handleAfterPrint);
})();
</script>

<script>
(()=>{
  const tip = document.getElementById('wordTip');
  if (!tip) return;

  // ===== Utilities =====
  const delay = (ms)=>new Promise(r=>setTimeout(r, ms));
  const isWord = (s)=>/^[A-Za-z][A-Za-z'\-]*$/.test(s||"");
  const clamp = (n,min,max)=>Math.max(min, Math.min(max,n));

  function atViewportWord(x, y){
    const d = document;
    const caret = (d.caretPositionFromPoint && d.caretPositionFromPoint(x,y)) ||
                  (d.caretRangeFromPoint && d.caretRangeFromPoint(x,y));
    let node, offset;
    if (!caret) return null;
    if (caret.offsetNode) { node = caret.offsetNode; offset = caret.offset; }
    else { node = caret.getClientRects ? caret.startContainer : null; offset = caret.startOffset; }
    if (!node) return null;
    if (node.nodeType !== 3){ // not text node -> try child text
      node = node.childNodes && node.childNodes[0];
      if (!node || node.nodeType !== 3) return null;
      offset = 0;
    }
    const text = node.textContent || "";
    if (!text.trim()) return null;
    // expand around offset to word boundaries
    let i = offset, L = text.length;
    let s = i, e = i;
    const isLetter = c => /[A-Za-z'\-]/.test(c);
    while (s>0 && isLetter(text[s-1])) s--;
    while (e<L && isLetter(text[e])) e++;
    const word = text.slice(s,e).trim();
    if (!isWord(word)) return null;
    // compute position near selection
    const range = document.createRange();
    range.setStart(node, s);
    range.setEnd(node, e);
    const rect = range.getBoundingClientRect();
    return {word, rect};
  }

  function placeTipNearRect(rect){
    const pad = 8;
    const top = rect.top + window.scrollY - tip.offsetHeight - 10;
    const left = clamp(rect.left + window.scrollX, 8, window.scrollX + document.documentElement.clientWidth - tip.offsetWidth - 8);
    tip.style.top = (top<window.scrollY ? (rect.bottom + window.scrollY + 10) : top) + "px";
    tip.style.left = left + "px";
  }

  async function translateWord(word){
    // Local fallback dictionary; can be replaced with AI call later
    const dict = { love:'愛', dream:'夢想', moon:'月亮', sun:'太陽', world:'世界', festival:'節日', round:'圓形的', brave:'勇敢的', mountain:'山', arrow:'箭' };
    return dict[word.toLowerCase()] || '(暫無翻譯)';
  }

  function showTip(rect, word, meaning){
    tip.innerHTML = `<span class="w">${word}</span><span class="p">：${meaning}</span>`;
    tip.style.display = 'block';
    // need size to place precisely
    requestAnimationFrame(()=>placeTipNearRect(rect));
  }

  function hideTip(){ tip.style.display='none'; }

  // ===== Hover (desktop) with small delay =====
  let hoverTimer = null, lastWord=null;
  document.addEventListener('mousemove', (e)=>{
    if (hoverTimer) clearTimeout(hoverTimer);
    hoverTimer = setTimeout(async ()=>{
      const hit = atViewportWord(e.clientX, e.clientY);
      if (!hit){ hideTip(); return; }
      if (lastWord === hit.word && tip.style.display==='block') return;
      lastWord = hit.word;
      const meaning = await translateWord(hit.word);
      showTip(hit.rect, hit.word, meaning);
    }, 300);
  });

  document.addEventListener('mouseout', (e)=>{
    // if leaving the document/body
    if (!e.relatedTarget) hideTip();
  });

  // ===== Touch long-press (mobile) =====
  let pressTimer=null, startXY=null;
  document.addEventListener('touchstart', (e)=>{
    startXY = {x:e.touches[0].clientX, y:e.touches[0].clientY};
    pressTimer = setTimeout(async ()=>{
      const hit = atViewportWord(startXY.x, startXY.y);
      if (!hit){ hideTip(); return; }
      const meaning = await translateWord(hit.word);
      showTip(hit.rect, hit.word, meaning);
    }, 400);
  }, {passive:true});
  document.addEventListener('touchmove', ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } hideTip(); }, {passive:true});
  document.addEventListener('touchend',  ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
  document.addEventListener('scroll', hideTip, {passive:true});

  // Also hide on print
  window.addEventListener('beforeprint', hideTip);
})();
</script>

<script>
(()=>{
  // ===== Dotted underline for words we have translations for =====
  const DICT = { 
    love:'愛', dream:'夢想', moon:'月亮', sun:'太陽', world:'世界',
    festival:'節日', round:'圓形的', brave:'勇敢的', mountain:'山', arrow:'箭',
    day:'天', people:'人們', happy:'快樂的', hot:'炎熱的', help:'幫助'
  };

  const WORDS = Object.keys(DICT).sort((a,b)=>b.length-a.length); // long first
  const WORD_RE = new RegExp("\\\\b(" + WORDS.map(w=>w.replace(/[-/\\\\^$*+?.()|[\\]{}]/g,"\\\\$&")).join("|") + ")\\\\b", "gi");

  // Containers likely holding English text (subtitles table, quiz, etc.)
  const TARGET_SELECTORS = [
    "#pane-sub", "#pane-quiz", "#pane-vocab", ".right", ".subs", ".subtitle-table", "table"
  ];

  function wrapHintsInNode(node){
    if (!node || node.nodeType !== 3) return;
    const txt = node.nodeValue;
    if (!txt || !WORD_RE.test(txt)) { WORD_RE.lastIndex = 0; return; }
    WORD_RE.lastIndex = 0;
    const htmlFrag = txt.replace(WORD_RE, (m)=>`<span class="dict-hint" data-w="${m}">${m}</span>`);
    const span = document.createElement("span");
    span.innerHTML = htmlFrag;
    node.parentNode.replaceChild(span, node);
  }

  function walkAndWrap(root){
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(n){
        if (!n.nodeValue || !n.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
        // skip inside scripts/styles
        const p = n.parentElement; 
        if (!p) return NodeFilter.FILTER_REJECT;
        const tn = p.tagName;
        if (tn === "SCRIPT" || tn === "STYLE" || tn === "BUTTON" || tn === "A") return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);
    nodes.forEach(wrapHintsInNode);
  }

  function applyHints(){
    TARGET_SELECTORS.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>walkAndWrap(el));
    });
  }

  // Initial apply after DOM ready (delay to allow content rendering)
  document.addEventListener("DOMContentLoaded", ()=>{
    setTimeout(applyHints, 150);
    // Observe dynamic subtitle updates
    const obsTargets = new Set();
    TARGET_SELECTORS.forEach(sel=>document.querySelectorAll(sel).forEach(el=>obsTargets.add(el)));
    obsTargets.forEach(el=>{
      const mo = new MutationObserver((muts)=>{
        let need=false;
        for (const m of muts){ if (m.addedNodes && m.addedNodes.length){ need=true; break; } }
        if (need) setTimeout(applyHints, 50);
      });
      mo.observe(el, {childList:true, subtree:true});
    });
  });

  // ===== Hide login button by text as well (fallback) =====
  function hideLoginByText(){
    Array.from(document.querySelectorAll("button, a")).forEach(el=>{
      const t = (el.textContent||"").trim();
      if (t === "登入" || t.toLowerCase() === "login"){
        el.style.display = "none";
        el.classList.add("no-print");
      }
    });
  }
  document.addEventListener("DOMContentLoaded", hideLoginByText);

  // Tooltip behavior already exists from previous version; no change needed.
})();
</script>

<script>
// ===== V2.4: Robust dictionary hint marker with global observer & debouncing =====
(()=>{
  const DICT = { 
    love:'愛', dream:'夢想', moon:'月亮', sun:'太陽', world:'世界',
    festival:'節日', round:'圓形的', brave:'勇敢的', mountain:'山', arrow:'箭',
    day:'天', people:'人們', happy:'快樂的', hot:'炎熱的', help:'幫助'
  };
  const WORDS = Object.keys(DICT).sort((a,b)=>b.length-a.length);
  if (!WORDS.length) return;

  const ESC = s => s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
  const WORD_RE = new RegExp("\\\\b(" + WORDS.map(ESC).join("|") + ")\\\\b", "gi");

  const TARGET_SELECTORS = [
    "#pane-sub", "#pane-quiz", "#pane-vocab",
    ".subtitle-table", ".subs", ".right", "table"
  ];

  function shouldSkipNode(n){
    if (!n || n.nodeType !== 3) return true;
    if (!n.nodeValue || !n.nodeValue.trim()) return true;
    const p = n.parentElement;
    if (!p) return true;
    const tn = p.tagName;
    if (/^(SCRIPT|STYLE|CODE|PRE)$/i.test(tn)) return true;
    if (p.closest('.dict-hint')) return true; // already wrapped
    return false;
  }

  function wrapHintsInTextNode(node){
    if (shouldSkipNode(node)) return;
    const txt = node.nodeValue;
    if (!WORD_RE.test(txt)){ WORD_RE.lastIndex = 0; return; }
    WORD_RE.lastIndex = 0;
    const fragHTML = txt.replace(WORD_RE, (m)=>`<span class="dict-hint" data-w="${m}">${m}</span>`);
    const span = document.createElement('span');
    span.innerHTML = fragHTML;
    node.parentNode.replaceChild(span, node);
  }

  function walkAndWrap(root){
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const list = [];
    while (walker.nextNode()) list.push(walker.currentNode);
    list.forEach(wrapHintsInTextNode);
  }

  function applyHints(){
    const roots = new Set();
    TARGET_SELECTORS.forEach(sel => document.querySelectorAll(sel).forEach(el => roots.add(el)));
    if (roots.size === 0) return;
    roots.forEach(walkAndWrap);
  }

  // Debounce helper
  let timer = null;
  function scheduleApply(){ if (timer) cancelAnimationFrame(timer); timer = requestAnimationFrame(applyHints); }

  // Initial
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(applyHints, 150);
    // Global observer to catch late content
    const mo = new MutationObserver(()=>scheduleApply());
    mo.observe(document.body, {childList:true, subtree:true});
  });
})();
</script>

<script>
// ===== V2.7 全字幕單字可翻譯：英欄位逐字標記 + 懸停/長按顯示翻譯 =====
(()=>{
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const tip = document.getElementById('wordTip');
  if (!tip) return;

  function translateWordLocal(w){
    const dict = { love:'愛', dream:'夢想', moon:'月亮', sun:'太陽', world:'世界', festival:'節日', round:'圓形的', brave:'勇敢的', mountain:'山', arrow:'箭' };
    return dict[w.toLowerCase()] || '(暫無翻譯)';
  }

  function showTipNear(el, word, meaning){
    tip.innerHTML = `<span class="w">${word}</span><span class="p">：${meaning}</span>`;
    tip.style.display = 'block';
    const r = el.getBoundingClientRect();
    const x = r.left + window.scrollX;
    const y = r.top + window.scrollY - tip.offsetHeight - 8;
    tip.style.left = Math.max(8, Math.min(x, window.scrollX + document.documentElement.clientWidth - tip.offsetWidth - 8)) + 'px';
    tip.style.top  = (y < window.scrollY ? (r.bottom + window.scrollY + 8) : y) + 'px';
  }
  function hideTip(){ tip.style.display='none'; }

  // 1) 將字幕表中的「英文欄」逐字包裝成 .wtoken
  function wrapSubtitleEnglishWords(){
    const sub = $('#pane-sub');
    if (!sub) return;
    const table = sub.querySelector('table');
    if (!table) return;
    const ths = $$('thead th', table);
    let enIdx = -1;
    ths.forEach((th,i)=>{
      const t = (th.textContent||'').trim().toLowerCase();
      if (t.includes('英文') || t.includes('english')) enIdx = i;
    });
    if (enIdx === -1) return;
    $$('tbody tr', table).forEach(tr=>{
      const tds = $$('td', tr);
      if (!tds[enIdx]) return;
      tokenizeCell(tds[enIdx]);
    });
  }

  function tokenizeCell(cell){
    const walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT);
    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);
    nodes.forEach(n=>{
      const text = n.nodeValue;
      if (!text || !text.trim()) return;
      const parts = text.split(/(\b[A-Za-z][A-Za-z'-]*\b)/g);
      if (parts.length<=1) return;
      const frag = document.createDocumentFragment();
      parts.forEach(p=>{
        if (/^\b[A-Za-z][A-Za-z'-]*\b$/.test(p)){
          const span = document.createElement('span');
          span.className = 'wtoken';
          span.textContent = p;
          frag.appendChild(span);
        }else{
          frag.appendChild(document.createTextNode(p));
        }
      });
      n.parentNode.replaceChild(frag, n);
    });
  }

  // 2) 懸停/長按事件（覆用本地小字典；後續可接 AI）
  function bindHoverAndTouch(){
    document.addEventListener('mouseover', (e)=>{
      const t = e.target.closest('.wtoken');
      if (!t){ hideTip(); return; }
      const w = t.textContent.trim();
      const m = translateWordLocal(w);
      showTipNear(t, w, m);
    });
    document.addEventListener('mouseout', (e)=>{
      if (e.relatedTarget && e.relatedTarget.closest && e.relatedTarget.closest('#wordTip')) return;
      const t = e.target.closest('.wtoken');
      if (t) hideTip();
    });
    let pressTimer=null, touchTarget=null;
    document.addEventListener('touchstart', (e)=>{
      const t = e.target.closest('.wtoken'); if (!t) return;
      touchTarget = t;
      pressTimer = setTimeout(()=>{
        const w = t.textContent.trim();
        const m = translateWordLocal(w);
        showTipNear(t, w, m);
      }, 400);
    }, {passive:true});
    document.addEventListener('touchend', ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
    document.addEventListener('touchmove', ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; hideTip(); } }, {passive:true});
    document.addEventListener('scroll', hideTip, {passive:true});
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // 初次標記
    wrapSubtitleEnglishWords();
    // 監聽字幕表變動（例如載入其他字幕）
    const sub = $('#pane-sub');
    if (sub){
      const mo = new MutationObserver(()=>wrapSubtitleEnglishWords());
      mo.observe(sub, {childList:true, subtree:true});
    }
    bindHoverAndTouch();
  });
})();
</script>
</body>
</html>






































