<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  /* å…©æ¬„ 50/50 ç‰ˆé¢ */
  .app{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);height:100vh;min-height:100vh;}
  @media(max-width:1024px){ .app{grid-template-columns:1fr; height:auto; min-height:auto;} }

  /* å·¦æ¬„ï¼šå½±ç‰‡ä¸Š + å·¥å…·åˆ—ä¸‹ï¼ˆå·¥å…·åˆ—é»åº•ï¼‰ */
  .videoCol{display:flex;flex-direction:column;min-width:0;height:100%;padding:8px 8px 0 8px;}
  .videoBox{
    background:#000;border-radius:12px;border:1px solid var(--border);
    overflow:hidden; width:100%;
    /* æ ¸å¿ƒï¼šå›ºå®šç­‰æ¯”ï¼Œä¸å†äº‚ç¸® */
    aspect-ratio:16/9; 
    position:relative;
  }
  .videoBox video{
    width:100%;height:100%;object-fit:contain;background:#000;
    transform:scale(var(--zoom,1));
    transform-origin:center center;
  }
  .toolDock{
    position:sticky; bottom:0; z-index:5;
    margin-top:8px; padding:10px 12px;
    background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,.75) 30%, rgba(11,19,36,.95));
    border-top:1px solid var(--border);
    backdrop-filter: blur(4px);
  }
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px; border-radius:10px;
    background:#15224a;border:1px solid var(--border);color:#fff;cursor:pointer;
    user-select:none;
  }
  .btn:active{transform:translateY(1px)}
  .btn.on{box-shadow:0 0 0 2px #2d7bff66 inset}
  .seg{display:flex;align-items:center;gap:8px}
  .seg label{color:var(--muted);font-size:13px}
  .seg input[type="range"]{width:180px}
  .seg .val{min-width:44px;text-align:right}

  /* å³æ¬„ç¶­æŒåŸæ¨£ */
  .side{display:flex;flex-direction:column;background:var(--panel);border-left:1px solid var(--border);}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .chip{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}
  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .line{line-height:1.6;margin:6px 0;padding:3px 6px;border-radius:8px}
  .line.active{background:#1a274e}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:6px}

  .light{--bg:#f7f8fb;--panel:#ffffff;--border:#e4e7f0;--text:#222;--muted:#667}
  .light .side{background:#fff}
  .light .chip{background:#f4f6fb}
  .light .videoBox{background:#111;border-color:#e4e7f0}
  .light .toolDock{background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.9))}
  .light .btn{background:#f4f6fb;color:#222;border-color:#e4e7f0}
</style>
</head>
<body>
<div class="app">

  <!-- å·¦ï¼šå½±ç‰‡ + å·¥å…·åˆ— -->
  <section class="videoCol">
    <div class="videoBox">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- å·¥å…·åˆ—å›ºå®šåœ¨å·¦æ¬„åº•éƒ¨ -->
    <div class="toolDock">
      <div class="bar">
        <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
        <button class="btn" id="btnPlay">â¯ æ’­æ”¾</button>
        <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
        <button class="btn" id="btnReplay">ğŸ” é‡æ–°æœ¬å¥</button>

        <button class="btn" id="btnAB">ğŸ…°ğŸ…± é»å¥å³å¾ªç’°</button>
        <button class="btn" id="btnClearAB">â›” å–æ¶ˆå¾ªç’°</button>
        <button class="btn" id="btnAutoPause">ğŸ›‘ é€å¥è‡ªå‹•æš«åœ</button>
        <button class="btn" id="btnLoopAll">ğŸ” æ•´æ®µå¾ªç’°</button>
        <button class="btn" id="btnFit">ğŸ–¼ é©æ‡‰ç•«é¢</button>

        <span class="seg">
          <label>è®Šç„¦</label>
          <input type="range" min="100" max="200" value="100" id="zoomRange">
        </span>
        <span class="seg">
          <label>é€Ÿåº¦</label>
          <input type="range" min="50" max="200" value="100" id="speedRange">
          <span class="val" id="speedVal">1.00Ã—</span>
        </span>
      </div>
    </div>
  </section>

  <!-- å³ï¼šå­—å¹•/æ¸¬é©—ï¼ˆç¶­æŒä½ åŸä¾†çš„æ¶æ§‹ï¼‰ -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
    </div>

    <div class="toolbar">
      <span class="muted">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnTheme" class="chip">ä¸»é¡Œ</button>
      <button id="btnFollow" class="chip on">è·Ÿéš¨</button>
    </div>

    <div id="panelTranscript" class="panel"></div>

    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="muted" id="quizProgress">0 / 0</div>
      <div id="quizResult" class="muted" style="margin-top:8px;"></div>
    </div>
  </aside>
</div>

<script>
/* ---------- å°å·¥å…· ---------- */
const $ =(s,root=document)=>root.querySelector(s);
const $$=(s,root=document)=>[...root.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* ç‹€æ…‹ */
let CUES = [];          // [{t:ç§’, time:"MM:SS", text:"..."} ...]
let A = null, B = null; // AB å¾ªç’°é»
let AUTO_PAUSE = false; // é€å¥æš«åœ
let FOLLOW = true;      // å³æ¬„è·Ÿéš¨
let FIT = 'contain';    // contain/cover
let ZOOM = 1;

/* ---------- å­—ç´š ---------- */
function setFont(size){
  const map = {S:'13px',M:'15px',L:'17px'};
  $$('#panelTranscript, #panelQuiz').forEach(el=> el.style.fontSize = map[size]);
  $$('.chip').forEach(c=>c.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* ---------- è¼‰å…¥ index / cues / quiz ---------- */
async function loadMeta(){
  const r = await fetch('data/index.json');
  if(!r.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await r.json();
  const item = (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item;
}
const toSec = (mmss='0:0')=>{
  const [m,s] = mmss.split(':').map(n=>parseInt(n,10)||0); return m*60+s;
};
async function loadCues(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('cues è¼‰å…¥å¤±æ•—');
  const raw = await r.json();
  const list = Array.isArray(raw)? raw : (raw.items||raw.lines||[]);
  return list.map(x=>{
    const time = x.time || x.t || x.start || '0:00';
    const text = x.text || x.caption || x.en || '';
    return {t:toSec(time), time, text};
  }).sort((a,b)=>a.t-b.t);
}

/* ---------- æ¸²æŸ“å­—å¹• ---------- */
function renderTranscript(){
  const box = $('#panelTranscript'); box.innerHTML='';
  CUES.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className = 'line';
    div.dataset.idx = i;
    div.innerHTML = `<span class="time">[${c.time}]</span>${c.text}`;
    div.onclick = ()=>{ const v=$('#player'); v.currentTime=c.t; v.play(); };
    box.appendChild(div);
  });
}

/* é«˜äº® + æ²å‹•å°é½Š */
let lastActive = -1;
function highlightAt(t){
  // æ‰¾ <= t æœ€æ¥è¿‘çš„è¡Œ
  let idx = 0;
  for(let i=0;i<CUES.length;i++){ if(CUES[i].t<=t) idx=i; else break; }
  if(idx!==lastActive){
    if(lastActive>=0){
      const prev = $(`.line[data-idx="${lastActive}"]`); prev && prev.classList.remove('active');
    }
    const cur = $(`.line[data-idx="${idx}"]`);
    if(cur){
      cur.classList.add('active');
      if(FOLLOW){
        const p = $('#panelTranscript');
        const top = cur.offsetTop - p.clientHeight*0.35;
        p.scrollTo({top,behavior:'smooth'});
      }
    }
    lastActive = idx;
  }
}

/* ---------- å·¥å…·åˆ—åŠŸèƒ½ ---------- */
function cueIndexFrom(t){
  let idx = 0;
  for(let i=0;i<CUES.length;i++){ if(CUES[i].t<=t) idx=i; else break; }
  return idx;
}
function prevCue(){
  const v=$('#player');
  const idx = cueIndexFrom(v.currentTime);
  const to = Math.max(0, idx-1);
  v.currentTime = CUES[to]?.t || 0;
}
function nextCue(){
  const v=$('#player');
  const idx = cueIndexFrom(v.currentTime);
  const to = Math.min(CUES.length-1, idx+1);
  v.currentTime = CUES[to]?.t || v.currentTime;
}
function replayCue(){
  const v=$('#player');
  const idx = cueIndexFrom(v.currentTime);
  v.currentTime = CUES[idx]?.t || 0;
  v.play();
}

function toggleBtn(el, on){
  el.classList.toggle('on', !!on);
}

/* ---------- å•Ÿå‹• ---------- */
(async ()=>{
  try{
    // å³æ¬„å­—ç´š/ä¸»é¡Œ/è·Ÿéš¨
    $('#fS').onclick = ()=> setFont('S');
    $('#fM').onclick = ()=> setFont('M');
    $('#fL').onclick = ()=> setFont('L');
    $('#btnTheme').onclick = ()=> document.body.classList.toggle('light');
    $('#btnFollow').onclick = (e)=>{ FOLLOW=!FOLLOW; toggleBtn(e.currentTarget,FOLLOW); };
    setFont('M');

    // è¼‰å…¥ meta + è¨­å®šå½±ç‰‡
    const meta = await loadMeta();
    const v = $('#player');
    v.src = meta.video;           // videos/xxx.mp4
    CUES = await loadCues(meta.cues);
    renderTranscript();

    // å·¥å…·åˆ—ç¹«çµ
    $('#btnPrev').onclick  = prevCue;
    $('#btnNext').onclick  = nextCue;
    $('#btnReplay').onclick= replayCue;

    $('#btnPlay').onclick = ()=>{
      const v=$('#player'); v.paused? v.play(): v.pause();
      $('#btnPlay').textContent = v.paused? 'â–¶ï¸ æ’­æ”¾' : 'â¸ æš«åœ';
    };

    let abWaiting = false;
    $('#btnAB').onclick = ()=>{
      if(A==null){ A = v.currentTime; abWaiting = true; toggleBtn($('#btnAB'), true); }
      else if(B==null){ B = Math.max(v.currentTime, A+0.1); abWaiting = false; }
      else{ A = v.currentTime; B = null; abWaiting = true; }
    };
    $('#btnClearAB').onclick = ()=>{ A=B=null; abWaiting=false; toggleBtn($('#btnAB'), false); };

    $('#btnAutoPause').onclick = (e)=>{ AUTO_PAUSE=!AUTO_PAUSE; toggleBtn(e.currentTarget, AUTO_PAUSE); };
    $('#btnLoopAll').onclick    = (e)=>{ v.loop = !v.loop; toggleBtn(e.currentTarget, v.loop); };

    $('#btnFit').onclick = ()=>{
      FIT = (FIT==='contain')? 'cover' : 'contain';
      $('#player').style.objectFit = FIT;
      $('#btnFit').classList.toggle('on', FIT==='cover');
    };

    // è®Šç„¦/é€Ÿåº¦
    $('#zoomRange').addEventListener('input', e=>{
      ZOOM = (e.target.value|0)/100;
      document.documentElement.style.setProperty('--zoom', ZOOM);
    });
    $('#speedRange').addEventListener('input', e=>{
      const rate = (e.target.value|0)/100;
      v.playbackRate = rate;
      $('#speedVal').textContent = rate.toFixed(2)+'Ã—';
    });

    // timeupdateï¼šé«˜äº® + ABå¾ªç’° + é€å¥æš«åœ
    v.addEventListener('timeupdate', ()=>{
      const t = v.currentTime;
      highlightAt(t);

      // AB loop
      if(A!=null && B!=null){
        if(t>=B-0.02) v.currentTime = A;
      }

      // è‡ªå‹•æš«åœï¼ˆé€²ä¸‹ä¸€å¥çš„ç¬é–“æš«åœï¼‰
      if(AUTO_PAUSE){
        const idx = cueIndexFrom(t);
        const next = CUES[idx+1];
        if(next && Math.abs(t-next.t)<0.06){ v.pause(); }
      }
    });

  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
  }
})();
</script>
</body>
</html>
