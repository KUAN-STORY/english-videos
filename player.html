<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;}

  /* 兩欄：左影片 / 右面板 = 50 / 50 */
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);height:100vh;}
  @media(max-width:1024px){
    .layout{grid-template-columns:1fr;height:auto;grid-template-rows:auto auto;}
  }

  /* 左：影片舞台 + 底部工具列（固定看得到） */
  .videoColumn{display:grid;grid-template-rows:1fr auto;min-height:0;border-right:1px solid var(--border);}
  .videoStage{min-height:0;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden;}
  video{max-width:100%;max-height:100%;object-fit:contain;background:#000}
  .toolBar{
    position:relative;z-index:2;padding:10px 12px;background:#101b39;border-top:1px solid var(--border);
    display:flex;flex-wrap:wrap;gap:8px;align-items:center
  }
  .btn,.chip{
    border:1px solid var(--border);background:#15224a;color:#fff;border-radius:10px;padding:8px 10px;
    cursor:pointer;user-select:none
  }
  .btn:hover,.chip:hover{filter:brightness(1.1)}
  .chip.active{background:#1a2c66;border-color:#2d4ea7}
  .range{vertical-align:middle;width:160px;margin-left:8px}

  /* 右：字幕/測驗 */
  .side{display:flex;flex-direction:column;min-height:0;background:var(--panel)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted)}
  .tab.active{color:var(--text);background:#132046;font-weight:700}

  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  .toolbar .grow{flex:1}
  .search{flex:1;min-width:220px;padding:8px;border-radius:10px;border:1px solid var(--border);background:#0b1733;color:#e7eaf3}

  .panel{flex:1;overflow:auto}
  /* 三欄字幕表格 */
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0f1a33;border-bottom:1px solid var(--border);text-align:left;padding:10px;color:#a9b3cf}
  tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06)}
  tbody tr:hover{background:#132046}
  tbody tr.active{background:#1a2c66}
  .col-time{width:88px;color:#a9b3cf;font-variant-numeric:tabular-nums;white-space:nowrap}

  .small{opacity:.8;font-size:.9rem}
</style>
</head>
<body>
<div class="layout">

  <!-- 左：影片 -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- 底部工具列（維持你的按鈕） -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlay">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>
      <button class="btn" id="btnRepeatOne">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnABClear">取消循環</button>

      <label class="chip">速度
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" class="range">
        <span id="rateLabel" class="small">1.00×</span>
      </label>

      <label class="chip">變焦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" class="range">
      </label>
    </div>
  </section>

  <!-- 右：字幕/測驗 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <!-- 工具列：搜尋／跟隨／字級／校準 -->
    <div class="toolbar">
      <input id="search" class="search" placeholder="搜尋字幕…（支援英文或中文）"/>
      <button id="btnFollow" class="btn">跟隨</button>

      <span class="small" style="margin-left:12px">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>

      <div class="grow"></div>

      <span class="small">校準</span>
      <button id="btnAlignHere" class="btn">此行＝現在</button>
      <button id="btnShiftPlus" class="btn">提前 0.5s</button>
      <button id="btnShiftMinus" class="btn">延後 0.5s</button>
      <span id="shiftInfo" class="small" style="min-width:90px;text-align:right">偏移 0.0s</span>
    </div>

    <!-- 字幕 -->
    <div id="panelTranscript" class="panel">
      <table>
        <thead>
          <tr>
            <th class="col-time">時間</th>
            <th>英文</th>
            <th>中文</th>
          </tr>
        </thead>
        <tbody id="tbodyCues"></tbody>
      </table>
    </div>

    <!-- 測驗（之後需要再打開） -->
    <div id="panelQuiz" class="panel" style="display:none"></div>
  </aside>
</div>

<script>
/* ========= 小工具 ========= */
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs  = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* ========= 載入索引 ========= */
async function loadMeta(){
  const res  = await fetch('data/index.json');
  const meta = await res.json();
  return (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
}

/* ========= 狀態 ========= */
let cuesRaw = [];   // [{tSec,en,zh,tr}]
let filtered = [];  // 篩選後供渲染
let follow = false;
let selectedIndex = -1;
let repeatOne=false, A=null, B=null, abTimer=null;

/* 校準：以 slug 萬年存 */
const SHIFT_KEY = 'shift_' + slug;
let shift = parseFloat(localStorage.getItem(SHIFT_KEY) || '0');   // 秒
updateShiftInfo();
function setShift(v){
  shift = Math.round(v*1000)/1000;
  localStorage.setItem(SHIFT_KEY, String(shift));
  updateShiftInfo();
}
function updateShiftInfo(){ $('#shiftInfo').textContent = `偏移 ${shift.toFixed(1)}s`; }

/* ========= 轉秒 ========= */
function toSec(t){
  const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);
  return m*60 + s;
}
function secToLabel(sec){
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60);
  return `[${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}]`;
}

/* ========= 渲染字幕表格 ========= */
function renderTable(list){
  const tb = $('#tbodyCues');
  tb.innerHTML = '';
  list.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.dataset.idx = i;
    tr.innerHTML = `
      <td class="col-time">${secToLabel(c.tSec)}</td>
      <td>${c.en||''}</td>
      <td>${c.zh||''}</td>
    `;
    tr.onclick = ()=>{
      selectedIndex = i;
      highlightRow(i);
      // 點行跳播：考慮校準（把影片跳到：字幕目標秒 - shift）
      const want = Math.max(0, c.tSec - shift);
      const v = $('#player');
      v.currentTime = want; v.play();
    };
    tb.appendChild(tr);
  });
}
function highlightRow(i){
  $$('#tbodyCues tr').forEach(tr=>tr.classList.remove('active'));
  const tr = $(`#tbodyCues tr[data-idx="${i}"]`);
  if(tr){ tr.classList.add('active'); if(follow) tr.scrollIntoView({block:'center',behavior:'smooth'}); }
}

/* ========= 搜尋過濾 ========= */
function applyFilter(){
  const q = $('#search').value.trim().toLowerCase();
  if(!q){ filtered = cuesRaw.slice(); }
  else{
    filtered = cuesRaw.filter(c =>
      (c.en||'').toLowerCase().includes(q) ||
      (c.zh||'').toLowerCase().includes(q)
    );
  }
  renderTable(filtered);
}

/* ========= 時間驅動高亮 ========= */
function onTimeTick(){
  const v = $('#player');
  const eff = v.currentTime + shift; // 校準後的「比對時間」
  // 找到 <= eff 的最後一行
  let idx = -1;
  for(let i=0;i<filtered.length;i++){
    if(filtered[i].tSec <= eff) idx = i; else break;
  }
  if(idx>=0) highlightRow(idx);
}

/* ========= 左下工具列 ========= */
function jumpPrev(){
  const t = $('#player').currentTime + shift;
  const prev = [...filtered].reverse().find(c=>c.tSec < t - 0.05);
  if(prev){ $('#player').currentTime = Math.max(0, prev.tSec - shift); $('#player').play(); }
}
function jumpNext(){
  const t = $('#player').currentTime + shift;
  const next = filtered.find(c=>c.tSec > t + 0.05);
  if(next){ $('#player').currentTime = Math.max(0, next.tSec - shift); $('#player').play(); }
}
function setRepeatOne(){
  repeatOne = true;
  const v = $('#player');
  const t = v.currentTime + shift;
  let i = filtered.findIndex(c=> c.tSec <= t && t < (filtered[filtered.length-1].tSec+3600));
  if(i<0) i=0;
  A = filtered[i].tSec - shift;
  B = (i+1<filtered.length ? filtered[i+1].tSec - shift : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = Math.max(0,A); }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('已設定 A 點'); }
  else if(B==null){ B = v.currentTime; alert('已設定 B 點；開始循環'); startAB(); }
  else { A=v.currentTime; B=null; alert('已重設 A 點，請再按一次設定 B 點'); }
}
function startAB(){
  repeatOne = false;
  clearInterval(abTimer);
  abTimer = setInterval(()=>{ const v=$('#player'); if(B!=null && v.currentTime>=B) v.currentTime=A; },120);
}
function clearLoop(){ repeatOne=false;A=null;B=null;clearInterval(abTimer); }

/* ========= 綁定 ========= */
function bindUI(){
  // 左下工具列
  $('#btnPrev').onclick = jumpPrev;
  $('#btnNext').onclick = jumpNext;
  $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
  $('#btnRepeatOne').onclick = setRepeatOne;
  $('#btnAB').onclick = setAB;
  $('#btnABClear').onclick = clearLoop;

  $('#rate').oninput = e=>{ const v=$('#player'); v.playbackRate=+e.target.value; $('#rateLabel').textContent=v.playbackRate.toFixed(2)+'×'; };
  $('#zoom').oninput = e=>{ const z=+e.target.value; const v=$('#player'); v.style.transform=`scale(${z})`; v.style.transformOrigin='center center'; };

  // 右側工具列
  $('#btnFollow').onclick = ()=>{
    follow = !follow;
    $('#btnFollow').textContent = follow? '跟隨中' : '跟隨';
  };
  const setFont = s=>{
    const px = {S:'13px',M:'15px',L:'17px'}[s] || '15px';
    $('#panelTranscript').style.fontSize = px;
    [$('#fS'),$('#fM'),$('#fL')].forEach(b=>b.classList.remove('active'));
    ({S:'#fS',M:'#fM',L:'#fL'}[s] && $(({S:'#fS',M:'#fM',L:'#fL'}[s])).classList.add('active'));
  };
  $('#fS').onclick=()=>setFont('S');
  $('#fM').onclick=()=>setFont('M');
  $('#fL').onclick=()=>setFont('L');

  // 校準：此行＝現在（需先點任一行成為 selectedIndex）
  $('#btnAlignHere').onclick = ()=>{
    if(selectedIndex<0){ alert('請先點一行字幕作為「此行」。'); return; }
    const v = $('#player');
    // 讓「該行字幕時間」對齊「目前影片秒」
    const target = filtered[selectedIndex].tSec;
    const now = v.currentTime;
    // 影片秒 + shift ≈ 字幕秒  =>  shift ≈ target - now
    setShift(target - now);
  };
  $('#btnShiftPlus').onclick  = ()=> setShift(shift + 0.5); // 字幕太晚 → 提前（+）
  $('#btnShiftMinus').onclick = ()=> setShift(shift - 0.5); // 字幕太早 → 延後（-）

  // 搜尋
  $('#search').addEventListener('input', applyFilter);
}

/* ========= 啟動 ========= */
(async ()=>{
  bindUI();

  const meta = await loadMeta();
  if(!meta) return;

  // 影片
  $('#player').src = meta.video;

  // 字幕（支援 {time,en,zh} 或 {items:[...]}）
  const res = await fetch(meta.cues);
  const data = await res.json();
  const items = Array.isArray(data)? data : (data.items||[]);
  cuesRaw = items.map(x=>({
    tSec: toSec(x.time || x.t || x.start || '0:0'),
    en: x.en || x.text || '',
    zh: x.zh || x.cn || x.zht || ''
  }));
  filtered = cuesRaw.slice();
  renderTable(filtered);

  // 播放時間 → 高亮
  $('#player').addEventListener('timeupdate', onTimeTick);

  // 預設字級
  $('#fM').click();
})();
</script>
</body>
</html>
