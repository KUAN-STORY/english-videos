<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}

  .layout{display:grid;grid-template-columns: 1fr 1fr;gap:var(--gap);height:100vh}
  @media(max-width:1024px){ .layout{grid-template-columns:1fr;grid-template-rows:auto auto;height:auto} }

  /* å·¦æ¬„ï¼šå½±ç‰‡å€ + å›ºå®šå·¥å…·åˆ— */
  .videoColumn{display:grid;grid-template-rows:1fr auto;min-height:0;border-right:1px solid var(--border)}
  .videoStage{min-height:0;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden}
  video{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;background:#000}

  .toolBar{position:relative;z-index:2;padding:10px 12px;background:#101b39;border-top:1px solid var(--border);
    display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btn,.chip{border:1px solid var(--border);background:#15224a;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;user-select:none}
  .btn:hover,.chip:hover{filter:brightness(1.1)}
  .chip.active{background:#1a2c66;border-color:#2d4ea7}

  /* å³æ¬„ */
  .side{display:flex;flex-direction:column;min-height:0;background:var(--panel)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}

  /* å­—å¹•ä¸‰æ¬„ */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #132046;padding:10px 8px;vertical-align:top}
  .table th{color:#cad3f5;text-align:left;background:#0f1c3a;position:sticky;top:0}
  .timeCell{white-space:nowrap;color:#a9b3cf}
  .line.active{background:#1a2c66;border-radius:6px}
  .search{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0e1b3b;color:#fff;outline:none}

  /* æ¸¬é©—ï¼ˆä¿ç•™ï¼‰ */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}

  /* å–®å­—å¡ï¼ˆå¡«ç©ºæ¨¡å¼ï¼‰ */
  .vcard{border:1px solid var(--border);border-radius:14px;background:#0f1a33;margin:12px 0;padding:12px}
  .vhead{display:flex;align-items:center;gap:10px}
  .tag{font-size:12px;color:#a9b3cf;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
  .jump{margin-left:auto}
  .cloze{font-size:16px;line-height:1.7;margin:10px 0}
  .input{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0e1b3b;color:#fff;outline:none}
  .ok{color:#23d18b;margin-left:8px}
  .bad{color:#f5a524;margin-left:8px}
  .grammar{margin-top:6px;color:#a9b3cf}
</style>
</head>
<body>
<div class="layout">

  <!-- å·¦ï¼šå½±ç‰‡ï¼ˆä¸Šï¼šèˆå°ï¼Œä¸‹ï¼šå·¥å…·åˆ—ï¼‰ -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- å›ºå®šåœ¨å·¦æ¬„åº•éƒ¨çš„å·¥å…·åˆ— -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
      <button class="btn" id="btnPlay">æ’­æ”¾/æš«åœ</button>
      <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>

      <button class="btn" id="btnRepeatOne">é‡è¤‡æœ¬å¥</button>
      <button class="btn" id="btnAB">A-B å¾ªç’°</button>
      <button class="btn" id="btnABClear">å–æ¶ˆå¾ªç’°</button>

      <label class="chip">é€Ÿåº¦
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" style="vertical-align:middle; width:160px; margin-left:8px;">
        <span id="rateLabel" style="margin-left:6px">1.00Ã—</span>
      </label>
      <label class="chip">è®Šç„¦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" style="vertical-align:middle; width:140px; margin-left:8px;">
      </label>
    </div>
  </section>

  <!-- å³ï¼šå­—å¹• / æ¸¬é©— / å–®å­— -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
      <div id="tabVocab" class="tab">å–®å­—</div>
    </div>

    <!-- å³å´å·¥å…·åˆ—ï¼ˆè·Ÿéš¨ + æ ¡æº– + å­—ç´šï¼‰ -->
    <div class="toolbar">
      <input id="searchBox" class="search" placeholder="æœå°‹å­—å¹•â€¦ï¼ˆæ”¯æ´è‹±æ–‡æˆ–ä¸­æ–‡ï¼‰" />
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">è·Ÿéš¨</button>
      <button id="btnSyncBack" class="btn">ææ—©0.5ç§’</button>
      <button id="btnSyncFwd" class="btn">å»¶å¾Œ0.5ç§’</button>
      <span class="muted" id="offsetLabel">åç§» 0.00s</span>
      <div style="width:12px"></div>
      <span class="muted">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
    </div>

    <!-- å­—å¹•é¢æ¿ -->
    <div id="panelTranscript" class="panel"></div>

    <!-- æ¸¬é©—é¢æ¿ï¼ˆä¿ç•™ç¾æœ‰ 20 é¡Œç°¡æ˜“é¸æ“‡é¡Œï¼‰ -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div class="row">
            <button id="btnCheck" class="btn">äº¤å·</button>
            <button id="btnRetry" class="btn" style="display:none">å†è©¦ä¸€æ¬¡</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>

    <!-- å–®å­—é¢æ¿ï¼ˆæ”¹ç‚ºå¡«ç©ºæ¨¡å¼ï¼‰ -->
    <div id="panelVocab" class="panel" style="display:none">
      <h3 id="vocabTitle" style="margin:0 0 8px 0">å–®å­—è§£é‡‹</h3>
      <input id="vocabSearch" class="search" placeholder="æœå°‹å–®å­—æˆ–ä¸­æ–‡è§£é‡‹â€¦" style="margin-bottom:10px"/>
      <div id="vocabBox"></div>
    </div>
  </aside>
</div>

<script>
/* ================== å·¥å…· ================== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

function toSec(t){ // "mm:ss" => seconds
  const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);
  return m*60 + s;
}
function pad(n){return String(n).padStart(2,'0')}
function secToMMSS(sec){
  sec = Math.max(0, Math.round(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return `${pad(m)}:${pad(s)}`
}

/* ================== è¼‰å…¥ meta ================== */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item; // {video,cues,quiz,title_zh...}
}

/* ================== å½±ç‰‡èˆ‡å­—å¹• ================== */
let cueList = []; // [{tSec, en, zh, elTr}]
let follow=false, offset=0;

function renderTranscript(data){
  const panel = $('#panelTranscript'); panel.innerHTML = '';
  const box = document.createElement('div');

  // æœå°‹æ¡†ç›£è½
  $('#searchBox').oninput = ()=>{
    const kw = $('#searchBox').value.trim().toLowerCase();
    $$('.line', box).forEach(row=>{
      const hit = row.dataset.hit.includes(kw);
      row.style.display = (kw && !hit) ? 'none':'table-row';
    });
  };

  // è¡¨é ­
  const table = document.createElement('table');
  table.className = 'table';
  table.innerHTML = `
    <thead><tr>
      <th style="width:90px">æ™‚é–“</th>
      <th>è‹±æ–‡</th>
      <th style="width:34%">ä¸­æ–‡</th>
    </tr></thead>
    <tbody></tbody>`;
  const tbody = $('tbody', table);
  panel.appendChild(table);

  // items
  const list = Array.isArray(data)? data : (data.items||[]);
  cueList = list.map(row=>{
    const t = row.time || row.t || row.start || '0:0';
    const en = row.text || row.en || '';
    const zh = row.zh || row.cn || row.tw || '';
    const tr = document.createElement('tr');
    tr.className = 'line';
    tr.dataset.hit = (en+' '+zh).toLowerCase();

    tr.innerHTML = `
      <td class="timeCell">[${t}]</td>
      <td>${en || '&nbsp;'}</td>
      <td>${zh || '&nbsp;'}</td>
    `;
    tr.onclick = ()=>{
      const sec = toSec(t) + offset;
      const v = $('#player');
      v.currentTime = Math.max(0, sec);
      v.play();
      highlightByTime(v.currentTime);
    };
    tbody.appendChild(tr);
    return { tSec: toSec(t), en, zh, elTr: tr };
  });
}

function highlightByTime(current){
  // æ‰¾åˆ° <= current çš„æœ€å¾Œä¸€å¥
  let idx = -1;
  for(let i=0;i<cueList.length;i++){
    if(cueList[i].tSec + offset <= current) idx = i; else break;
  }
  cueList.forEach(c=>c.elTr.classList.remove('active'));
  if(idx>=0){
    const el = cueList[idx].elTr;
    el.classList.add('active');
    if(follow){
      el.scrollIntoView({block:'center', behavior:'smooth'});
    }
  }
}

/* ================== å·¦æ¬„å·¥å…·åˆ—ï¼ˆä¸Šä¸€å¥/ä¸‹ä¸€å¥/ABï¼‰ ================== */
let A=null,B=null,abTimer=null;
function jumpPrev(){
  const t = $('#player').currentTime - offset;
  const prev = [...cueList].reverse().find(c=> c.tSec < t - 0.05);
  if(prev){ $('#player').currentTime = Math.max(0, prev.tSec + offset); $('#player').play(); }
}
function jumpNext(){
  const t = $('#player').currentTime - offset;
  const next = cueList.find(c=> c.tSec > t + 0.05);
  if(next){ $('#player').currentTime = Math.max(0, next.tSec + offset); $('#player').play(); }
}
function setRepeatOne(){
  const v = $('#player');
  const t = v.currentTime - offset;
  let i = cueList.findIndex(c=> c.tSec <= t);
  if(i<0) i=0;
  A = cueList[i].tSec + offset;
  B = (i+1<cueList.length ? cueList[i+1].tSec + offset : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = A; }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('å·²è¨­å®š A é»'); }
  else if(B==null){ B = v.currentTime; alert('å·²è¨­å®š B é»ï¼›é–‹å§‹å¾ªç’°'); startAB(); }
  else { A=v.currentTime; B=null; alert('å·²é‡è¨­ A é»ï¼Œè«‹å†æŒ‰ä¸€æ¬¡è¨­å®š B é»'); }
}
function startAB(){
  clearInterval(abTimer);
  abTimer = setInterval(()=>{ const v=$('#player'); if(B!=null && v.currentTime>=B) v.currentTime=A; }, 120);
}
function clearLoop(){ A=null; B=null; clearInterval(abTimer); }

function bindLeftToolbar(){
  $('#btnPrev').onclick = jumpPrev;
  $('#btnNext').onclick = jumpNext;
  $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
  $('#btnRepeatOne').onclick = setRepeatOne;
  $('#btnAB').onclick = setAB;
  $('#btnABClear').onclick = clearLoop;
  $('#rate').oninput = e=>{ const v=$('#player'); v.playbackRate=+e.target.value; $('#rateLabel').textContent=v.playbackRate.toFixed(2)+'Ã—' };
  $('#zoom').oninput = e=>{ const z=+e.target.value; const v=$('#player'); v.style.transform=`scale(${z})`; v.style.transformOrigin='center center'; };
}

/* ================== å³æ¬„å·¥å…·åˆ—ï¼ˆè·Ÿéš¨ / æ ¡æº– / å­—ç´šï¼‰ ================== */
function bindRightToolbar(){
  $('#btnFollow').onclick = ()=>{ follow=!follow; $('#btnFollow').textContent = follow? 'è·Ÿéš¨ä¸­' : 'è·Ÿéš¨'; };
  $('#btnSyncBack').onclick = ()=>{ offset -= 0.5; $('#offsetLabel').textContent = `åç§» ${offset.toFixed(2)}s`; };
  $('#btnSyncFwd').onclick  = ()=>{ offset += 0.5; $('#offsetLabel').textContent = `åç§» ${offset.toFixed(2)}s`; };
  const setFont = s=>{
    const map={S:'13px',M:'15px',L:'17px'};
    $('#panelTranscript').style.fontSize = map[s]||'15px';
    $('#panelQuiz').style.fontSize = map[s]||'15px';
    $('#panelVocab').style.fontSize = map[s]||'15px';
    $$('.chip').forEach(b=>b.classList.remove('active'));
    ({S:'#fS',M:'#fM',L:'#fL'}[s] && $(({S:'#fS',M:'#fM',L:'#fL'}[s])).classList.add('active'));
  };
  $('#fS').onclick=()=>setFont('S'); $('#fM').onclick=()=>setFont('M'); $('#fL').onclick=()=>setFont('L');
}

/* ================== åˆ†é åˆ‡æ› ================== */
function setupTabs(){
  const t1 = $('#tabTranscript'), p1 = $('#panelTranscript');
  const t2 = $('#tabQuiz'),       p2 = $('#panelQuiz');
  const t3 = $('#tabVocab'),      p3 = $('#panelVocab');
  t1.onclick = ()=>{ t1.classList.add('active');t2.classList.remove('active');t3.classList.remove('active'); p1.style.display='block';p2.style.display='none';p3.style.display='none'; };
  t2.onclick = ()=>{ t2.classList.add('active');t1.classList.remove('active');t3.classList.remove('active'); p2.style.display='block';p1.style.display='none';p3.style.display='none'; };
  t3.onclick = ()=>{ t3.classList.add('active');t1.classList.remove('active');t2.classList.remove('active'); p3.style.display='block';p1.style.display='none';p2.style.display='none'; };
}

/* ================== æ¸¬é©—ï¼ˆä¿ç•™ 20 é¡ŒåŸºç¤ï¼‰ ================== */
async function loadQuiz(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('æ¸¬é©— JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  let arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  // æ¨£æ¿åªåšé¸æ“‡é¡Œï¼ˆè‹¥æ˜¯ç°¡çŸ­å¡«ç©ºå¯ç”¨ a ç‚ºé™£åˆ— + answerIndex æŒ‡å‘ï¼‰
  return arr.slice(0,20).map((x,i)=>{
    const q = x.q || x.question || x.title || `Q${i+1}`;
    const opts = x.a || x.options || x.choices || [];
    let ans = x.answerIndex ?? x.correct ?? x.ans ?? 0;
    if(typeof ans!=='number'){
      const idx = opts.findIndex(o=> (o.text||o)===ans);
      ans = idx>=0? idx : 0;
    }
    return {q, opts:opts.map(o=> (o.text||o)), ans};
  });
}
function renderQuiz(questions){
  const box = $('#quizBox'); box.innerHTML='';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className='q';
    wrap.innerHTML = `<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt,j)=>{
      const line = document.createElement('label');
      line.className='opt';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}"/> <span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick = ()=>{
    let correct=0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const val = picked? +picked.value : -1;
      if(val===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    const res = $('#quizResult');
    res.style.display = 'block';
    res.className = 'result ' + (ratio>=80?'pass':'fail');
    res.textContent = `åˆ†æ•¸ï¼š${correct} / ${questions.length}ï¼ˆ${ratio}%ï¼‰` + (ratio>=80?'  ğŸ‘ å¤ªæ£’äº†ï¼':'  å†æ¥å†å²ï¼');
    $('#btnRetry').style.display = 'inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent = `0 / ${questions.length}`;
    const res = $('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display = 'none';
  };
}

/* ================== å–®å­—ï¼ˆå¡«ç©ºæ¨¡å¼ï¼‰ ================== */
/*
  æœŸå¾… vocab JSON çµæ§‹ï¼ˆæ²¿ç”¨ä½ ç¾è¡Œå¯è®€æ ¼å¼ï¼‰ï¼š
  {
    "title": "Mid-Autumn Vocabulary",
    "items": [
      {"time":"00:08","word":"lantern","pos":"n.","zh":"ç‡ˆç± ","en":"a light ...","example":"Families carry lanterns at night.","grammar":"å¯æ•¸åè©ï¼›..."},
      ...
