<!-- login.js éœ€å…ˆè¼‰å…¥ï¼Œç¶­è­· window.__AUTH èˆ‡ window.showLogin() -->
<script src="login.js"></script>

<style>
  /* æœªç™»å…¥é®ç½© */
  .gate-mask {
    position: fixed; inset: 0; background: rgba(5,10,20,.86);
    display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .gate-card {
    width: min(560px, 92vw); background: #0f1a33; color: #e7eaf3;
    border: 1px solid #203057; border-radius: 14px; padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,.4);
  }
  .gate-card h3 { margin: 0 0 8px 0; font-size: 20px; }
  .gate-card p  { margin: 0 0 16px 0; color: #a9b3cf; }
  .gate-row     { display:flex; gap:10px; justify-content:flex-end; }
  .gate-btn     { padding:8px 12px; border:1px solid #203057; border-radius:10px;
                  background:#15224a; color:#fff; cursor:pointer; }
  .gate-btn:hover { filter:brightness(1.08); }
</style>

<div id="gateMask" class="gate-mask" aria-hidden="true">
  <div class="gate-card">
    <h3>è«‹å…ˆç™»å…¥</h3>
    <p>æ­¤å½±ç‰‡åƒ…é™æœƒå“¡è§€çœ‹ã€‚ä½ å¯ä»¥å…ˆè§€çœ‹å…è²»å½±ç‰‡ã€ˆä¸­ç§‹ç¯€ã€‰ä½œç‚ºè©¦çœ‹ ğŸ™‚</p>
    <div class="gate-row">
      <button id="btnGoFree" class="gate-btn">å…ˆå»å…è²»å½±ç‰‡</button>
      <button id="btnLogin" class="gate-btn">ç™»å…¥</button>
    </div>
  </div>
</div>

<script>
  // èˆ‡ index.html ç›¸åŒï¼šå…ç™»å…¥æ¸…å–®
  const FREE_SLUGS = new Set(["mid-autumn"]);

  const qs   = new URLSearchParams(location.search);
  const slug = qs.get('slug') || '';

  function isSignedIn(){
    return !!(window.__AUTH && window.__AUTH.signedIn);
  }

  // å®ˆé–€ï¼šæœªç™»å…¥ & éå…è²» => æ“‹ä¸‹ä¸¦é¡¯ç¤ºé®ç½©
  function guard(){
    if (!FREE_SLUGS.has(slug) && !isSignedIn()){
      const mask = document.getElementById('gateMask');
      mask.style.display = 'flex';
      // è®“æ’­æ”¾å™¨å€åŸŸä¸æœƒç¹¼çºŒè¼‰å…¥ / æ“ä½œ
      try {
        const v = document.getElementById('player');
        if (v) { v.pause?.(); v.removeAttribute('src'); v.load?.(); }
      } catch(e){}
      return false;
    }
    return true;
  }

  // ç¶å®šæŒ‰éˆ•
  (function bindGateUI(){
    const btnLogin = document.getElementById('btnLogin');
    const btnFree  = document.getElementById('btnGoFree');

    btnLogin?.addEventListener('click', ()=>{
      if (typeof window.showLogin === 'function') {
        window.showLogin();
      } else {
        alert('è«‹åœ¨ login.js æä¾› window.showLogin() ä»¥é–‹å•Ÿç™»å…¥å°è©±æ¡†');
      }
    });

    btnFree?.addEventListener('click', ()=>{
      location.href = 'player.html?slug=mid-autumn';
    });

    // è‹¥ login.js è§¸ç™¼ auth:changeï¼Œç™»å…¥å¾Œè‡ªå‹•é—œé–‰é®ç½©ä¸¦é‡æ–°è¼‰å…¥å½±ç‰‡
    window.addEventListener('auth:change', ()=>{
      if (guard()){
        const mask = document.getElementById('gateMask');
        mask.style.display = 'none';
        // é‡æ–°è¼‰å…¥å½±ç‰‡ (ä½ çš„åˆå§‹åŒ–ç¨‹å¼é€šå¸¸æœƒåœ¨é é¢ä¸‹æ–¹)
        // è‹¥ä½ çš„åˆå§‹åŒ–é‚è¼¯åœ¨ IIFE ä¸­ä¸€æ¬¡æ€§åŸ·è¡Œï¼Œå¯æ‰‹å‹•å‘¼å«ä½ å°è£çš„ init()ã€‚
        // æˆ–è€…ç°¡å–®ä¸€é»é‡æ•´ï¼š
        location.reload();
      }
    });
  })();

  // é é¢ä¸€é€²ä¾†å…ˆæª¢æŸ¥ä¸€æ¬¡
  guard();
</script>



