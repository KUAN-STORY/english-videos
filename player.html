<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;}

  .layout{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); height:100vh;}
  @media(max-width:1024px){.layout{grid-template-columns:1fr; grid-template-rows:auto auto; height:auto;}}

  /* 左欄影片 */
  .videoColumn{display:grid; grid-template-rows:1fr auto; min-height:0; border-right:1px solid var(--border);}
  .videoStage{min-height:0; display:flex; align-items:center; justify-content:center; background:#000; overflow:hidden;}
  video{max-width:100%; max-height:100%; object-fit:contain; background:#000;}
  .toolBar{padding:10px 12px; background:#101b39; border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
  .btn,.chip{border:1px solid var(--border); background:#15224a; color:#fff; border-radius:10px; padding:6px 10px; cursor:pointer;}
  .btn:hover,.chip:hover{filter:brightness(1.1)}
  .chip.active{background:#1a2c66; border-color:#2d4ea7;}

  /* 右欄 */
  .side{display:flex;flex-direction:column;min-height:0;background:var(--panel);}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted)}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}

  /* 字幕 */
  table.subs{width:100%; border-collapse:collapse; font-size:15px;}
  table.subs td{padding:6px 8px; border-bottom:1px solid #203057; vertical-align:top;}
  table.subs tr.active{background:#1a2c66}
  .time{color:var(--muted); font-variant-numeric:tabular-nums; cursor:pointer;}

  /* 測驗 */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0}
  .opt{margin:6px 0;cursor:pointer}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid #14b86e}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid #f5a524}
  .stickyFoot{position:sticky;bottom:0;background:#101b39;padding:8px;border-top:1px solid var(--border)}
</style>
</head>
<body>
<div class="layout">

  <!-- 左 -->
  <section class="videoColumn">
    <div class="videoStage"><video id="player" controls preload="metadata"></video></div>
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlay">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>
      <button class="btn" id="btnRepeatOne">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnABClear">取消循環</button>
      <label class="chip">速度
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1"
          style="vertical-align:middle;width:120px;margin-left:6px;">
        <span id="rateLabel">1.00×</span>
      </label>
      <label class="chip">變焦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1"
          style="vertical-align:middle;width:120px;margin-left:6px;">
      </label>
    </div>
  </section>

  <!-- 右 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <div class="toolbar">
      <span style="color:#a9b3cf">字級</span>
      <button id="fS" class="chip">S</button><button id="fM" class="chip active">M</button><button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">跟隨</button>
      <button id="btnTheme" class="btn">主題</button>
    </div>

    <div id="panelTranscript" class="panel"></div>
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="result" id="quizResult"></div>
        <button class="btn" id="btnCheck">交卷</button>
        <button class="btn" id="btnRetry" style="display:none">再試一次</button>
      </div>
    </div>
  </aside>
</div>

<script>
const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const qs=new URLSearchParams(location.search);const slug=qs.get('slug')||'';

async function loadMeta(){
  const res=await fetch('data/index.json');const meta=await res.json();
  return (meta.items||[]).find(x=>x.slug===slug)||meta.items?.[0];
}

/* 字幕 */
let cueList=[];
function toSec(t){const [m,s]=String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);return m*60+s;}
function renderTranscript(data){
  const list=Array.isArray(data)?data:(data.items||[]);const box=$('#panelTranscript');box.innerHTML='';
  cueList=list.map(r=>{
    const t=r.time||'0:0',en=r.en||r.text||'',zh=r.zh||'';
    const tr=document.createElement('tr');tr.innerHTML=`<td class="time">[${t}]</td><td>${en}</td><td style="color:#a9b3cf">${zh}</td>`;
    tr.onclick=()=>{$('#player').currentTime=toSec(t);$('#player').play();};
    box.appendChild(document.createElement('table')).className='subs';
    return {tSec:toSec(t),el:tr};
  });
  const tbl=document.createElement('table');tbl.className='subs';cueList.forEach(c=>tbl.appendChild(c.el));box.appendChild(tbl);
}
function highlight(cur){let idx=-1;for(let i=0;i<cueList.length;i++){if(cueList[i].tSec<=cur)idx=i;else break;}
  cueList.forEach(c=>c.el.classList.remove('active'));if(idx>=0){cueList[idx].el.classList.add('active');if(follow)cueList[idx].el.scrollIntoView({block:'center'});}}

/* 測驗 */
async function loadQuiz(path){
  const res=await fetch(path);const raw=await res.json();let arr=Array.isArray(raw)?raw:(raw.items||[]);
  return arr.slice(0,20).map((q,i)=>({q:q.q||q.question||`Q${i+1}`,opts:q.options||q.choices||q.a||[],ans:q.ans||q.answerIndex||0}));
}
function renderQuiz(list){
  const box=$('#quizBox');box.innerHTML='';list.forEach((q,i)=>{const d=document.createElement('div');d.className='q';d.innerHTML=`<h4>${i+1}. ${q.q}</h4>`;q.opts.forEach((o,j)=>{d.innerHTML+=`<label class="opt"><input type="radio" name="q${i}" value="${j}"> ${o}</label>`});box.appendChild(d);});
  $('#btnCheck').onclick=()=>{let c=0;list.forEach((q,i)=>{const sel=$(`input[name="q${i}"]:checked`,box);if(sel&&+sel.value===q.ans)c++;});const r=$('#quizResult');r.style.display='block';r.className='result '+(c/list.length>=0.8?'pass':'fail');r.textContent=`得分 ${c}/${list.length}`;$('#btnRetry').style.display='inline-block';};
  $('#btnRetry').onclick=()=>{$$('input[type=radio]',box).forEach(r=>r.checked=false);$('#quizResult').style.display='none';$('#btnRetry').style.display='none';};
}

/* 左工具列 */
$('#btnPrev').onclick=()=>{const t=$('#player').currentTime;const p=[...cueList].reverse().find(c=>c.tSec<t);if(p)$('#player').currentTime=p.tSec;}
$('#btnNext').onclick=()=>{const t=$('#player').currentTime;const n=cueList.find(c=>c.tSec>t);if(n)$('#player').currentTime=n.tSec;}
$('#btnPlay').onclick=()=>{const v=$('#player');v.paused?v.play():v.pause();}
$('#rate').oninput=e=>{$('#player').playbackRate=+e.target.value;$('#rateLabel').textContent=(+e.target.value).toFixed(2)+'×';}
$('#zoom').oninput=e=>{$('#player').style.transform=`scale(${+e.target.value})`;}
let follow=false;$('#btnFollow').onclick=()=>{follow=!follow;$('#btnFollow').textContent=follow?'跟隨中':'跟隨';}

/* Tab */
$('#tabTranscript').onclick=()=>{$('#tabTranscript').classList.add('active');$('#tabQuiz').classList.remove('active');$('#panelTranscript').style.display='block';$('#panelQuiz').style.display='none';}
$('#tabQuiz').onclick=()=>{$('#tabQuiz').classList.add('active');$('#tabTranscript').classList.remove('active');$('#panelQuiz').style.display='block';$('#panelTranscript').style.display='none';}

/* 啟動 */
(async()=>{
  const meta=await loadMeta();$('#player').src=meta.video;
  const cues=await (await fetch(meta.cues)).json();renderTranscript(cues);
  $('#player').addEventListener('timeupdate',()=>highlight($('#player').currentTime));
  if(meta.quiz){const qs=await loadQuiz(meta.quiz);renderQuiz(qs);}else{$('#tabQuiz').style.display='none';}
})();
</script>
</body>
</html>
