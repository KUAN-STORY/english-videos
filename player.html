<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);height:100dvh;box-sizing:border-box}
  @media(max-width:1024px){ .layout{grid-template-columns:1fr} }

  /* 左側：影片 + 工具列 */
  .videoWrap{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:#000;position:relative;overflow:hidden;padding:10px}
  .videoBox{width:100%;display:flex;justify-content:center;align-items:center;background:#000}
  video{width:100%;height:auto;max-height:calc(100dvh - 220px);object-fit:contain;background:#000;display:block;transform-origin:center center;transition:transform .2s}
  .toolBar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px;width:100%;box-sizing:border-box}
  .btn{padding:8px 12px;border:1px solid var(--border);background:#15224a;color:#fff;border-radius:10px;cursor:pointer;font-size:14px}
  .btn:hover{filter:brightness(1.12)}
  .btn.toggled{outline:2px solid var(--brand)}
  .seg{display:flex;gap:8px;align-items:center}
  .sliderBox{display:flex;align-items:center;gap:8px;margin-left:6px}
  .sliderBox input{width:140px}

  /* 右側欄 */
  .side{display:flex;flex-direction:column;background:var(--panel);border-left:1px solid var(--border)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .chip{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}
  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .line{line-height:1.5;margin:8px 0;cursor:pointer}
  .line:hover{background:#15224a;border-radius:8px;padding:4px}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:6px}
  .line.active{background:#1a2c66;border-radius:8px;padding:4px}

  /* 測驗 */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}
</style>
</head>
<body>
<div class="layout">
  <!-- 左：影片 + 工具列 -->
  <div class="videoWrap">
    <div class="videoBox">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- 學習工具列 -->
    <div class="toolBar">
      <div class="seg">
        <button class="btn" id="btnPrev">上一句</button>
        <button class="btn" id="btnPlayPause">播放</button>
        <button class="btn" id="btnNext">下一句</button>
        <button class="btn" id="btnRepeat">重複本句</button>
      </div>

      <div class="seg">
        <button class="btn" id="btnAB">點句即循環</button>
        <button class="btn" id="btnCancelAB">取消循環</button>
        <button class="btn" id="btnFit">適應畫面</button>
      </div>

      <div class="seg">
        <button class="btn" id="btnAutoPause">逐句自動暫停</button>
        <button class="btn" id="btnLoopAll">整段循環</button>
      </div>

      <div class="seg sliderBox">
        <label>變焦</label>
        <input type="range" id="zoomSlider" min="0.5" max="1.5" step="0.1" value="1">
      </div>
      <div class="seg sliderBox">
        <label>速度</label>
        <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
        <span id="speedLabel">1.00×</span>
      </div>
    </div>
  </div>

  <!-- 右：字幕/測驗 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>
    <div class="toolbar">
      <span class="muted">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
    </div>
    <div id="panelTranscript" class="panel"></div>
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div>
            <button id="btnCheck" class="btn">交卷</button>
            <button id="btnRetry" class="btn" style="display:none">再試一次</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>
  </aside>
</div>

<script>
/* ===== 工具 ===== */
const $ = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* ===== 狀態 ===== */
let FONT='M';
let cues=[], cueSecs=[], currentIdx=0;
let abA=null, abB=null;          // A-B 循環
let abStep=0;                    // 0=未設定, 1=已設 A 等 B
let autoPause=false;             // 逐句自動暫停
let lastPausedIdx=-1;

/* ===== 字級 ===== */
function setFont(size){
  FONT=size; const map={S:'13px',M:'15px',L:'17px'};
  $$('#panelTranscript, #panelQuiz, .q').forEach(el=> el.style.fontSize=map[size]);
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* ===== 載入資料 ===== */
async function loadMeta(){
  const res = await fetch('data/index.json'); if(!res.ok) throw new Error('index.json 載入失敗');
  const meta = await res.json(); const item=(meta.items||[]).find(x=>x.slug===slug)||meta.items?.[0];
  if(!item) throw new Error('index.json 無對應項目'); return item;
}
async function loadCues(path){ const r=await fetch(path); if(!r.ok) throw new Error('字幕載入失敗'); return await r.json(); }
function toSec(t){ if(typeof t==='number') return t; const [m,s]=(t||'0:0').split(':').map(n=>+n||0); return m*60+s; }

function renderTranscript(data){
  cues = Array.isArray(data)?data:(data.items||[]);
  cueSecs = cues.map(r=> toSec(r.time||r.t||r.start||0));
  const box=$('#panelTranscript'); box.innerHTML='';
  cues.forEach((r,i)=>{
    const t=r.time||r.t||r.start||'', s=r.text||r.en||r.caption||'';
    const div=document.createElement('div'); div.className='line'; div.dataset.idx=i;
    div.innerHTML=`<span class="time">[${t}]</span>${s}`;
    div.onclick = ()=>{ $('#player').currentTime = cueSecs[i]; $('#player').play(); highlight(i); };
    box.appendChild(div);
  });
}
function highlight(i){
  currentIdx=i;
  $$('.line').forEach(el=> el.classList.remove('active'));
  const el = $(`.line[data-idx="${i}"]`);
  if(el){ el.classList.add('active'); el.scrollIntoView({block:'nearest'}); }
}

/* ===== 工具列功能 ===== */
function setupTools(){
  const v=$('#player');

  const setPlayButton = ()=> $('#btnPlayPause').textContent = v.paused ? '播放' : '暫停';

  $('#btnPlayPause').onclick = ()=> v.paused ? v.play() : v.pause();
  v.onplay = v.onpause = setPlayButton;

  $('#btnPrev').onclick = ()=> {
    const t=v.currentTime;
    let i = cueSecs.findIndex(sec=> sec>t) - 1;
    if(i<0) i = cueSecs.length-1;
    v.currentTime = cueSecs[i]; v.play(); highlight(i);
  };
  $('#btnNext').onclick = ()=> {
    const t=v.currentTime;
    let i = cueSecs.findIndex(sec=> sec>t);
    if(i<0) i = cueSecs.length-1;
    v.currentTime = cueSecs[i]; v.play(); highlight(i);
  };

  // 重複本句：把目前句的起訖當成 A-B
  $('#btnRepeat').onclick = ()=>{
    const i = currentIdx;
    const A = cueSecs[i];
    const B = cueSecs[i+1] ?? (v.duration||A+2);
    abA=A; abB=B; abStep=0;
    $('#btnAB').classList.add('toggled');
    v.currentTime=A; v.play();
  };

  // A-B 循環：第一次按設 A，第二次按設 B；再按一次清除
  $('#btnAB').onclick = ()=>{
    if(abStep===0){ abA=v.currentTime; abB=null; abStep=1; $('#btnAB').classList.add('toggled'); }
    else if(abStep===1){ abB=v.currentTime; if(abB<abA) [abA,abB]=[abB,abA]; abStep=2; }
    else { abA=abB=null; abStep=0; $('#btnAB').classList.remove('toggled'); }
  };
  $('#btnCancelAB').onclick = ()=>{ abA=abB=null; abStep=0; $('#btnAB').classList.remove('toggled'); };

  // 適應畫面：重設縮放+contain
  $('#btnFit').onclick = ()=>{
    $('#zoomSlider').value = 1;
    v.style.transform = 'scale(1)';
    v.style.objectFit = 'contain';
  };

  // 逐句自動暫停
  $('#btnAutoPause').onclick = ()=>{
    autoPause = !autoPause;
    $('#btnAutoPause').classList.toggle('toggled', autoPause);
    lastPausedIdx = -1;
  };

  // 整段循環
  $('#btnLoopAll').onclick = ()=> {
    v.loop = !v.loop;
    $('#btnLoopAll').classList.toggle('toggled', v.loop);
  };

  // 變焦 / 速度
  $('#zoomSlider').oninput = e => v.style.transform = `scale(${e.target.value})`;
  $('#speedSlider').oninput = e => { v.playbackRate = parseFloat(e.target.value); $('#speedLabel').textContent = v.playbackRate.toFixed(2)+'×'; };

  // 時間事件：A-B & 自動暫停 & 高亮
  v.ontimeupdate = ()=>{
    const t = v.currentTime;

    // A-B
    if(abA!=null && abB!=null && t>=abB-0.01) v.currentTime = abA;

    // 目前句 index
    let i = cueSecs.findIndex(sec=> sec>t) - 1;
    if(i<0) i=0;
    if(i!==currentIdx) highlight(i);

    // 逐句自動暫停：到達該句結尾就停
    if(autoPause){
      const end = cueSecs[i+1] ?? (v.duration||Infinity);
      if(t>=end-0.02 && lastPausedIdx!==i){
        v.pause();
        lastPausedIdx=i;
      }
      if(t<end-0.1 && lastPausedIdx===i){ lastPausedIdx=-1; }
    }
  };
}

/* ===== 分頁/字級 ===== */
function setupTabs(){
  const t1=$('#tabTranscript'), p1=$('#panelTranscript');
  const t2=$('#tabQuiz'),       p2=$('#panelQuiz');
  t1.onclick=()=>{t1.classList.add('active');t2.classList.remove('active');p1.style.display='block';p2.style.display='none';};
  t2.onclick=()=>{t2.classList.add('active');t1.classList.remove('active');p2.style.display='block';p1.style.display='none';};
}
function bindFont(){
  $('#fS').onclick = ()=> setFont('S');
  $('#fM').onclick = ()=> setFont('M');
  $('#fL').onclick = ()=> setFont('L');
}

/* ===== 測驗（簡版） ===== */
async function loadQuiz(path){
  try{
    const r=await fetch(path); if(!r.ok) return null;
    const raw=await r.json();
    return (Array.isArray(raw)?raw:(raw.items||raw.questions||[])).slice(0,20).map((x,i)=>{
      const q=x.question||x.q||x.title||`Q${i+1}`;
      const opts=(x.options||x.choices||x.a||[]).map(o=>o.text||o);
      let ans = x.answerIndex ?? x.correct ?? x.ans ?? 0;
      if(typeof ans!=='number'){ const idx=opts.findIndex(o=>o===ans); ans= idx>=0? idx:0; }
      return {q,opts,ans,explain:x.explain||x.note||''};
    });
  }catch{ return null; }
}
function renderQuiz(questions){
  if(!questions){ $('#tabQuiz').style.display='none'; return; }
  const box=$('#quizBox'); box.innerHTML='';
  questions.forEach((q,i)=>{
    const w=document.createElement('div'); w.className='q';
    w.innerHTML=`<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt,j)=>{
      const line=document.createElement('label'); line.className='opt';
      line.innerHTML=`<input type="radio" name="q${i}" value="${j}"><span>${opt}</span>`;
      w.appendChild(line);
    });
    box.appendChild(w);
  });
  $('#quizProgress').textContent=`0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent=`${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick=()=>{
    let correct=0;
    questions.forEach((q,i)=>{
      const picked=$('input[name="q'+i+'"]:checked', box);
      if(picked && +picked.value===q.ans) correct++;
    });
    const ratio=Math.round(correct/questions.length*100);
    const res=$('#quizResult'); res.style.display='block';
    res.className='result ' + (ratio>=80?'pass':'fail');
    res.textContent=`分數：${correct} / ${questions.length}（${ratio}%）`+(ratio>=80?'  👍 太棒了！':'  再接再厲！');
    $('#btnRetry').style.display='inline-block';
  };
  $('#btnRetry').onclick=()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent=`0 / ${questions.length}`;
    const res=$('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display='none';
  };
}

/* ===== 啟動 ===== */
(async ()=>{
  try{
    setupTabs(); bindFont(); setFont('M');

    const meta = await loadMeta();
    $('#player').src = meta.video;
    const cueData = await loadCues(meta.cues);
    renderTranscript(cueData);
    setupTools();

    const qs = await loadQuiz(meta.quiz);
    renderQuiz(qs);
  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">載入失敗：${err.message}</div>`;
  }
})();
</script>
</body>
</html>

