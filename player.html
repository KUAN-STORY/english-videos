<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è‹±èªå½±ç‰‡æ’­æ”¾å™¨</title>
  <style>
    :root{
      --bg:#0b1324; --panel:#0f172a; --border:#1f2a44;
      --ink:#e6efff; --muted:#9fb0c9; --accent:#3c7cff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
    h1{font-size:20px;margin:0}
    .btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
    .btn.blue{background:#14335f;border-color:#2c5aa3}
    .muted{color:var(--muted)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}

    /* ä¸»è¦å®¹å™¨ï¼ˆæ¡Œæ©Ÿï¼‰ */
    .wrap{padding:16px;height:calc(100vh - 58px);}
    .layout{height:100%;display:flex;gap:16px;overflow:hidden}
    .left,.right{flex:1;min-width:0;background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .left{display:flex;flex-direction:column;padding:14px}
    .right{display:flex;flex-direction:column}
    .pane{flex:1;overflow:auto}

    /* å½±ç‰‡ï¼ˆé è¨­ object-fit: coverï¼‰ */
    .videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
    .videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

    /* å·¦å´å·¥å…·åˆ—ï¼ˆæ¡Œæ©Ÿï¼‰ */
    .controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
    .controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
    .speed{display:flex;align-items:center;gap:10px}
    input[type="range"]{width:260px;accent-color:var(--accent)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}

    /* å³ï¼šåˆ†é ï¼ˆä¸Šç§»ã€ç¸®å°é–“è·ä»¥é‡‹å‡ºç©ºé–“ï¼‰ */
    .tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid var(--border)}
    .tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:10px;padding:8px 12px}
    .tab.active{background:#154274}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
    tbody tr{background:#0f1f34}
    tbody tr:nth-child(2n){background:#0d1a2b}
    tbody tr:hover{background:#0f2a4e}
    tr.active{background:#173a6e}

    /* æ¡Œæ©Ÿï¼šä¸­è‹±è¡Œè· */
    #pane-sub td:nth-child(2), #pane-sub td:nth-child(3){
      word-break:break-word; white-space:normal; line-height:1.6;
    }

    /* æ¸¬é©—åˆ†å€æŒ‰éˆ• */
    .q-tabs{display:flex;gap:8px;flex-wrap:wrap}
    .q-tabs .qtab{background:#122340;border:1px solid #1f375f;border-radius:10px;padding:6px 12px;color:#e6efff;cursor:pointer}
    .q-tabs .qtab.on{background:#154274}

    /* ===== æ‰‹æ©Ÿï¼šå½±ç‰‡å›ºå®šåœ¨é ‚ï¼›å³é‚Šæ»¾å‹•ï¼›åº•éƒ¨æŠ½å±œï¼›å­—å¹•è‹±æ–‡ä¸Šä¸­æ–‡ä¸‹ ===== */
    @media (max-width: 900px){
      .wrap{height:calc(100vh - 58px); padding:12px;}
      .layout{flex-direction:column; height:100%}
      .left{position:sticky; top:0; z-index:5; padding:12px}
      .right{flex:1; min-height:0; display:flex; flex-direction:column}
      .pane{flex:1; overflow:auto; padding-bottom:96px;} /* åº•éƒ¨å®‰å…¨è·ï¼Œé¿å…è¢«æŠ½å±œè“‹ä½ */

      /* æŠ½å±œ */
      .controls{
        position:fixed; left:8px; right:8px; bottom:8px;
        border-radius:16px 16px 12px 12px;
        box-shadow:0 10px 30px rgba(0,0,0,.4);
        transform:translateY(calc(100% - 28px));
        transition:transform .25s ease;
        padding:6px 10px 10px;
        z-index:20;
      }
      .controls.open{ transform:translateY(0); }
      .drawer-grab{ width:100%; text-align:center; cursor:pointer; user-select:none; padding:4px 0 8px; margin-bottom:6px; }
      .grab-bar{ width:44px; height:4px; border-radius:4px; margin:0 auto 4px; background:#2b4a78; }
      .drawer-title{font-size:12px; color:#9fb0c9;}

      /* å­—å¹•å †ç–Šï¼ˆè‹±æ–‡ä¸Šã€ä¸­æ–‡ä¸‹ï¼‰ï¼Œä¸­æ–‡é•·å¥æ’ç‰ˆ */
      #pane-sub table thead { display:none; }
      #pane-sub table, #pane-sub tbody, #pane-sub tr, #pane-sub td { display:block; width:100%; }
      #pane-sub tr { border-bottom:1px solid #162a48; padding:10px 0; }
      #pane-sub td{ padding:6px 12px; }
      #pane-sub td:nth-child(1){ font-size:12px; color:var(--muted); margin-bottom:4px; }
      #pane-sub td:nth-child(2){ font-size:16.5px; line-height:1.55; color:#e6efff; margin-bottom:4px; }
      #pane-sub td:nth-child(3){
        display:block; font-size:16px; line-height:1.8; color:#dfe8ff;
        word-break:keep-all; overflow-wrap:anywhere; line-break:loose; letter-spacing:0;
      }

      /* å°ˆå¿ƒæ¨¡å¼ï¼šæ¸¬é©—/å–®å­—æ™‚éš±è—å½±ç‰‡èˆ‡æŠ½å±œ */
      body.focus-mode .left{ display:none !important; }
      body.focus-mode #controlsDrawer{ display:none !important; }
      body.focus-mode .right{ flex:1 !important; }
    }

    /* ===== æ‰‹æ©Ÿé–±è®€æ¨¡å¼ï¼ˆæœªå‹¾è·Ÿéš¨ä¸”é»å­—å¹•æ™‚ï¼‰ ===== */
    @media (max-width:900px){
      body.read-mode .left{display:none !important}
      body.read-mode #controlsDrawer{display:none !important}
      body.read-mode .right{flex:1 !important}
      body.read-mode #pane-sub td:nth-child(2){font-size:18px;line-height:1.7;margin:10px 0 2px;color:#fff}
      body.read-mode #pane-sub td:nth-child(3){font-size:17px;line-height:1.9;margin:0 0 16px;color:#cfe2ff}
    }

    /* ===== åˆ—å°ï¼ˆç°¡åŒ–ä¿ç•™ï¼‰ ===== */
    @media print{
      html, body{ background:#fff !important; color:#000 !important; }
      header, .left, .tabs, .controls{ display:none !important; }
      .wrap{ padding:0 !important; }
      .layout{ display:block !important; height:auto !important; overflow:visible !important; }
      .right{ display:block !important; border:none !important; height:auto !important; }
      .pane, #pane-quiz, .quiz-shell, #quizList{
        height:auto !important; max-height:none !important; overflow:visible !important;
      }
      #quizList{ font-size:12.5pt; line-height:1.25; }
      #quizList > li{
        break-inside:avoid; page-break-inside:avoid;
        padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc;
      }
      @page { margin:10mm 10mm 12mm 10mm; }
      #printHeader{ display:block !important; }
      #ph-score .big{ font-size:22px; font-weight:800; }
    }
  </style>
</head>
<body>
  <header>
    <h1>è‹±èªå½±ç‰‡æ’­æ”¾å™¨</h1>
    <div id="authArea" style="display:flex;gap:10px;align-items:center">
      <button id="btnLogin" class="btn">ç™»å…¥</button>
      <button id="btnLogout" class="btn" style="display:none">ç™»å‡º</button>
      <span id="userNameBadge" class="muted"></span>
    </div>
  </header>

  <!-- åˆ—å°æŠ¬é ­ï¼ˆç°¡åŒ–ï¼‰ -->
  <div id="printHeader" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <img id="ph-logo" src="./images/bookwide-logo.png" alt="BookWide" style="height:18mm;object-fit:contain" onerror="this.style.display='none'">
        <div style="font-weight:700">BookWide Â· è‹±èªå½±ç‰‡æ¸¬é©—æˆç¸¾å–®</div>
      </div>
      <div id="ph-score" style="text-align:right;">
        <div>åˆ†æ•¸ï¼š<span class="big" id="ph-score-num">--</span> / 100</div>
        <div class="muted" id="ph-remark"></div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:10pt;margin-top:4px;">
      <div>å½±ç‰‡ï¼š<span id="ph-title"></span></div>
      <div>åˆ†å€ï¼š<span id="ph-sec"></span></div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- å·¦ï¼šå½±ç‰‡ -->
      <section class="left" id="videoContainer">
        <div id="videoWrap" class="videoWrap">
          <video id="player" playsinline controls></video>
        </div>

        <!-- å·¥å…·åˆ—ï¼šåº•éƒ¨æŠ½å±œï¼ˆæ‰‹æ©Ÿå¯æ”¶åˆ/å±•é–‹ï¼›æ¡Œæ©Ÿä¸€èˆ¬é¢æ¿ï¼‰ -->
        <div class="controls" id="controlsDrawer">
          <div class="drawer-grab" id="drawerGrab">
            <div class="grab-bar"></div>
            <div class="drawer-title">æ’­æ”¾å·¥å…·åˆ—ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰</div>
          </div>

          <div class="row">
            <button id="btnPrev" class="btn">â® ä¸Šä¸€å¥</button>
            <button id="btnPlay" class="btn">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
            <button id="btnNext" class="btn">â­ ä¸‹ä¸€å¥</button>
            <button id="btnReplay" class="btn">ğŸ” é‡è¤‡æœ¬å¥</button>
          </div>

          <!-- è·Ÿéš¨ / åç§» + ğŸ§­ è‡ªå‹•æ ¡æº– -->
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox"/> è·Ÿéš¨</label>
            <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
            <button id="btnOffsetMinus" class="btn">-0.5s</button>
            <button id="btnOffsetPlus" class="btn">+0.5s</button>
            <button id="btnAutoSync" class="btn">ğŸ§­ è‡ªå‹•æ ¡æº–</button>
          </div>

          <div class="row speed">
            <span class="muted">é€Ÿåº¦</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
            <span id="speedVal">1.00x</span>
          </div>
        </div>
      </section>

      <!-- å³ï¼šå­—å¹• / æ¸¬é©— / å–®å­— -->
      <section class="right" id="studyContainer">
        <div class="tabs">
          <div class="tab active" data-tab="sub" id="tabSub">å­—å¹•</div>
          <div class="tab" data-tab="quiz">æ¸¬é©—</div>
          <div class="tab" data-tab="vocab">å–®å­—</div>
        </div>

        <div class="pane">
          <!-- å­—å¹• -->
          <div id="pane-sub">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">æ™‚é–“</th>
                  <th>è‹±æ–‡</th>
                  <th style="width:40%">ä¸­æ–‡</th>
                </tr>
              </thead>
              <tbody id="cuesBody"></tbody>
            </table>
            <div id="cuesStatus" class="muted" style="padding:10px 14px"></div>
          </div>

          <!-- æ¸¬é©— -->
          <div id="pane-quiz" style="display:none">
            <div class="quiz-shell">
              <div id="quizTabs" class="q-tabs" style="margin:6px 0 10px 0;">
                <button class="qtab on" data-sec="Vocabulary">å–®å­—</button>
                <button class="qtab" data-sec="Grammar">æ–‡æ³•</button>
                <button class="qtab" data-sec="Reading">é–±è®€</button>
                <button class="qtab" data-sec="Mixed">ç¶œåˆ</button>
                <span id="quizMeta" class="muted" style="margin-left:12px"></span>
              </div>
              <ol id="quizList" style="line-height:1.6"></ol>
              <div class="q-actions" style="margin:14px 0 6px; display:flex; gap:8px; align-items:center;">
                <button class="btn" id="btnSubmitQuiz">äº¤å·</button>
                <button class="btn" id="btnShowAnswer" style="display:none">é¡¯ç¤ºç­”æ¡ˆ</button>
                <button class="btn" id="btnPrintQuiz" style="display:none">åˆ—å°æˆç¸¾å–®</button>
                <span id="quizScore" style="margin-left:8px"></span>
              </div>
              <div id="quizResult" style="display:none;margin-top:10px"></div>
            </div>
          </div>

          <!-- å–®å­— -->
          <div id="pane-vocab" style="display:none">
            <div id="vocabStatus" class="muted" style="padding:10px 14px">( å°šæœªè¼‰å…¥ )</div>
            <div id="vocabBox" style="padding:0 14px 14px"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ç¨‹å¼ -->
  <script>
  /* ======= player.jsï¼ˆå…§åµŒç‰ˆï¼Œå«è‡ªå‹•æ ¡æº–ï¼‰ ======= */
  (() => {
    const $  = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];

    // DOM
    const video      = $('#player');
    const videoWrap  = $('#videoWrap');

    const btnPrev        = $('#btnPrev');
    const btnPlay        = $('#btnPlay');
    const btnNext        = $('#btnNext');
    const btnReplay      = $('#btnReplay');

    const tabs      = $$('.tab');
    const paneSub   = $('#pane-sub');
    const paneQuiz  = $('#pane-quiz');
    const paneVocab = $('#pane-vocab');

    const cuesBody   = $('#cuesBody');
    const cuesStatus = $('#cuesStatus');
    const chkFollow  = $('#chkFollow');
    const btnOffsetMinus = $('#btnOffsetMinus');
    const btnOffsetPlus  = $('#btnOffsetPlus');
    const offsetVal      = $('#offsetVal');
    const speedRange     = $('#speedRange');
    const speedVal       = $('#speedVal');

    // URL
    const params = new URLSearchParams(location.search);
    const slug   = params.get('slug') || 'mid-autumn';

    // ç‹€æ…‹
    let cues = [];
    let offset = 0;
    let follow = false; // é è¨­ä¸è·Ÿéš¨
    let loopSentence = false;

    // utils
    const toSec = (t) => {
      if (typeof t === 'number') return t;
      const p = String(t).split(':').map(Number);
      if (p.length===3) return p[0]*3600 + p[1]*60 + p[2];
      if (p.length===2) return p[0]*60 + p[1];
      return Number(t)||0;
    };
    const fmt = (sec) => {
      sec=Math.max(0, sec|0); const m=(sec/60)|0, s=sec%60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    };
    const esc = (s) => String(s??'')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    // åç§» setterï¼ˆä¾› UI/è‡ªå‹•æ ¡æº–/é‚„åŸä½¿ç”¨ï¼‰
    function setOffset(newOffset){
      offset = Number(newOffset) || 0;
      if (offsetVal) offsetVal.textContent = `${offset.toFixed(1)}s`;
    }
    // æš´éœ²
    window.player = window.player || {};
    window.player.setOffset = setOffset;
    window.player.clearRepeat = function(){ loopSentence=false; btnReplay?.classList.remove('blue'); };

    // ====== è¼‰å…¥ ======
    async function loadVideo() {
      video.crossOrigin = 'anonymous'; // è®“ WebAudio å¯è®€å–éŸ³è¨Š
      video.src = `./videos/${slug}.mp4`;
      video.addEventListener('error',()=>{ if(cuesStatus) cuesStatus.textContent='âš ï¸ ç„¡æ³•è¼‰å…¥å½±ç‰‡';},{once:true});
    }
    async function loadCues() {
      try{
        const r = await fetch(`./data/cues-${slug}.json?v=${Date.now()}`,{cache:'no-store'});
        if(!r.ok) throw 0;
        const json = await r.json();
        cues = (json||[]).map(x=>({t:toSec(x.time), en:x.en||'', zh:x.zh||''}));
      }catch{ cues = []; }
      renderCues();
    }
    function renderCues(){
      cuesBody.innerHTML='';
      if(!cues.length){ cuesStatus.textContent='âš ï¸ æŸ¥ç„¡å­—å¹•è³‡æ–™'; return; }
      cuesStatus.textContent='';
      cuesBody.innerHTML = cues.map((c,i)=>`
        <tr data-i="${i}">
          <td class="muted" style="width:80px">${c.t?fmt(c.t):''}</td>
          <td>${esc(c.en)}</td>
          <td style="width:40%">${esc(c.zh)}</td>
        </tr>
      `).join('');
      $$('#cuesBody tr').forEach(tr=> tr.addEventListener('click',()=>{
        const i=+tr.dataset.i;
        seekTo(i,true);
      }));
    }

    const currentIndex = () => {
      const t = video.currentTime + offset;
      let i=0; while(i+1<cues.length && cues[i+1].t <= t+0.0001) i++; return i;
    };
    const highlightRow = (idx) => {
      const trs = $$('#cuesBody tr'); trs.forEach(tr=>tr.classList.remove('active'));
      const tr = trs[idx]; if(!tr) return; tr.classList.add('active');
      if (follow) tr.scrollIntoView({block:'center',behavior:'smooth'});
    };
    const seekTo = (idx, play=true) => {
      if(!cues[idx]) return;
      video.currentTime = Math.max(0,cues[idx].t - offset + 0.0001);
      highlightRow(idx); if(play) video.play();
    };
    const sentenceRange = (idx)=>{
      if(!cues[idx]) return [0,0];
      const s=cues[idx].t, e=(idx+1<cues.length?cues[idx+1].t:s+3);
      return [s,e];
    };

    // ====== å–®å­—ï¼ˆç•¥ï¼šå¯ä¾éœ€è¦å†è¼‰å…¥ï¼‰ ======
    async function loadVocabUI(){ /* å¯èˆ‡ä½ ç¾æœ‰çš„ vocab æª”çµåˆï¼›æ­¤è™•ç•¥ */ }

    // ====== æ¸¬é©—ï¼ˆå››åˆ†å€ï¼‰ ======
    async function bootQuizTab(){
      const pane = paneQuiz;
      if(!pane){ console.warn('[quiz] #pane-quiz not found'); return; }

      const $q=(s)=>pane.querySelector(s);
      const listEl=$q('#quizList'), metaEl=$q('#quizMeta');
      const btnSubmit=$q('#btnSubmitQuiz'), btnPrint=$q('#btnPrintQuiz'), btnShowAns=$q('#btnShowAnswer');
      const resultEl=$q('#quizResult');

      // load
      let raw=[];
      try{
        const r=await fetch(`./data/quiz-${slug}.json?v=${Date.now()}`,{cache:'no-store'});
        if(!r.ok) throw new Error(`${r.status}`);
        raw=await r.json(); if(!Array.isArray(raw)&&!raw.sections) throw 0;
      }catch(e){
        metaEl.textContent='âš ï¸ é¡Œåº«è¼‰å…¥å¤±æ•—'; console.error(e); return;
      }

      let questions=[];
      if (Array.isArray(raw)){
        questions = raw.map(q => ({
          section:(q.section||'Mixed'),
          type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
          question:q.question||q.q||'',
          options:q.options||q.choices||[],
          answer:q.answer??q.ans??'',
          explanation:q.explanation||q.ex||''
        }));
      }else if (raw.sections){
        const push=(sec,arr=[])=>arr?.forEach(q=>questions.push({
          section:sec, type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
          question:q.question||'', options:q.options||[], answer:q.answer??'',
          explanation:q.explanation||''
        }));
        push('Vocabulary',raw.sections.vocab);
        push('Grammar',raw.sections.grammar);
        push('Reading',raw.sections.reading);
        push('Mixed',raw.sections.mixed);
      }

      const renderSection=(sec)=>{
        const data=questions.filter(q=>q.section===sec);
        if(!data.length){ listEl.innerHTML='<li style="color:#9fb3ff">ï¼ˆæ­¤åˆ†å€ç„¡é¡Œç›®ï¼‰</li>'; metaEl.textContent='0 é¡Œ'; return; }
        listEl.innerHTML=data.map((q,i)=>{
          const idx=i+1;
          if(q.type==='MCQ'){
            const opts=q.options.map(opt=>`
              <label style="display:block;margin:4px 0">
                <input type="radio" name="q${sec}-${idx}" value="${String(opt)}"> ${String(opt)}
              </label>`).join('');
            return `<li data-sec="${sec}" data-idx="${idx}" data-type="MCQ" data-ans="${String(q.answer)}">
              <div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div>
              <div>${opts}</div>
              <div class="msg" style="margin-top:4px"></div>
              <div class="exp" style="margin-top:4px;color:#9fb3ff"></div>
            </li>`;
          }else{
            return `<li data-sec="${sec}" data-idx="${idx}" data-type="SA" data-ans="${String(q.answer)}">
              <div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div>
              <input type="text" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff">
              <button class="btn btn-check" style="margin-left:6px">æª¢æŸ¥</button>
              <div class="msg" style="margin-top:4px"></div>
              <div class="exp" style="margin-top:4px;color:#9fb3ff"></div>
            </li>`;
          }
        }).join('');
        metaEl.textContent=`${sec}ï¼š${data.length} é¡Œ`;

        listEl.addEventListener('click', e=>{
          if(!e.target.classList.contains('btn-check')) return;
          const li=e.target.closest('li'); const ipt=li.querySelector('input[type="text"]');
          const msg=li.querySelector('.msg'); const exp=li.querySelector('.exp');
          const user=(ipt.value||'').trim().toLowerCase();
          const ans=String(li.dataset.ans||'').trim().toLowerCase();
          const ok=(user===ans);
          msg.textContent = ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤';
          msg.style.color = ok?'#5bd3c7':'#ff6b6b';
          exp.textContent = ok?'':`æ­£è§£ï¼š${li.dataset.ans}`;
        }, { once:true });
      };

      pane.querySelectorAll('.qtab').forEach(b=>{
        b.addEventListener('click',()=>{
          pane.querySelectorAll('.qtab').forEach(x=>x.classList.remove('on'));
          b.classList.add('on'); renderSection(b.dataset.sec);
        });
      });

      const btnSubmit=$q('#btnSubmitQuiz'), btnPrint=$q('#btnPrintQuiz'), btnShowAns=$q('#btnShowAnswer');
      btnSubmit.onclick=()=>{
        const items=[...$q('#quizList').querySelectorAll('li')]; if(!items.length) return;
        let got=0, total=items.length;
        items.forEach(li=>{
          const type=li.dataset.type; const ans=String(li.dataset.ans||'').trim();
          if(type==='MCQ'){
            const sel=li.querySelector('input[type="radio"]:checked'); const user=sel?sel.value:'';
            const ok=(user===ans); if(ok) got++;
            const msg=li.querySelector('.msg'), exp=li.querySelector('.exp');
            msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b';
            exp.textContent=ok?'':`æ­£è§£ï¼š${ans}`;
          }else{
            const ipt=li.querySelector('input[type="text"]'); const user=(ipt.value||'').trim();
            const ok=(user.toLowerCase()===ans.toLowerCase()); if(ok) got++;
            const msg=li.querySelector('.msg'), exp=li.querySelector('.exp');
            msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b';
            exp.textContent=ok?'':`æ­£è§£ï¼š${ans}`;
          }
        });
        const score = got*5; const full = total*5;
        $('#quizScore').textContent = `æœ¬åˆ†å€åˆ†æ•¸ï¼š${score} / ${full}`;
        $q('#quizResult').style.display='block';
        $q('#btnPrintQuiz').style.display='inline-block';
        $q('#btnShowAnswer').style.display='inline-block';
      };
      btnShowAns.onclick=()=>{
        $q('#quizList').querySelectorAll('li').forEach(li=>{
          const exp=li.querySelector('.exp'); if(exp && !exp.textContent) exp.textContent=`æ­£è§£ï¼š${li.dataset.ans}`;
        });
      };
      btnPrint.onclick=()=>window.print();

      renderSection('Vocabulary');
    }

    // ====== æ§åˆ¶åˆ— ======
    speedRange?.addEventListener('input',()=>{
      const r=Number(speedRange.value)||1; video.playbackRate=r;
      if(speedVal) speedVal.textContent=`${r.toFixed(2)}x`;
    });
    btnPlay?.addEventListener('click',()=>{ if(video.paused) video.play(); else video.pause(); });
    btnPrev?.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
    btnNext?.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));

    // é‡è¤‡æœ¬å¥å–®éµåˆ‡æ›
    (function(){
      const btn = btnReplay; if(!btn) return;
      const on = ()=>{ btn.dataset.active='1'; btn.classList.add('blue'); };
      const off= ()=>{ btn.dataset.active='0'; btn.classList.remove('blue'); loopSentence=false; };
      off();
      btn.addEventListener('click',function(e){
        const isOn = btn.dataset.active==='1';
        if(isOn){
          e.stopImmediatePropagation();
          window.player?.clearRepeat?.(); off(); return;
        }
        loopSentence=true; on(); seekTo(currentIndex(),true);
      }, true);
    })();

    btnOffsetMinus?.addEventListener('click',()=>{ setOffset(offset-0.5); saveOffset(); });
    btnOffsetPlus ?.addEventListener('click',()=>{ setOffset(offset+0.5); saveOffset(); });
    chkFollow     ?.addEventListener('change',()=> follow=chkFollow.checked);

    // æ’­æ”¾äº‹ä»¶
    video.addEventListener('timeupdate',()=>{
      if(!cues.length) return;
      const i=currentIndex(); highlightRow(i);
      const t=video.currentTime+offset;

      if(loopSentence){
        const [s,e]=sentenceRange(i);
        if(t>=e-0.02){ video.currentTime=Math.max(0,s-offset+0.0001); video.play(); }
      }
    });

    // åˆ†é åˆ‡æ› + æ‰‹æ©Ÿé–±è®€æ¨¡å¼
    (function(){
      function applyReadMode(){
        if (window.innerWidth <= 900) {
          const active = document.querySelector('.tabs .tab.active')?.dataset.tab;
          if (active==='sub' && chkFollow && !chkFollow.checked) document.body.classList.add('read-mode');
          else document.body.classList.remove('read-mode');
        } else {
          document.body.classList.remove('read-mode');
        }
      }
      function show(name){
        paneSub.style.display   = name==='sub'   ? '' : 'none';
        paneQuiz.style.display  = name==='quiz'  ? '' : 'none';
        paneVocab.style.display = name==='vocab' ? '' : 'none';
        tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
        if (window.innerWidth <= 900) {
          if (name==='quiz' || name==='vocab') document.body.classList.add('focus-mode');
          else document.body.classList.remove('focus-mode');
        }
        applyReadMode();
      }
      tabs.forEach(t=> t.addEventListener('click', ()=> show(t.dataset.tab)));
      $('#tabSub')?.addEventListener('click', applyReadMode);
      chkFollow?.addEventListener('change', applyReadMode);
      window.addEventListener('resize', applyReadMode);
      show(document.querySelector('.tabs .tab.active')?.dataset.tab || 'sub');
    })();

    // ===== è‡ªå‹•æ ¡æº–ï¼šç”¨å‰æ®µéŸ³è¨Šæ‰¾èªéŸ³èµ·é»ï¼Œèˆ‡ç¬¬ä¸€å¥å­—å¹•æ¯”å‡ºå…¨ç‰‡åç§» Î” =====
    (function autoSyncInit(){
      const btn = document.getElementById('btnAutoSync');
      if (!btn || !video) return;

      function saveOffset(){ localStorage.setItem(`offset:${slug}`, String(offset)); }
      window.saveOffset = saveOffset; // è®“ä¸Šé¢æŒ‰éˆ•å¯å‘¼å«

      function getFirstCueStart(){
        if (cues && cues.length) return cues[0].t || 0;
        const firstRow = document.querySelector('#cuesBody tr');
        if (!firstRow) return null;
        const m = firstRow.querySelector('td')?.textContent?.trim().match(/(\d{2}):(\d{2})/);
        if (!m) return null;
        return parseInt(m[1],10)*60 + parseInt(m[2],10);
      }

      async function estimateSpeechStart(){
        try{
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          if (ctx.state === 'suspended') { try{ await ctx.resume(); }catch{} }
          const src = ctx.createMediaElementSource(video);
          const an  = ctx.createAnalyser();
          an.fftSize = 2048;
          src.connect(an); an.connect(ctx.destination);

          const SAMPLE_SECONDS = Math.min(30, Math.max(10, video.duration || 30));
          const buf = new Float32Array(an.fftSize);

          const wasPaused = video.paused;
          const oldTime   = video.currentTime;
          try { video.pause(); } catch {}
          video.currentTime = 0;

          const ENERGY_TH = 0.03, HOLD_MS = 120;
          let firstSpeechAt = null, overSince=null;

          await new Promise(resolve=>{
            function tick(){
              an.getFloatTimeDomainData(buf);
              let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+=v*v; }
              const rms = Math.sqrt(sum/buf.length);
              const now = performance.now();
              const t   = video.currentTime;

              if (rms > ENERGY_TH){
                if (overSince==null) overSince=now;
                if (now - overSince > HOLD_MS && firstSpeechAt==null) firstSpeechAt=t;
              } else {
                overSince=null;
              }
              if (t >= SAMPLE_SECONDS || firstSpeechAt!=null) return resolve();
              requestAnimationFrame(tick);
            }
            video.play().then(()=>requestAnimationFrame(tick)).catch(()=>resolve());
          });

          try { video.pause(); } catch {}
          video.currentTime = oldTime;
          if (!wasPaused) { try { await video.play(); } catch {} }
          await ctx.close();

          return firstSpeechAt;
        }catch(e){
          console.warn('AutoSync error:', e);
          return null;
        }
      }

      btn.addEventListener('click', async ()=>{
        btn.disabled = true;
        const oldTxt = btn.textContent;
        btn.textContent = 'æ ¡æº–ä¸­â€¦';

        const speechAt = await estimateSpeechStart();
        const cueAt    = getFirstCueStart();

        if (speechAt != null && cueAt != null){
          const delta = +(speechAt - cueAt).toFixed(1);
          setOffset(delta);
          saveOffset();
          btn.textContent = 'ğŸ§­ è‡ªå‹•æ ¡æº– âœ“';
          setTimeout(()=> btn.textContent = oldTxt, 1500);
        }else{
          alert('å‰æ®µéŸ³è¨Šç‰¹å¾µä¸æ˜é¡¯ï¼Œç„¡æ³•è‡ªå‹•æ ¡æº–ã€‚\nè«‹å…ˆæ’­åˆ°æœ‰è²éŸ³çš„åœ°æ–¹å†æŒ‰ä¸€æ¬¡ï¼Œæˆ–ç”¨ Â±0.5s æ‰‹å‹•å¾®èª¿ã€‚');
          btn.textContent = oldTxt;
        }
        btn.disabled = false;
      });

      // åˆå§‹åŒ–ï¼šå¥—ç”¨ä¸Šä¸€å›æ ¡æº–å€¼
      const saved = localStorage.getItem(`offset:${slug}`);
      if (saved !== null) setOffset(parseFloat(saved));
    })();

    // å•Ÿå‹•
    (async function init(){
      const r=Number(speedRange?.value)||1; video.playbackRate=r;
      if(speedVal) speedVal.textContent=`${r.toFixed(2)}x`;
      await loadVideo(); await loadCues(); await bootQuizTab();
    })();
  })();
  </script>
</body>
</html>






