<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}
  .layout{display:grid;grid-template-columns:minmax(280px,1fr) 420px;gap:var(--gap);height:100%}
  @media(max-width:1024px){ .layout{grid-template-columns:1fr} }
  .videoWrap{display:flex;flex-direction:column;background:#000;position:relative}
  .videoStage{display:flex;align-items:center;justify-content:center;background:#000;flex:1}
  video{width:100%;height:100%;max-height:100vh;object-fit:contain;background:#000;transition:transform .15s}

  /* 控制面板 */
  .controls{
    display:flex;flex-wrap:wrap;gap:8px;
    background:#0f1a33;border:1px solid var(--border);
    padding:10px;border-radius:12px;margin:8px;
  }
  .controls .btn{background:#15224a;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 12px;cursor:pointer}
  .controls .btn:hover{filter:brightness(1.1)}
  .controls .btn.active{outline:2px solid var(--brand)}
  .controls .grp{display:flex;gap:8px;align-items:center}
  .controls label{color:var(--muted);margin-left:6px;margin-right:6px}
  .controls input[type="range"]{vertical-align:middle}

  /* 右側欄 */
  .side{display:flex;flex-direction:column;background:var(--panel);border-left:1px solid var(--border)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .btn2{padding:8px 10px;border:1px solid var(--border);background:#15224a;color:var(--text);border-radius:10px;cursor:pointer}
  .btn2:hover{filter:brightness(1.1)}
  .chip{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}
  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}

  /* 字幕 */
  .line{line-height:1.5;margin:8px 0}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:6px}
  .line:hover{background:#15224a;border-radius:8px;padding:4px}

  /* 測驗 */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}

  /* 亮/暗主題 */
  .light{--bg:#f7f8fb;--panel:#ffffff;--border:#e4e7f0;--text:#222;--muted:#667;background:#fff;color:#222}
  .light .videoStage{background:#111}
  .light .btn2,.light .chip,.light .controls .btn{background:#f4f6fb;border-color:#e4e7f0;color:#333}
  .light .tab.active{background:#eaf1ff}
</style>
</head>
<body>
<div class="layout">
  <!-- 左：影片 -->
  <div class="videoWrap">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- 進階控制面板 -->
    <div class="controls">
      <div class="grp">
        <button class="btn" id="btnPrev">⏮ 上一句</button>
        <button class="btn" id="btnPlay">▶ 播放/暫停</button>
        <button class="btn" id="btnNext">⏭ 下一句</button>
        <button class="btn" id="btnRepeat">🔁 重複本句</button>
      </div>

      <div class="grp">
        <button class="btn" id="btnAutoPause">⏸ 逐句自動暫停</button>
        <button class="btn" id="btnLoopAB">A-B 點句循環</button>
        <button class="btn" id="btnCancelLoop">❌ 取消循環</button>
      </div>

      <div class="grp">
        <button class="btn" id="btnFit">🖼 適應畫面</button>
      </div>

      <div class="grp" style="margin-left:auto">
        <label>變焦</label>
        <input type="range" id="zoomRange" min="0.5" max="2" step="0.1" value="1">
        <label>速度</label>
        <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1">
        <span id="speedLabel" class="muted">1.00×</span>
      </div>
    </div>
  </div>

  <!-- 右：字幕/測驗 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <!-- 工具列 -->
    <div class="toolbar">
      <div class="row">
        <span class="muted">字級</span>
        <button id="fS" class="chip">S</button>
        <button id="fM" class="chip active">M</button>
        <button id="fL" class="chip">L</button>
      </div>
      <div style="flex:1"></div>
      <button id="btnTheme" class="btn2">主題</button>
    </div>

    <!-- 字幕 -->
    <div id="panelTranscript" class="panel"></div>

    <!-- 測驗 -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>

      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div class="row">
            <button id="btnCheck" class="btn2">交卷</button>
            <button id="btnRetry" class="btn2" style="display:none">再試一次</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>
  </aside>
</div>

<script>
/* ------------------ 小工具 ------------------ */
const $  = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';
let FONT = 'M'; // S/M/L

function setFont(size){
  FONT = size;
  const map = {S:'13px', M:'15px', L:'17px'};
  $$('#panelTranscript, #panelQuiz, .q').forEach(el=> el.style.fontSize = map[size]||'15px');
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* ------------------ 載入索引 ------------------ */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json 載入失敗');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=> x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json 無對應項目');
  return item; // {video,cues,quiz,...}
}

/* ------------------ 設定影片 ------------------ */
function setupVideo(src){
  $('#player').src = src;
}

/* ------------------ 字幕 ------------------ */
const toSec = (t)=>{
  const parts = (t||'0:0').split(':').map(x=>parseFloat(x)||0);
  if(parts.length===3) return parts[0]*3600 + parts[1]*60 + parts[2];
  return parts[0]*60 + parts[1];
};
async function loadCues(path){
  const r = await fetch(path);
  if(!r.ok) throw new Error('字幕 JSON 載入失敗');
  return await r.json();
}
let cuesList = []; // {t,s,sec}
function renderTranscript(data){
  const box = $('#panelTranscript');
  box.innerHTML = '';
  const list = Array.isArray(data)? data : (data.items||[]);
  cuesList = list.map(row=>{
    const t = row.time || row.t || row.start || '';
    const s = row.text || row.en || row.caption || '';
    return { t, s, sec: toSec(t) };
  });
  cuesList.forEach(row=>{
    const div = document.createElement('div');
    div.className = 'line';
    div.innerHTML = `<span class="time">[${row.t}]</span>${row.s}`;
    div.onclick = ()=>{ const v=$('#player'); v.currentTime=row.sec; v.play(); };
    box.appendChild(div);
  });
}

/* ------------------ 測驗 ------------------ */
async function loadQuiz(path){
  const r = await fetch(path);
  if(!r.ok) throw new Error('測驗 JSON 載入失敗');
  const raw = await r.json();
  let arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  return arr.slice(0,20).map((x,i)=>{
    const q = x.question || x.q || x.title || `Q${i+1}`;
    const opts = x.options || x.choices || x.a || [];
    let ans = x.answerIndex ?? x.correct ?? x.ans ?? 0;
    if(typeof ans!=='number'){
      const idx = opts.findIndex(o=> (o.text||o)===ans);
      ans = idx>=0? idx : 0;
    }
    return {q, opts:opts.map(o=> (o.text||o)), ans, explain: x.explain || x.note || ''};
  });
}
function renderQuiz(questions){
  const box = $('#quizBox');
  box.innerHTML = '';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    wrap.innerHTML = `<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt, j)=>{
      const line = document.createElement('label');
      line.className = 'opt';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}"/><span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick = ()=>{
    let correct = 0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const val = picked ? parseInt(picked.value,10) : -1;
      if(val===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    const res = $('#quizResult');
    res.style.display = 'block';
    res.className = 'result ' + (ratio>=80 ? 'pass':'fail');
    res.textContent = `分數：${correct} / ${questions.length}（${ratio}%）` + (ratio>=80?'  👍 太棒了！':'  再接再厲！');
    $('#btnRetry').style.display = 'inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent = `0 / ${questions.length}`;
    const res = $('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display = 'none';
  };
}

/* ------------------ 分頁/主題/字級 ------------------ */
function setupTabs(){
  const t1 = $('#tabTranscript'), p1 = $('#panelTranscript');
  const t2 = $('#tabQuiz'),       p2 = $('#panelQuiz');
  t1.onclick = ()=>{ t1.classList.add('active'); t2.classList.remove('active'); p1.style.display='block'; p2.style.display='none'; };
  t2.onclick = ()=>{ t2.classList.add('active'); t1.classList.remove('active'); p2.style.display='block'; p1.style.display='none'; };
}
function bindUI(){
  $('#fS').onclick = ()=> setFont('S');
  $('#fM').onclick = ()=> setFont('M');
  $('#fL').onclick = ()=> setFont('L');
  $('#btnTheme').onclick = ()=> document.body.classList.toggle('light');
}

/* ------------------ 進階控制：逐句/AB/倍速/變焦 ------------------ */
const v = document.getElementById('player');
let curIndex = 0;
let autoPause = false;
let loopA = null, loopB = null;

v.addEventListener('timeupdate', ()=>{
  const t = v.currentTime;

  if(loopA!=null && loopB!=null && t >= loopB - 0.04){ v.currentTime = loopA; return; }

  while(curIndex+1 < cuesList.length && t >= cuesList[curIndex+1].sec) curIndex++;
  while(curIndex>0 && t < cuesList[curIndex].sec) curIndex--;

  if(autoPause){
    const nextSec = cuesList[curIndex+1]?.sec ?? Infinity;
    if(t >= nextSec - 0.04) v.pause();
  }
});

$('#btnPrev').onclick  = ()=>{ if(!cuesList.length) return; curIndex=Math.max(0,curIndex-1); v.currentTime=cuesList[curIndex].sec; v.play(); };
$('#btnNext').onclick  = ()=>{ if(!cuesList.length) return; curIndex=Math.min(cuesList.length-1,curIndex+1); v.currentTime=cuesList[curIndex].sec; v.play(); };
$('#btnPlay').onclick  = ()=> v.paused ? v.play() : v.pause();
$('#btnRepeat').onclick= ()=>{ if(!cuesList.length) return; v.currentTime=cuesList[curIndex].sec; v.play(); };

$('#btnAutoPause').onclick = ()=>{ autoPause=!autoPause; $('#btnAutoPause').classList.toggle('active',autoPause); };

$('#btnLoopAB').onclick = ()=>{
  if(loopA==null){ loopA=v.currentTime; $('#btnLoopAB').textContent='A 設定 ✓；再按設 B'; }
  else if(loopB==null){ loopB=v.currentTime; $('#btnLoopAB').textContent='A-B 循環中'; }
  else { loopA=v.currentTime; loopB=null; $('#btnLoopAB').textContent='A 設定 ✓；再按設 B'; }
};
$('#btnCancelLoop').onclick = ()=>{ loopA=loopB=null; $('#btnLoopAB').textContent='A-B 點句循環'; };

$('#btnFit').onclick = ()=>{ v.style.objectFit = (v.style.objectFit==='cover'?'contain':'cover'); };

$('#zoomRange').oninput = e=>{ v.style.transformOrigin='center center'; v.style.transform=`scale(${parseFloat(e.target.value)})`; };
$('#speedRange').oninput= e=>{ v.playbackRate=parseFloat(e.target.value); $('#speedLabel').textContent=v.playbackRate.toFixed(2)+'×'; };
v.playbackRate = parseFloat($('#speedRange').value);
$('#speedLabel').textContent = v.playbackRate.toFixed(2)+'×';

/* ------------------ 啟動 ------------------ */
(async ()=>{
  try{
    setupTabs();
    bindUI();
    setFont('M');

    const meta = await loadMeta();
    setupVideo(meta.video);
    const cues = await loadCues(meta.cues);
    renderTranscript(cues);

    if(meta.quiz){
      const qs = await loadQuiz(meta.quiz);
      renderQuiz(qs);
    }else{
      $('#tabQuiz').style.display='none';
    }
  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">載入失敗：${err.message}</div>`;
  }
})();
</script>
</body>
</html>
