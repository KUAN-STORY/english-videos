<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;}

  /* å…©æ¬„å¸ƒå±€ï¼šå·¦å½±ç‰‡ / å³é¢æ¿ */
  .layout{
    display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh;
  }
  @media(max-width:1024px){
    .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; }
  }

  /* å·¦æ¬„ï¼šä¸Šæ–¹å½±ç‰‡èˆå° + ä¸‹æ–¹å·¥å…·åˆ— */
  .videoColumn{
    display:grid; grid-template-rows: 1fr auto; min-height:0;
    border-right:1px solid var(--border);
  }
  .videoStage{
    min-height:0; display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden;
  }
  video{
    max-width:100%; max-height:100%;
    width:auto; height:auto; object-fit:contain; background:#000;
    transform-origin:center center;
  }
  .toolBar{
    position:relative; z-index:2;
    padding:10px 12px; background:#101b39;
    border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .btn,.chip{
    border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; user-select:none;
  }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }

  /* å³æ¬„ */
  .side{ display:flex; flex-direction:column; min-height:0; background:var(--panel); }
  .tabs{ display:flex; border-bottom:1px solid var(--border) }
  .tab{ flex:1; padding:10px 12px; text-align:center; cursor:pointer;
        color:var(--muted); user-select:none }
  .tab.active{ color:var(--text); background:#132046; font-weight:700 }
  .toolbar{ display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid var(--border)}
  .panel{ flex:1; overflow:auto; padding:12px }

  /* å­—å¹•ä¸‰æ¬„è¡¨ */
  .table{ width:100%; border-collapse:collapse; }
  .table th,.table td{ border-bottom:1px solid var(--border); padding:10px; vertical-align:top }
  .table th{ color:#a9b3cf; font-weight:600; position:sticky; top:0; background:#0f1a33; z-index:1 }
  .row.active{ background:#1a2c66; border-radius:6px }
  .time{ color:var(--muted); font-variant-numeric:tabular-nums; white-space:nowrap }

  /* å–®å­—å¡Š */
  .vcard{ border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px; background:#0f1a33 }
  .vtitle{ font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px }
  .muted{ color:var(--muted) }

  /* å­—ç´šå¿«æ·ï¼ˆåªèª¿å³æ¬„ï¼‰ */
  .fs-s{ font-size:13px }
  .fs-m{ font-size:15px }
  .fs-l{ font-size:17px }
</style>
</head>
<body>
<div class="layout">

  <!-- å·¦ï¼šå½±ç‰‡ -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
      <button class="btn" id="btnPlay">æ’­æ”¾/æš«åœ</button>
      <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>

      <button class="btn" id="btnRepeatOne">é‡è¤‡æœ¬å¥</button>
      <button class="btn" id="btnAB">A-B å¾ªç’°</button>
      <button class="btn" id="btnABClear">å–æ¶ˆå¾ªç’°</button>

      <label class="chip">è®Šç„¦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" style="vertical-align:middle; width:140px; margin-left:8px;">
      </label>
      <label class="chip">é€Ÿåº¦
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" style="vertical-align:middle; width:160px; margin-left:8px;">
        <span id="rateLabel" style="margin-left:6px">1.00Ã—</span>
      </label>
    </div>
  </section>

  <!-- å³ï¼šå­—å¹• / æ¸¬é©— / å–®å­— -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
      <div id="tabVocab" class="tab">å–®å­—</div>
    </div>

    <div class="toolbar">
      <span class="muted">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">è·Ÿéš¨</button>
    </div>

    <!-- å­—å¹•é¢æ¿ -->
    <div id="panelTranscript" class="panel fs-m">
      <table class="table" id="cueTable">
        <thead>
          <tr><th style="width:90px">æ™‚é–“</th><th>è‹±æ–‡</th><th style="width:36%">ä¸­æ–‡</th></tr>
        </thead>
        <tbody id="cueBody"></tbody>
      </table>
    </div>

    <!-- æ¸¬é©—é¢æ¿ -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div style="margin-top:12px">
        <button class="btn" id="btnCheck">äº¤å·</button>
        <button class="btn" id="btnRetry" style="display:none">å†è©¦ä¸€æ¬¡</button>
        <span id="quizProgress" class="muted" style="margin-left:8px">0 / 0</span>
        <div id="quizResult" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- å–®å­—é¢æ¿ -->
    <div id="panelVocab" class="panel" style="display:none">
      <div id="vocabBox"></div>
    </div>
  </aside>
</div>

<script>
/* ========= å°å·¥å…· ========= */
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* ========= å­—ç´š / è·Ÿéš¨ ========= */
let follow = false;
function setFont(size){
  $('#panelTranscript').classList.remove('fs-s','fs-m','fs-l');
  $('#panelTranscript').classList.add({'S':'fs-s','M':'fs-m','L':'fs-l'}[size] || 'fs-m');
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* ========= è¼‰å…¥ index.json ========= */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item; // {video, cues, quiz?, vocab?}
}

/* ========= è¼‰å…¥å­—å¹• =========
   æ”¯æ´æ ¼å¼ï¼š
   - [{time:"00:05", text:"...", zh:"..."}]
   - æˆ– {items:[...]} äº¦å¯
*/
let cueList = []; // [{tSec,en,zh,trEl}]
function toSec(t){ const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0); return m*60+s; }

async function loadCues(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('å­—å¹• JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  return Array.isArray(raw) ? raw : (raw.items||[]);
}
function renderTranscript(rows){
  const body = $('#cueBody'); body.innerHTML = '';
  cueList = rows.map(r=>{
    const t  = r.time || r.t || r.start || '0:00';
    const en = r.text || r.en || '';
    const zh = r.zh   || r.cn || r.zh_tw || '';
    const tr = document.createElement('tr');
    tr.className = 'row';
    tr.innerHTML = `<td class="time">[${t}]</td><td>${en}</td><td>${zh}</td>`;
    tr.onclick = ()=>{
      $('#player').currentTime = toSec(t);
      $('#player').play();
    };
    body.appendChild(tr);
    return { tSec: toSec(t), en, zh, trEl: tr };
  });
}

/* é€å¥é«˜äº® + è·Ÿéš¨ */
function highlightByTime(current){
  let idx = -1;
  for(let i=0;i<cueList.length;i++){
    if(cueList[i].tSec <= current) idx=i; else break;
  }
  $$('#cueBody .row').forEach(r=>r.classList.remove('active'));
  if(idx>=0){
    const el = cueList[idx].trEl;
    el.classList.add('active');
    if(follow) el.scrollIntoView({block:'center', behavior:'smooth'});
  }
}

/* ========= æ¸¬é©—ï¼ˆé¸æ“‡/å¡«ç©ºï¼‰ =========
   æ”¯æ´ï¼š
   - Array æˆ– {items:[]}
   - å•: q/title/question
   - é¸é …: a/options/choices
   - ç­”æ¡ˆ: ans/answerIndex/correct (ç´¢å¼•æˆ–æ–‡å­—)
*/
async function loadQuiz(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('æ¸¬é©— JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  const arr = Array.isArray(raw) ? raw : (raw.items||raw.questions||[]);
  return arr.slice(0,20).map((x,i)=>{
    const q = x.q || x.title || x.question || `Q${i+1}`;
    const opts = x.a || x.options || x.choices || [];
    let ans = x.ans ?? x.answerIndex ?? x.correct ?? 0;
    if(typeof ans!=='number'){  // å¦‚æœç­”æ¡ˆæ˜¯æ–‡å­—ï¼Œè½‰æˆç´¢å¼•
      const idx = opts.findIndex(o=> (o.text||o)===ans);
      ans = idx>=0? idx : 0;
    }
    return {q, opts:opts.map(o=>(o.text||o)), ans};
  });
}
function renderQuiz(questions){
  const box = $('#quizBox'); box.innerHTML = '';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'vcard';
    wrap.innerHTML = `<div class="vtitle">${i+1}. ${q.q}</div>`;
    q.opts.forEach((opt,j)=>{
      const id = `q${i}_o${j}`;
      const line = document.createElement('label');
      line.style.display='flex'; line.style.gap='8px'; line.style.margin='6px 0';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}" id="${id}"><span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick = ()=>{
    let correct = 0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const v = picked ? parseInt(picked.value,10) : -1;
      if(v===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    $('#quizResult').innerHTML = `åˆ†æ•¸ï¼š${correct}/${questions.length}ï¼ˆ${ratio}%ï¼‰` + (ratio>=80?' ğŸ‘ å¤ªæ£’äº†ï¼':' å†æ¥å†å²ï¼');
    $('#btnRetry').style.display = 'inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizResult').innerHTML = '';
    $('#btnRetry').style.display = 'none';
    $('#quizProgress').textContent = `0 / ${questions.length}`;
  };
}

/* ========= å–®å­—ï¼ˆç°¡æ½”å¡ç‰‡ï¼‰ =========
   æ¡ç”¨ä½ ç¾è¡Œå¯è®€æ ¼å¼ï¼š
   {
     "title": "...",
     "items":[{"time":"00:08","word":"lantern","pos":"n.","zh":"ç‡ˆç± ","en":"...","example":"..."}]
   }
*/
async function loadVocab(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('å–®å­— JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  return raw.items || [];
}
function renderVocab(items){
  const box = $('#vocabBox'); box.innerHTML = '';
  items.forEach(v=>{
    const card = document.createElement('div');
    card.className = 'vcard';
    const tSec = toSec(v.time||'0:0');
    card.innerHTML = `
      <div class="vtitle">
        <span>${v.word}</span>
        <span class="muted">${v.pos||''}</span>
        ${v.time? `<button class="btn" data-sec="${tSec}" style="padding:4px 8px; margin-left:6px">[${v.time}]</button>`:''}
      </div>
      <div style="margin-top:6px">${v.zh||''}</div>
      <div class="muted" style="margin-top:6px">${v.en||''}</div>
      ${v.example? `<div style="margin-top:6px">ä¾‹ï¼š${v.example}</div>`:''}
      ${v.grammar? `<div class="muted" style="margin-top:6px">æ–‡æ³•ï¼š${v.grammar}</div>`:''}
    `;
    box.appendChild(card);
  });
  // è·³è½‰æŒ‰éˆ•
  $$('#vocabBox .btn[data-sec]').forEach(b=>{
    b.onclick = ()=>{
      $('#player').currentTime = parseFloat(b.dataset.sec||'0');
      $('#player').play();
    };
  });
}

/* ========= å·¦å´å·¥å…·åˆ— ========= */
let A=null, B=null, abTimer=null, repeatOne=false;

function jumpPrev(){
  const t = $('#player').currentTime;
  const prev = [...cueList].reverse().find(c=>c.tSec < t - 0.05);
  if(prev){ $('#player').currentTime = prev.tSec; $('#player').play(); }
}
function jumpNext(){
  const t = $('#player').currentTime;
  const next = cueList.find(c=>c.tSec > t + 0.05);
  if(next){ $('#player').currentTime = next.tSec; $('#player').play(); }
}
function setRepeatOne(){
  repeatOne = true;
  const t = $('#player').currentTime;
  let i = cueList.findIndex(c=> c.tSec <= t);
  if(i<0) i=0;
  A = cueList[i].tSec;
  B = (i+1<cueList.length ? cueList[i+1].tSec : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('å·²è¨­å®š A é»'); }
  else if(B==null){ B = v.currentTime; alert('å·²è¨­å®š B é»ï¼›é–‹å§‹å¾ªç’°'); startAB(); }
  else { A=v.currentTime; B=null; alert('å·²é‡è¨­ A é»ï¼Œè«‹å†æŒ‰ä¸€æ¬¡è¨­å®š B é»'); }
}
function startAB(){
  repeatOne = false;
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    const v = $('#player');
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function clearLoop(){ repeatOne=false; A=null; B=null; clearInterval(abTimer); }

/* ========= åˆ†é  ========= */
function setupTabs(){
  const t1 = $('#tabTranscript'), p1 = $('#panelTranscript');
  const t2 = $('#tabQuiz'),       p2 = $('#panelQuiz');
  const t3 = $('#tabVocab'),      p3 = $('#panelVocab');
  const act = (a,b,c)=>{ [t1,t2,t3].forEach(x=>x.classList.remove('active'));
                         a.classList.add('active');
                         p1.style.display = (a===t1)?'block':'none';
                         p2.style.display = (a===t2)?'block':'none';
                         p3.style.display = (a===t3)?'block':'none'; };
  t1.onclick = ()=> act(t1);
  t2.onclick = ()=> act(t2);
  t3.onclick = ()=> act(t3);
}

/* ========= å•Ÿå‹• ========= */
(async ()=>{
  try{
    setupTabs();

    // å­—ç´š / è·Ÿéš¨ / å·¦å·¥å…·åˆ—
    $('#fS').onclick = ()=> setFont('S');
    $('#fM').onclick = ()=> setFont('M');
    $('#fL').onclick = ()=> setFont('L');
    $('#btnFollow').onclick = ()=>{ follow=!follow; $('#btnFollow').textContent = follow?'è·Ÿéš¨ä¸­':'è·Ÿéš¨'; };
    setFont('M');

    $('#btnPrev').onclick = jumpPrev;
    $('#btnNext').onclick = jumpNext;
    $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
    $('#btnRepeatOne').onclick = setRepeatOne;
    $('#btnAB').onclick = setAB;
    $('#btnABClear').onclick = clearLoop;
    $('#rate').oninput = e=>{ const v=$('#player'); v.playbackRate=+e.target.value; $('#rateLabel').textContent=v.playbackRate.toFixed(2)+'Ã—'; };
    $('#zoom').oninput = e=>{ $('#player').style.transform = `scale(${+e.target.value})`; };

    // è¼‰å…¥ç´¢å¼•
    const meta = await loadMeta();

    // è¨­å®šå½±ç‰‡
    $('#player').src = meta.video;

    // è¼‰å…¥å­—å¹•
    const cues = await loadCues(meta.cues);
    renderTranscript(cues);

    // æ’­æ”¾é«˜äº®
    $('#player').addEventListener('timeupdate', ()=> highlightByTime($('#player').currentTime));

    // æ¸¬é©—ï¼ˆå¯é¸ï¼‰
    if(meta.quiz){
      try{
        const qs = await loadQuiz(meta.quiz);
        renderQuiz(qs);
      }catch(e){ console.warn(e); $('#tabQuiz').style.display='none'; }
    }else{
      $('#tabQuiz').style.display='none';
    }

    // å–®å­—ï¼ˆå¯é¸ï¼‰
    if(meta.vocab){
      try{
        const vs = await loadVocab(meta.vocab);
        renderVocab(vs);
      }catch(e){ console.warn(e); $('#tabVocab').style.display='none'; }
    }else{
      $('#tabVocab').style.display='none';
    }

  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
  }
})();
</script>
</body>
</html>
