<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --ok:#14b86e; --warn:#f5a524; --gap:12px;
  }
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;
  }

  /* æ•´é«” 50/50ï¼šå·¦å½±ç‰‡ / å³é¢æ¿ */
  .layout{
    display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh;
  }
  @media(max-width:1024px){
    .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; }
  }

  /* å·¦æ¬„ï¼šä¸Šæ–¹å½±ç‰‡ 1fr + ä¸‹æ–¹å·¥å…·åˆ— autoï¼ˆä½ çš„ç‰ˆå‹åŸå°ä¸å‹•ï¼‰ */
  .videoColumn{
    display:grid; grid-template-rows: 1fr auto; min-height:0;
    border-right:1px solid var(--border);
  }
  .videoStage{
    min-height:0; display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden;
  }
  video{
    max-width:100%; max-height:100%;
    width:auto; height:auto; object-fit:contain; background:#000;
    transform-origin:center center; /* çµ¦è®Šç„¦ç”¨ */
  }
  .toolBar{
    position:relative; z-index:2;
    padding:10px 12px; background:#101b39;
    border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .btn,.chip{
    border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; user-select:none;
  }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }

  /* å³æ¬„ï¼šå­—å¹•/æ¸¬é©— */
  .side{ display:flex; flex-direction:column; min-height:0; background:var(--panel); }
  .tabs{ display:flex; border-bottom:1px solid var(--border); }
  .tab{ flex:1; padding:10px 12px; text-align:center; cursor:pointer; color:var(--muted); user-select:none; }
  .tab.active{ color:var(--text); background:#132046; font-weight:700; }
  .toolbar{ display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid var(--border); }
  .panel{ flex:1; overflow:auto; padding:12px; }

  /* å­—å¹•åˆ— */
  .line{ line-height:1.55; margin:6px 0; padding:6px 8px; border-radius:8px; cursor:pointer; }
  .line:hover{ background:#15224a; }
  .line.active{ background:#233366; outline:1px solid #3957b7; }
  .time{ color:var(--muted); margin-right:8px; font-variant-numeric:tabular-nums; }

  /* æ¸¬é©— */
  .q{ padding:12px; border:1px solid var(--border); border-radius:12px; background:#0f1a33; margin:12px 0; }
  .q h4{ margin:0 0 8px 0; font-weight:700; }
  .opt{ display:flex; gap:8px; align-items:flex-start; margin:6px 0; cursor:pointer; }
  .opt input{ margin-top:4px; }
  .stickyFoot{ position:sticky; bottom:0; background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 35%); padding-top:12px; }
  .footBar{ display:flex; gap:8px; justify-content:space-between; align-items:center; background:#101b39; border:1px solid var(--border); border-radius:12px; padding:10px; }
  .result{ margin-top:10px; padding:10px; border-radius:10px; display:none; }
  .result.pass{ background:rgba(20,184,110,.12); border:1px solid var(--ok); }
  .result.fail{ background:rgba(245,165,36,.12); border:1px solid var(--warn); }
  .muted{ color:var(--muted); }
</style>
</head>
<body>
<div class="layout">

  <!-- å·¦ï¼šå½±ç‰‡ï¼ˆä½ çš„ç‰ˆå‹ï¼Œä¸å‹•ï¼‰ -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <div class="toolBar">
      <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
      <button class="btn" id="btnPlay">æ’­æ”¾/æš«åœ</button>
      <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>

      <button class="btn" id="btnRepeatOne">é‡è¤‡æœ¬å¥</button>
      <button class="btn" id="btnAB">A-B å¾ªç’°</button>
      <button class="btn" id="btnABClear">å–æ¶ˆå¾ªç’°</button>

      <label class="chip">è®Šç„¦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" style="vertical-align:middle; width:140px; margin-left:8px;">
      </label>
      <label class="chip">é€Ÿåº¦
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" style="vertical-align:middle; width:160px; margin-left:8px;">
        <span id="rateLabel" style="margin-left:6px">1.00Ã—</span>
      </label>
    </div>
  </section>

  <!-- å³ï¼šå­—å¹•ï¼ˆè‡ªå‹•è·Ÿéš¨ï¼‰ï¼æ¸¬é©—ï¼ˆ20 é¡Œï¼‰ -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
    </div>

    <div class="toolbar">
      <span style="color:#a9b3cf">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
    </div>

    <div id="panelTranscript" class="panel"></div>

    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div>
            <button id="btnCheck" class="btn">äº¤å·</button>
            <button id="btnRetry" class="btn" style="display:none">å†è©¦ä¸€æ¬¡</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>
  </aside>
</div>

<script>
/* ========== å°å·¥å…· ========== */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* ========== è¼‰å…¥ meta ========== */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item; // {video,cues,quiz}
}

/* ========== å·¦é‚Šå½±ç‰‡ï¼ˆç¶­æŒä½ çš„æ“ä½œï¼‰ ========== */
const v = $('#player');
let cueList = [];             // [{tSec,time,text,el}]
let A=null,B=null,abTimer=null,repeatOne=false;
function toSec(t){ const [m=0,s=0]=String(t||'0:0').split(':').map(n=>parseInt(n,10)||0); return m*60+s; }

function jumpPrev(){
  const t = v.currentTime;
  const prev = [...cueList].reverse().find(c=>c.tSec < t - 0.05);
  if(prev){ v.currentTime = prev.tSec + 0.01; v.play(); }
}
function jumpNext(){
  const t = v.currentTime;
  const next = cueList.find(c=>c.tSec > t + 0.05);
  if(next){ v.currentTime = next.tSec + 0.01; v.play(); }
}
function setRepeatOne(){
  repeatOne = true;
  const t = v.currentTime;
  let i = 0;
  for(let k=0;k<cueList.length;k++){ if(cueList[k].tSec<=t) i=k; else break; }
  A = cueList[i].tSec;
  B = (i+1<cueList.length ? cueList[i+1].tSec : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = A + 0.01; },120);
}
function setAB(){
  if(A==null){ A=v.currentTime; alert('å·²è¨­å®š A é»'); }
  else if(B==null){ B=v.currentTime; alert('å·²è¨­å®š B é»ï¼›é–‹å§‹å¾ªç’°'); startAB(); }
  else { A=v.currentTime; B=null; alert('å·²é‡è¨­ A é»ï¼Œè«‹å†æŒ‰ä¸€æ¬¡è¨­å®š B é»'); }
}
function startAB(){
  repeatOne=false; clearInterval(abTimer);
  abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = A + 0.01; },120);
}
function clearLoop(){ repeatOne=false; A=null; B=null; clearInterval(abTimer); }

$('#btnPrev').onclick = jumpPrev;
$('#btnNext').onclick = jumpNext;
$('#btnPlay').onclick = ()=> v.paused ? v.play() : v.pause();
$('#btnRepeatOne').onclick = setRepeatOne;
$('#btnAB').onclick = setAB;
$('#btnABClear').onclick = clearLoop;
$('#rate').oninput = e=>{ v.playbackRate = +e.target.value; $('#rateLabel').textContent = v.playbackRate.toFixed(2)+'Ã—'; };
$('#zoom').oninput = e=>{ v.style.transform = `scale(${+e.target.value})`; };

/* ========== å³é‚Šå­—å¹•ï¼ˆè‡ªå‹•è·Ÿéš¨ï¼‹é»é¸è·³æ’­ï¼‰ ========== */
let currentIdx = -1;
function renderTranscript(data){
  const list = Array.isArray(data)? data : (data.items||[]);
  const box = $('#panelTranscript'); box.innerHTML='';
  cueList = list.map((row,i)=>{
    const tStr = row.time || row.t || row.start || '0:00';
    const sec  = row.tSec ?? toSec(tStr);
    const text = row.text || row.en || row.caption || '';
    const el = document.createElement('div');
    el.className='line';
    el.dataset.idx = i;
    el.innerHTML = `<span class="time">[${tStr}]</span>${text}`;
    el.onclick = ()=>{ v.currentTime = sec + 0.01; v.play(); };
    box.appendChild(el);
    return { tSec:sec, time:tStr, text, el };
  });
  currentIdx = -1;
}

function syncTranscript(){
  if(!cueList.length || v.readyState<1) return;
  const t = v.currentTime;
  // æ‰¾åˆ° <= t çš„æœ€å¾Œä¸€è¡Œï¼ˆç°¡å–®ç·šæ€§æˆ–äºŒåˆ†éƒ½å¯ï¼›é€™è£¡ç”¨äºŒåˆ†ï¼‰
  let lo=0, hi=cueList.length-1, mid=0;
  while(lo<=hi){ mid=(lo+hi)>>1; if(cueList[mid].tSec<=t) lo=mid+1; else hi=mid-1; }
  const idx = Math.max(0, Math.min(cueList.length-1, hi));
  if(idx===currentIdx) return;
  if(currentIdx>=0){ cueList[currentIdx].el.classList.remove('active'); }
  currentIdx = idx;
  const curEl = cueList[currentIdx].el;
  curEl.classList.add('active');
  // æ°¸é è·Ÿéš¨ï¼šç½®ä¸­
  curEl.scrollIntoView({behavior:'smooth', block:'center'});
}

/* å­—ç´š */
function setFont(size){
  const map={S:'13px',M:'15px',L:'17px'};
  $('#panelTranscript').style.fontSize = map[size]||'15px';
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}
$('#fS').onclick=()=>setFont('S'); $('#fM').onclick=()=>setFont('M'); $('#fL').onclick=()=>setFont('L');

/* ========== æ¸¬é©—ï¼ˆå‰ 20 é¡Œï¼‰ ========== */
async function loadQuiz(path){
  const res = await fetch(path);
  if(!res.ok) return null;
  const raw = await res.json();
  const arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  return arr.slice(0,20).map((x,i)=>{
    const q = x.question || x.q || x.title || `Q${i+1}`;
    const opts = x.options || x.choices || x.a || [];
    let ans = x.answerIndex ?? x.correct ?? x.ans ?? 0;
    if(typeof ans!=='number'){
      const idx = opts.findIndex(o => (o.text||o)===ans);
      ans = idx>=0? idx : 0;
    }
    return { q, opts:opts.map(o=>o.text||o), ans };
  });
}
function renderQuiz(questions){
  if(!questions?.length){ $('#tabQuiz').style.display='none'; return; }
  const box = $('#quizBox'); box.innerHTML='';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className='q';
    wrap.innerHTML = `<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt,j)=>{
      const id = `q${i}_o${j}`;
      const line = document.createElement('label');
      line.className='opt';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}" id="${id}"><span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick = ()=>{
    let correct=0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const val = picked ? +picked.value : -1;
      if(val===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    const res = $('#quizResult');
    res.style.display='block';
    res.className = 'result ' + (ratio>=80?'pass':'fail');
    res.textContent = `åˆ†æ•¸ï¼š${correct} / ${questions.length}ï¼ˆ${ratio}%ï¼‰` + (ratio>=80?' ğŸ‘ å¾ˆæ£’ï¼':' å†æ¥å†å²ï¼');
    $('#btnRetry').style.display='inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=>r.checked=false);
    $('#quizProgress').textContent = `0 / ${questions.length}`;
    const res=$('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display='none';
  };
}

/* ========== åˆ†é  ========== */
function setupTabs(){
  const t1=$('#tabTranscript'), p1=$('#panelTranscript');
  const t2=$('#tabQuiz'),       p2=$('#panelQuiz');
  t1.onclick=()=>{ t1.classList.add('active'); t2.classList.remove('active'); p1.style.display='block'; p2.style.display='none'; };
  t2.onclick=()=>{ t2.classList.add('active'); t1.classList.remove('active'); p2.style.display='block'; p1.style.display='none'; };
}

/* ========== å•Ÿå‹• ========== */
(async ()=>{
  try{
    setupTabs();
    setFont('M');

    const meta = await loadMeta();
    v.src = meta.video;

    // å­—å¹•
    const cueRes = await fetch(meta.cues);
    const cueJson = await cueRes.json();
    renderTranscript(cueJson);

    // æ¸¬é©—ï¼ˆè‹¥å­˜åœ¨ï¼‰
    if(meta.quiz){
      const qs = await loadQuiz(meta.quiz);
      if(qs?.length){ renderQuiz(qs); } else { $('#tabQuiz').style.display='none'; }
    }else{
      $('#tabQuiz').style.display='none';
    }

    // æ’­æ”¾äº‹ä»¶
    v.addEventListener('timeupdate', ()=>{
      if(A!=null && B!=null && v.currentTime>B) v.currentTime = A + 0.01;
      if(repeatOne && B!=null && v.currentTime>=B) v.currentTime = A + 0.01;
      syncTranscript();
    });

  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
  }
})();
</script>
</body>
</html>
