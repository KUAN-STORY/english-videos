<!-- login.js 需先載入，維護 window.__AUTH 與 window.showLogin() -->
<script src="login.js"></script>

<style>
  /* 未登入遮罩 */
  .gate-mask {
    position: fixed; inset: 0; background: rgba(5,10,20,.86);
    display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .gate-card {
    width: min(560px, 92vw); background: #0f1a33; color: #e7eaf3;
    border: 1px solid #203057; border-radius: 14px; padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,.4);
  }
  .gate-card h3 { margin: 0 0 8px 0; font-size: 20px; }
  .gate-card p  { margin: 0 0 16px 0; color: #a9b3cf; }
  .gate-row     { display:flex; gap:10px; justify-content:flex-end; }
  .gate-btn     { padding:8px 12px; border:1px solid #203057; border-radius:10px;
                  background:#15224a; color:#fff; cursor:pointer; }
  .gate-btn:hover { filter:brightness(1.08); }
</style>

<div id="gateMask" class="gate-mask" aria-hidden="true">
  <div class="gate-card">
    <h3>請先登入</h3>
    <p>此影片僅限會員觀看。你可以先觀看免費影片〈中秋節〉作為試看 🙂</p>
    <div class="gate-row">
      <button id="btnGoFree" class="gate-btn">先去免費影片</button>
      <button id="btnLogin" class="gate-btn">登入</button>
    </div>
  </div>
</div>

<script>
  // 與 index.html 相同：免登入清單
  const FREE_SLUGS = new Set(["mid-autumn"]);

  const qs   = new URLSearchParams(location.search);
  const slug = qs.get('slug') || '';

  function isSignedIn(){
    return !!(window.__AUTH && window.__AUTH.signedIn);
  }

  // 守門：未登入 & 非免費 => 擋下並顯示遮罩
  function guard(){
    if (!FREE_SLUGS.has(slug) && !isSignedIn()){
      const mask = document.getElementById('gateMask');
      mask.style.display = 'flex';
      // 讓播放器區域不會繼續載入 / 操作
      try {
        const v = document.getElementById('player');
        if (v) { v.pause?.(); v.removeAttribute('src'); v.load?.(); }
      } catch(e){}
      return false;
    }
    return true;
  }

  // 綁定按鈕
  (function bindGateUI(){
    const btnLogin = document.getElementById('btnLogin');
    const btnFree  = document.getElementById('btnGoFree');

    btnLogin?.addEventListener('click', ()=>{
      if (typeof window.showLogin === 'function') {
        window.showLogin();
      } else {
        alert('請在 login.js 提供 window.showLogin() 以開啟登入對話框');
      }
    });

    btnFree?.addEventListener('click', ()=>{
      location.href = 'player.html?slug=mid-autumn';
    });

    // 若 login.js 觸發 auth:change，登入後自動關閉遮罩並重新載入影片
    window.addEventListener('auth:change', ()=>{
      if (guard()){
        const mask = document.getElementById('gateMask');
        mask.style.display = 'none';
        // 重新載入影片 (你的初始化程式通常會在頁面下方)
        // 若你的初始化邏輯在 IIFE 中一次性執行，可手動呼叫你封裝的 init()。
        // 或者簡單一點重整：
        location.reload();
      }
    });
  })();

  // 頁面一進來先檢查一次
  guard();
</script>



