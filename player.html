<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>故事播放器</title>
  <style>
    body{margin:0;background:#0c1424;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang TC,Heiti TC,Noto Sans TC,Arial;}
    .wrap{display:grid;grid-template-columns:minmax(0,1fr) 480px;gap:0}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}
    .video{background:#000;display:flex;align-items:center;justify-content:center}
    video{width:100%;max-height:calc(100vh - 120px);background:#000}
    .panel{background:#0f1a2f;border-left:1px solid #223055;height:100vh;overflow:auto}
    .head{display:flex;gap:10px;padding:12px;border-bottom:1px solid #223055;position:sticky;top:0;background:#0f1a2f}
    .btn{padding:6px 10px;border-radius:10px;background:#1e2a44;border:1px solid #2d3b5d;color:#e6eefc}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1a2742;padding:8px;vertical-align:top}
    th{position:sticky;top:48px;background:#0f1a2f}
    .time{white-space:nowrap;opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="video">
      <video id="v" controls></video>
    </div>

    <div class="panel">
      <div class="head">
        <button class="btn" onclick="history.back()">返回</button>
        <a class="btn" href="#quiz">到測驗</a>
        <span id="offsetBox" class="btn">偏移 <span id="off">0.0</span>s</span>
        <button class="btn" id="btnMinus">-0.5s</button>
        <button class="btn" id="btnPlus">+0.5s</button>
      </div>
      <table>
        <thead>
          <tr><th style="width:90px">時間</th><th>英文</th><th>中文</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="quiz" style="padding:12px"></div>
    </div>
  </div>

  <script type="module">
    import { supa } from './js/supa.js';

    const url = (p) => new URL(p, location.origin + location.pathname.replace(/\/[^/]*$/, '/')).toString();
    const qs   = new URLSearchParams(location.search);
    const slug = qs.get('slug') || 'mid-autumn';

    const video   = document.getElementById('v');
    const tbody   = document.getElementById('tbody');
    const offEl   = document.getElementById('off');

    // 偏移校準（localStorage）
    const KEY = `offset:${slug}`;
    let offset = +(localStorage.getItem(KEY) || 0);
    offEl.textContent = offset.toFixed(1);

    document.getElementById('btnMinus').onclick = ()=>{ offset -= .5; offEl.textContent = offset.toFixed(1); localStorage.setItem(KEY, offset); };
    document.getElementById('btnPlus').onclick  = ()=>{ offset += .5; offEl.textContent = offset.toFixed(1); localStorage.setItem(KEY, offset); };

    // 設定影片來源（相對路徑）
    video.src = url(`videos/${slug}.mp4`);

    // 載入字幕與測驗
    const cuesUrl = url(`data/cues-${slug}.json`);
    const quizUrl = url(`data/quiz-${slug}.json`);

    async function loadCues(){
      const res = await fetch(`${cuesUrl}?v=${Date.now()}`);
      if(!res.ok) throw new Error('載入字幕失敗');
      const list = await res.json();
      renderCues(list);
    }

    function renderCues(list){
      tbody.innerHTML = list.map((r,i)=>`
        <tr data-t="${toSec(r.time)}">
          <td class="time">[${r.time}]</td>
          <td>${escapeHTML(r.text_en || r.text || '')}</td>
          <td>${escapeHTML(r.text_zh || '')}</td>
        </tr>
      `).join('');
    }

    function toSec(t){
      const [mm,ss] = t.split(':').map(Number);
      return mm*60 + ss;
    }

    function escapeHTML(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

    // 跟隨播放自動捲動
    video.addEventListener('timeupdate', ()=>{
      const t = video.currentTime + offset;
      let best, bestDiff = 1e9;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const tt = +tr.dataset.t;
        const d = Math.abs(tt - t);
        if(d < bestDiff){ bestDiff=d; best=tr; }
      });
      if(best) best.scrollIntoView({block:'center',behavior:'smooth'});
    });

    // 簡易載入測驗
    async function loadQuiz(){
      const res = await fetch(`${quizUrl}?v=${Date.now()}`);
      if(!res.ok) return;
      const q = await res.json();
      const box = document.getElementById('quiz');
      box.innerHTML = `<h3>小測驗</h3>` + q.map((x,i)=>`
        <div style="margin:8px 0">
          <div>${i+1}. ${escapeHTML(x.q)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">
            ${x.a.map(opt=>`<button class="btn opt" data-i="${i}" data-t="${escapeHTML(opt)}">${escapeHTML(opt)}</button>`).join('')}
          </div>
        </div>
      `).join('');

      box.querySelectorAll('.opt').forEach(btn=>{
        btn.onclick = ()=>{ btn.style.background = '#2a6'; };
      });
    }

    loadCues().catch(err=>{
      tbody.innerHTML = `<tr><td colspan="3" style="padding:12px">載入失敗：${err.message}</td></tr>`;
    });
    loadQuiz();
  </script>
</body>
</html>
