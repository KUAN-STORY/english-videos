!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>英語影片播放器</title>
<style>
/* === patch: remove login & sticky quiz actions on mobile === */
#authArea { display:none !important; }
@media (max-width: 860px) {
  #pane-quiz .q-actions{
    position: sticky;
    top: 0;
    z-index: 5;
    background: var(--panel1, #0f172a);
    border-bottom: 1px solid var(--border, #1f2a44);
    padding: 10px 8px !important;
  }
}

  :root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6efff; --muted:#9fb0c9; --accent:#3c7cff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
  h1{font-size:20px;margin:0}
  .btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
  .btn.blue{background:#14335f;border-color:#2c5aa3}
  .muted{color:var(--muted)}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}

  .wrap{padding:16px;height:calc(100vh - 58px);}
  .layout{height:100%;display:flex;gap:16px;overflow:hidden}
  .left,.right{flex:1;min-width:0;background:var(--panel);border:1px solid #1f2a44;border-radius:12px}
  .left{display:flex;flex-direction:column;padding:14px}
  .right{display:flex;flex-direction:column}
  .pane{flex:1;overflow:auto}

  .videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
  .videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

  .controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
  .controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
  .speed{display:flex;align-items:center;gap:10px}
  input[type="range"]{width:260px;accent-color:var(--accent)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}

  .tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid #1f2a44}
  .tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:10px;padding:8px 12px}
  .tab.active{background:#154274}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
  tbody tr{background:#0f1f34}
  tbody tr:nth-child(2n){background:#0d1a2b}
  tbody tr:hover{background:#0f2a4e}
  tr.active{background:#173a6e}
  #pane-sub td:nth-child(2),#pane-sub td:nth-child(3){word-break:break-word;white-space:normal;line-height:1.6}

  .q-tabs{display:flex;gap:8px;flex-wrap:wrap}
  .q-tabs .qtab{background:#122340;border:1px solid #1f375f;border-radius:10px;padding:6px 12px;color:#e6efff;cursor:pointer}
  .q-tabs .qtab.on{background:#154274}

  .voc{border:1px solid #213a64;background:#0f223b;border-radius:12px;padding:12px;margin:10px 14px}
  .voc-h{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
  .voc-word{font-size:20px;font-weight:800}
  .voc-pos{opacity:.85}
  .voc-zh{color:#cfe2ff;margin-top:2px}
  .voc-en{color:#9fb0c9}
  .voc-actions{display:flex;gap:8px;margin-top:8px}

  /* ===== 列印樣式（關鍵補強） ===== */
  @media print{
    html,body{ background:#fff !important; color:#000 !important; height:auto !important; }
    header,.tabs,.controls,#authArea,.drawer-grab{ display:none !important; }
    .wrap{ padding:0 !important; }
    .layout{ display:block !important; height:auto !important; overflow:visible !important; }
    .left{ display:none !important; }
    .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
    .pane, #pane-quiz, .quiz-shell, #quizList{
      height:auto !important; max-height:none !important; overflow:visible !important;
    }
    #pane-quiz{ display:block !important; }        /* 只印測驗 */
    #quizList{ font-size:12.5pt; line-height:1.25; }
    #quizList > li{
      break-inside:avoid; page-break-inside:avoid;     /* 題目不被切半 */
      padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc;
    }
    @page { margin:10mm 10mm 12mm 10mm; }           /* 版邊 */
    #printHeader{ display:flex !important; }         /* 顯示列印頁首 */
    #phScore{ font-size:22px; font-weight:900; }
  }
  /* 列印頁首（平常隱藏、列印顯示） */
  #printHeader{display:none; align-items:center; justify-content:space-between; padding:12px 8px 16px; margin:0 8px 8px; border-bottom:1px solid #ddd; color:#111; background:#fff;}
  #phLeft{display:flex;align-items:center;gap:10px}
  #phLogo{width:26px;height:26px}
  #phTitle{font-weight:800}
  #phMeta{font-size:12px;color:#444;margin-top:2px}
  #phRight{text-align:right}
  #phScore{font-size:24px;font-weight:900}
  #phFeedback{font-size:12px;color:#444}
</style>

<style>
/* ===== FocusMobile v3.0.2 base ===== */
#verBadgeTop{
  position: fixed; top: 8px; right: 10px; z-index: 10050;
  background: rgba(15,23,42,.9); color: #e6efff;
  border: 1px solid rgba(100,116,139,.5);
  padding: 4px 8px; border-radius: 8px; font-size: 12px;
}
@media (max-width:860px) and (orientation:portrait){
  /* Two-page track */
  #mainWrap.pager-track, .layout.pager-track{
    display: flex !important;
    flex-direction: row !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    scroll-snap-type: x mandatory !important;
    -webkit-overflow-scrolling: touch !important;
    gap: 0 !important;
  }
  .pager-page{
    flex: 0 0 100vw !important;
    max-width: 100vw !important;
    height: calc(100vh - 58px);
    scroll-snap-align: start;
    overflow-y: auto;
  }
  .pager-page > .left, .pager-page > .right{
    width: 100% !important;
    max-width: 100% !important;
    border-radius: 0 !important;
    border-left: 0 !important; border-right: 0 !important;
  }
  /* 工具列預設展開 */
  #controlsDrawer, .controls, .toolbar, .player-toolbar{
    max-height: none !important; opacity: 1 !important; visibility: visible !important;
  }
  #btnExitFocus{
    position: fixed; right: 16px; bottom: 16px;
    z-index: 10020; display: none;
    padding:8px 12px;border-radius:10px;border:1px solid rgba(100,116,139,.5);
    background:#0f172a;color:#e6efff;
  }
  .at-right-page #btnExitFocus{ display: inline-flex; }
}
</style>
<style>
/* === Print helpers (added by patch V20251007-08) === */
@media print{
  #verBadge, #loginGate, .nav, .toolbar, .topbar, [data-no-print="1"]{ display:none !important; }
  #printHeader{ display:block !important; margin-bottom:12px; }
  body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
}
</style>
</head>
<body>

<!-- version badge -->
<div id="verBadge" style="position:fixed;top:10px;right:10px;z-index:9999;">
  <span style="display:inline-block;background:#0b1e3a;color:#fff;border:1px solid #2c6fff;border-radius:12px;padding:4px 10px;font:600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', Arial;">V20251007-08</span>
</div>

<!-- LOGIN GATE (lite) -->
<div id="loginGate" style="position:fixed;left:0;right:0;bottom:0;background:rgba(15,23,42,.95);color:#e5edff;padding:18px 16px;display:none;z-index:9998;border-top:1px solid rgba(100,116,139,.35)">
  <div style="max-width:900px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
    <div style="font:600 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial">需要登入</div>
    <div style="opacity:.9">請先登入以繼續使用，您的學習記錄會安全地儲存於雲端。</div>
    <div style="margin-left:auto;display:flex;gap:10px">
      <button id="gateLater" style="background:#334155;color:#e2e8f0;border:0;border-radius:10px;padding:8px 14px;">稍後</button>
      <button id="gateLogin" style="background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 14px;">以 Google 登入</button>
    </div>
  </div>
</div>

<!-- Print header -->
<div id="printHeader" style="display:none">
  <h2 id="ph_title">英語影片測驗成績單</h2>
  <div id="ph_meta" style="font-size:14px;opacity:.8"></div>
  <hr/>
</div>


<header>
  <h1>英語影片播放器</h1>
  </header>

<div class="wrap">
  <div class="layout">
    <section class="left" id="videoContainer">
      <div id="videoWrap" class="videoWrap">
        <video id="player" playsinline controls></video>
      </div>

      <div class="controls" id="controlsDrawer">
        <div class="drawer-grab" id="drawerGrab">
          <div class="grab-bar" style="width:44px;height:4px;border-radius:4px;margin:0 auto 4px;background:#2b4a78;"></div>
          <div class="drawer-title" style="font-size:12px;color:#9fb0c9;">播放工具列（點擊展開/收合）</div>
        </div>
        <div class="row">
          <button id="btnPrev" class="btn">⏮ 上一句</button>
          <button id="btnPlay" class="btn">▶️ 播放 / 暫停</button>
          <button id="btnNext" class="btn">⏭ 下一句</button>
          <button id="btnReplay" class="btn">🔁 重複本句</button>
        </div>
        <div class="row">
          <label class="chip"><input id="chkFollow" type="checkbox"/> 跟隨</label>
          <span class="chip">偏移 <span id="offsetVal">0.0s</span></span>
          <button id="btnOffsetMinus" class="btn">-0.5s</button>
          <button id="btnOffsetPlus" class="btn">+0.5s</button>
          <button id="btnAutoSync" class="btn">🧭 簡易校準</button>
        </div>
        <div class="row speed">
          <span class="muted">速度</span>
          <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
          <span id="speedVal">1.00x</span>
        </div>
      </div>
    </section>

    <section class="right" id="studyContainer">
      <div class="tabs">
        <div class="tab active" data-tab="sub" id="tabSub">字幕</div>
        <div class="tab" data-tab="quiz">測驗</div>
        <div class="tab" data-tab="vocab">單字</div>
      </div>

      <!-- 列印頁首（列印時顯示） -->
      <div id="printHeader" aria-hidden="true">
        <div id="phLeft">
          <!-- 內嵌 SVG Logo -->
          <svg id="phLogo" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="2"></circle>
            <path d="M7 13h10M7 9h10M7 17h6" stroke="#111" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div>
            <div id="phTitle">BookWide · 英語影片測驗成績單</div>
            <div id="phMeta">
              影片：<span id="phSlug">-</span>　分區：<span id="phSection">-</span>　列印：<span id="phTime">-</span>
            </div>
          </div>
        </div>
        <div id="phRight">
          <div id="phScore">0 / 100</div>
          <div id="phFeedback">（0%）</div>
        </div>
      </div>

      <div class="pane">
        <div id="pane-sub">
          <div id="cuesStatus" class="muted" style="padding:10px 14px">（字幕載入中…）</div>
          <table>
            <thead><tr><th style="width:80px">時間</th><th>英文</th><th style="width:40%">中文</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div id="pane-quiz" style="display:none">
<div id="printHeader" aria-hidden="true">
  <div id="phLeft">
    <svg id="phLogo" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="2"></circle>
      <path d="M7 13h10M7 9h10M7 17h6" stroke="#111" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <div>
      <div id="phTitle">BookWide · 英語影片測驗成績單</div>
      <div id="phMeta">
        影片：<span id="phSlug">-</span>　分區：<span id="phSection">-</span>　列印：<span id="phTime">-</span>
      </div>
    </div>
  </div>
  <div id="phRight">
    <div id="phScore">0 / 100</div>
    <div id="phFeedback">（0%）</div>
  </div>
</div>

          <div class="quiz-shell">
            <div id="quizTabs" class="q-tabs" style="margin:6px 0 10px 0;">
              <button class="qtab on" data-sec="Vocabulary">單字</button>
              <button class="qtab" data-sec="Grammar">文法</button>
              <button class="qtab" data-sec="Reading">閱讀</button>
              <button class="qtab" data-sec="Mixed">綜合</button>
              <span id="quizMeta" class="muted" style="margin-left:12px">（測驗載入中…）</span>
            </div>
            <ol id="quizList" style="line-height:1.6"></ol>
            <div class="q-actions" style="margin:14px 0 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">交卷</button>
              <button class="btn" id="btnShowAnswer" style="display:none">顯示答案</button>
              <!-- 列印按鈕（常駐顯示於測驗區） -->
              <button class="btn" id="btnPrint" style="display:none">列印成績單</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
            <div id="quizResult" style="display:none;margin-top:10px"></div>
          </div>
        </div>

        <div id="pane-vocab" style="display:none">
          <div id="vocabStatus" class="muted" style="padding:10px 14px">( 單字載入中… )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ===== 播放器主程式 ===== -->
<script>
/* ---------- 小工具 ---------- */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ---------- 參數 ---------- */
const params=new URLSearchParams(location.search);
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;

/* ---------- 資源載入（含回退） ---------- */
async function fetchWithFallback(p,f,kind){
  try{const r=await fetch(p,{cache:'no-store'}); if(!r.ok)throw 0; return {data:await r.json(),used:'primary'};}
  catch{ try{const r2=await fetch(f,{cache:'no-store'}); if(!r2.ok)throw 0; slug='mid-autumn'; return {data:await r2.json(),used:'fallback'};}
  catch(e2){ console.error(`[fatal] ${kind} 讀取失敗`,e2); return {data:null,used:'error'};}}
}

/* ---------- DOM ---------- */
const video=$('#player'); const cuesBody=$('#cuesBody'); const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnAutoSync=$('#btnAutoSync'); const btnPrint=$('#btnPrint');
const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;
function setOffset(v){offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset));}
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* ---------- 影片 & 字幕 ---------- */
async function loadVideo(){
  const src=s=>`./videos/${s}.mp4`;
  video.src=src(primarySlug);
  video.addEventListener('error',()=>{ video.src=src('mid-autumn'); },{once:true});
}
async function loadCues(){
  cuesStatus.textContent='（字幕載入中…）';
  const {data,used}=await fetchWithFallback(`./data/cues-${primarySlug}.json?v=${Date.now()}`,`./data/cues-mid-autumn.json?v=${Date.now()}`,'cues');
  if(!data){ cuesStatus.textContent='⚠️ 字幕讀取失敗'; return; }
  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}"><td class="muted" style="width:80px">${c.t?fmt(c.t):''}</td><td>${esc(c.en)}</td><td style="width:40%">${esc(c.zh)}</td></tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent=used==='fallback' ? '已載入字幕（mid-autumn 回退）' : `已載入字幕（${primarySlug}）`;
}
function currentIndex(){ const t=video.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }
function highlightRow(idx){ const trs=$$('#cuesBody tr'); trs.forEach(tr=>tr.classList.remove('active')); const tr=trs[idx]; if(!tr)return; tr.classList.add('active'); if(chkFollow.checked) tr.scrollIntoView({block:'center',behavior:'smooth'}); }
function seekTo(idx,play=true){ if(!cues[idx])return; video.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) video.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }

/* ---------- 測驗 ---------- */
async function loadQuiz(){
  const listEl=$('#quizList',paneQuiz), metaEl=$('#quizMeta',paneQuiz);
  const {data,used}=await fetchWithFallback(`./data/quiz-${primarySlug}.json?v=${Date.now()}`,`./data/quiz-mid-autumn.json?v=${Date.now()}`,'quiz');
  if(!data){ metaEl.textContent='⚠️ 題庫讀取失敗'; return; }

  let questions=[];
  if(Array.isArray(data)){
    questions=data.map(q=>({section:(q.section||'Mixed'),type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||q.q||'',options:q.options||q.choices||[],answer:q.answer??q.ans??''}));
  }else if(data.sections){
    const push=(sec,arr=[])=>arr?.forEach(q=>questions.push({section:sec,type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||'',options:q.options||[],answer:q.answer??''}));
    push('Vocabulary',data.sections.vocab); push('Grammar',data.sections.grammar);
    push('Reading',data.sections.reading); push('Mixed',data.sections.mixed);
  }
  metaEl.textContent=used==='fallback'?`已載入（mid-autumn 回退），共 ${questions.length} 題`:`已載入（${primarySlug}），共 ${questions.length} 題`;

  function renderSection(sec){
    const arr=questions.filter(q=>q.section===sec);
    if(!arr.length){ listEl.innerHTML='<li style="color:#9fb3ff">（此分區無題目）</li>'; return; }
    listEl.innerHTML=arr.map((q,i)=>{
      const idx=i+1;
      if(q.type==='MCQ'){
        const opts=q.options.map(opt=>`<label style="display:block;margin:4px 0"><input type="radio" name="q${sec}-${idx}" value="${String(opt)}"> ${String(opt)}</label>`).join('');
        return `<li data-type="MCQ" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><div>${opts}</div><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }else{
        return `<li data-type="SA" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><input type="text" placeholder="輸入答案…" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff"><button class="btn btn-check" style="margin-left:6px">檢查</button><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }
    }).join('');
    listEl.addEventListener('click',e=>{
      if(!e.target.classList.contains('btn-check'))return;
      const li=e.target.closest('li'); const ipt=li.querySelector('input');
      const ok=(ipt.value||'').trim().toLowerCase()===String(li.dataset.ans||'').trim().toLowerCase();
      const msg=li.querySelector('span.msg')||li.querySelector('.msg'); const exp=li.querySelector('.exp');
      msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; exp.textContent=ok?'':`正解：${li.dataset.ans}`;
    },{once:true});
  }
  $('#quizTabs').querySelectorAll('.qtab').forEach(b=>{ b.addEventListener('click',()=>{ $('#quizTabs').querySelectorAll('.qtab').forEach(x=>x.classList.remove('on')); b.classList.add('on'); renderSection(b.dataset.sec); }); });
  renderSection('Vocabulary');

  $('#btnSubmitQuiz').onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')]; if(!items.length)return;
    let got=0,total=items.length;
    items.forEach(li=>{
      const ans=String(li.dataset.ans||'').trim();
      if(li.dataset.type==='MCQ'){
        const sel=li.querySelector('input[type="radio"]:checked'); const user=sel?sel.value:''; const ok=user===ans;
        if(ok)got++; const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }else{
        const ipt=li.querySelector('input'); const ok=(ipt.value||'').trim().toLowerCase()===ans.toLowerCase(); if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }
    });
    const score=got*5, full=total*5;
    $('#quizScore').textContent=`本分區分數：${score} / ${full}`;
    $('#quizResult').style.display='block';
    $('#btnShowAnswer').style.display='inline-block';
    btnPrint.style.display='inline-block';
    // 更新列印頁首資訊
    updatePrintHeader(score, full);
  };
  $('#btnShowAnswer').onclick=()=>{ $('#quizList').querySelectorAll('li').forEach(li=>{ const exp=li.querySelector('.exp'); if(exp&&!exp.textContent) exp.textContent=`正解：${li.dataset.ans}`; }); };

  /* ===== 列印（使用強化過的 CSS；這裡只負責補上頁首資訊） ===== */
  function updatePrintHeader(score, full){
    const pct = full ? Math.round((score/full)*100) : 0;
    const words = pct>=90 ? '太強了！' : pct>=75 ? '很棒，繼續加油！' : pct>=60 ? '還可以，再練練會更好。' : '先別灰心！重作錯題、背關鍵字再試一次會更好。';
    $('#phSlug').textContent = slug;
    $('#phSection').textContent = $('#quizTabs .qtab.on')?.textContent?.trim() || 'Vocabulary';
    $('#phTime').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
    $('#phScore').textContent = `${score} / ${full}`;
    $('#phFeedback').textContent = `（${pct}%）${words}`;
  }
  // 讓 20 題完整顯示：其實題目本來就都在 DOM，中途不再動 display，交給 @media print 負責高度/分頁

  // 列印按鈕：開印前再保險抓一次分數（避免沒交卷也能印）
  btnPrint.onclick=()=>{
    let s=0,f=0;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f||100);
    window.print();
  };
  // 使用者直接 Ctrl+P 時也補頁首
  window.addEventListener('beforeprint',()=>{
    let s=0,f=100;
    const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; }
    updatePrintHeader(s,f);
  });
}

/* ---------- 字彙卡 ---------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const {data,used}=await fetchWithFallback(`./data/vocab-${primarySlug}.json?v=${Date.now()}`,`./data/vocab-mid-autumn.json?v=${Date.now()}`,'vocab');
  if(!data||!data.length){ vStatus.textContent='⚠️ 查無單字資料'; vBox.innerHTML=''; return; }
  vStatus.textContent=used==='fallback'?'已載入單字（mid-autumn 回退）':`已載入單字（${primarySlug}）`;
  const go=t=>{ const p=toSec(t); video.currentTime=Math.max(0,p); video.play(); };
  vBox.innerHTML=data.map(v=>`<div class="voc"><div class="voc-h"><div class="voc-word">${esc(v.word||'')}</div><div class="voc-pos">${esc(v.pos||'')}</div></div>${v.zh?`<div class="voc-zh">${esc(v.zh)}</div>`:''}${v.en?`<div class="voc-en">${esc(v.en)}</div>`:''}<div class="voc-actions">${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">跳到片段</button>`:''}<button class="btn" data-act="speak" data-text="${esc(v.word||v.en||'')}">🔊 朗讀</button></div></div>`).join('');
  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump')go(e.target.dataset.time||0);
    if(act==='speak'){ try{ const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  });
}

/* ---------- 控制 ---------- */
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(video.paused) video.play(); else video.pause(); });
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));

video.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=video.currentTime+offset; if(t>=e-0.02){ video.currentTime=Math.max(0,s-offset+0.0001); video.play(); } } });

(function(){ const drawer=$('#controlsDrawer'),grab=$('#drawerGrab'); if(!drawer||!grab)return; const toggle=()=>drawer.classList.toggle('open'); grab.addEventListener('click',toggle); })();

function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ---------- 初始化 ---------- */
(async function init(){
  // 播放參數
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;

  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab();
  showTab('sub');
})();
</script>



<script>
/* ===== Mobile Two-Page Freeze-Guard v3.0.1 ===== */
(function () {
  const qs = new URLSearchParams(location.search);
  if (qs.get('noPager') === '1') return;   // 緊急關閉：?noPager=1
  const isMobile = () => matchMedia('(max-width:860px) and (orientation:portrait)').matches;
  const $  = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  const TRACK_SEL = '#mainWrap, .layout';
  const LEFT_SEL  = '#leftPanel, .left';
  const RIGHT_SEL = '#rightPanel, .right';

  let inited = false;
  let rafInit = 0;
  let rafScroll = 0;

  function ensureBadge() {
    let b = $('#verBadgeTop');
    if (!b) {
      b = document.createElement('div');
      b.id = 'verBadgeTop';
      document.body.appendChild(b);
    }
    b.textContent = '2025.10.14 FocusMobile v3.0.2';
  }

  function setPage(idx) {
    const track = $(TRACK_SEL);
    if (!track) return;
    const w = track.clientWidth;
    track.scrollTo({ left: idx * w, behavior: 'smooth' });
    document.body.classList.toggle('at-right-page', idx === 1);
    const back = $('#btnExitFocus');
    if (back) back.style.display = idx === 1 ? 'inline-flex' : 'none';
  }

  function bindTopTabsOnce() {
    const labels = new Set(['字幕', '測驗', '單字']);
    const buttons = $$('button,a,[role="tab"]');
    const groups = new Map();
    buttons.forEach((el) => {
      const t = (el.textContent || '').trim();
      if (!labels.has(t)) return;
      const c = el.closest('.tabs, nav, .tabbar, .tabs-container, section, div') || el.parentElement;
      if (!c) return;
      const s = groups.get(c) || new Set();
      s.add(t); groups.set(c, s);
    });
    const topBars = Array.from(groups.entries())
      .filter(([c, set]) => set.has('字幕') && set.has('測驗') && set.has('單字'))
      .map(([c]) => c);
    if (!topBars.length) return;
    const topBar = topBars[0];
    $$('button,a,[role="tab"]', topBar).forEach((el) => {
      const t = (el.textContent || '').trim();
      if (!labels.has(t) || el.dataset._pagerBound) return;
      el.dataset._pagerBound = '1';
      el.addEventListener('click', () => setPage(1), { passive: true });
    });
  }

  function ensureBackButton() {
    if ($('#btnExitFocus')) return;
    const btn = document.createElement('button');
    btn.id = 'btnExitFocus';
    btn.textContent = '返回影片';
    document.body.appendChild(btn);
    btn.addEventListener('click', () => setPage(0));
  }

  // 只做一次包裝
  function ensurePagerOnce() {
    const track = $(TRACK_SEL);
    if (!track) return;
    track.classList.add('pager-track');

    if (!$('#mPageLeft')) {
      const left = $(LEFT_SEL, track);
      if (left) {
        const leftPage = document.createElement('section');
        leftPage.id = 'mPageLeft'; leftPage.className = 'pager-page';
        left.before(leftPage); leftPage.appendChild(left);
      }
    }
    if (!$('#mPageRight')) {
      const right = $(RIGHT_SEL, track);
      if (right) {
        const rightPage = document.createElement('section');
        rightPage.id = 'mPageRight'; rightPage.className = 'pager-page';
        right.before(rightPage); rightPage.appendChild(right);
      }
    }
  }

  function onScrollSync() {
    const track = $(TRACK_SEL);
    if (!track) return;
    const idx = track.scrollLeft >= track.clientWidth * 0.5 ? 1 : 0;
    document.body.classList.toggle('at-right-page', idx === 1);
    const back = $('#btnExitFocus');
    if (back) back.style.display = idx === 1 ? 'inline-flex' : 'none';
  }

  function scheduleInit() {
    cancelAnimationFrame(rafInit);
    rafInit = requestAnimationFrame(init);
  }

  function init() {
    if (!isMobile()) return;
    ensureBadge();
    ensureBackButton();
    ensurePagerOnce();
    bindTopTabsOnce();
    onScrollSync();
    inited = true;
  }

  window.addEventListener('resize', scheduleInit, { passive: true });
  window.addEventListener('orientationchange', scheduleInit, { passive: true });
  document.addEventListener('DOMContentLoaded', scheduleInit);

  document.addEventListener('scroll', (e) => {
    const t = e.target;
    const track = $(TRACK_SEL);
    if (!track) return;
    if (t !== track && !(t.matches && t.matches(TRACK_SEL))) return;
    cancelAnimationFrame(rafScroll);
    rafScroll = requestAnimationFrame(onScrollSync);
  }, { passive: true, capture: true });

  // 只監聽 track 的直接子項變化
  const mo = new MutationObserver(() => scheduleInit());
  document.addEventListener('DOMContentLoaded', () => {
    const track = $(TRACK_SEL);
    if (track) mo.observe(track, { childList: true, subtree: false });
  });
})();
</script>

<!-- === Subtitle inline (EN + CN under EN) & Version Badge === -->
<style>
#verBadgeTop {
  position: fixed;
  top: 8px;
  right: 10px;
  background: white;
  color: black;
  font-weight: 600;
  font-size: 13px;
  padding: 4px 8px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  z-index: 9999;
}

/* Subtitles: hide CN column; show CN under EN */
.table-subtitles thead th.cnCol { display:none; }
.table-subtitles td.cnCol { display:none; }
.table-subtitles td.enCol .cn-inline {
  display:block; margin-top:.35rem;
  font-size:.92em; line-height:1.45;
  opacity:.85; color:rgba(255,255,255,.85);
}
.table-subtitles td.timeCol{
  white-space:nowrap; width:64px;
}
</style>

<div id="verBadgeTop">V20251007-002</div>

<script>
(function(){
function findSubtitleTable(){
  let t = document.querySelector('table.table-subtitles');
  if (t) return t;
  const tables = document.querySelectorAll('table');
  for (const tb of tables) {
    const heads = Array.from(tb.querySelectorAll('thead th')).map(th=>th.textContent.trim());
    if (heads.join('|').includes('時間') && heads.join('|').includes('英文') && heads.join('|').includes('中文')) {
      tb.classList.add('table-subtitles');
      const headTh = tb.querySelectorAll('thead th');
      if (headTh[0]) headTh[0].classList.add('timeCol');
      if (headTh[1]) headTh[1].classList.add('enCol');
      if (headTh[2]) headTh[2].classList.add('cnCol');
      tb.querySelectorAll('tbody tr').forEach(tr=>{
        const tds = tr.children;
        if (tds[0]) tds[0].classList.add('timeCol');
        if (tds[1]) tds[1].classList.add('enCol');
        if (tds[2]) tds[2].classList.add('cnCol');
      });
      return tb;
    }
  }
  return null;
}

function mergeRows(table){
  if (!table) return;
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(tr=>{
    const enCell = tr.querySelector('td.enCol') || tr.children[1];
    const cnCell = tr.querySelector('td.cnCol') || tr.children[2];
    if (!enCell || !cnCell) return;
    const cnHTML = cnCell.innerHTML.trim();
    if (!cnHTML) return;
    if (!enCell.querySelector('.cn-inline')) {
      const div = document.createElement('div');
      div.className = 'cn-inline';
      div.innerHTML = cnHTML;
      enCell.appendChild(div);
    }
    cnCell.style.display = 'none';
  });
  const thCN = table.querySelector('thead th.cnCol');
  if (thCN) thCN.style.display = 'none';
}

function run(){
  const table = findSubtitleTable();
  if (!table) return;
  mergeRows(table);
  const tbody = table.querySelector('tbody');
  if (tbody) {
    const mo = new MutationObserver(()=>mergeRows(table));
    mo.observe(tbody, { childList:true, subtree:true });
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', run);
} else {
  run();
}
})();
</script>


<!-- === Supabase Auth + Watch Logs + Version Badge === -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
#verBadgeTop { position: fixed; top: 8px; right: 10px; background: #fff; color:#111; 
  font-weight:700; font-size:12px; padding:4px 8px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.25); z-index:10001; }
#authGate { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:10000; }
#authGate .card { background:#101826; color:#e6f0ff; padding:24px 18px; border:1px solid #213048; border-radius:14px; width:min(92vw,440px); }
#authGate .row { display:flex; justify-content:flex-end; gap:8px; margin-top:16px; }
.btn { cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid #2a3a58; background:#0f172a; color:#e6f0ff; }
.btn.primary { background:#2563eb; border-color:#2563eb; }
#userBadge { position:fixed; top:8px; right:110px; color:#e6f0ff; font-size:13px; opacity:.9; }
#authBtns { position:fixed; top:8px; right:10px; display:flex; gap:6px; z-index:10002; }
#authBtns .btn { padding:4px 10px; font-size:12px; }

/* ===== 列印（手機/桌機皆用）===== */
@media print{
  html,body{ background:#fff !important; color:#000 !important; height:auto !important; }
  header,.tabs,.controls,#authArea,.drawer-grab{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .left{ display:none !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; }
  .pane, #pane-quiz, .quiz-shell, #quizList{ height:auto !important; max-height:none !important; overflow:visible !important; }
  #pane-quiz{ display:block !important; }
  #quizList{ font-size:12.5pt; line-height:1.25; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  @page { margin:10mm 10mm 12mm 10mm; }
  #printHeader{ display:flex !important; }
  #phScore{ font-size:22px; font-weight:900; }
}
#printHeader{display:none; align-items:center; justify-content:space-between; padding:12px 8px 16px; margin:0 8px 8px; border-bottom:1px solid #ddd; color:#111; background:#fff;}
#phLeft{display:flex;align-items:center;gap:10px}
#phLogo{width:26px;height:26px}
#phTitle{font-weight:800}
#phMeta{font-size:12px;color:#444;margin-top:2px}
#phRight{text-align:right}
#phScore{font-size:24px;font-weight:900}
#phFeedback{font-size:12px;color:#444}
</style>

<div id="verBadgeTop">V20251007-003</div>
<div id="authBtns">
  <button id="btnLogin" class="btn primary">登入</button>
  <button id="btnLogout" class="btn" style="display:none">登出</button>
</div>
<div id="userBadge" style="display:none"></div>

<div id="authGate">
  <div class="card">
    <h3 style="margin:0 0 6px 0;">需要登入</h3>
    <p style="margin:0 0 12px 0; opacity:.9">請先登入以繼續使用，您的學習記錄會安全地保存於雲端。</p>
    <div class="row">
      <button id="gateCancel" class="btn">稍後</button>
      <button id="gateLogin" class="btn primary">以 Google 登入</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://qtgwedankftrqjmzuset.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const qs = new URLSearchParams(location.search);
const videoSlug = qs.get('slug') || 'unknown';

const $gate = document.getElementById('authGate');
const $btnLogin = document.getElementById('btnLogin');
const $btnLogout = document.getElementById('btnLogout');
const $userBadge = document.getElementById('userBadge');
const $gateLogin = document.getElementById('gateLogin');
const $gateCancel = document.getElementById('gateCancel');

let watchLogged = false;

function showGate(show){
  $gate.style.display = show ? 'flex' : 'none';
}

function setUserUI(user){
  if (user) {
    $btnLogin.style.display = 'none';
    $btnLogout.style.display = 'inline-block';
    $userBadge.style.display = 'inline-block';
    $userBadge.textContent = user.email || (user.user_metadata && user.user_metadata.full_name) || '已登入';
  } else {
    $btnLogin.style.display = 'inline-block';
    $btnLogout.style.display = 'none';
    $userBadge.style.display = 'none';
    $userBadge.textContent = '';
  }
}

async function logWatch(user){
  if (watchLogged || !user) return;
  try {
    const payload = { user_id: user.id, email: user.email, video_slug: videoSlug };
    const { error } = await supabase.from('watch_logs').insert(payload);
    if (!error) watchLogged = true;
    else console.warn('watch_logs insert error', error);
  } catch(err) { console.error(err); }
}

async function initAuth(){
  const { data: { user } } = await supabase.auth.getUser();
  setUserUI(user);
  if (!user) showGate(true);
  else logWatch(user);
}

supabase.auth.onAuthStateChange((_event, session)=>{
  const user = session?.user || null;
  setUserUI(user);
  showGate(!user);
  if (user) logWatch(user);
});

$btnLogin.addEventListener('click', ()=>{ 
  supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
});
$gateLogin.addEventListener('click', ()=>{ 
  supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
});
$gateCancel.addEventListener('click', ()=> showGate(false));
$btnLogout.addEventListener('click', async ()=>{ await supabase.auth.signOut(); });

initAuth();

// ===== 手機/桌機 列印成績單（存 PDF）補丁 =====
function updatePrintHeader(score, full){
  const pct = full ? Math.round((score/full)*100) : 0;
  const words = pct>=90 ? '太強了！' : pct>=75 ? '很棒，繼續加油！' : pct>=60 ? '還可以，再練練會更好。' : '先別灰心！重作錯題、背關鍵字再試一次會更好。';
  const usp = new URLSearchParams(location.search);
  const slug = usp.get('slug') || (document.querySelector('#videoSlug')?.textContent?.trim()) || 'mid-autumn';
  document.querySelector('#phSlug').textContent = slug;
  document.querySelector('#phSection').textContent = document.querySelector('#quizTabs .qtab.on')?.textContent?.trim() || 'Vocabulary';
  document.querySelector('#phTime').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
  document.querySelector('#phScore').textContent = `${score} / ${full}`;
  document.querySelector('#phFeedback').textContent = `（${pct}%）${words}`;
}

(function(){
  const btnSubmit = document.querySelector('#btnSubmitQuiz');
  const btnPrint  = document.querySelector('#btnPrint');
  const scoreNode = document.querySelector('#quizScore');
  if(!btnSubmit || !btnPrint) return;

  btnSubmit.addEventListener('click', ()=>{
    let s=0,f=0;
    const m=(scoreNode?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; } else { s=0; f=100; }
    updatePrintHeader(s,f);
    btnPrint.style.display='inline-block';
  });

  btnPrint.addEventListener('click', ()=>{
    let s=0,f=0;
    const m=(scoreNode?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; } else { s=0; f=100; }
    updatePrintHeader(s,f);
    window.print();
  });

  window.addEventListener('beforeprint', ()=>{
    let s=0,f=0;
    const m=(scoreNode?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; } else { s=0; f=100; }
    updatePrintHeader(s,f);
  });
})();
// ===== end: 列印補丁 =====
</script>


<!-- ======= LOGIN-GATE (LITE) PATCH v20251007-06: start ======= -->
<style>
  .ver-badge {
    position: fixed; right: 12px; top: 10px; z-index: 2147483647;
    background: #fff; color: #111; font-weight: 700; border-radius: 12px;
    padding: 2px 10px; box-shadow: 0 2px 10px rgba(0,0,0,.25);
    font-size: 12px; opacity: .95; pointer-events: none;
  }
  .btn-login, #btnLogin, [data-role="login"] { display: none !important; }
  #gateMask {
    position: fixed; inset: 0; background: rgba(0,0,0,.5);
    display: none; z-index: 2147483600;
  }
  #gateDialog {
    position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
    width: min(92vw, 520px); background: #141b2d; color: #e8eefc;
    border: 1px solid rgba(255,255,255,.12); border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0,0,0,.45);
    display: none; z-index: 2147483601; overflow: hidden;
  }
  #gateDialog header { padding: 16px 18px; font-size: 18px; font-weight: 800; }
  #gateDialog .msg { padding: 0 18px 16px; line-height: 1.6; color: #cfe0ff; }
  #gateDialog footer { padding: 12px 18px 18px; display: flex; gap: 10px; justify-content: flex-end; }
  #gateDialog button {
    appearance: none; border: 0; cursor: pointer; border-radius: 10px; padding: 10px 14px;
    font-weight: 700;
  }
  #btnGateLater { background: #233252; color: #e8eefc; }
  #btnGateLogin { background: #2f6dff; color: #fff; }
  #gateToast {
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    background: rgba(20,27,45,.95); color: #e8eefc; border: 1px solid rgba(255,255,255,.12);
    border-radius: 12px; padding: 10px 14px; z-index: 2147483602; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
  }
</style>

<div class="ver-badge">V20251007-06</div>
<div id="gateMask"></div>
<div id="gateDialog" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
  <header id="gateTitle">需要登入</header>
  <div class="msg">請先登入以繼續使用，您的學習記錄會安全地儲存於雲端。</div>
  <footer>
    <button id="btnGateLater">稍後</button>
    <button id="btnGateLogin">以 Google 登入（示意）</button>
  </footer>
</div>
<div id="gateToast">請先登入以繼續使用</div>

<script>
(function(){
  const IS_LOGGED_IN = false;
  let gateActive = !IS_LOGGED_IN;

  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const $mask = $('#gateMask');
  const $dlg  = $('#gateDialog');
  const $toast= $('#gateToast');
  const $btnLater = $('#btnGateLater');
  const $btnLogin = $('#btnGateLogin');

  function showDialog(on=true){
    $mask.style.display = on ? 'block' : 'none';
    $dlg.style.display  = on ? 'block' : 'none';
  }
  function toast(msg='請先登入以繼續使用', time=1500){
    $toast.textContent = msg;
    $toast.style.display='block';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ $toast.style.display='none'; }, time);
  }

  function attachGuards() {
    const blocker = (e) => {
      if (!gateActive) return;
      e.preventDefault();
      e.stopPropagation();
      if ($dlg.style.display !== 'block') toast();
    };

    $$('video').forEach(v => {
      v.addEventListener('play', blocker, true);
      v.addEventListener('click', blocker, true);
    });

    const controlAreas = ['#playerControls','.controls','.toolbar'];
    controlAreas.forEach(sel => {
      $$(sel).forEach(area => {
        area.addEventListener('click', blocker, true);
        area.addEventListener('input', blocker, true);
      });
    });

    const tabSelectors = ['[data-tab]','.tab','.tabs button','#tabSub','#tabQuiz','#tabVocab'];
    tabSelectors.forEach(sel => {
      $$(sel).forEach(el => {
        el.addEventListener('click', blocker, true);
      });
    });
  }

  function initGate(){
    if (gateActive) showDialog(true);
    attachGuards();
    const legacyLogin = $('#btnLogin') || $('.btn-login') || $('[data-role="login"]');
    if (legacyLogin) legacyLogin.style.display = 'none';

    $btnLater.addEventListener('click', () => {
      showDialog(false);
      toast('未登入狀態，功能已限制');
    });

    $btnLogin.addEventListener('click', () => {
      toast('此版本僅示意，未提供實際登入');
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGate);
  } else {
    initGate();
  }
})();
</script>
<!-- ======= LOGIN-GATE (LITE) PATCH v20251007-06: end ======= -->


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {

  const SUPABASE_URL = "https://qtgwedankftrqjmzuset.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g";
  const supabase = window.supabase?.createClient
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        : window.supabaseClient || window.SUPABASE_CLIENT || window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  const gateEl = document.getElementById('loginGate');
  const btnLater = document.getElementById('gateLater');
  const btnLogin = document.getElementById('gateLogin');

  let authed = false;
  let userEmail = '';

  function setBlocked(b){
    if(!gateEl) return;
    gateEl.style.display = b ? 'block' : 'none';
    const v = document.querySelector('video');
    if(v){
      v.style.pointerEvents = b ? 'none' : 'auto';
      v.pause && v.pause();
    }
    document.querySelectorAll('button, input[type="checkbox"], a').forEach(el=>{
      if(el.closest('#loginGate')) return;
      if(b) el.setAttribute('data-gated','1');
      el.disabled = b ? true : (el.getAttribute('data-gated') ? false : el.disabled);
    });
  }

  async function checkAuth(){
    try{
      const { data } = await supabase.auth.getUser();
      if(data && data.user){
        authed = true;
        userEmail = data.user.email || '';
        setBlocked(false);
        let badge = document.querySelector('#userBadgeEmail');
        if(!badge){
          badge = document.createElement('div');
          badge.id = 'userBadgeEmail';
          badge.style.cssText = 'position:fixed;top:10px;right:130px;z-index:9999;background:#172554;color:#e2e8f0;border:1px solid #2563eb;border-radius:12px;padding:4px 10px;font:600 12px system-ui';
          document.body.appendChild(badge);
        }
        badge.textContent = userEmail;
      }else{
        authed = false;
        setBlocked(true);
      }
    }catch(e){
      console.warn('auth check fail', e);
      setBlocked(true);
    }
  }

  btnLater && btnLater.addEventListener('click', ()=> setBlocked(true));
  btnLogin && btnLogin.addEventListener('click', async ()=>{
    try{
      await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.href }
      });
    }catch(e){
      alert('登入失敗，請稍後再試');
    }
  });

  function updatePrintHeader(){
    try{
      const title = document.querySelector('#ph_title');
      const meta = document.querySelector('#ph_meta');
      const scoreNow = document.querySelector('[data-score-now]')?.textContent || '';
      const slug = new URLSearchParams(window.location.search).get('slug') || (document.querySelector('[data-video-slug]')?.dataset?.videoSlug || '');
      const dt = new Date();
      const ts = dt.toISOString().slice(0,19).replace('T',' ');
      title && (title.textContent = '英語影片測驗成績單');
      meta && (meta.textContent = `帳號: ${userEmail||'未登入'} ｜ 影片: ${slug||'-'} ｜ 分數: ${scoreNow||'-'} ｜ 列印時間: ${ts}`);
    }catch(e){ console.warn(e); }
  }
  window.addEventListener('beforeprint', updatePrintHeader);

  checkAuth();
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState === 'visible') checkAuth();
  });

})();
</script>

</body>
</html>
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































