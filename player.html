<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}

  /* 兩欄 -> 左50% 右50% */
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);height:100vh}
  @media(max-width:1024px){.layout{grid-template-columns:1fr;grid-template-rows:auto auto;height:auto}}

  /* 左欄：影片 + 工具列（工具列固定在底部） */
  .videoColumn{display:grid;grid-template-rows:1fr auto;min-height:0;border-right:1px solid var(--border)}
  .videoStage{min-height:0;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden}
  video{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;background:#000;transform-origin:center center}

  .toolBar{position:relative;z-index:2;padding:10px 12px;background:#101b39;border-top:1px solid var(--border);
           display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btn,.chip{border:1px solid var(--border);background:#15224a;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover,.chip:hover{filter:brightness(1.1)}
  .chip.active{background:#1a2c66;border-color:#2d4ea7}
  .muted{color:var(--muted)}
  .sep{width:1px;height:26px;background:var(--border);margin:0 6px}

  /* 右欄 */
  .side{display:flex;flex-direction:column;min-height:0;background:var(--panel)}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}

  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .panel{flex:1;overflow:auto;padding:12px}

  /* 字幕表格（三欄：時間／英文／中文） */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{position:sticky;top:0;background:#0f1a33;color:#a9b3cf;font-weight:600;z-index:1}
  tr.active{background:#1a2c66}

  /* 亮/暗主題切換（保留，可選） */
  .light{--bg:#f7f8fb;--panel:#ffffff;--border:#e4e7f0;--text:#222;--muted:#667}
  .light .videoStage{background:#111}
  .light .btn,.light .chip{background:#f4f6fb;border-color:#e4e7f0;color:#333}
  .light th{background:#fff}
</style>
</head>
<body>
<div class="layout">

  <!-- 左：影片 -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- 左下工具列（新增：校準 -0.5s / +0.5s） -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">上一句</button>
      <button class="btn" id="btnPlay">播放/暫停</button>
      <button class="btn" id="btnNext">下一句</button>

      <span class="sep"></span>

      <button class="btn" id="btnRepeatOne">重複本句</button>
      <button class="btn" id="btnAB">A-B 循環</button>
      <button class="btn" id="btnABClear">取消循環</button>

      <span class="sep"></span>

      <label class="chip">速度
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1"
               style="vertical-align:middle;width:150px;margin-left:8px">
        <span id="rateLabel" style="margin-left:6px">1.00×</span>
      </label>

      <label class="chip">變焦
        <input id="zoom" type="range" min="1" max="2" step="0.05" value="1"
               style="vertical-align:middle;width:140px;margin-left:8px">
      </label>

      <span class="sep"></span>

      <!-- ▲ 校準功能（全域字幕偏移） -->
      <span class="muted">校準</span>
      <button class="btn" id="btnShiftMinus">-0.5s</button>
      <button class="btn" id="btnShiftPlus">+0.5s</button>
      <span class="muted" id="shiftLabel">偏移 0.0s</span>
    </div>
  </section>

  <!-- 右：字幕/測驗/單字（保持現有結構；這份示範主要是字幕） -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
      <div id="tabVocab" class="tab">單字</div>
    </div>

    <!-- 右上工具列（保留字級與主題；不顯示額外搜尋框） -->
    <div class="toolbar">
      <span class="muted">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">跟隨</button>
      <button id="btnTheme" class="btn">主題</button>
      <span class="muted" id="shiftLabelTop" style="margin-left:8px">偏移 0.0s</span>
    </div>

    <!-- 三個面板 -->
    <div id="panelTranscript" class="panel"></div>
    <div id="panelQuiz" class="panel" style="display:none"><div class="muted">（保留：測驗之後接資料）</div></div>
    <div id="panelVocab" class="panel" style="display:none"><div class="muted">（保留：單字面板不變）</div></div>
  </aside>
</div>

<script>
/* ───── 小工具 ───── */
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* 全域狀態 */
let RAW_CUES = [];        // 原始字幕（保存原始時間）
let CUES = [];            // 套用偏移後的字幕
let OFFSET = 0;           // 全域偏移（秒）
let follow = true;        // 自動跟隨
let A=null,B=null,abTimer=null,repeatOne=false;

/* 讀取 index.json */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json 載入失敗');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json 無對應項目');
  return item; // {video,cues,quiz,...}
}

/* 轉換時間 */
function toSec(t){
  if(typeof t === 'number') return t;
  const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0);
  return m*60 + s;
}
function toClock(sec){
  sec = Math.max(0, Math.round(sec));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* 讀字幕（支援雙語） */
async function loadCues(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('字幕 JSON 載入失敗');
  const raw = await res.json();
  const arr = Array.isArray(raw)? raw : (raw.items||[]);
  RAW_CUES = arr.map(x=>({
    tSec : toSec(x.time || x.t || x.start || 0),
    en   : x.en || x.text || x.caption || '',
    zh   : x.zh || x.cn || x.tw || ''
  }));
  applyOffset(0); // 初始化 CUES
  renderTranscript();
}

/* 套用偏移量 → 產生 CUES */
function applyOffset(delta){
  OFFSET = Math.round((OFFSET + delta)*10)/10;
  CUES = RAW_CUES.map(r=>({
    tSec:r.tSec + OFFSET,
    en:r.en, zh:r.zh
  })).sort((a,b)=> a.tSec - b.tSec);
  $('#shiftLabel').textContent     = `偏移 ${OFFSET.toFixed(1)}s`;
  $('#shiftLabelTop').textContent  = `偏移 ${OFFSET.toFixed(1)}s`;
}

/* 渲染字幕（時間／英文／中文） */
function renderTranscript(){
  const box = $('#panelTranscript');
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr><th style="width:88px">時間</th><th>英文</th><th>中文</th></tr>
    </thead>
    <tbody></tbody>`;
  const tb = table.querySelector('tbody');

  CUES.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.dataset.index = i;
    tr.innerHTML = `
      <td class="time">[${toClock(c.tSec)}]</td>
      <td>${c.en||''}</td>
      <td>${c.zh||''}</td>`;
    tr.onclick = ()=>{
      const v = $('#player');
      v.currentTime = Math.max(0, c.tSec);
      v.play();
      highlightByTime(v.currentTime);
    };
    tb.appendChild(tr);
  });

  box.innerHTML = '';
  box.appendChild(table);
}

/* 高亮＆跟隨 */
function highlightByTime(current){
  let idx = -1;
  for(let i=0;i<CUES.length;i++){
    if(CUES[i].tSec - 0.05 <= current) idx = i; else break;
  }
  $$('#panelTranscript tbody tr').forEach(tr=>tr.classList.remove('active'));
  if(idx>=0){
    const tr = $(`#panelTranscript tbody tr[data-index="${idx}"]`);
    if(tr){
      tr.classList.add('active');
      if(follow) tr.scrollIntoView({block:'center',behavior:'smooth'});
    }
  }
}

/* 左下工具列 */
function bindLeftToolbar(){
  const v = $('#player');

  $('#btnPrev').onclick = ()=>{
    const t = v.currentTime;
    const prev = [...CUES].reverse().find(c=>c.tSec < t - 0.05);
    if(prev){ v.currentTime = Math.max(0, prev.tSec); v.play(); }
  };
  $('#btnNext').onclick = ()=>{
    const t = v.currentTime;
    const next = CUES.find(c=>c.tSec > t + 0.05);
    if(next){ v.currentTime = Math.max(0, next.tSec); v.play(); }
  };
  $('#btnPlay').onclick = ()=> v.paused ? v.play() : v.pause();

  $('#rate').oninput = e=>{
    v.playbackRate = +e.target.value;
    $('#rateLabel').textContent = v.playbackRate.toFixed(2)+'×';
  };
  $('#zoom').oninput = e=>{
    v.style.transform = `scale(${+e.target.value})`;
  };

  // 重複本句 / A-B 循環
  $('#btnRepeatOne').onclick = ()=>{
    repeatOne = true;
    const t = v.currentTime;
    let i = CUES.findIndex(c=> c.tSec <= t);
    if(i<0) i=0;
    A = CUES[i].tSec;
    B = (i+1<CUES.length ? CUES[i+1].tSec : null);
    clearInterval(abTimer);
    abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = A; }, 120);
  };
  $('#btnAB').onclick = ()=>{
    if(A==null){ A = v.currentTime; alert('已設定 A 點'); }
    else if(B==null){ B = v.currentTime; alert('已設定 B 點；開始循環'); startAB(); }
    else { A=v.currentTime; B=null; alert('已重設 A 點，請再按一次設定 B 點'); }
  };
  $('#btnABClear').onclick = ()=>{ repeatOne=false; A=null; B=null; clearInterval(abTimer); };
  function startAB(){
    repeatOne=false; clearInterval(abTimer);
    abTimer = setInterval(()=>{ if(B!=null && v.currentTime>=B) v.currentTime = A; }, 120);
  }

  // ▲ 校準按鈕：全域偏移 -0.5s / +0.5s
  $('#btnShiftMinus').onclick = ()=>{
    applyOffset(-0.5);
    renderTranscript();
    highlightByTime(v.currentTime);
  };
  $('#btnShiftPlus').onclick = ()=>{
    applyOffset(+0.5);
    renderTranscript();
    highlightByTime(v.currentTime);
  };

  // 播放進度 → 高亮
  v.addEventListener('timeupdate', ()=> highlightByTime(v.currentTime));
}

/* 右側工具列（字級/跟隨/主題） */
function bindRightToolbar(){
  const setFont = s=>{
    const map={S:'13px',M:'15px',L:'17px'};
    $('#panelTranscript').style.fontSize = map[s]||'15px';
    $$('.toolbar .chip').forEach(b=>b.classList.remove('active'));
    ({S:'#fS',M:'#fM',L:'#fL'}[s] && $(({S:'#fS',M:'#fM',L:'#fL'}[s])).classList.add('active'));
  };
  $('#fS').onclick=()=>setFont('S');
  $('#fM').onclick=()=>setFont('M');
  $('#fL').onclick=()=>setFont('L');

  $('#btnFollow').onclick = ()=>{
    follow = !follow;
    $('#btnFollow').textContent = follow ? '跟隨' : '跟隨（關）';
  };
  $('#btnTheme').onclick = ()=> document.body.classList.toggle('light');

  // 分頁（保留）
  const t1=$('#tabTranscript'), p1=$('#panelTranscript');
  const t2=$('#tabQuiz'),       p2=$('#panelQuiz');
  const t3=$('#tabVocab'),      p3=$('#panelVocab');
  t1.onclick=()=>{ t1.classList.add('active'); t2.classList.remove('active'); t3.classList.remove('active');
                   p1.style.display='block'; p2.style.display='none'; p3.style.display='none'; };
  t2.onclick=()=>{ t2.classList.add('active'); t1.classList.remove('active'); t3.classList.remove('active');
                   p2.style.display='block'; p1.style.display='none'; p3.style.display='none'; };
  t3.onclick=()=>{ t3.classList.add('active'); t1.classList.remove('active'); t2.classList.remove('active');
                   p3.style.display='block'; p1.style.display='none'; p2.style.display='none'; };
}

/* 啟動 */
(async ()=>{
  try{
    const meta = await loadMeta();
    $('#player').src = meta.video;

    await loadCues(meta.cues);   // 讀取並渲染字幕
    bindLeftToolbar();
    bindRightToolbar();

    // 初始字級
    $('#panelTranscript').style.fontSize='15px';
  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">載入失敗：${err.message}</div>`;
  }
})();
</script>
</body>
</html>
