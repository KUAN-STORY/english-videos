<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff;
    --ok:#14b86e; --warn:#f5a524;
    --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;}

  /* å…©æ¬„ï¼šå·¦å½±ç‰‡ / å³é¢æ¿ = 50 / 50 */
  .layout{
    display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); height:100vh;
  }
  @media(max-width:1024px){
    .layout{ grid-template-columns: 1fr; grid-template-rows: auto auto; height:auto; }
  }

  /* å·¦æ¬„ = ä¸Šæ–¹å½±ç‰‡èˆå°(1fr) + ä¸‹æ–¹å·¥å…·åˆ—(auto) -> æ°¸é çœ‹å¾—åˆ°å·¥å…·åˆ— */
  .videoColumn{
    display:grid; grid-template-rows: 1fr auto; min-height:0; /* 1fr å¯æ”¶ç¸® */
    border-right:1px solid var(--border);
  }

  .videoStage{
    min-height:0;
    display:flex; align-items:center; justify-content:center;
    background:#000; overflow:hidden;
  }
  video{
    max-width:100%; max-height:100%;
    width:auto; height:auto; object-fit:contain; background:#000;
    transition:transform .1s ease;
  }

  /* å·¦æ¬„å·¥å…·åˆ— */
  .toolBar{
    position:relative; z-index:2;
    padding:10px 12px; background:#101b39;
    border-top:1px solid var(--border);
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .btn,.chip{
    border:1px solid var(--border); background:#15224a; color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; user-select:none;
  }
  .btn:hover,.chip:hover{ filter:brightness(1.1); }
  .chip.active{ background:#1a2c66; border-color:#2d4ea7; }
  .label{
    color:var(--muted); margin-right:4px;
  }
  .range{
    vertical-align:middle; width:160px; margin-left:8px;
  }

  /* å³å´ç¸½é«” */
  .side{
    display:flex; flex-direction:column; min-height:0; 
    background:var(--panel);
  }
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:0 0 auto; padding:10px 12px; text-align:center; cursor:pointer;
       color:var(--muted); user-select:none}
  .tab.active{color:var(--text); background:#132046; font-weight:700}

  .toolbar{display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid var(--border)}
  .toolbar .grow{flex:1}

  .panel{flex:1; overflow:auto; padding:12px}

  /* å­—å¹•è¡¨æ ¼ */
  .searchBox{
    width:100%; box-sizing:border-box; padding:10px 12px; margin-bottom:8px;
    border:1px solid var(--border); border-radius:10px; background:#09122a; color:var(--text);
  }
  table.cues{width:100%; border-collapse:collapse}
  table.cues th, table.cues td{
    border-bottom:1px solid #142145; padding:8px 10px; vertical-align:top;
  }
  table.cues th{ color:var(--muted); font-weight:600; position:sticky; top:0; background:#0f1a33; }
  tr.active{ background:#1a2c66; }
  .time{font-variant-numeric:tabular-nums; color:var(--muted)}

  /* æ¸¬é©— */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}

  /* å–®å­— */
  .vocabTitle{font-size:18px; font-weight:700; margin-bottom:8px}
  .vocabCard{ padding:12px; border:1px solid var(--border); border-radius:12px; background:#0f1a33; margin:10px 0 }
  .wordHdr{ display:flex; align-items:center; gap:8px; margin-bottom:6px }
  .wordHdr strong{ font-size:18px }
  .pos{ color:var(--muted) }
  .jumpBtn{ font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid var(--border); background:#132046; cursor:pointer }
  .grammar{ font-size:.9em; color:#a9b3cf; margin-top:4px }
  .tip{ color:#8bb3ff; font-size:.9em; margin-left:6px }
</style>
</head>
<body>
<div class="layout">

  <!-- å·¦ï¼šå½±ç‰‡ï¼ˆä¸Šï¼šèˆå°ï¼Œä¸‹ï¼šå·¥å…·åˆ—ï¼‰ -->
  <section class="videoColumn">
    <div class="videoStage">
      <video id="player" controls preload="metadata"></video>
    </div>

    <!-- å›ºå®šåœ¨å·¦æ¬„åº•éƒ¨çš„å·¥å…·åˆ— -->
    <div class="toolBar">
      <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
      <button class="btn" id="btnPlay">æ’­æ”¾/æš«åœ</button>
      <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>

      <button class="btn" id="btnRepeatOne">é‡è¤‡æœ¬å¥</button>
      <button class="btn" id="btnAB">A-B å¾ªç’°</button>
      <button class="btn" id="btnABClear">å–æ¶ˆå¾ªç’°</button>

      <span class="label">é€Ÿåº¦</span>
      <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1" class="range">
      <span id="rateLabel">1.00Ã—</span>

      <span class="label" style="margin-left:12px">è®Šç„¦</span>
      <input id="zoom" type="range" min="1" max="2" step="0.05" value="1" class="range">
    </div>
  </section>

  <!-- å³ï¼šå­—å¹• / æ¸¬é©— / å–®å­— -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
      <div id="tabVocab" class="tab">å–®å­—</div>
    </div>

    <!-- å·¥å…·åˆ—ï¼ˆå­—å¹•åˆ†é æ‰é¡¯ç¤ºï¼‰ -->
    <div class="toolbar" id="toolbarTranscript">
      <input id="search" class="searchBox" placeholder="æœå°‹å­—å¹•â€¦ï¼ˆæ”¯æ´è‹±æ–‡æˆ–ä¸­æ–‡ï¼‰"/>
      <div class="grow"></div>
      <button id="btnFollow" class="btn">è·Ÿéš¨</button>
      <button id="btnSyncNow" class="btn">å°é½Šä¸­å¥</button>
      <button id="btnCalibMinus" class="btn">ææ—©0.5ç§’</button>
      <button id="btnCalibPlus" class="btn">å»¶å¾Œ0.5ç§’</button>
    </div>

    <!-- å­—å¹• -->
    <div id="panelTranscript" class="panel">
      <table class="cues" id="cueTable">
        <thead>
          <tr><th style="width:90px">æ™‚é–“</th><th>è‹±æ–‡</th><th>ä¸­æ–‡</th></tr>
        </thead>
        <tbody id="cueTbody"></tbody>
      </table>
    </div>

    <!-- æ¸¬é©— -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div>
            <button id="btnCheck" class="btn">äº¤å·</button>
            <button id="btnRetry" class="btn" style="display:none">å†è©¦ä¸€æ¬¡</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>

    <!-- å–®å­— -->
    <div id="panelVocab" class="panel" style="display:none">
      <div class="vocabTitle" id="vocabTitle">Vocabulary</div>
      <input id="vocabSearch" class="searchBox" placeholder="æœå°‹å–®å­—æˆ–ä¸­æ–‡è§£é‡‹â€¦"/>
      <div id="vocabList"></div>
    </div>

  </aside>
</div>

<script>
/* ========= å·¥å…· ========= */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

function toSec(t){ const [m,s] = String(t||'0:0').split(':').map(n=>parseInt(n,10)||0); return m*60+s; }
function fmt(t){ const m = Math.floor(t/60), s = Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}` }

/* ========= ç‹€æ…‹ ========= */
let cueList = [];       // [{tSec, en, zh, tr}]
let follow = false;
let calib = 0;          // æ ¡æº–ç§’æ•¸
let A=null, B=null, abTimer=null, repeatOne=false;

/* ========= è¼‰å…¥ index ========= */
async function loadMeta(){
  const res = await fetch('data/index.json');
  const meta = await res.json();
  return (meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
}

/* ========= å½±ç‰‡ ========= */
function setupVideo(src){
  const v = $('#player');
  v.src = src;
}

/* ========= å­—å¹• ========= */
async function loadCues(path){
  const r = await fetch(path);
  const raw = await r.json();                // æ”¯æ´ [{time,en,zh}] æˆ– {items:[...]}
  return Array.isArray(raw) ? raw : (raw.items||[]);
}
function renderCues(list){
  const tbody = $('#cueTbody'); tbody.innerHTML='';
  cueList = list.map(row=>{
    const t = row.time || row.t || row.start || '0:0';
    const en = row.en || row.text || row.caption || '';
    const zh = row.zh || row.cn || row.tw || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="time">[${t}]</td><td>${en}</td><td>${zh}</td>`;
    tr.onclick = ()=>{
      const sec = toSec(t);
      const v = $('#player'); v.currentTime = sec; v.play();
      highlightByTime(sec);
    };
    tbody.appendChild(tr);
    return {tSec:toSec(t), en, zh, tr};
  });
}
function highlightByTime(current){
  let idx=-1;
  for(let i=0;i<cueList.length;i++){
    if(cueList[i].tSec + calib <= current+0.001) idx=i; else break;
  }
  $$('#cueTbody tr').forEach(tr=> tr.classList.remove('active'));
  if(idx>=0){
    const tr = cueList[idx].tr; tr.classList.add('active');
    if(follow) tr.scrollIntoView({block:'center', behavior:'smooth'});
  }
}

/* ========= å³å´å­—å¹•å·¥å…· ========= */
function bindTranscriptToolbar(){
  $('#btnFollow').onclick = ()=>{
    follow = !follow;
    $('#btnFollow').textContent = follow ? 'è·Ÿéš¨ä¸­' : 'è·Ÿéš¨';
  };
  $('#btnCalibPlus').onclick  = ()=>{ calib += 0.5; };
  $('#btnCalibMinus').onclick = ()=>{ calib -= 0.5; };
  $('#btnSyncNow').onclick = ()=>{
    const v = $('#player');
    highlightByTime(v.currentTime);
  };
  // æœå°‹
  $('#search').oninput = (e)=>{
    const q = e.target.value.trim().toLowerCase();
    cueList.forEach(c=>{
      const hit = !q || c.en.toLowerCase().includes(q) || c.zh.toLowerCase().includes(q);
      c.tr.style.display = hit ? '' : 'none';
    });
  };
}

/* ========= å·¦æ¬„å·¥å…· ========= */
function jumpPrev(){
  const v = $('#player');
  const t = v.currentTime;
  const prev = [...cueList].reverse().find(c=> c.tSec+calib < t-0.05);
  if(prev){ v.currentTime = prev.tSec+calib; v.play(); }
}
function jumpNext(){
  const v = $('#player');
  const t = v.currentTime;
  const next = cueList.find(c=> c.tSec+calib > t+0.05);
  if(next){ v.currentTime = next.tSec+calib; v.play(); }
}
function setRepeatOne(){
  const v = $('#player');
  repeatOne = true;
  const t = v.currentTime;
  let i = cueList.findIndex(c=> c.tSec+calib <= t);
  if(i<0) i=0;
  A = cueList[i].tSec+calib;
  B = (i+1<cueList.length ? cueList[i+1].tSec+calib : null);
  clearInterval(abTimer);
  abTimer = setInterval(()=>{
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function setAB(){
  const v = $('#player');
  if(A==null){ A = v.currentTime; alert('å·²è¨­å®š A é»'); }
  else if(B==null){ B = v.currentTime; alert('å·²è¨­å®š B é»ï¼›é–‹å§‹å¾ªç’°'); startAB(); }
  else { A=v.currentTime; B=null; alert('å·²é‡è¨­ A é»ï¼Œè«‹å†æŒ‰ä¸€æ¬¡è¨­å®š B é»'); }
}
function startAB(){
  repeatOne = false;
  clearInterval(abTimer);
  const v = $('#player');
  abTimer = setInterval(()=>{
    if(B!=null && v.currentTime>=B) v.currentTime = A;
  }, 120);
}
function clearLoop(){
  repeatOne=false; A=null; B=null; clearInterval(abTimer);
}
function bindLeftToolbar(){
  $('#btnPrev').onclick = jumpPrev;
  $('#btnNext').onclick = jumpNext;
  $('#btnPlay').onclick = ()=>{ const v=$('#player'); v.paused?v.play():v.pause(); };
  $('#btnRepeatOne').onclick = setRepeatOne;
  $('#btnAB').onclick = setAB;
  $('#btnABClear').onclick = clearLoop;
  $('#rate').oninput = e=>{
    const v = $('#player'); v.playbackRate = +e.target.value;
    $('#rateLabel').textContent = v.playbackRate.toFixed(2)+'Ã—';
  };
  $('#zoom').oninput = e=>{
    $('#player').style.transform = `scale(${+e.target.value})`;
    $('#player').style.transformOrigin = 'center center';
  };
}

/* ========= æ¸¬é©— ========= */
async function loadQuiz(path){
  const r = await fetch(path);
  const raw = await r.json();
  const arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  // ç›¸å®¹ï¼š{q, a:[], ans or answerIndex}
  return arr.slice(0,20).map((x,i)=>{
    const q = x.q || x.question || x.title || `Q${i+1}`;
    const opts = x.a || x.options || x.choices || [];
    let ans = x.ans ?? x.correct ?? x.answerIndex ?? 0;
    if(typeof ans!=='number'){ // è‹¥ç­”æ¡ˆæ˜¯å­—ä¸²
      const idx = opts.findIndex(o=> (o.text||o)===ans);
      ans = idx>=0? idx : 0;
    }
    return { q, opts: opts.map(o=> (o.text||o)), ans };
  });
}
function renderQuiz(questions){
  const box = $('#quizBox'); box.innerHTML='';
  questions.forEach((q,i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    wrap.innerHTML = `<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt,j)=>{
      const line = document.createElement('label');
      line.className = 'opt';
      line.innerHTML = `<input type="radio" name="q${i}" value="${j}"><span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent = `0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked', box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick = ()=>{
    let correct=0;
    questions.forEach((q,i)=>{
      const picked = $('input[name="q'+i+'"]:checked', box);
      const val = picked? parseInt(picked.value,10) : -1;
      if(val===q.ans) correct++;
    });
    const ratio = Math.round(correct/questions.length*100);
    const res = $('#quizResult');
    res.style.display='block';
    res.className = 'result ' + (ratio>=80 ? 'pass':'fail');
    res.textContent = `åˆ†æ•¸ï¼š${correct} / ${questions.length}ï¼ˆ${ratio}%ï¼‰` + (ratio>=80?'  ğŸ‘ å¤ªæ£’äº†ï¼':'  å†æ¥å†å²ï¼');
    $('#btnRetry').style.display='inline-block';
  };
  $('#btnRetry').onclick = ()=>{
    $$('input[type="radio"]', box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent = `0 / ${questions.length}`;
    const res = $('#quizResult'); res.style.display='none';
    $('#btnRetry').style.display='none';
  };
}

/* ========= å–®å­—ï¼ˆå« grammarï¼‰ ========= */
async function loadVocab(path){
  try{
    const r = await fetch(path);
    if(!r.ok) throw 0;
    const raw = await r.json();
    return raw.items || raw || [];
  }catch(e){
    return []; // æ²’æœ‰ vocab æª”æ™‚é¡¯ç¤ºç©º
  }
}
function seekTo(tstr){
  const v = $('#player'); v.currentTime = toSec(tstr)+calib; v.play();
}
function renderVocab(items){
  $('#vocabTitle').textContent = (items.title || 'Vocabulary');
  const list = Array.isArray(items)? items : (items.items||[]);
  const box = $('#vocabList'); box.innerHTML='';
  list.forEach(it=>{
    const c = document.createElement('div');
    c.className='vocabCard';
    c.innerHTML = `
      <div class="wordHdr">
        <strong>${it.word || ''}</strong>
        <span class="pos">${it.pos || ''}</span>
        ${it.time ? `<button class="jumpBtn" data-time="${it.time}">â–¶ [${it.time}]</button>` : ''}
        ${it.grammar ? `<span class="tip">å«æ–‡æ³•</span>` : ''}
      </div>
      <div>${it.zh || ''}</div>
      <div>${it.en || ''}</div>
      ${it.example ? `<div>ä¾‹ï¼š${it.example}</div>` : ''}
      ${it.grammar ? `<div class="grammar">æ–‡æ³•ï¼š${it.grammar}</div>` : ''}
    `;
    if(it.time){
      c.querySelector('.jumpBtn').onclick = ()=> seekTo(it.time);
    }
    box.appendChild(c);
  });

  // æœå°‹
  $('#vocabSearch').oninput = (e)=>{
    const q = e.target.value.trim().toLowerCase();
    [...box.children].forEach(card=>{
      const txt = card.textContent.toLowerCase();
      card.style.display = (!q || txt.includes(q)) ? '' : 'none';
    });
  };
}

/* ========= åˆ†é åˆ‡æ› ========= */
function setupTabs(){
  const T1=$('#tabTranscript'), P1=$('#panelTranscript');
  const T2=$('#tabQuiz'),       P2=$('#panelQuiz');
  const T3=$('#tabVocab'),      P3=$('#panelVocab');
  const TB=$('#toolbarTranscript');

  T1.onclick=()=>{ T1.classList.add('active'); T2.classList.remove('active'); T3.classList.remove('active');
                   P1.style.display='block'; P2.style.display='none'; P3.style.display='none'; TB.style.display='flex'; };
  T2.onclick=()=>{ T2.classList.add('active'); T1.classList.remove('active'); T3.classList.remove('active');
                   P2.style.display='block'; P1.style.display='none'; P3.style.display='none'; TB.style.display='none'; };
  T3.onclick=()=>{ T3.classList.add('active'); T1.classList.remove('active'); T2.classList.remove('active');
                   P3.style.display='block'; P1.style.display='none'; P2.style.display='none'; TB.style.display='none'; };
}

/* ========= å•Ÿå‹• ========= */
(async ()=>{
  setupTabs();
  bindLeftToolbar();
  bindTranscriptToolbar();

  const meta = await loadMeta();
  if(!meta){ $('#cueTbody').innerHTML='<tr><td colspan="3">æœªæ‰¾åˆ°å…§å®¹</td></tr>'; return; }

  setupVideo(meta.video);

  // å­—å¹•
  const cues = await loadCues(meta.cues);
  renderCues(cues);
  $('#player').addEventListener('timeupdate', ()=> highlightByTime($('#player').currentTime));

  // æ¸¬é©—ï¼ˆå¦‚æœæœ‰ï¼‰
  if(meta.quiz){
    const qs = await loadQuiz(meta.quiz);
    renderQuiz(qs);
  }else{
    $('#tabQuiz').style.display='none';
  }

  // å–®å­—ï¼ˆå¦‚æœæœ‰ï¼‰
  const vocabPath = `data/vocab-${slug}.json`;
  const vocabItems = await loadVocab(vocabPath);
  if(Array.isArray(vocabItems) && vocabItems.length===0 && !vocabItems.title){
    $('#tabVocab').style.display='none';
  }else{
    renderVocab(vocabItems);
  }
})();
</script>
</body>
</html>
