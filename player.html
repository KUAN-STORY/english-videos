<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories · Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057; --text:#e7eaf3; --muted:#a9b3cf;
    --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524; --gap:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Noto Sans",sans-serif}
  /* 兩欄：左影片 + 右功能（字幕/測驗） */
  .layout{display:grid;grid-template-columns:minmax(320px,1fr) 520px;gap:var(--gap);height:100%}
  @media(max-width:1100px){ .layout{grid-template-columns:1fr} }

  /* 左邊：影片與工具列（你原本的效果保留） */
  .videoWrap{display:flex;flex-direction:column;height:100%}
  .videoBox{flex:1;display:flex;align-items:center;justify-content:center;background:#000;position:relative;min-height:240px}
  video{width:100%;height:100%;max-height:100vh;object-fit:contain;background:#000}
  .vtools{position:sticky;bottom:0;background:#0d1733;border-top:1px solid var(--border);padding:10px 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#14224a;color:#fff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  label.slider{display:flex;align-items:center;gap:8px;margin-left:10px}
  input[type="range"]{accent-color:#8b1d1d}

  /* 右邊：字幕/測驗外框 */
  .side{display:flex;flex-direction:column;background:var(--panel);border-left:1px solid var(--border);min-height:0}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;text-align:center;padding:10px 12px;color:var(--muted);cursor:pointer;user-select:none}
  .tab.active{color:#fff;background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
  .chip{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}
  .panel{flex:1;min-height:0;overflow:auto;padding:12px}

  /* 字幕清單 */
  .line{line-height:1.55;margin:6px 0;padding:6px 8px;border-radius:8px;transition:background .15s}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:8px}
  .line:hover{background:#122147}
  .line.active{background:#1e335f;outline:1px solid #2d4ea7}

  /* 亮色主題（可視需要保留） */
  .light{--bg:#f7f8fb;--panel:#fff;--border:#e6e8f2;--text:#222;--muted:#667}
  .light .videoBox{background:#111}
  .light .side{border-color:#e6e8f2}
  .light .btn,.light .chip{background:#f4f6fb;color:#333;border-color:#e6e8f2}
  .light .line:hover{background:#eef3ff}
  .light .line.active{background:#dfe9ff;outline-color:#8fb3ff}
</style>
</head>
<body>
<div class="layout">
  <!-- 左：影片區（保留你原來的結構與工具列） -->
  <section class="videoWrap">
    <div class="videoBox">
      <video id="player" controls preload="metadata"></video>
    </div>
    <!-- 固定在影片下方的工具列（A-B、上一句、下一句、速度、變焦） -->
    <div class="vtools">
      <div class="row">
        <button class="btn" id="prevLine">上一句</button>
        <button class="btn" id="playPause">播放/暫停</button>
        <button class="btn" id="nextLine">下一句</button>
        <button class="btn" id="repeatLine">重複本句</button>
        <button class="btn" id="abToggle">A-B 循環</button>
        <button class="btn" id="abClear">取消循環</button>
        <label class="slider">速度
          <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1">
          <span id="rateVal">1.00×</span>
        </label>
        <label class="slider">變焦
          <input id="zoom" type="range" min="0.8" max="1.2" step="0.02" value="1">
        </label>
      </div>
    </div>
  </section>

  <!-- 右：字幕/測驗 -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTrans" class="tab active">字幕</div>
      <div id="tabQuiz" class="tab">測驗</div>
    </div>

    <div class="toolbar">
      <span style="color:var(--muted)">字級</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>
      <div style="flex:1"></div>
      <button id="btnFollow" class="btn">跟隨：開</button>
      <button id="btnTheme" class="btn">主題</button>
    </div>

    <!-- 字幕面板 -->
    <div id="panelTrans" class="panel"></div>

    <!-- 測驗面板（先保留，不改動內容） -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div class="line" style="opacity:.7">小測驗之後再補；目前僅保留面板。</div>
    </div>
  </aside>
</div>

<script>
/* =============== 小工具 =============== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

/* 字級 */
function setFont(size='M'){
  const map={S:'13px',M:'15px',L:'17px'};
  $$('#panelTrans').forEach(v=>v.style.fontSize=map[size]||'15px');
  $$('.chip').forEach(c=>c.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}

/* 載入索引與檔案 */
async function loadMeta(){
  const res=await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json 載入失敗');
  const meta=await res.json();
  const item=(meta.items||[]).find(x=>x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json 無對應項目');
  return item; // {video,cues,quiz}
}

function toSec(t){
  if(typeof t==='number') return t;
  if(!t) return 0;
  const m = String(t).trim().split(':').map(n=>parseInt(n,10)||0);
  if(m.length===3) return m[0]*3600+m[1]*60+m[2];
  return (m[0]*60 + (m[1]||0));
}

/* =============== 字幕渲染與同步 =============== */
let cues = [];         // [{t, text, el}]
let follow = true;     // 是否自動跟隨
let lastActive = -1;   // 上一次高亮索引
const SCROLL_MARGIN = 120; // 捲動到視窗中的緩衝

async function loadCues(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('字幕 JSON 載入失敗');
  const raw = await res.json();
  const list = Array.isArray(raw) ? raw : (raw.items||raw.lines||[]);
  return list.map(r=>({
    t: toSec(r.time||r.start||r.t),
    text: r.text || r.en || r.caption || ''
  })).sort((a,b)=>a.t-b.t);
}

function renderTranscript(arr){
  const box = $('#panelTrans');
  box.innerHTML = '';
  cues = arr.map((row,i)=>{
    const div = document.createElement('div');
    div.className = 'line';
    div.dataset.idx = i;
    div.innerHTML = `<span class="time">[${fmt(row.t)}]</span>${row.text}`;
    div.onclick = ()=>{ player.currentTime = row.t + 0.01; player.play(); };
    box.appendChild(div);
    return { ...row, el: div };
  });
}
function fmt(sec){
  const m = Math.floor(sec/60), s = Math.floor(sec%60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function syncHighlight(time){
  if(!cues.length) return;
  // 找到時間 <= current 的最後一句
  let i = cues.findIndex(c=>c.t>time) - 1;
  if(i<0) i = cues.length-1;
  if(i===lastActive) return;

  // 取消舊的、標記新的
  if(lastActive>=0) cues[lastActive].el.classList.remove('active');
  cues[i].el.classList.add('active');
  lastActive = i;

  // 自動捲動到視窗中
  if(follow){
    const el = cues[i].el;
    const container = $('#panelTrans');
    const top = el.offsetTop - container.scrollTop;
    if(top < SCROLL_MARGIN || top > container.clientHeight - SCROLL_MARGIN){
      el.scrollIntoView({block:'center',behavior:'smooth'});
    }
  }
}

/* =============== 左側工具列（保留你現有的邏輯） =============== */
const player = $('#player');
let A=null, B=null; // A-B loop

$('#playPause').onclick = ()=> player.paused ? player.play() : player.pause();

$('#rate').oninput = e=>{
  player.playbackRate = parseFloat(e.target.value);
  $('#rateVal').textContent = player.playbackRate.toFixed(2)+'×';
};

$('#zoom').oninput = e=>{
  const z = parseFloat(e.target.value);
  // 用 CSS transform 放大縮小影片
  player.style.transform = `scale(${z})`;
  player.style.transformOrigin = 'center center';
};

$('#abToggle').onclick = ()=>{
  const ct = player.currentTime;
  if(A===null){ A = ct; B = null; $('#abToggle').textContent='A-B 循環：已設 A'; }
  else if(B===null && ct>A){ B = ct; $('#abToggle').textContent='A-B 循環：啟用'; }
  else { A = ct; B = null; $('#abToggle').textContent='A-B 循環：已更新 A'; }
};
$('#abClear').onclick = ()=>{ A=null; B=null; $('#abToggle').textContent='A-B 循環'; };

$('#repeatLine').onclick = ()=>{
  if(lastActive>=0){
    const t0 = cues[lastActive].t, t1 = (cues[lastActive+1]?.t ?? (t0+3));
    player.currentTime = t0 + 0.01;
    player.play();
    A = t0; B = t1;
  }
};
$('#prevLine').onclick = ()=>{
  const t = player.currentTime - 0.1;
  let i = cues.findIndex(c=>c.t>t) - 1;
  if(i<0) i=0;
  player.currentTime = cues[i].t + 0.01;
};
$('#nextLine').onclick = ()=>{
  const t = player.currentTime + 0.05;
  let i = cues.findIndex(c=>c.t>t);
  if(i<0) i=cues.length-1;
  player.currentTime = cues[i].t + 0.01;
};

/* A-B 迴圈與字幕同步 */
player.addEventListener('timeupdate', ()=>{
  const t = player.currentTime;
  if(A!==null && B!==null && B>A){
    if(t>=B) player.currentTime = A + 0.01;
  }
  syncHighlight(t);
});

/* =============== 右欄按鈕 =============== */
$('#fS').onclick=()=>setFont('S');
$('#fM').onclick=()=>setFont('M');
$('#fL').onclick=()=>setFont('L');
$('#btnTheme').onclick=()=>document.body.classList.toggle('light');
$('#btnFollow').onclick=()=>{
  follow = !follow;
  $('#btnFollow').textContent = '跟隨：' + (follow?'開':'關');
};

/* 分頁切換（測驗先保留） */
(function tabs(){
  const t1=$('#tabTrans'), p1=$('#panelTrans');
  const t2=$('#tabQuiz'),  p2=$('#panelQuiz');
  t1.onclick=()=>{t1.classList.add('active');t2.classList.remove('active');p1.style.display='block';p2.style.display='none';};
  t2.onclick=()=>{t2.classList.add('active');t1.classList.remove('active');p2.style.display='block';p1.style.display='none';};
})();

/* =============== 啟動 =============== */
(async ()=>{
  try{
    setFont('M');

    const meta = await loadMeta();
    player.src = meta.video;

    const arr = await loadCues(meta.cues);
    renderTranscript(arr);

    // 若需要：載入測驗時再把 tab 打開
    if(!meta.quiz){ $('#tabQuiz').style.display='none'; }
  }catch(err){
    console.error(err);
    $('#panelTrans').innerHTML = `<div class="line" style="opacity:.7">載入失敗：${err.message}</div>`;
  }
})();
</script>
</body>
</html>
