<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn English with Stories Â· Player</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1a33; --border:#203057;
    --text:#e7eaf3; --muted:#a9b3cf; --brand:#3c7cff; --ok:#14b86e; --warn:#f5a524;
    --gap:12px; --zoom:1;
    --vbar-h:74px; /* å½±ç‰‡å·¥å…·åˆ—é«˜åº¦ */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif}

  /* ç‰ˆé¢ï¼šå·¦å³å„ 50% */
  .layout{display:grid;grid-template-columns: 1fr 1fr;gap:var(--gap);height:100%;padding:var(--gap)}
  @media(max-width:1024px){ .layout{grid-template-columns:1fr} }

  /* å·¦ï¼šå½±ç‰‡å€ */
  .videoCol{display:grid; grid-template-rows: 1fr var(--vbar-h); min-height:0; background:#000; border:1px solid var(--border); border-radius:12px; overflow:hidden}
  .videoWrap{position:relative; display:flex; align-items:center; justify-content:center; background:#000; min-height:0}
  .videoStage{transform:scale(var(--zoom)); transform-origin:center center; transition:transform .08s linear}
  video{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:contain; background:#000}

  /* å½±ç‰‡å·¥å…·åˆ—ï¼ˆå›ºå®šåœ¨å·¦æ¬„å…§åº•éƒ¨ï¼‰ */
  .vbar{display:flex; align-items:center; gap:8px; padding:10px; background:#101b39; border-top:1px solid var(--border)}
  .btn{padding:8px 10px;border:1px solid var(--border);background:#15224a;color:var(--text);border-radius:10px;cursor:pointer;user-select:none}
  .btn:hover{filter:brightness(1.08)}
  .btn.on{background:#1a2c66;border-color:#2d4ea7}
  .seg{margin:0 6px; opacity:.5}
  .rangeRow{display:flex; align-items:center; gap:8px; margin-left:auto}
  .label{color:var(--muted); margin-right:2px}
  input[type="range"]{accent-color:#8a1d1d}

  /* å³ï¼šå´æ¬„ */
  .side{display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{color:var(--text);background:#132046;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  .chip{padding:6px 9px;border:1px solid var(--border);border-radius:8px;background:#121d3d;color:var(--muted);cursor:pointer}
  .chip.active{background:#1a2c66;color:#fff;border-color:#2d4ea7}

  .panel{flex:1;overflow:auto;padding:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}

  /* å­—å¹• */
  .line{line-height:1.55;margin:6px 0;padding:2px 6px;border-radius:8px}
  .time{color:var(--muted);font-variant-numeric:tabular-nums;margin-right:6px}
  .line:hover{background:#15224a}
  .line.active{background:#1b2b5f}

  /* æ¸¬é©— */
  .q{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1a33;margin:10px 0}
  .q h4{margin:0 0 8px 0;font-weight:700}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;cursor:pointer}
  .opt input{margin-top:4px}
  .result{margin-top:12px;padding:8px;border-radius:10px;display:none}
  .result.pass{background:rgba(20,184,110,.12);border:1px solid var(--ok)}
  .result.fail{background:rgba(245,165,36,.12);border:1px solid var(--warn)}
  .stickyFoot{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,19,36,0),rgba(11,19,36,1) 30%);padding-top:12px}
  .footBar{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#101b39;border:1px solid var(--border);border-radius:12px;padding:10px}

  /* äº®/æš—ä¸»é¡Œåˆ‡æ› */
  .light{--bg:#f7f8fb;--panel:#ffffff;--border:#e4e7f0;--text:#222;--muted:#667; background:#fff;color:#222}
  .light .vbar{background:#f5f7fc}
  .light .btn,.light .chip{background:#f4f6fb;border-color:#e4e7f0;color:#333}
  .light .tab.active{background:#eaf1ff}
  .light .line.active{background:#e8f0ff}
</style>
</head>
<body>
<div class="layout">
  <!-- å·¦æ¬„ï¼šå½±ç‰‡ + å·¥å…·åˆ— -->
  <section class="videoCol">
    <div class="videoWrap">
      <div class="videoStage">
        <video id="player" controls preload="metadata"></video>
      </div>
    </div>

    <div class="vbar">
      <button id="btnPrev" class="btn">â® ä¸Šä¸€å¥</button>
      <button id="btnPlay" class="btn">â¯ æ’­æ”¾</button>
      <button id="btnNext" class="btn">â­ ä¸‹ä¸€å¥</button>
      <span class="seg">|</span>
      <button id="btnRepeatLine" class="btn">ğŸ” é‡è¤‡æœ¬å¥</button>
      <button id="btnAutoPause" class="btn">ğŸŸ¢ é€å¥è‡ªå‹•æš«åœ</button>
      <button id="btnLoopAll" class="btn">ğŸ” æ•´æ®µå¾ªç’°</button>
      <span class="seg">|</span>
      <button id="btnInstantAB" class="btn">ğŸ…°ï¸ğŸ…±ï¸ é»å¥å³å¾ªç’°</button>
      <button id="btnCancelLoop" class="btn">â›” å–æ¶ˆå¾ªç’°</button>
      <span class="seg">|</span>
      <button id="btnFit" class="btn">ğŸ–¼ é©æ‡‰ç•«é¢</button>

      <div class="rangeRow">
        <span class="label">è®Šç„¦</span>
        <input id="zoom" type="range" min="0.8" max="1.4" step="0.02" value="1">
        <span class="label">é€Ÿåº¦</span>
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1">
        <span id="rateVal">1.00Ã—</span>
      </div>
    </div>
  </section>

  <!-- å³æ¬„ï¼šå­—å¹• / æ¸¬é©— -->
  <aside class="side">
    <div class="tabs">
      <div id="tabTranscript" class="tab active">å­—å¹•</div>
      <div id="tabQuiz" class="tab">æ¸¬é©—</div>
    </div>

    <div class="toolbar">
      <span class="muted">å­—ç´š</span>
      <button id="fS" class="chip">S</button>
      <button id="fM" class="chip active">M</button>
      <button id="fL" class="chip">L</button>

      <div style="flex:1"></div>
      <button id="btnFollow" class="chip active" title="å­—å¹•è·Ÿéš¨å½±ç‰‡">è·Ÿéš¨</button>
      <button id="btnTheme" class="chip">ä¸»é¡Œ</button>
    </div>

    <!-- å­—å¹•é¢æ¿ -->
    <div id="panelTranscript" class="panel"></div>

    <!-- æ¸¬é©—é¢æ¿ -->
    <div id="panelQuiz" class="panel" style="display:none">
      <div id="quizBox"></div>
      <div class="stickyFoot">
        <div class="footBar">
          <div class="muted" id="quizProgress">0 / 0</div>
          <div class="row">
            <button id="btnCheck" class="btn">äº¤å·</button>
            <button id="btnRetry" class="btn" style="display:none">å†è©¦ä¸€æ¬¡</button>
          </div>
        </div>
        <div id="quizResult" class="result"></div>
      </div>
    </div>
  </aside>
</div>

<script>
/* ------------------ å°å·¥å…· ------------------ */
const $  = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug') || '';

let FONT = 'M';                      // S/M/L
let cues = [];                       // [{t,text,startSec}]
let currentIdx = -1;                 // ç›®å‰å¥ç´¢å¼•
let instantAB = false;               // é»å¥å³å¾ªç’°æ¨¡å¼
let abA = null, abB = null;          // A/B æ™‚é–“ï¼ˆç§’ï¼‰
let autoPause = false;               // é€å¥è‡ªå‹•æš«åœ
let loopAll = false;                 // å…¨ç‰‡å¾ªç’°
let followTranscript = true;         // å­—å¹•è·Ÿéš¨å½±ç‰‡
let followPauseTimer = null;         // æ²å‹•æš«åœè¨ˆæ™‚
let fitContain = true;               // contain / cover

/* å¤–è§€ */
function setFont(size){
  FONT = size;
  const map = {S:'13px', M:'15px', L:'17px'};
  $$('#panelTranscript, #panelQuiz, .q').forEach(el=> el.style.fontSize = map[size]||'15px');
  $$('.chip').forEach(b=>b.classList.remove('active'));
  ({S:'#fS',M:'#fM',L:'#fL'}[size] && $(({S:'#fS',M:'#fM',L:'#fL'}[size])).classList.add('active'));
}
function scrollIntoViewCentered(el, container){
  if(!el || !container) return;
  const box = container.getBoundingClientRect();
  const r   = el.getBoundingClientRect();
  if (r.top < box.top + 20 || r.bottom > box.bottom - 20) {
    container.scrollTo({
      top: container.scrollTop + (r.top - box.top) - (box.height/2 - r.height/2),
      behavior: 'smooth'
    });
  }
}

/* ------------------ ç´¢å¼•/å½±ç‰‡/å­—å¹• ------------------ */
async function loadMeta(){
  const res = await fetch('data/index.json');
  if(!res.ok) throw new Error('index.json è¼‰å…¥å¤±æ•—');
  const meta = await res.json();
  const item = (meta.items||[]).find(x=> x.slug===slug) || meta.items?.[0];
  if(!item) throw new Error('index.json ç„¡å°æ‡‰é …ç›®');
  return item;
}
function setupVideo(src){
  const v = $('#player');
  v.src = src;
}
async function loadCues(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('å­—å¹• JSON è¼‰å…¥å¤±æ•—');
  const raw = await res.json();
  const arr = Array.isArray(raw)? raw : (raw.items||[]);
  // æ­£è¦åŒ–
  cues = arr.map((row,i)=>{
    const t = row.time || row.t || row.start || '';
    const s = row.text || row.en || row.caption || '';
    const [mm,ss] = (t||'0:0').toString().split(':').map(n=>parseInt(n,10)||0);
    return {idx:i, t, text:s, startSec:mm*60+ss};
  }).sort((a,b)=> a.startSec - b.startSec);
}
function renderTranscript(){
  const box = $('#panelTranscript'); box.innerHTML='';
  cues.forEach(row=>{
    const div = document.createElement('div');
    div.className='line'; div.dataset.idx=row.idx;
    div.innerHTML=`<span class="time">[${row.t}]</span>${row.text}`;
    div.onclick = ()=>{
      const v=$('#player');
      if(instantAB){
        abA = row.startSec;
        const next = cues[row.idx+1];
        abB = next ? next.startSec-0.05 : (v.duration||abA+3);
        v.currentTime = abA; v.play();
      }else{
        v.currentTime = row.startSec; v.play();
      }
    };
    box.appendChild(div);
  });
}

/* ------------------ å½±ç‰‡æ§åˆ¶ / é€å¥é‚è¼¯ ------------------ */
function findCurrentIdx(t){
  // æ‰¾ <= t çš„æœ€å¾Œä¸€å¥
  let i=0; for(; i<cues.length; i++){ if(cues[i].startSec > t+0.02) break; }
  return Math.max(0, i-1);
}
function highlight(i){
  currentIdx=i;
  $$('.line').forEach(el=> el.classList.remove('active'));
  const el = $(`.line[data-idx="${i}"]`);
  if(el){
    el.classList.add('active');
    if (followTranscript) scrollIntoViewCentered(el, $('#panelTranscript'));
  }
}
function jumpTo(i){
  if(i<0||i>=cues.length) return;
  $('#player').currentTime = cues[i].startSec;
  $('#player').play();
}
function nextLine(){ jumpTo(Math.min(cues.length-1, currentIdx+1)); }
function prevLine(){
  const now = $('#player').currentTime;
  const cur = findCurrentIdx(now);
  // è‹¥å‰›é–‹å§‹ 0.6 ç§’å…§ï¼Œè·³åˆ°å‰ä¸€å¥ï¼›å¦å‰‡å›åˆ°æœ¬å¥é–‹é ­
  if(now - cues[cur].startSec > .6) jumpTo(cur);
  else jumpTo(Math.max(0, cur-1));
}
/* é‡è¤‡æœ¬å¥ï¼šè¨­ç‚º A-B å¾ªç’° */
function repeatThisLine(){
  const v=$('#player');
  const a = cues[currentIdx]?.startSec ?? 0;
  const b = cues[currentIdx+1]?.startSec ?? (v.duration||a+3);
  abA=a; abB=b-0.05; v.currentTime=a; v.play();
}
/* æ¯å¥çµå°¾æš«åœ */
function toggleAutoPause(){
  autoPause = !autoPause;
  $('#btnAutoPause').classList.toggle('on', autoPause);
}
/* å…¨ç‰‡å¾ªç’° */
function toggleLoopAll(){
  loopAll=!loopAll;
  $('#btnLoopAll').classList.toggle('on', loopAll);
}
/* é»å¥å³å¾ªç’° */
function toggleInstantAB(){
  instantAB = !instantAB;
  $('#btnInstantAB').classList.toggle('on', instantAB);
}
/* å–æ¶ˆå¾ªç’° */
function cancelLoop(){ abA=null; abB=null; }

/* è·Ÿéš¨é–‹é—œèˆ‡ä½¿ç”¨è€…æ‰‹å‹•æ²å‹•æš«åœ */
function setupFollow(){
  $('#btnFollow').onclick=()=>{
    followTranscript=!followTranscript;
    $('#btnFollow').classList.toggle('active', followTranscript);
  };
  ['wheel','touchstart','pointerdown'].forEach(ev=>{
    $('#panelTranscript').addEventListener(ev, ()=>{
      followTranscript=false;
      $('#btnFollow').classList.remove('active');
      clearTimeout(followPauseTimer);
      followPauseTimer=setTimeout(()=>{
        followTranscript=true;
        $('#btnFollow').classList.add('active');
      }, 5000);
    }, {passive:true});
  });
}

/* å·¥å…·åˆ—ï¼šè®Šç„¦ / é€Ÿåº¦ / é©æ‡‰ */
function setupTools(){
  $('#zoom').oninput = e=>{
    document.documentElement.style.setProperty('--zoom', e.target.value);
  };
  const v=$('#player');
  $('#rate').oninput = e=>{
    v.playbackRate = parseFloat(e.target.value);
    $('#rateVal').textContent = v.playbackRate.toFixed(2)+'Ã—';
  };
  $('#btnFit').onclick = ()=>{
    fitContain=!fitContain;
    v.style.objectFit = fitContain? 'contain':'cover';
    $('#btnFit').classList.toggle('on', !fitContain);
  };
  $('#btnPlay').onclick = ()=> v.paused ? v.play() : v.pause();
  $('#btnPrev').onclick = prevLine;
  $('#btnNext').onclick = nextLine;
  $('#btnRepeatLine').onclick = repeatThisLine;
  $('#btnAutoPause').onclick = toggleAutoPause;
  $('#btnLoopAll').onclick = toggleLoopAll;
  $('#btnInstantAB').onclick = toggleInstantAB;
  $('#btnCancelLoop').onclick = cancelLoop;
}

/* åˆ†é /å­—ç´š/ä¸»é¡Œ */
function setupUI(){
  const t1=$('#tabTranscript'), p1=$('#panelTranscript');
  const t2=$('#tabQuiz'),       p2=$('#panelQuiz');
  t1.onclick=()=>{t1.classList.add('active');t2.classList.remove('active');p1.style.display='block';p2.style.display='none'};
  t2.onclick=()=>{t2.classList.add('active');t1.classList.remove('active');p2.style.display='block';p1.style.display='none'};
  $('#fS').onclick=()=>setFont('S'); $('#fM').onclick=()=>setFont('M'); $('#fL').onclick=()=>setFont('L');
  $('#btnTheme').onclick=()=>document.body.classList.toggle('light');
  setFont('M');
  setupFollow();
  setupTools();
}

/* æ¸¬é©—è¼‰å…¥èˆ‡æ¸²æŸ“ï¼ˆ20 é¡Œï¼‰ */
async function loadQuiz(path){
  const res=await fetch(path);
  if(!res.ok) throw new Error('æ¸¬é©— JSON è¼‰å…¥å¤±æ•—');
  const raw=await res.json();
  let arr = Array.isArray(raw)? raw : (raw.items||raw.questions||[]);
  return arr.slice(0,20).map((x,i)=>{
    const q = x.question||x.q||x.title||`Q${i+1}`;
    const opts = (x.options||x.choices||x.a||[]).map(o=>o.text||o);
    let ans = x.answerIndex ?? x.correct ?? x.ans ?? 0;
    if(typeof ans!=='number'){
      const idx = opts.findIndex(o=>o===ans); ans = idx>=0? idx : 0;
    }
    return {q, opts, ans};
  });
}
function renderQuiz(questions){
  const box=$('#quizBox'); box.innerHTML='';
  questions.forEach((q,i)=>{
    const wrap=document.createElement('div'); wrap.className='q';
    wrap.innerHTML=`<h4>${i+1}. ${q.q}</h4>`;
    q.opts.forEach((opt,j)=>{
      const line=document.createElement('label'); line.className='opt';
      line.innerHTML=`<input type="radio" name="q${i}" value="${j}"><span>${opt}</span>`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
  $('#quizProgress').textContent=`0 / ${questions.length}`;
  box.addEventListener('change', ()=>{
    const done = questions.filter((_,i)=> $('input[name="q'+i+'"]:checked',box)).length;
    $('#quizProgress').textContent = `${done} / ${questions.length}`;
  });
  $('#btnCheck').onclick=()=>{
    let correct=0;
    questions.forEach((q,i)=>{
      const picked=$('input[name="q'+i+'"]:checked',box);
      if(picked && parseInt(picked.value,10)===q.ans) correct++;
    });
    const ratio=Math.round(correct/questions.length*100);
    const res=$('#quizResult');
    res.style.display='block'; res.className='result '+(ratio>=80?'pass':'fail');
    res.textContent=`åˆ†æ•¸ï¼š${correct} / ${questions.length}ï¼ˆ${ratio}%ï¼‰`+(ratio>=80?'  ğŸ‘ å¤ªæ£’äº†ï¼':'  å†æ¥å†å²ï¼');
    $('#btnRetry').style.display='inline-block';
  };
  $('#btnRetry').onclick=()=>{
    $$('input[type="radio"]',box).forEach(r=> r.checked=false);
    $('#quizProgress').textContent=`0 / ${questions.length}`;
    $('#quizResult').style.display='none';
    $('#btnRetry').style.display='none';
  };
}

/* å½±ç‰‡äº‹ä»¶ */
function attachVideoEvents(){
  const v=$('#player');
  v.addEventListener('timeupdate', ()=>{
    const t=v.currentTime;

    // A-B å¾ªç’°
    if(abA!=null && abB!=null){
      if(t<abA || t>abB) v.currentTime=abA;
      return;
    }
    // å…¨ç‰‡å¾ªç’°
    if(loopAll && v.duration){
      if(t>=v.duration-0.05) v.currentTime=0;
    }

    // é«˜äº®ç•¶å‰å¥
    const idx = findCurrentIdx(t);
    if(idx!==currentIdx) highlight(idx);

    // é€å¥è‡ªå‹•æš«åœï¼šåˆ°ä¸‹ä¸€å¥é–‹é ­å°±æš«åœ
    if(autoPause){
      const next = cues[idx+1];
      if(next && t >= next.startSec-0.02 && t < next.startSec+0.2){
        v.pause();
      }
    }
  });

  v.addEventListener('play', ()=> $('#btnPlay').textContent='â¸ æš«åœ');
  v.addEventListener('pause',()=> $('#btnPlay').textContent='â–¶ï¸ æ’­æ”¾');
}

/* ------------------ å•Ÿå‹• ------------------ */
(async ()=>{
  try{
    setupUI();
    attachVideoEvents();
    const meta = await loadMeta();
    setupVideo(meta.video);

    await loadCues(meta.cues);
    renderTranscript();

    if(meta.quiz){
      const qs = await loadQuiz(meta.quiz);
      renderQuiz(qs);
    }else{
      $('#tabQuiz').style.display='none';
    }
  }catch(err){
    console.error(err);
    $('#panelTranscript').innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
  }
})();
</script>
</body>
</html>
