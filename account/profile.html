<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>我的資料 · BookWide</title>
  <style>
    :root{
      --bg:#0b1324; --panel:#0f172a; --ink:#eaf1ff; --muted:#a8b6d3;
      --line:#1f2a44; --btn:#1e90ff; --btn-ink:#fff;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1000px;margin:0 auto;padding:18px}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .back{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--line);border-radius:10px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin:12px 0}
    h2{margin:0 0 10px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row{display:flex;flex-direction:column;gap:6px}
    .row label{font-size:13px;color:var(--muted)}
    input[type="text"],input[type="url"]{
      background:#0b1324;border:1px solid var(--line);border-radius:10px;height:44px;padding:0 12px;color:var(--ink)
    }
    .actions{display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#132036;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--btn);border-color:#2a5bff;color:var(--btn-ink)}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#0f223b;border:1px solid #2c3e66;color:#dfe8ff;padding:10px 14px;border-radius:10px;display:none}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="topbar">
      <a class="back" href="../index.html">← 回首頁</a>
      <div class="muted">帳號 / 個人資料</div>
    </div>

    <section class="card">
      <h2>基本資料</h2>
      <div id="basicEmail" class="muted">電子郵件：<span id="emailText">載入中…</span></div>
    </section>

    <section class="card">
      <h2>編輯個人檔案（profiles）</h2>
      <div class="grid">
        <div class="row">
          <label for="display_name">暱稱</label>
          <input id="display_name" type="text" placeholder="您的暱稱（可留白）"/>
        </div>
        <div class="row">
          <label for="avatar_url">頭像網址</label>
          <input id="avatar_url" type="url" placeholder="https://example.com/me.png"/>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="actions">
        <button id="btnSave" class="btn primary">儲存</button>
        <a class="btn" href="../account/learning.html">查看學習曲線</a>
      </div>
      <div id="err" class="muted" style="margin-top:8px;min-height:1em"></div>
    </section>
  </main>

  <div id="toast" class="toast">已儲存</div>

  <script type="module">
    import { supabase } from '../supa.js'; // ← 依你的 repo，這個路徑是正確的

    const $ = (s, e=document)=>e.querySelector(s);
    const emailText   = $('#emailText');
    const iptName     = $('#display_name');
    const iptAvatar   = $('#avatar_url');
    const btnSave     = $('#btnSave');
    const toast       = $('#toast');
    const errBox      = $('#err');

    function showToast(msg){
      toast.textContent = msg || '已儲存';
      toast.style.display='block';
      setTimeout(()=>toast.style.display='none', 1600);
    }

    // 讀取 session + profiles
    async function loadProfile(){
      errBox.textContent='';
      try{
        const { data:sessionData, error:sErr } = await supabase.auth.getSession();
        if(sErr) throw sErr;

        const user = sessionData?.session?.user;
        if(!user){
          emailText.textContent = '未登入（將導向登入頁）';
          setTimeout(()=>location.href='../login-test.html', 900);
          return;
        }

        // 顯示 email
        emailText.textContent = user.email || '(無)';

        // 讀取 profiles
        const { data:prof, error:pErr } = await supabase
          .from('profiles')
          .select('email, display_name, avatar_url')
          .eq('id', user.id)
          .single();

        if(pErr){
          // 若還沒被 trigger 建立，也不當錯，只給空白欄位
          if(pErr.code !== 'PGRST116'){ // row not found
            throw pErr;
          }
        }

        iptName.value   = prof?.display_name || '';
        iptAvatar.value = prof?.avatar_url   || '';

      }catch(e){
        console.error(e);
        errBox.textContent = e?.message || '讀取失敗';
      }
    }

    // 儲存 profiles
    btnSave.addEventListener('click', async ()=>{
      errBox.textContent='';
      try{
        const { data:sessionData } = await supabase.auth.getSession();
        const user = sessionData?.session?.user;
        if(!user) throw new Error('請先登入');

        const payload = {
          id: user.id, // upsert 需要帶 id
          email: user.email, // 讓資料一致
          display_name: iptName.value?.trim() || null,
          avatar_url:   iptAvatar.value?.trim() || null,
        };

        const { error:uErr } = await supabase
          .from('profiles')
          .upsert(payload, { onConflict: 'id' });

        if(uErr) throw uErr;

        // 可選：把暱稱也同步到 Auth 的 metadata（之後登入快顯用得到）
        await supabase.auth.updateUser({ data: { display_name: payload.display_name, avatar_url: payload.avatar_url } });

        showToast('已儲存');
      }catch(e){
        console.error(e);
        errBox.textContent = e?.message || '儲存失敗';
      }
    });

    loadProfile();
  </script>
</body>
</html>



