<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>帳號／個人資料</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      margin: 0;
    }
    .container { max-width: 960px; margin: 40px auto; padding: 0 20px; }
    a.back {
      display: inline-block; margin-bottom: 16px;
      background: #1e293b; color: #f8fafc;
      text-decoration: none; padding: 8px 16px; border-radius: 8px;
    }
    .card {
      background: #111827; border-radius: 12px; padding: 20px;
      margin-bottom: 24px; border: 1px solid #1f2937;
    }
    .heading { font-size: 1.5rem; font-weight: bold; margin-bottom: 16px; }
    .row { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .avatar {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      border: 2px solid #374151; background: #000;
    }
    .btn {
      background: #1d4ed8; border: none; color: white;
      padding: 10px 18px; border-radius: 8px; cursor: pointer;
    }
    .btn:hover { background: #2563eb; }
    .btn.secondary { background: #374151; }
    .btn.secondary:hover { background: #475569; }
    input[type="text"], input[type="file"] {
      width: 100%; padding: 10px; border-radius: 6px;
      border: 1px solid #334155; background: #0f172a; color: #f9fafb;
    }
    label { color: #9ca3af; display: block; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="back">← 回首頁</a>

    <div class="card" id="viewCard">
      <div class="heading">基本資料</div>
      <div class="row">
        <img id="viewAvatar" class="avatar" src="../img/avatar-default.svg" alt="頭像">
        <div>
          <p>暱稱：<span id="viewName">—</span></p>
          <p>電子郵件：<span id="viewEmail">載入中…</span></p>
        </div>
        <div style="flex:1"></div>
        <button id="btnEdit" class="btn secondary">編輯資料</button>
      </div>
    </div>

    <div class="card hidden" id="editCard">
      <div class="heading">編輯個人檔案（profiles）</div>
      <label for="displayName">暱稱</label>
      <input id="displayName" type="text" placeholder="您的暱稱（可留白）">

      <label for="avatarFile">大頭貼（上傳圖片）</label>
      <input id="avatarFile" type="file" accept="image/*">
      <p style="font-size: 0.9rem; color:#9ca3af;">支援 jpg / png / webp，建議 &lt; 2MB。</p>

      <div style="margin-top: 12px; text-align:right;">
        <button id="btnCancel" class="btn secondary">取消</button>
        <button id="btnSave" class="btn">完成並儲存</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../supa.js';
    const $ = (s, e=document) => e.querySelector(s);
    const viewCard = $('#viewCard');
    const editCard = $('#editCard');
    const viewAvatar = $('#viewAvatar');
    const viewName = $('#viewName');
    const viewEmail = $('#viewEmail');
    const displayNameInput = $('#displayName');
    const avatarFileInput = $('#avatarFile');
    const btnEdit = $('#btnEdit');
    const btnCancel = $('#btnCancel');
    const btnSave = $('#btnSave');

    let currentUser = null;
    let currentProfile = null;

    init();

    async function init() {
      const { data: authData, error: authErr } = await supabase.auth.getUser();
      if (authErr || !authData?.user) {
        alert('請先登入');
        location.href = '../login-test.html';
        return;
      }
      currentUser = authData.user;
      viewEmail.textContent = currentUser.email || '(無)';
      await loadProfile();

      btnEdit.onclick = () => {
        displayNameInput.value = currentProfile?.display_name ?? '';
        avatarFileInput.value = '';
        viewCard.classList.add('hidden');
        editCard.classList.remove('hidden');
      };
      btnCancel.onclick = () => {
        editCard.classList.add('hidden');
        viewCard.classList.remove('hidden');
      };
      btnSave.onclick = onSaveClicked;
    }

    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, email, display_name, avatar_url')
        .eq('id', currentUser.id)
        .maybeSingle();
      if (error) console.warn(error);
      currentProfile = data;
      viewName.textContent = currentProfile?.display_name || '—';
      viewAvatar.src = currentProfile?.avatar_url || '../img/avatar-default.svg';
    }

    async function onSaveClicked() {
      btnSave.disabled = true;
      btnSave.textContent = '儲存中…';
      try {
        let avatarUrl = currentProfile?.avatar_url || null;
        const file = avatarFileInput.files?.[0];
        if (file) {
          const path = `${currentUser.id}/${Date.now()}_${file.name}`;
          const { error: upErr } = await supabase
            .storage.from('avatars')
            .upload(path, file, { upsert:true });
          if (upErr) throw upErr;
          const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(path);
          avatarUrl = urlData.publicUrl;
        }

        const { error: upsertErr } = await supabase
          .from('profiles')
          .upsert({
            id: currentUser.id,
            email: currentUser.email,
            display_name: displayNameInput.value?.trim() || null,
            avatar_url: avatarUrl
          });
        if (upsertErr) throw upsertErr;

        alert('已儲存');
        await loadProfile();
        editCard.classList.add('hidden');
        viewCard.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        alert('儲存失敗');
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = '完成並儲存';
      }
    }
  </script>
</body>
</html>





