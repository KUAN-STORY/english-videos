<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æˆ‘çš„è³‡æ–™ï½œBookWide</title>

  <!-- å…¨ç«™å¸³è™Ÿæ¨£å¼ -->
  <link rel="stylesheet" href="./account.css" />

  <!-- å¾Œå‚™æ¨£å¼ï¼ˆè‹¥æ‰¾ä¸åˆ° account.css ä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤ºï¼‰ -->
  <style>
    :root{--ink:#e6f0ff;--muted:#98a7bd;--bg:#0b1324;--panel:#0f172a;--border:#1f2a44;--accent:#3c7cff;}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
    a{color:#aaccff;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(var(--bg),rgba(11,19,36,.6));backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
    header .inner{display:flex;align-items:center;gap:10px;padding:14px 10px}
    header .back{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0c1730}
    h1{font-size:22px;margin:0 0 16px}
    h2{font-size:18px;margin:24px 0 10px}
    .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:10px 0}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 14px;border:1px solid #244464;border-radius:10px;background:#16233d;color:#e6f0ff;cursor:pointer}
    .btn_blue{background:#14325f;border-color:#2a568d}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3955;background:#0d1a33;color:var(--ink)}
    .list{display:grid;gap:10px}
    .rowlink{display:block;padding:12px;border:1px solid var(--border);border-radius:10px;background:#0e1c35}
    .rowlink .title{font-weight:700}
    .rowlink .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .card{background:#0e1b34;border:1px solid var(--border);border-radius:12px;padding:12px}
    .grid{display:grid;gap:12px;max-width:520px}
    .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:1px solid #234}
  </style>
</head>
<body>
  <header>
    <div class="wrap inner">
      <a class="back" href="../index.html">â† å›é¦–é </a>
      <h1 style="margin:0">æˆ‘çš„è³‡æ–™</h1>
    </div>
  </header>

  <main class="wrap">
    <section class="section">
      <h2>åŸºæœ¬è³‡æ–™</h2>
      <div id="basic-info"><p class="muted">è¼‰å…¥ä¸­â€¦</p></div>
    </section>

    <section class="section">
      <h2>æœ€è¿‘äº¤å·</h2>
      <div id="attempts-list"><p class="muted">è¼‰å…¥ä¸­â€¦</p></div>
    </section>

    <section class="section">
      <h2>æœ€è¿‘çœ‹ç‰‡</h2>
      <div id="watches-list"><p class="muted">è¼‰å…¥ä¸­â€¦</p></div>
    </section>
  </main>

  <!-- å…¨ç«™ Supabase åˆå§‹åŒ–ï¼ˆæä¾› window.supaï¼‰ -->
  <script src="./_shared.js"></script>

  <script>
  (async () => {
    const supa = window.supa;
    const $ = (sel) => document.querySelector(sel);
    const basicBox    = $('#basic-info');
    const attemptsBox = $('#attempts-list');
    const watchesBox  = $('#watches-list');

    if (!supa) { basicBox.innerHTML = '<p>åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>'; return; }

    const { data: { user }, error: uErr } = await supa.auth.getUser();
    if (uErr) console.error(uErr);
    if (!user) { basicBox.innerHTML = '<p>å°šæœªç™»å…¥ï¼Œè«‹å…ˆå›é¦–é ç™»å…¥ã€‚</p>'; return; }

    const fmt = (ts) => ts ? new Date(ts).toLocaleString() : '';
    const esc = (s) => (s||'').replace(/[&<>\"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[m]));

    async function ensureProfile(uid) {
      let { data: row, error } = await supa.from('profiles').select('*').eq('user_id', uid).maybeSingle();
      if (error && error.code !== 'PGRST116') throw error;
      if (!row) {
        const { data, error: insErr } = await supa.from('profiles')
          .insert({ user_id: uid, display_name: null, photo_url: null })
          .select('*').single();
        if (insErr) throw insErr;
        row = data;
      }
      return row;
    }

    async function renderBasic() {
      basicBox.innerHTML = '<p class="muted">è¼‰å…¥ä¸­â€¦</p>';
      let profile;
      try { profile = await ensureProfile(user.id); }
      catch(e){ console.error(e); basicBox.innerHTML = '<p>è¼‰å…¥å¤±æ•—ã€‚</p>'; return; }

      basicBox.innerHTML = `
        <div class="card">
          <div style="display:flex;gap:16px;align-items:center;">
            <img id="avatarPreview" class="avatar" src="\${esc(profile.photo_url)||'https://placehold.co/64x64?text=ğŸ‘¤'}" alt="avatar">
            <div>
              <div style="font-size:12px;color:#9aa4;">Email</div>
              <div>\${esc(user.email||'')}</div>
            </div>
          </div>

          <div class="grid" style="margin-top:16px;">
            <label style="display:grid;gap:6px;">
              <span class="muted">æš±ç¨±ï¼ˆé¡¯ç¤ºåç¨±ï¼‰</span>
              <input id="displayName" type="text" placeholder="æœªè¨­å®š" value="\${esc(profile.display_name||'')}" />
            </label>

            <label style="display:grid;gap:6px;">
              <span class="muted">é ­åƒåœ–ç‰‡ç¶²å€ï¼ˆå¯ç©ºï¼‰</span>
              <input id="photoUrl" type="url" placeholder="https://â€¦" value="\${esc(profile.photo_url||'')}" />
            </label>

            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnSaveProfile" class="btn">å„²å­˜è®Šæ›´</button>
              <button id="btnResetPwd"   class="btn btn_blue">å¯„é€é‡è¨­å¯†ç¢¼ä¿¡</button>
              <button id="btnExportJson" class="btn">ä¸‹è¼‰æˆ‘çš„è³‡æ–™ï¼ˆJSONï¼‰</button>
            </div>
          </div>
        </div>`;

      const photoInput = $('#photoUrl');
      const avatarPrev = $('#avatarPreview');
      photoInput?.addEventListener('input', () => {
        avatarPrev.src = photoInput.value.trim() || 'https://placehold.co/64x64?text=ğŸ‘¤';
      });

      $('#btnSaveProfile')?.addEventListener('click', async () => {
        const display_name = $('#displayName').value.trim() || null;
        const photo_url    = $('#photoUrl').value.trim() || null;
        const { error } = await supa.from('profiles').update({ display_name, photo_url }).eq('user_id', user.id);
        if (error) return alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
        alert('å·²å„²å­˜ï¼');
      });

      $('#btnResetPwd')?.addEventListener('click', async () => {
        const { error } = await supa.auth.resetPasswordForEmail(user.email, {
          redirectTo: location.origin + '/english-videos/account/profile.html'
        });
        if (error) return alert('å¯„é€å¤±æ•—ï¼š' + error.message);
        alert('å·²å¯„å‡ºé‡è¨­å¯†ç¢¼ä¿¡ï¼Œè«‹åˆ°ä¿¡ç®±æ”¶ä¿¡ã€‚');
      });

      $('#btnExportJson')?.addEventListener('click', async () => {
        try {
          const [attempts, watches] = await Promise.all([getAttempts(), getWatches()]);
          const payload = { user: { id: user.id, email: user.email }, profile, attempts, watches };
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
          const url  = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'my-bookwide-data.json'; a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error(e); alert('ä¸‹è¼‰å¤±æ•—');
        }
      });
    }

    async function getAttempts() {
      const { data, error } = await supa.from('quiz_attempts')
        .select('video_slug,score,total,submitted_at')
        .order('submitted_at', { ascending:false }).limit(10);
      if (error) throw error;
      return data || [];
    }

    async function getWatches() {
      const { data, error } = await supa.from('watch_logs')
        .select('video_slug,last_seen_at,position_ms')
        .order('last_seen_at', { ascending:false }).limit(10);
      if (error) throw error;
      return data || [];
    }

    async function renderAttempts() {
      attemptsBox.innerHTML = '<p class="muted">è¼‰å…¥ä¸­â€¦</p>';
      let rows=[]; try { rows = await getAttempts(); } catch(e){ console.error(e); attemptsBox.innerHTML='<p>è®€å–å¤±æ•—</p>'; return; }
      if (!rows.length){ attemptsBox.innerHTML='<p class="muted">å°šç„¡äº¤å·ç´€éŒ„</p>'; return; }
      attemptsBox.innerHTML = '<div class="list">' + rows.map(r => {
        const score = `\${r.score} / \${r.total}`;
        const url   = '../player.html?slug=' + encodeURIComponent(r.video_slug||'');
        return `<a class="rowlink" href="\${url}"><div class="title">\${esc(r.video_slug)}</div><div class="meta">åˆ†æ•¸ï¼š\${score}ã€€æ™‚é–“ï¼š\${fmt(r.submitted_at)}</div></a>`;
      }).join('') + '</div>';
    }

    async function renderWatches() {
      watchesBox.innerHTML = '<p class="muted">è¼‰å…¥ä¸­â€¦</p>';
      let rows=[]; try { rows = await getWatches(); } catch(e){ console.error(e); watchesBox.innerHTML='<p>è®€å–å¤±æ•—</p>'; return; }
      if (!rows.length){ watchesBox.innerHTML='<p class="muted">å°šç„¡è§€çœ‹ç´€éŒ„</p>'; return; }
      watchesBox.innerHTML = '<div class="list">' + rows.map(r => {
        const sec  = Math.floor((r.position_ms||0)/1000);
        const url  = '../player.html?slug=' + encodeURIComponent(r.video_slug||'');
        return `<a class="rowlink" href="\${url}"><div class="title">\${esc(r.video_slug)}</div><div class="meta">ä¸Šæ¬¡çœ‹åˆ°ï¼š\${fmt(r.last_seen_at)}ã€€ï¼ˆç´„ \${sec}sï¼‰</div></a>`;
      }).join('') + '</div>';
    }

    try {
      await renderBasic();
      await renderAttempts();
      await renderWatches();
    } catch (e) {
      console.error(e);
    }
  })();
  </script>
</body>
</html>
