<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>帳號 / 個人資料</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #2563eb;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --ok: #10b981;
      --border: #1f2937;
      --chip: #0b1220;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    a,button,input,select,textarea { font: inherit }
    .container { max-width: 1100px; margin: 0 auto; padding: 28px 20px 80px }
    .crumb { display: inline-flex; gap: 8px; align-items: center; color: var(--muted) }
    .crumb a { color: var(--muted); text-decoration: none }
    .crumb a:hover { color: var(--text) }
    .back { padding: 8px 12px; background: var(--chip); border: 1px solid var(--border); border-radius: 10px; color: var(--text); text-decoration: none }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 22px 22px }
    .space { height: 18px }
    .hstack { display: flex; align-items: center; gap: 16px }
    .avatar { width: 96px; height: 96px; border-radius: 999px; object-fit: cover; border: 2px solid var(--border); background: #0b1220 }
    h2 { margin: 0 0 18px; font-size: 22px; letter-spacing: .02em }
    .row { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 16px }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr } }
    label { display: block; font-size: 14px; color: var(--muted); margin: 6px 2px }
    input[type=text],input[type=email],input[type=url]{
      width: 100%; padding: 12px 14px; color: var(--text);
      background: #0b1220; border: 1px solid var(--border); border-radius: 12px;
      outline: none;
    }
    input:focus { border-color: var(--accent-2) }
    .chip { display: inline-flex; align-items: center; background: var(--chip); border: 1px solid var(--border); border-radius: 999px; padding: 6px 12px; gap: 8px }
    .muted { color: var(--muted) }
    .btn {
      appearance: none; border: 1px solid var(--border); background: #0b1220; color: var(--text);
      border-radius: 12px; padding: 10px 14px; cursor: pointer;
    }
    .btn:hover { filter: brightness(1.05) }
    .btn-accent { background: linear-gradient(135deg,var(--accent),var(--accent-2)); border-color: transparent }
    .btn-ghost { background: transparent }
    .btn[disabled] { opacity: .5; cursor: not-allowed }
    .end { display: flex; justify-content: flex-end; gap: 12px }
    .msg-ok { color: var(--ok) }
    .msg-err { color: var(--danger) }
    .tag { display:inline-block; font-size:12px; color:#93c5fd; background:#0b1220; border:1px solid var(--border); padding:2px 8px; border-radius:999px }
  </style>
</head>
<body>
  <div class="container">
    <div class="hstack" style="justify-content: space-between; margin-bottom: 14px;">
      <a href="javascript:history.back()" class="back">← 回首頁</a>
      <div class="crumb">
        <a href="../index.html">帳號</a> / <span>個人資料</span>
      </div>
    </div>

    <!-- 卡片一：顯示區 -->
    <div class="card">
      <div class="hstack" style="justify-content: space-between;">
        <h2>基本資料</h2>
        <button id="btnEdit" class="btn">編輯資料</button>
      </div>

      <div class="hstack" style="gap: 18px;">
        <img id="avatarImg" class="avatar" src="./avatar-default.svg" alt="頭像" />
        <div style="display:grid; gap:8px;">
          <div class="hstack" style="gap:10px;">
            <span class="muted">暱稱：</span>
            <span id="displayNameText" class="chip">—</span>
          </div>
          <div class="hstack" style="gap:10px;">
            <span class="muted">電子郵件：</span>
            <span id="emailText" class="chip"></span>
          </div>

          <!-- 顯示新欄位（電話 / LINE / WeChat / 地址） -->
          <div class="hstack" style="gap:10px; flex-wrap: wrap;">
            <span class="muted">聯絡電話：</span><span id="viewPhone" class="tag">—</span>
            <span class="muted" style="margin-left:8px;">LINE：</span><span id="viewLine" class="tag">—</span>
            <span class="muted" style="margin-left:8px;">WeChat：</span><span id="viewWechat" class="tag">—</span>
          </div>
          <div class="hstack" style="gap:10px; flex-wrap: wrap;">
            <span class="muted">地址：</span><span id="viewAddress" class="tag" style="max-width:600px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="space"></div>

    <!-- 卡片二：編輯區 -->
    <div class="card">
      <h2>編輯個人檔案（profiles）</h2>

      <div class="row">
        <div>
          <label for="display_name">暱稱</label>
          <input id="display_name" type="text" placeholder="您的暱稱（可留白）">
        </div>
        <div>
          <label>大頭貼（上傳圖片）</label>
          <div class="hstack">
            <input id="fileAvatar" type="file" accept="image/png,image/jpeg,image/webp" />
            <span id="uploadHint" class="muted">支援 jpg / png / webp，建議 &lt; 2MB。</span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <div>
          <label for="phone">聯絡電話</label>
          <input id="phone" type="text" placeholder="例：0912-345-678">
        </div>
        <div>
          <label for="line_id">LINE ID</label>
          <input id="line_id" type="text" placeholder="您的 LINE ID">
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <div>
          <label for="wechat_id">WeChat ID</label>
          <input id="wechat_id" type="text" placeholder="您的 WeChat ID">
        </div>
        <div>
          <label for="address">通訊地址</label>
          <input id="address" type="text" placeholder="您的地址">
        </div>
      </div>

      <div class="end" style="margin-top:18px;">
        <button id="btnCancel" class="btn btn-ghost">取消</button>
        <button id="btnSave" class="btn btn-accent">完成並儲存</button>
      </div>
      <div id="formMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- ====== JS ====== -->
  <script type="module">
    /* 調整成你的實際路徑：如果 profile.html 在 english-videos/account/，
       而 supa.js 在專案根目錄，這裡要用 '../../supa.js' */
    import { supabase } from '../supa.js';

    // ===== 快速選取工具 =====
    const $ = (s, el = document) => el.querySelector(s);

    // 顯示區元素
    const avatarImg   = $('#avatarImg');
    const displayText = $('#displayNameText');
    const emailText   = $('#emailText');
    const viewPhone   = $('#viewPhone');
    const viewLine    = $('#viewLine');
    const viewWechat  = $('#viewWechat');
    const viewAddress = $('#viewAddress');

    // 編輯區元素
    const nameIpt   = $('#display_name');
    const fileIpt   = $('#fileAvatar');
    const phoneIpt  = $('#phone');
    const lineIpt   = $('#line_id');
    const wechatIpt = $('#wechat_id');
    const addrIpt   = $('#address');
    const btnEdit   = $('#btnEdit');
    const btnSave   = $('#btnSave');
    const btnCancel = $('#btnCancel');
    const formMsg   = $('#formMsg');

    // ===== 輔助 =====
    function msg(text, type = 'muted') {
      formMsg.className = type === 'ok' ? 'msg-ok' : type === 'err' ? 'msg-err' : 'muted';
      formMsg.textContent = text;
    }

    // 統一把顯示 chip（—）處理乾淨
    const chip = v => v?.toString().trim() || '—';

    // 防呆：拿掉舊版「學習曲線」按鈕
    (function removeOldProgressButton() {
      const candidates = [
        'button#viewProgress',
        'button#btnProgress',
        'a[href*="progress"]',
        '[data-test="view-progress"]',
      ];
      for (const sel of candidates) {
        const n = document.querySelector(sel);
        if (n) n.remove();
      }
    })();

    // ===== 讀取 Profile =====
    async function loadProfile() {
      msg('載入中…');

      const { data: { user }, error: uerr } = await supabase.auth.getUser();
      if (uerr || !user) {
        msg('尚未登入，請先登入。', 'err');
        return;
      }

      // 顯示 email
      emailText.textContent = user.email || '—';

      // 讀取 profiles
      const { data, error } = await supabase
        .from('profiles')
        .select('id, display_name, avatar_url, phone, line_id, wechat_id, address')
        .eq('id', user.id)
        .maybeSingle();

      if (error) {
        msg('讀取失敗：' + (error.message || error), 'err');
        return;
      }

      const prof = data || {};

      // 顯示區
      displayText.textContent = chip(prof.display_name);
      avatarImg.src = prof.avatar_url || './avatar-default.svg';
      viewPhone.textContent   = chip(prof.phone);
      viewLine.textContent    = chip(prof.line_id);
      viewWechat.textContent  = chip(prof.wechat_id);
      viewAddress.textContent = chip(prof.address);

      // 編輯區
      nameIpt.value   = prof.display_name || '';
      phoneIpt.value  = prof.phone || '';
      lineIpt.value   = prof.line_id || '';
      wechatIpt.value = prof.wechat_id || '';
      addrIpt.value   = prof.address || '';

      msg('載入完成。', 'ok');
    }

    // ===== 上傳大頭貼到 Storage：avatars bucket =====
    async function uploadAvatar(file, userId) {
      if (!file) return { url: null };

      // 產生檔名：uid/ts-原檔名
      const ext = file.name.split('.').pop()?.toLowerCase() || 'jpg';
      const filePath = `${userId}/${Date.now()}.${ext}`;

      // 上傳
      const { error: upErr } = await supabase
        .storage
        .from('avatars')
        .upload(filePath, file, { upsert: true });

      if (upErr) throw upErr;

      // 取得公開網址（你已設 public read）
      const { data: pub } = supabase
        .storage
        .from('avatars')
        .getPublicUrl(filePath);

      return { url: pub?.publicUrl || null };
    }

    // ===== 事件：儲存 =====
    btnSave.addEventListener('click', async () => {
      try {
        btnSave.disabled = true;
        msg('儲存中…');

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          msg('尚未登入，請先登入。', 'err');
          return;
        }

        // 先處理頭像上傳（若有選檔）
        let avatar_url = null;
        const file = fileIpt.files?.[0];
        if (file) {
          const { url } = await uploadAvatar(file, user.id);
          avatar_url = url;
        }

        // upsert profiles（RLS：auth.uid() = id）
        const payload = {
          id: user.id,
          display_name: nameIpt.value || null,
          phone:       phoneIpt.value || null,
          line_id:     lineIpt.value || null,
          wechat_id:   wechatIpt.value || null,
          address:     addrIpt.value || null,
        };
        if (avatar_url) payload.avatar_url = avatar_url;

        const { error } = await supabase
          .from('profiles')
          .upsert(payload, { onConflict: 'id' });

        if (error) throw error;

        msg('已儲存。', 'ok');

        // 重新載入一次顯示最新資料
        await loadProfile();

        // 清空檔案 input 以免重複
        if (fileIpt.value) fileIpt.value = '';
      } catch (e) {
        msg('儲存失敗：' + (e?.message || e), 'err');
      } finally {
        btnSave.disabled = false;
      }
    });

    btnEdit.addEventListener('click', () => {
      window.scrollTo({ top: document.body.scrollHeight / 2, behavior: 'smooth' });
      nameIpt.focus();
    });

    btnCancel.addEventListener('click', () => {
      // 還原編輯區內容
      loadProfile();
      msg('已取消變更。');
    });

    // 啟動
    loadProfile();
  </script>
</body>
</html>







