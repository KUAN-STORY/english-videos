<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>推廣分潤｜BookWide</title>
  <link rel="icon" href="../img/favicon.png" />
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#666;
      --accent:#1e66ff;
      --accent-2:#0f52ff;
      --border:#e9eaee;
      --card:#fafafa;
      --ok:#0a7c2f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:960px;margin:48px auto;padding:0 20px}
    h1{font-size:28px;margin:0 0 18px}
    .sub{color:var(--muted);margin-bottom:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
    .row{display:flex;gap:16px;align-items:center}
    .row + .row{margin-top:16px}
    .label{min-width:7em;color:#333}
    .input{
      flex:1;display:flex;align-items:center;background:#fff;border:1px solid var(--border);
      border-radius:10px;padding:12px 14px;min-height:48px;overflow:auto
    }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace}
    .btn{
      background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:600;
      cursor:pointer;transition:filter .15s ease,transform .02s ease;min-width:120px;text-align:center
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{filter:brightness(1.02)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-block;background:#eef3ff;color:#2d5bff;border:1px solid #dbe6ff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .hint{font-size:14px;color:var(--muted)}
    .faq{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:28px}
    .toast{
      position:fixed;left:50%;bottom:28px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--muted);margin-bottom:16px}
    @media (max-width:920px){.faq{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="../index.html">← 回首頁</a>
    <h1>推廣分潤 <span id="loadingPill" class="pill">載入中…</span></h1>
    <p class="sub">將你的專屬連結分享給朋友，只要他們透過連結加入並訂閱，你就能獲得推薦獎勵 🎉</p>

    <div class="card">
      <div class="row">
        <div class="label">我的推廣連結</div>
        <div id="refLinkBox" class="input mono" contenteditable="false">產生中…</div>
        <button id="btnCopyLink" class="btn" disabled>複製連結</button>
      </div>

      <div class="row">
        <div class="label">推薦碼</div>
        <div id="refCodeBox" class="input mono" style="max-width:320px">—</div>
        <button id="btnCopyCode" class="btn" disabled>複製推薦碼</button>
      </div>

      <p class="hint" style="margin-top:10px">
        推廣入口固定為：<span class="mono">https://bookwide.github.io/EduEnglish/index.html</span>，系統會自動在網址後面加上你的
        <span class="mono">?ref=推薦碼</span>。
      </p>
    </div>

    <div class="faq">
      <div class="card">
        <h3>如何推薦朋友？</h3>
        <ol>
          <li>按「複製連結」或「複製推薦碼」。</li>
          <li>把連結/推薦碼分享給朋友（公開貼文或私訊皆可）。</li>
          <li>朋友點連結或在結帳時帶著推薦碼完成訂閱，即算推薦成功。</li>
        </ol>
      </div>

      <div class="card">
        <h3>使用小提醒</h3>
        <ul>
          <li>朋友從你的連結進站後，系統會記住推薦碼（網址上的 <span class="mono">?ref=</span>）。</li>
          <li>若有任何問題，歡迎來信 <a href="mailto:support@bookwide.com">support@bookwide.com</a>。</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">已複製</div>

  <script type="module">
    // 依你的專案實際路徑：account/ → 到根目錄 supa.js 只要上一層
    import { supabase } from '../supa.js';

    // 固定推廣入口（你指定的）
    const REF_BASE = 'https://bookwide.github.io/EduEnglish/index.html';

    const $ = s => document.querySelector(s);
    const toast = (msg='已複製') => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 1400);
    };

    // 未登入 → 導回登入頁，next 回到本頁
    async function requireLogin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const next = encodeURIComponent(location.pathname);
        location.href = `../login.html?next=${next}`;
        return null;
      }
      return session.user;
    }

    // 取得或建立推薦碼
    async function getOrCreateReferral(userId) {
      // 讀取 profiles
      const { data: prof, error } = await supabase
        .from('profiles')
        .select('id, referral_code')
        .eq('id', userId)
        .single();

      if (error) {
        console.error(error);
        throw error;
      }

      // 若已有推薦碼，直接回傳
      if (prof && prof.referral_code) {
        return prof.referral_code;
      }

      // 產生穩定碼（以 userId 的雜湊/截取，這裡用簡易版：取前後各5碼）
      const safe = (userId || 'u').replace(/[^a-zA-Z0-9]/g,'');
      const code = (safe.slice(0,5) + safe.slice(-5)).toLowerCase() || cryptoRandom(10);

      const { error: upErr } = await supabase
        .from('profiles')
        .update({ referral_code: code })
        .eq('id', userId);

      if (upErr) {
        console.error(upErr);
        throw upErr;
      }
      return code;
    }

    function cryptoRandom(n=10){
      const arr = new Uint8Array(n);
      crypto.getRandomValues(arr);
      return Array.from(arr, v => ('0'+(v%36).toString(36)).slice(-1)).join('');
    }

    // 初始化
    (async () => {
      const user = await requireLogin();
      if (!user) return;

      try {
        const code = await getOrCreateReferral(user.id);
        const link = `${REF_BASE}?ref=${encodeURIComponent(code)}`;

        $('#refCodeBox').textContent = code;
        $('#refLinkBox').textContent = link;

        $('#btnCopyLink').disabled = false;
        $('#btnCopyCode').disabled = false;
        $('#loadingPill').style.display = 'none';

        $('#btnCopyLink').addEventListener('click', async () => {
          await navigator.clipboard.writeText(link);
          toast('已複製連結到剪貼簿');
        });

        $('#btnCopyCode').addEventListener('click', async () => {
          await navigator.clipboard.writeText(code);
          toast('已複製推薦碼到剪貼簿');
        });
      } catch (e) {
        console.error(e);
        toast('載入失敗，請稍後再試');
      }
    })();
  </script>
</body>
</html>










