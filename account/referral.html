<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¨å»£åˆ†æ½¤ï½œBookWide</title>
  <link rel="icon" href="../img/favicon.png" />
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#666;
      --accent:#1e66ff;
      --accent-2:#0f52ff;
      --border:#e9eaee;
      --card:#fafafa;
      --ok:#0a7c2f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:960px;margin:48px auto;padding:0 20px}
    h1{font-size:28px;margin:0 0 18px}
    .sub{color:var(--muted);margin-bottom:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
    .row{display:flex;gap:16px;align-items:center}
    .row + .row{margin-top:16px}
    .label{min-width:7em;color:#333}
    .input{
      flex:1;display:flex;align-items:center;background:#fff;border:1px solid var(--border);
      border-radius:10px;padding:12px 14px;min-height:48px;overflow:auto
    }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace}
    .btn{
      background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:600;
      cursor:pointer;transition:filter .15s ease,transform .02s ease;min-width:120px;text-align:center
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{filter:brightness(1.02)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-block;background:#eef3ff;color:#2d5bff;border:1px solid #dbe6ff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .hint{font-size:14px;color:var(--muted)}
    .faq{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:28px}
    .toast{
      position:fixed;left:50%;bottom:28px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--muted);margin-bottom:16px}
    @media (max-width:920px){.faq{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="../index.html">â† å›é¦–é </a>
    <h1>æ¨å»£åˆ†æ½¤ <span id="loadingPill" class="pill">è¼‰å…¥ä¸­â€¦</span></h1>
    <p class="sub">å°‡ä½ çš„å°ˆå±¬é€£çµåˆ†äº«çµ¦æœ‹å‹ï¼Œåªè¦ä»–å€‘é€éé€£çµåŠ å…¥ä¸¦è¨‚é–±ï¼Œä½ å°±èƒ½ç²å¾—æ¨è–¦çå‹µ ğŸ‰</p>

    <div class="card">
      <div class="row">
        <div class="label">æˆ‘çš„æ¨å»£é€£çµ</div>
        <div id="refLinkBox" class="input mono" contenteditable="false">ç”¢ç”Ÿä¸­â€¦</div>
        <button id="btnCopyLink" class="btn" disabled>è¤‡è£½é€£çµ</button>
      </div>

      <div class="row">
        <div class="label">æ¨è–¦ç¢¼</div>
        <div id="refCodeBox" class="input mono" style="max-width:320px">â€”</div>
        <button id="btnCopyCode" class="btn" disabled>è¤‡è£½æ¨è–¦ç¢¼</button>
      </div>

      <p class="hint" style="margin-top:10px">
        æ¨å»£å…¥å£å›ºå®šç‚ºï¼š<span class="mono">https://bookwide.github.io/EduEnglish/index.html</span>ï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨ç¶²å€å¾Œé¢åŠ ä¸Šä½ çš„
        <span class="mono">?ref=æ¨è–¦ç¢¼</span>ã€‚
      </p>
    </div>

    <div class="faq">
      <div class="card">
        <h3>å¦‚ä½•æ¨è–¦æœ‹å‹ï¼Ÿ</h3>
        <ol>
          <li>æŒ‰ã€Œè¤‡è£½é€£çµã€æˆ–ã€Œè¤‡è£½æ¨è–¦ç¢¼ã€ã€‚</li>
          <li>æŠŠé€£çµ/æ¨è–¦ç¢¼åˆ†äº«çµ¦æœ‹å‹ï¼ˆå…¬é–‹è²¼æ–‡æˆ–ç§è¨Šçš†å¯ï¼‰ã€‚</li>
          <li>æœ‹å‹é»é€£çµæˆ–åœ¨çµå¸³æ™‚å¸¶è‘—æ¨è–¦ç¢¼å®Œæˆè¨‚é–±ï¼Œå³ç®—æ¨è–¦æˆåŠŸã€‚</li>
        </ol>
      </div>

      <div class="card">
        <h3>ä½¿ç”¨å°æé†’</h3>
        <ul>
          <li>æœ‹å‹å¾ä½ çš„é€£çµé€²ç«™å¾Œï¼Œç³»çµ±æœƒè¨˜ä½æ¨è–¦ç¢¼ï¼ˆç¶²å€ä¸Šçš„ <span class="mono">?ref=</span>ï¼‰ã€‚</li>
          <li>è‹¥æœ‰ä»»ä½•å•é¡Œï¼Œæ­¡è¿ä¾†ä¿¡ <a href="mailto:support@bookwide.com">support@bookwide.com</a>ã€‚</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">å·²è¤‡è£½</div>

  <script type="module">
    // ä¾ä½ çš„å°ˆæ¡ˆå¯¦éš›è·¯å¾‘ï¼šaccount/ â†’ åˆ°æ ¹ç›®éŒ„ supa.js åªè¦ä¸Šä¸€å±¤
    import { supabase } from '../supa.js';

    // å›ºå®šæ¨å»£å…¥å£ï¼ˆä½ æŒ‡å®šçš„ï¼‰
    const REF_BASE = 'https://bookwide.github.io/EduEnglish/index.html';

    const $ = s => document.querySelector(s);
    const toast = (msg='å·²è¤‡è£½') => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 1400);
    };

    // æœªç™»å…¥ â†’ å°å›ç™»å…¥é ï¼Œnext å›åˆ°æœ¬é 
    async function requireLogin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const next = encodeURIComponent(location.pathname);
        location.href = `../login.html?next=${next}`;
        return null;
      }
      return session.user;
    }

    // å–å¾—æˆ–å»ºç«‹æ¨è–¦ç¢¼
    async function getOrCreateReferral(userId) {
      // è®€å– profiles
      const { data: prof, error } = await supabase
        .from('profiles')
        .select('id, referral_code')
        .eq('id', userId)
        .single();

      if (error) {
        console.error(error);
        throw error;
      }

      // è‹¥å·²æœ‰æ¨è–¦ç¢¼ï¼Œç›´æ¥å›å‚³
      if (prof && prof.referral_code) {
        return prof.referral_code;
      }

      // ç”¢ç”Ÿç©©å®šç¢¼ï¼ˆä»¥ userId çš„é›œæ¹Š/æˆªå–ï¼Œé€™è£¡ç”¨ç°¡æ˜“ç‰ˆï¼šå–å‰å¾Œå„5ç¢¼ï¼‰
      const safe = (userId || 'u').replace(/[^a-zA-Z0-9]/g,'');
      const code = (safe.slice(0,5) + safe.slice(-5)).toLowerCase() || cryptoRandom(10);

      const { error: upErr } = await supabase
        .from('profiles')
        .update({ referral_code: code })
        .eq('id', userId);

      if (upErr) {
        console.error(upErr);
        throw upErr;
      }
      return code;
    }

    function cryptoRandom(n=10){
      const arr = new Uint8Array(n);
      crypto.getRandomValues(arr);
      return Array.from(arr, v => ('0'+(v%36).toString(36)).slice(-1)).join('');
    }

    // åˆå§‹åŒ–
    (async () => {
      const user = await requireLogin();
      if (!user) return;

      try {
        const code = await getOrCreateReferral(user.id);
        const link = `${REF_BASE}?ref=${encodeURIComponent(code)}`;

        $('#refCodeBox').textContent = code;
        $('#refLinkBox').textContent = link;

        $('#btnCopyLink').disabled = false;
        $('#btnCopyCode').disabled = false;
        $('#loadingPill').style.display = 'none';

        $('#btnCopyLink').addEventListener('click', async () => {
          await navigator.clipboard.writeText(link);
          toast('å·²è¤‡è£½é€£çµåˆ°å‰ªè²¼ç°¿');
        });

        $('#btnCopyCode').addEventListener('click', async () => {
          await navigator.clipboard.writeText(code);
          toast('å·²è¤‡è£½æ¨è–¦ç¢¼åˆ°å‰ªè²¼ç°¿');
        });
      } catch (e) {
        console.error(e);
        toast('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    })();
  </script>
</body>
</html>










