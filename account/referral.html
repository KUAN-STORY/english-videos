<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¨å»£åˆ†æ½¤ | Learn English with Stories</title>
  <script type="module" src="../supa.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #fafafa;
      color: #222;
      margin: 0;
      padding: 0;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .referral-container {
      max-width: 800px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 2rem;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .link-box {
      background: #f7f9fc;
      border: 1px dashed #aaa;
      padding: 1rem;
      margin-top: 1rem;
      word-break: break-all;
      border-radius: 8px;
    }
    .btn {
      background: #0078ff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }
    .btn:hover { background: #005ec9; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    .summary {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

<header>
  <h2>æ¨å»£åˆ†æ½¤</h2>
  <a href="../index.html" class="btn">è¿”å›é¦–é </a>
</header>

<main class="referral-container">
  <h1>æˆ‘çš„æ¨å»£é€£çµ</h1>
  <p>å°‡æ­¤é€£çµåˆ†äº«çµ¦æœ‹å‹ï¼Œæ¯ç•¶ä»–å€‘è¨»å†Šä¸¦è¨‚é–±èª²ç¨‹ï¼Œä½ éƒ½èƒ½ç²å¾—åˆ†æ½¤çå‹µ ğŸ‰</p>
  <div class="link-box" id="referralLink">è¼‰å…¥ä¸­...</div>
  <button class="btn" id="copyBtn">è¤‡è£½é€£çµ</button>

  <div class="summary" id="summaryBox">çµ±è¨ˆè¼‰å…¥ä¸­...</div>

  <table>
    <thead>
      <tr><th>å—é‚€è€… Email</th><th>è¨»å†Šæ—¥æœŸ</th><th>ç‹€æ…‹</th></tr>
    </thead>
    <tbody id="referralTable">
      <tr><td colspan="3">è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>
</main>

<script type="module">
  import { supabase } from '../supa.js';

  const linkBox = document.getElementById('referralLink');
  const table = document.getElementById('referralTable');
  const summary = document.getElementById('summaryBox');
  const copyBtn = document.getElementById('copyBtn');

  let referralLink = '';

  async function initReferral() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      linkBox.textContent = 'è«‹å…ˆç™»å…¥å¸³è™Ÿ';
      table.innerHTML = '<tr><td colspan="3">è«‹ç™»å…¥å¾ŒæŸ¥çœ‹è³‡æ–™</td></tr>';
      return;
    }

    // å»ºç«‹æ¨è–¦é€£çµ
    const baseUrl = location.origin + '/index.html';
    referralLink = `${baseUrl}?ref=${encodeURIComponent(user.id)}`;
    linkBox.textContent = referralLink;

    // æ¨¡æ“¬æŸ¥è©¢ referral è¡¨
    const { data, error } = await supabase
      .from('referrals')
      .select('*')
      .eq('referrer_id', user.id)
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      table.innerHTML = '<tr><td colspan="3">ç„¡æ³•è®€å–è³‡æ–™</td></tr>';
      summary.textContent = 'è¼‰å…¥å¤±æ•—';
      return;
    }

    if (!data || data.length === 0) {
      table.innerHTML = '<tr><td colspan="3">å°šç„¡æ¨å»£ç´€éŒ„</td></tr>';
      summary.textContent = 'å°šç„¡åˆ†æ½¤è³‡æ–™';
      return;
    }

    table.innerHTML = data.map(r => `
      <tr>
        <td>${r.invitee_email || '(æœªçŸ¥)'}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${r.status || 'å·²è¨»å†Š'}</td>
      </tr>
    `).join('');

    summary.textContent = `ç›®å‰å…±æœ‰ ${data.length} ç­†æ¨è–¦ï¼Œç´¯ç©åˆ†æ½¤ ${data.length * 100} å…ƒ`;
  }

  copyBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(referralLink);
    copyBtn.textContent = 'âœ… å·²è¤‡è£½';
    setTimeout(() => copyBtn.textContent = 'è¤‡è£½é€£çµ', 2000);
  });

  initReferral();
</script>

</body>
</html>
